import { App, PluginSettingTab, Setting } from 'obsidian';
import type IdeatrPlugin from './main';
import { LLMSettingsSection } from './settings/sections/LLMSettingsSection';
import { CloudAISettingsSection } from './settings/sections/CloudAISettingsSection';
import { DomainSettingsSection } from './settings/sections/DomainSettingsSection';
import { WebSearchSettingsSection } from './settings/sections/WebSearchSettingsSection';
import { NameVariantSettingsSection } from './settings/sections/NameVariantSettingsSection';
import { ScaffoldSettingsSection } from './settings/sections/ScaffoldSettingsSection';
import { ProjectElevationSettingsSection } from './settings/sections/ProjectElevationSettingsSection';
import { ErrorLoggingSettingsSection } from './settings/sections/ErrorLoggingSettingsSection';
import { FeedbackSettingsSection } from './settings/sections/FeedbackSettingsSection';
import { CaptureModalSettingsSection } from './settings/sections/CaptureModalSettingsSection';
import { TutorialSettingsSection } from './settings/sections/TutorialSettingsSection';
import { createHelpIcon } from './utils/HelpIcon';

export interface IdeatrSettings {
    llmProvider: 'llama' | 'anthropic' | 'openai' | 'gemini' | 'groq' | 'openrouter' | 'custom' | 'none';
    llamaServerUrl: string; // Keep for backward compatibility or external server
    llamaBinaryPath: string;
    modelPath: string;
    llamaServerPort: number;
    concurrency: number;
    llmTimeout: number;
    autoClassify: boolean;

    // Domain checking settings
    enableDomainCheck: boolean;
    autoCheckDomains: boolean;
    enableProspectr: boolean; // Feature flag to show/hide Prospectr references
    prospectrUrl: string;
    domainCheckTimeout: number; // milliseconds

    // Web search settings
    enableWebSearch: boolean;
    autoSearchExistence: boolean;
    webSearchProvider: 'google' | 'duckduckgo' | 'none';
    googleSearchApiKey: string;
    googleSearchEngineId: string;
    webSearchTimeout: number; // milliseconds
    maxSearchResults: number; // 1-10, default 5

    // Name variant generation
    enableNameVariants: boolean;
    autoGenerateVariants: boolean; // Auto-generate on capture vs manual
    maxVariants: number; // 5-10, default 8
    useLLMForNameExtraction: boolean; // Use LLM for intelligent name extraction
    variantCacheMaxSize: number; // Maximum cache entries (0 = unlimited)
    variantCachePersist: boolean; // Persist cache to disk

    // Scaffold generation
    enableScaffolds: boolean;
    scaffoldDefaultAction: 'append' | 'new-note'; // Append to current or create new

    // Dashboard settings
    dashboardDefaultView: 'table' | 'graph' | 'inbox';
    dashboardItemsPerPage: number;
    dashboardAutoRefresh: boolean;
    dashboardPersistFilters: boolean; // Persist filter state across sessions

    // Clustering settings
    enableClustering: boolean;
    clusteringAlgorithm: 'hierarchical' | 'kmeans' | 'dbscan';
    maxClusters: number; // 0 = auto-determine
    clusterColorScheme: 'category' | 'age' | 'random';
    clusteringSimilarityThreshold: number; // 0-1, default 0.3

    // Resurfacing settings
    enableResurfacing: boolean;
    resurfacingThresholdDays: number; // Default 7
    resurfacingFrequency: 'daily' | 'weekly' | 'manual';
    resurfacingTime: string; // HH:MM format, if scheduled (e.g., "09:00")
    autoGenerateDigest: boolean; // Auto-generate on schedule (v2)
    digestIncludeSummary: boolean; // Include summary in digest
    digestMaxIdeas: number; // Max ideas per digest (0 = unlimited)

    // Project elevation settings
    enableElevation: boolean; // Enable project elevation feature
    elevationProjectsDirectory: string; // Directory for elevated projects (default: "Projects")
    elevationCreateDevraMetadata: boolean; // Create Devra metadata file on elevation
    elevationDefaultFolders: string; // Comma-separated list of default folders (e.g., "docs,notes,assets")

    // AI Model Management
    setupCompleted: boolean; // First-launch setup completed
    modelDownloaded: boolean; // Model has been downloaded
    keepModelLoaded: boolean; // Keep model loaded in memory
    preloadOnStartup: boolean; // Preload model on Obsidian startup

    // Cloud AI
    preferCloud: boolean; // Prefer cloud AI over local
    cloudProvider: 'anthropic' | 'openai' | 'gemini' | 'groq' | 'openrouter' | 'custom' | 'none';
    cloudApiKey: string; // API key for cloud provider
    customEndpointUrl: string; // Custom endpoint URL (for self-hosted)
    openRouterModel: string; // OpenRouter model selection

    // File Organization
    moveArchivedToFolder: boolean; // Move archived ideas to Ideas/Archived/ directory

    // Error Logging (for bug reports)
    errorLoggingEnabled: boolean; // Enable error logging
    errorLogMaxEntries: number; // Maximum number of error log entries
    errorLogRetentionDays: number; // Days to retain error logs

    // Debug Mode (for developers)
    debugMode: boolean; // Enable debug logging (gates console.log/info/warn)

    // Capture Modal Keyboard Shortcuts
    captureIdeaHotkey: string; // Keyboard shortcut for opening Capture Idea modal (e.g., "cmd+i" or "ctrl+i")
    captureSaveShortcut: string; // Keyboard shortcut for Save button (e.g., "cmd+enter" or "ctrl+enter")
    captureIdeateShortcut: string; // Keyboard shortcut for Ideate button (e.g., "ctrl+enter" or "alt+enter")
}

export const DEFAULT_SETTINGS: IdeatrSettings = {
    llmProvider: 'llama',
    llamaServerUrl: 'http://127.0.0.1:8080',
    llamaBinaryPath: '',
    modelPath: '',
    llamaServerPort: 8080,
    concurrency: 1,
    llmTimeout: 10000, // Increased default for local inference
    autoClassify: true,

    // Domain checking
    enableDomainCheck: true,
    autoCheckDomains: false, // Manual by default (user can enable auto)
    enableProspectr: false, // Hidden by default until Prospectr is live
    prospectrUrl: 'http://localhost:3000',
    domainCheckTimeout: 10000, // 10 seconds

    // Web search
    enableWebSearch: true,
    autoSearchExistence: false, // Manual by default
    webSearchProvider: 'google',
    googleSearchApiKey: '',
    googleSearchEngineId: '',
    webSearchTimeout: 15000, // 15 seconds
    maxSearchResults: 5,

    // Name variant generation
    enableNameVariants: true,
    autoGenerateVariants: false, // Manual by default (user can enable auto)
    maxVariants: 8,
    useLLMForNameExtraction: false, // Rule-based by default (user can enable LLM)
    variantCacheMaxSize: 100, // Default: 100 entries
    variantCachePersist: true, // Persist cache by default

    // Scaffold generation
    enableScaffolds: true,
    scaffoldDefaultAction: 'append', // Append to current note by default

    // Dashboard
    dashboardDefaultView: 'table',
    dashboardItemsPerPage: 50,
    dashboardAutoRefresh: true,
    dashboardPersistFilters: true,

    // Clustering
    enableClustering: true,
    clusteringAlgorithm: 'hierarchical',
    maxClusters: 0, // Auto
    clusterColorScheme: 'category',
    clusteringSimilarityThreshold: 0.3,

    // Resurfacing
    enableResurfacing: true,
    resurfacingThresholdDays: 7,
    resurfacingFrequency: 'manual', // Manual for v1
    resurfacingTime: '09:00',
    autoGenerateDigest: false, // Manual for v1
    digestIncludeSummary: true,
    digestMaxIdeas: 0, // Unlimited

    // Project elevation
    enableElevation: true,
    elevationProjectsDirectory: 'Projects',
    elevationCreateDevraMetadata: true, // Create .devra.json metadata file
    elevationDefaultFolders: 'docs,notes,assets', // Default folders to create

    // AI Model Management
    setupCompleted: false,
    modelDownloaded: false,
    keepModelLoaded: false,
    preloadOnStartup: false,

    // Cloud AI
    preferCloud: false,
    cloudProvider: 'none',
    cloudApiKey: '',
    customEndpointUrl: '',
    openRouterModel: '',

    // File Organization
    moveArchivedToFolder: false, // Default: don't move files, just update status

    // Error Logging
    errorLoggingEnabled: true, // Default: enabled
    errorLogMaxEntries: 50, // Default: 50 entries
    errorLogRetentionDays: 7, // Default: 7 days

    // Debug Mode (for developers)
    debugMode: false, // Default: false (only enabled for developer vaults)

    // Capture Modal Keyboard Shortcuts
    captureIdeaHotkey: 'cmd+i', // Default: Cmd+I (Mac) or Ctrl+I (Windows/Linux) - users can customize
    captureSaveShortcut: 'cmd+enter', // Default: Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux) - users can customize
    captureIdeateShortcut: 'alt+enter' // Default: Alt+Enter (works on both Mac and Windows/Linux)
};

export class IdeatrSettingTab extends PluginSettingTab {
    plugin: IdeatrPlugin;

    constructor(app: App, plugin: IdeatrPlugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display(): void {
        const { containerEl } = this;

        containerEl.empty();

        containerEl.createEl('h2', { text: 'Ideatr Settings' });

        // Initialize sections
        const llmSection = new LLMSettingsSection(this.app, this.plugin, this);
        const cloudAISection = new CloudAISettingsSection(this.app, this.plugin, this);
        const domainSection = new DomainSettingsSection(this.app, this.plugin, this);
        const webSearchSection = new WebSearchSettingsSection(this.app, this.plugin, this);
        const nameVariantSection = new NameVariantSettingsSection(this.app, this.plugin, this);
        const scaffoldSection = new ScaffoldSettingsSection(this.app, this.plugin, this);
        const projectElevationSection = new ProjectElevationSettingsSection(this.app, this.plugin, this);
        const errorLoggingSection = new ErrorLoggingSettingsSection(this.app, this.plugin, this);
        const feedbackSection = new FeedbackSettingsSection(this.app, this.plugin, this);
        const captureModalSection = new CaptureModalSettingsSection(this.app, this.plugin, this);
        const tutorialSection = new TutorialSettingsSection(this.app, this.plugin, this);

        // Display sections
        llmSection.display(containerEl);
        cloudAISection.display(containerEl);

        // Legacy LLM Provider setting (for backward compatibility)
        containerEl.createEl('h3', { text: 'Legacy Settings' });
        new Setting(containerEl)
            .setName('LLM Provider (Legacy)')
            .setDesc('Select the AI provider for classification (legacy setting)')
            .addDropdown(dropdown => dropdown
                .addOption('llama', 'Llama.cpp (Local)')
                .addOption('none', 'None (Disable AI)')
                .setValue(this.plugin.settings.llmProvider)
                .onChange(async (value) => {
                    this.plugin.settings.llmProvider = value as 'llama' | 'none';
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Llama Server URL')
            .setDesc('URL of your local Llama.cpp server (e.g., http://127.0.0.1:8080)')
            .addText(text => text
                .setPlaceholder('http://127.0.0.1:8080')
                .setValue(this.plugin.settings.llamaServerUrl)
                .onChange(async (value) => {
                    this.plugin.settings.llamaServerUrl = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Llama Server Binary')
            .setDesc('Absolute path to the llama-server executable')
            .addText(text => text
                .setPlaceholder('/path/to/llama-server')
                .setValue(this.plugin.settings.llamaBinaryPath)
                .onChange(async (value) => {
                    this.plugin.settings.llamaBinaryPath = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Model Path')
            .setDesc('Absolute path to the .gguf model file')
            .addText(text => text
                .setPlaceholder('/path/to/model.gguf')
                .setValue(this.plugin.settings.modelPath)
                .onChange(async (value) => {
                    this.plugin.settings.modelPath = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Server Port')
            .setDesc('Port to run the local server on')
            .addText(text => text
                .setPlaceholder('8080')
                .setValue(String(this.plugin.settings.llamaServerPort))
                .onChange(async (value) => {
                    const numValue = Number(value);
                    if (!isNaN(numValue)) {
                        this.plugin.settings.llamaServerPort = numValue;
                        this.plugin.settings.llamaServerUrl = `http://127.0.0.1:${numValue}`;
                        await this.plugin.saveSettings();
                    }
                }));

        new Setting(containerEl)
            .setName('API Timeout (ms)')
            .setDesc('Maximum time to wait for AI response')
            .addText(text => text
                .setPlaceholder('5000')
                .setValue(String(this.plugin.settings.llmTimeout))
                .onChange(async (value) => {
                    const numValue = Number(value);
                    if (!isNaN(numValue)) {
                        this.plugin.settings.llmTimeout = numValue;
                        await this.plugin.saveSettings();
                    }
                }));

        new Setting(containerEl)
            .setName('Auto-Classify')
            .setDesc('Automatically classify ideas upon capture')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.autoClassify)
                .onChange(async (value) => {
                    this.plugin.settings.autoClassify = value;
                    await this.plugin.saveSettings();
                }));

        // Validation Tools Section
        const validationTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        validationTitle.createEl('h2', { text: 'Validation Tools' });
        const validationHelpIcon = createHelpIcon(this.app, 'validation', 'Learn about Validation Tools');
        validationTitle.appendChild(validationHelpIcon);
        domainSection.display(containerEl);
        webSearchSection.display(containerEl);

        // Transformation Tools Section
        const transformationTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        transformationTitle.createEl('h2', { text: 'Transformation Tools' });
        const transformationHelpIcon = createHelpIcon(this.app, 'transformation', 'Learn about Transformation Tools');
        transformationTitle.appendChild(transformationHelpIcon);
        nameVariantSection.display(containerEl);
        scaffoldSection.display(containerEl);

        // Project Elevation Section
        projectElevationSection.display(containerEl);

        // Feedback Section
        const feedbackTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        feedbackTitle.createEl('h2', { text: 'Feedback & Support' });
        feedbackSection.display(containerEl);

        // Error Logging Settings
        containerEl.createEl('h3', { text: 'Error Logging' });
        errorLoggingSection.display(containerEl);

        // Capture Modal Settings
        const captureTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        captureTitle.createEl('h2', { text: 'Capture Modal' });
        const captureHelpIcon = createHelpIcon(this.app, 'capture-workflows', 'Learn about Capture Modal');
        captureTitle.appendChild(captureHelpIcon);
        captureModalSection.display(containerEl);

        // Tutorial Settings
        tutorialSection.display(containerEl);
    }
}
