import { App, PluginSettingTab } from 'obsidian';
import type IdeatrPlugin from './main';
import { LLMSettingsSection } from './settings/sections/LLMSettingsSection';
import { CloudAISettingsSection } from './settings/sections/CloudAISettingsSection';
// Domain checking removed - functionality hidden
// import { DomainSettingsSection } from './settings/sections/DomainSettingsSection';
import { WebSearchSettingsSection } from './settings/sections/WebSearchSettingsSection';
import { NameVariantSettingsSection } from './settings/sections/NameVariantSettingsSection';
import { ScaffoldSettingsSection } from './settings/sections/ScaffoldSettingsSection';
import { ProjectElevationSettingsSection } from './settings/sections/ProjectElevationSettingsSection';
import { ErrorLoggingSettingsSection } from './settings/sections/ErrorLoggingSettingsSection';
import { FeedbackSettingsSection } from './settings/sections/FeedbackSettingsSection';
import { CaptureModalSettingsSection } from './settings/sections/CaptureModalSettingsSection';
import { TutorialSettingsSection } from './settings/sections/TutorialSettingsSection';
import { createHelpIcon } from './utils/HelpIcon';

export interface IdeatrSettings {
    llmProvider: 'llama' | 'anthropic' | 'openai' | 'gemini' | 'groq' | 'openrouter' | 'custom' | 'none';
    llamaServerUrl: string; // Keep for backward compatibility or external server
    llamaBinaryPath: string;
    modelPath: string;
    llamaServerPort: number;
    concurrency: number;
    llmTimeout: number;
    autoClassify: boolean;

    // Domain checking settings
    enableDomainCheck: boolean;
    autoCheckDomains: boolean;
    enableProspectr: boolean; // Feature flag to show/hide domain checking service references
    prospectrUrl: string;
    domainCheckTimeout: number; // milliseconds

    // Web search settings
    enableWebSearch: boolean;
    autoSearchExistence: boolean;
    webSearchProvider: 'google' | 'duckduckgo' | 'none';
    googleSearchApiKey: string;
    googleSearchEngineId: string;
    webSearchTimeout: number; // milliseconds
    maxSearchResults: number; // 1-10, default 5

    // Name variant generation
    enableNameVariants: boolean;
    autoGenerateVariants: boolean; // Auto-generate on capture vs manual
    maxVariants: number; // 5-10, default 8
    useLLMForNameExtraction: boolean; // Use LLM for intelligent name extraction
    variantCacheMaxSize: number; // Maximum cache entries (0 = unlimited)
    variantCachePersist: boolean; // Persist cache to disk

    // Scaffold generation
    enableScaffolds: boolean;
    scaffoldDefaultAction: 'append' | 'new-note'; // Append to current or create new

    // Dashboard settings
    dashboardDefaultView: 'table' | 'graph' | 'inbox';
    dashboardItemsPerPage: number;
    dashboardAutoRefresh: boolean;
    dashboardPersistFilters: boolean; // Persist filter state across sessions

    // Clustering settings
    enableClustering: boolean;
    clusteringAlgorithm: 'hierarchical' | 'kmeans' | 'dbscan';
    maxClusters: number; // 0 = auto-determine
    clusterColorScheme: 'category' | 'age' | 'random';
    clusteringSimilarityThreshold: number; // 0-1, default 0.3

    // Resurfacing settings
    enableResurfacing: boolean;
    resurfacingThresholdDays: number; // Default 7
    resurfacingFrequency: 'daily' | 'weekly' | 'manual';
    resurfacingTime: string; // HH:MM format, if scheduled (e.g., "09:00")
    autoGenerateDigest: boolean; // Auto-generate on schedule (v2)
    digestIncludeSummary: boolean; // Include summary in digest
    digestMaxIdeas: number; // Max ideas per digest (0 = unlimited)

    // Project elevation settings
    enableElevation: boolean; // Enable project elevation feature
    elevationProjectsDirectory: string; // Directory for elevated projects (default: "Projects")
    elevationCreateDevraMetadata: boolean; // Create project metadata file on elevation (for future project management integration)
    elevationDefaultFolders: string; // Comma-separated list of default folders (e.g., "docs,notes,assets")

    // AI Model Management
    setupCompleted: boolean; // First-launch setup completed
    modelDownloaded: boolean; // Model has been downloaded
    keepModelLoaded: boolean; // Keep model loaded in memory
    preloadOnStartup: boolean; // Preload model on Obsidian startup
    localModel: 'phi-3.5-mini' | 'qwen-2.5-7b' | 'llama-3.1-8b' | 'llama-3.3-70b'; // Selected local AI model

    // Cloud AI
    preferCloud: boolean; // Prefer cloud AI over local
    cloudProvider: 'anthropic' | 'openai' | 'gemini' | 'groq' | 'openrouter' | 'custom' | 'custom-model' | 'none';
    cloudApiKeys: Record<'anthropic' | 'openai' | 'gemini' | 'groq' | 'openrouter', string>; // API keys per provider
    cloudApiKey?: string; // Legacy field for backward compatibility (deprecated)
    customEndpointUrl: string; // Custom endpoint URL (for self-hosted)
    openRouterModel: string; // OpenRouter model selection
    customModelProvider?: 'anthropic' | 'openai' | 'gemini' | 'groq'; // Provider for custom model selection
    customModel?: string; // Custom model ID for custom-model provider

    // File Organization
    moveArchivedToFolder: boolean; // Move archived ideas to Ideas/Archived/ directory

    // Error Logging (for bug reports)
    errorLoggingEnabled: boolean; // Enable error logging
    errorLogMaxEntries: number; // Maximum number of error log entries
    errorLogRetentionDays: number; // Days to retain error logs

    // Debug Mode (for developers)
    debugMode: boolean; // Enable debug logging (gates console.log/info/warn)

    // Capture Modal Keyboard Shortcuts
    captureIdeaHotkey: string; // Keyboard shortcut for opening Capture Idea modal (e.g., "cmd+i" or "ctrl+i")
    captureSaveShortcut: string; // Keyboard shortcut for Save button (e.g., "cmd+enter" or "ctrl+enter")
    captureIdeateShortcut: string; // Keyboard shortcut for Ideate button (e.g., "ctrl+enter" or "alt+enter")
}

export const DEFAULT_SETTINGS: IdeatrSettings = {
    llmProvider: 'llama',
    llamaServerUrl: 'http://127.0.0.1:8080',
    llamaBinaryPath: '',
    modelPath: '',
    llamaServerPort: 8080,
    concurrency: 1,
    llmTimeout: 10000, // Increased default for local inference
    autoClassify: true,

    // Domain checking
    enableDomainCheck: true,
    autoCheckDomains: false, // Manual by default (user can enable auto)
    enableProspectr: false, // Hidden by default until domain checking service is available
    prospectrUrl: 'http://localhost:3000',
    domainCheckTimeout: 10000, // 10 seconds

    // Web search
    enableWebSearch: true,
    autoSearchExistence: false, // Manual by default
    webSearchProvider: 'google',
    googleSearchApiKey: '',
    googleSearchEngineId: '',
    webSearchTimeout: 15000, // 15 seconds
    maxSearchResults: 5,

    // Name variant generation
    enableNameVariants: true,
    autoGenerateVariants: false, // Manual by default (user can enable auto)
    maxVariants: 8,
    useLLMForNameExtraction: false, // Rule-based by default (user can enable LLM)
    variantCacheMaxSize: 100, // Default: 100 entries
    variantCachePersist: true, // Persist cache by default

    // Scaffold generation
    enableScaffolds: true,
    scaffoldDefaultAction: 'append', // Append to current note by default

    // Dashboard
    dashboardDefaultView: 'table',
    dashboardItemsPerPage: 50,
    dashboardAutoRefresh: true,
    dashboardPersistFilters: true,

    // Clustering
    enableClustering: true,
    clusteringAlgorithm: 'hierarchical',
    maxClusters: 0, // Auto
    clusterColorScheme: 'category',
    clusteringSimilarityThreshold: 0.3,

    // Resurfacing
    enableResurfacing: true,
    resurfacingThresholdDays: 7,
    resurfacingFrequency: 'manual', // Manual for v1
    resurfacingTime: '09:00',
    autoGenerateDigest: false, // Manual for v1
    digestIncludeSummary: true,
    digestMaxIdeas: 0, // Unlimited

    // Project elevation
    enableElevation: true,
    elevationProjectsDirectory: 'Projects',
    elevationCreateDevraMetadata: true, // Create .devra.json metadata file (for future project management integration)
    elevationDefaultFolders: 'docs,notes,assets', // Default folders to create

    // AI Model Management
    setupCompleted: false,
    modelDownloaded: false,
    keepModelLoaded: false,
    preloadOnStartup: false,
    localModel: 'phi-3.5-mini',

    // Cloud AI
    preferCloud: false,
    cloudProvider: 'none',
    cloudApiKeys: {
        anthropic: '',
        openai: '',
        gemini: '',
        groq: '',
        openrouter: ''
    },
    customEndpointUrl: '',
    openRouterModel: '',
    customModelProvider: undefined,
    customModel: undefined,

    // File Organization
    moveArchivedToFolder: false, // Default: don't move files, just update status

    // Error Logging
    errorLoggingEnabled: true, // Default: enabled
    errorLogMaxEntries: 50, // Default: 50 entries
    errorLogRetentionDays: 7, // Default: 7 days

    // Debug Mode (for developers)
    debugMode: false, // Default: false (only enabled for developer vaults)

    // Capture Modal Keyboard Shortcuts
    captureIdeaHotkey: 'cmd+i', // Default: Cmd+I (Mac) or Ctrl+I (Windows/Linux) - users can customize
    captureSaveShortcut: 'alt+enter', // Default: Alt+Enter (Mac) or Alt+Enter (Windows/Linux) - users can customize
    captureIdeateShortcut: 'cmd+enter' // Default: Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux)
};

export class IdeatrSettingTab extends PluginSettingTab {
    plugin: IdeatrPlugin;

    constructor(app: App, plugin: IdeatrPlugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display(): void {
        const { containerEl } = this;

        containerEl.empty();

        containerEl.createEl('h2', { text: 'Ideatr settings' });

        // Beta notice
        const betaNotice = containerEl.createDiv({ cls: 'ideatr-beta-notice' });
        betaNotice.style.cssText = 'background: var(--background-modifier-border); padding: 1em; border-radius: 4px; margin-bottom: 1.5em; border-left: 3px solid var(--text-accent);';
        
        const betaTitle = betaNotice.createEl('strong', { text: '‚ö†Ô∏è Ideatr is in Beta' });
        betaTitle.style.cssText = 'display: block; margin-bottom: 0.5em; color: var(--text-accent);';
        
        const betaText = betaNotice.createEl('p', { 
            text: 'Ideatr is currently in beta. AI technology involves many moving parts, so things might not work as expected 100% of the time. We\'d love to hear from you!'
        });
        betaText.style.cssText = 'margin: 0.5em 0;';
        
        const betaActions = betaNotice.createDiv();
        betaActions.style.cssText = 'margin-top: 0.75em; display: flex; gap: 0.5em; flex-wrap: wrap;';
        
        const reportButton = betaActions.createEl('a', { 
            text: 'üìù Report Bug or Request Feature',
            href: '#ideatr-feedback-section'
        });
        reportButton.style.cssText = 'color: var(--text-accent); text-decoration: none; cursor: pointer;';
        reportButton.addEventListener('click', (e) => {
            e.preventDefault();
            // Scroll to feedback section after a short delay to ensure it's rendered
            setTimeout(() => {
                const feedbackSection = containerEl.querySelector('#ideatr-feedback-section');
                if (feedbackSection) {
                    feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        });
        
        const roadmapLink = betaActions.createEl('a', { 
            text: 'üó∫Ô∏è View Planned Features',
            href: 'https://github.com/FallingWithStyle/obsidian-ideatr#roadmap',
            attr: { target: '_blank', rel: 'noopener' }
        });
        roadmapLink.style.cssText = 'color: var(--text-accent); text-decoration: none;';
        
        const githubLink = betaActions.createEl('a', { 
            text: 'üêõ GitHub Issues',
            href: 'https://github.com/FallingWithStyle/obsidian-ideatr/issues',
            attr: { target: '_blank', rel: 'noopener' }
        });
        githubLink.style.cssText = 'color: var(--text-accent); text-decoration: none;';

        // Initialize sections
        const llmSection = new LLMSettingsSection(this.app, this.plugin, this);
        const cloudAISection = new CloudAISettingsSection(this.app, this.plugin, this);
        // Domain checking removed - functionality hidden
        // const domainSection = new DomainSettingsSection(this.app, this.plugin, this);
        const webSearchSection = new WebSearchSettingsSection(this.app, this.plugin, this);
        const nameVariantSection = new NameVariantSettingsSection(this.app, this.plugin, this);
        const scaffoldSection = new ScaffoldSettingsSection(this.app, this.plugin, this);
        const projectElevationSection = new ProjectElevationSettingsSection(this.app, this.plugin, this);
        const errorLoggingSection = new ErrorLoggingSettingsSection(this.app, this.plugin, this);
        const feedbackSection = new FeedbackSettingsSection(this.app, this.plugin, this);
        const captureModalSection = new CaptureModalSettingsSection(this.app, this.plugin, this);
        const tutorialSection = new TutorialSettingsSection(this.app, this.plugin, this);

        // Display sections
        llmSection.display(containerEl);
        cloudAISection.display(containerEl);

        // Validation Tools Section
        const validationTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        validationTitle.createEl('h2', { text: 'Validation tools' });
        const validationHelpIcon = createHelpIcon(this.app, 'validation', 'Learn about Validation Tools');
        validationTitle.appendChild(validationHelpIcon);
        // Domain checking settings hidden - functionality removed
        // domainSection.display(containerEl);
        webSearchSection.display(containerEl);

        // Transformation Tools Section
        const transformationTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        transformationTitle.createEl('h2', { text: 'Transformation tools' });
        const transformationHelpIcon = createHelpIcon(this.app, 'transformation', 'Learn about Transformation Tools');
        transformationTitle.appendChild(transformationHelpIcon);
        nameVariantSection.display(containerEl);
        scaffoldSection.display(containerEl);

        // Project Elevation Section
        projectElevationSection.display(containerEl);

        // Feedback Section
        const feedbackTitle = containerEl.createDiv({ cls: 'settings-section-title', attr: { id: 'ideatr-feedback-section' } });
        feedbackTitle.createEl('h2', { text: 'Feedback & support' });
        feedbackSection.display(containerEl);

        // Error Logging Settings
        containerEl.createEl('h3', { text: 'Error logging' });
        errorLoggingSection.display(containerEl);

        // Capture Modal Settings
        const captureTitle = containerEl.createDiv({ cls: 'settings-section-title' });
        captureTitle.createEl('h2', { text: 'Capture modal' });
        const captureHelpIcon = createHelpIcon(this.app, 'capture-workflows', 'Learn about Capture Modal');
        captureTitle.appendChild(captureHelpIcon);
        captureModalSection.display(containerEl);

        // Tutorial Settings
        tutorialSection.display(containerEl);
    }
}
