/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var ff=Object.create;var da=Object.defineProperty;var gf=Object.getOwnPropertyDescriptor;var yf=Object.getOwnPropertyNames;var bf=Object.getPrototypeOf,wf=Object.prototype.hasOwnProperty;var Dc=(n,e)=>()=>(n&&(e=n(n=0)),e);var Oc=(n,e)=>{for(var t in e)da(n,t,{get:e[t],enumerable:!0})},Nu=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of yf(e))!wf.call(n,s)&&s!==t&&da(n,s,{get:()=>e[s],enumerable:!(r=gf(e,s))||r.enumerable});return n};var ua=(n,e,t)=>(t=n!=null?ff(bf(n)):{},Nu(e||!n||!n.__esModule?da(t,"default",{value:n,enumerable:!0}):t,n)),vf=n=>Nu(da({},"__esModule",{value:!0}),n);function Nc(n){let e=Hu[n];if(!e)return"Tutorials/00-Index.md";let t=e.anchor?`#${e.anchor.replace("#","")}`:"";return`Tutorials/${e.file}${t}`}async function $c(n,e){let t=Nc(e),r=Hu[e],s=[t,t.replace("Tutorials/","tutorials/"),`Ideatr/${t}`,`Ideatr/${t.replace("Tutorials/","tutorials/")}`,`Ideatr/Tutorials/${r.file}`,`Ideatr/tutorials/${r.file}`];for(let a of s){let o=n.vault.getAbstractFileByPath(a);if(o&&o instanceof Nn.TFile){await n.workspace.openLinkText(a,"",!0);return}}let i=["Tutorials/00-Index.md","tutorials/00-Index.md","Ideatr/Tutorials/00-Index.md","Ideatr/tutorials/00-Index.md"];for(let a of i){let o=n.vault.getAbstractFileByPath(a);if(o&&o instanceof Nn.TFile){await n.workspace.openLinkText(o.path,"",!0);return}}new Nn.Notice("Tutorial file not found. Please ensure tutorials are available in your vault.")}function he(n,e,t){let r=document.createElement("span");return r.addClass("ideatr-help-icon"),r.setAttribute("aria-label",t||"Get help"),r.textContent="?",r.style.cursor="pointer",r.style.display="inline-flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.width="16px",r.style.height="16px",r.style.borderRadius="50%",r.style.backgroundColor="var(--background-modifier-border)",r.style.color="var(--text-muted)",r.style.fontSize="12px",r.style.fontWeight="bold",r.style.marginLeft="4px",r.style.verticalAlign="middle",r.style.lineHeight="1",r.addEventListener("mouseenter",()=>{r.style.backgroundColor="var(--interactive-accent)",r.style.color="var(--text-on-accent)"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor="var(--background-modifier-border)",r.style.color="var(--text-muted)"}),r.addEventListener("click",async s=>{s.stopPropagation(),await $c(n,e)}),t&&r.setAttribute("title",t),r}var Nn,Hu,ir=Dc(()=>{"use strict";Nn=require("obsidian"),Hu={"getting-started":{file:"01-Getting-Started.md"},"capture-workflows":{file:"02-Capture-Workflows.md"},validation:{file:"03-Validation-Guide.md"},transformation:{file:"04-Transformation-Tools.md"},lifecycle:{file:"05-Lifecycle-Management.md"},dashboard:{file:"06-Dashboard-Guide.md"},"graph-view":{file:"07-Graph-View-Guide.md"},"batch-operations":{file:"08-Batch-Operations.md"},"advanced-features":{file:"09-Advanced-Features.md"},"ideate-button":{file:"02-Capture-Workflows.md"},"save-button":{file:"02-Capture-Workflows.md"},"triage-inbox":{file:"06-Dashboard-Guide.md",anchor:"#triage-inbox"},clusters:{file:"06-Dashboard-Guide.md",anchor:"#clusters-panel"},resurfacing:{file:"06-Dashboard-Guide.md",anchor:"#resurfacing-panel"},filters:{file:"06-Dashboard-Guide.md",anchor:"#filtering"},"status-management":{file:"05-Lifecycle-Management.md",anchor:"#status-management"},"domain-checking":{file:"03-Validation-Guide.md",anchor:"#domain-checking"},"existence-search":{file:"03-Validation-Guide.md",anchor:"#existence-search"},"duplicate-detection":{file:"03-Validation-Guide.md",anchor:"#duplicate-detection"},"related-notes":{file:"03-Validation-Guide.md",anchor:"#related-notes-discovery"},"name-variants":{file:"04-Transformation-Tools.md",anchor:"#name-variants"},scaffolds:{file:"04-Transformation-Tools.md",anchor:"#scaffolds"},mutations:{file:"04-Transformation-Tools.md",anchor:"#mutations"},expansion:{file:"04-Transformation-Tools.md",anchor:"#expansion"},reorganization:{file:"04-Transformation-Tools.md",anchor:"#reorganization"},archiving:{file:"05-Lifecycle-Management.md",anchor:"#archiving-ideas"},codename:{file:"05-Lifecycle-Management.md",anchor:"#codename-generation"},"project-elevation":{file:"05-Lifecycle-Management.md",anchor:"#project-elevation"}}});var Nh={};Oc(Nh,{TutorialService:()=>ea});var Zi,ea,Au=Dc(()=>{"use strict";Zi=require("obsidian");ir();ea=class{constructor(e){this.app=e}async openIndex(){let e=["Tutorials/00-Index.md","tutorials/00-Index.md","Ideatr/Tutorials/00-Index.md","Ideatr/tutorials/00-Index.md"];for(let t of e){let r=this.app.vault.getAbstractFileByPath(t);if(r&&r instanceof Zi.TFile){await this.app.workspace.openLinkText(t,"",!0);return}}new Zi.Notice("Tutorial files not found. Please ensure tutorials are available in your vault.")}async openTopic(e){await $c(this.app,e)}getTutorialPath(e){return Nc(e)}areTutorialsAvailable(){let e=["Tutorials/00-Index.md","tutorials/00-Index.md","Ideatr/Tutorials/00-Index.md","Ideatr/tutorials/00-Index.md"];for(let t of e){let r=this.app.vault.getAbstractFileByPath(t);if(r&&r instanceof Zi.TFile)return!0}return!1}}});var Qh={};Oc(Qh,{MutationErrorModal:()=>_u});var ra,_u,Yh=Dc(()=>{"use strict";ra=require("obsidian"),_u=class extends ra.Modal{errorDetails;onRetry;constructor(e,t,r){super(e),this.errorDetails=t,this.onRetry=r}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Failed to generate mutations"}),e.addClass("ideatr-error-modal"),e.createDiv("ideatr-error-message").createEl("p",{text:this.errorDetails.message,cls:"ideatr-error-text"}),this.errorDetails.responseLength!==void 0){let o=e.createDiv("ideatr-error-details");if(o.createEl("p",{text:`Response length: ${this.errorDetails.responseLength} characters`,cls:"ideatr-error-detail"}),this.errorDetails.responsePreview){let l=o.createEl("strong",{text:"Response preview:"});l.style.display="block",l.style.marginTop="10px",l.style.marginBottom="5px";let c=o.createEl("pre",{text:this.errorDetails.responsePreview,cls:"ideatr-error-preview"});c.style.fontSize="0.9em",c.style.maxHeight="200px",c.style.overflow="auto",c.style.padding="10px",c.style.backgroundColor="var(--background-secondary)",c.style.borderRadius="4px",c.style.whiteSpace="pre-wrap",c.style.wordBreak="break-word"}}let r=e.createDiv("ideatr-error-causes");r.createEl("strong",{text:"Possible causes:",cls:"ideatr-error-causes-title"});let s=r.createEl("ul",{cls:"ideatr-error-causes-list"});this.errorDetails.responseLength===0?(s.createEl("li",{text:"The AI model stopped generating or returned an empty response"}),s.createEl("li",{text:"The model may have hit a token limit or encountered an error"}),s.createEl("li",{text:"Try reducing the number of mutations requested or using a different model"})):(s.createEl("li",{text:"The AI model returned malformed JSON that could not be parsed"}),s.createEl("li",{text:"The response may have been cut off mid-generation"}),s.createEl("li",{text:"Try again - the model may generate valid JSON on retry"}));let i=e.createDiv("ideatr-modal-buttons");i.style.marginTop="20px",this.errorDetails.canRetry&&this.onRetry&&i.createEl("button",{text:"Retry",cls:"mod-cta"}).addEventListener("click",async()=>{this.close(),new ra.Notice("Retrying mutation generation...");try{await this.onRetry()}catch(l){new ra.Notice(`Retry failed: ${l instanceof Error?l.message:"Unknown error"}`)}}),i.createEl("button",{text:"Close"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}}});var Jb={};Oc(Jb,{default:()=>Fc});module.exports=vf(Jb);var Ae=require("obsidian");var Ve=require("obsidian");function pa(n){let e=n.trim();return e.length===0?{valid:!1,error:"Idea cannot be empty"}:e.length<3?{valid:!1,error:"Idea must be at least 3 characters"}:e.length>5e3?{valid:!1,error:"Idea must be less than 5000 characters"}:{valid:!0,sanitizedText:xf(e)}}function xf(n){return n.trim().replace(/\0/g,"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`)}var m=class n{static app=null;static debugMode=!0;static debugFileChecked=!1;static debugFileExists=!1;static DEBUG_FILE_NAMES=[".ideatr-debug",".ideatr-debug.md"];static checkPromise=null;static async initialize(e,t=!0){n.app=e,n.debugMode=t,n.debugFileChecked=!1,n.debugFileExists=!1,e?.vault&&await n.checkDebugFile(e.vault),n.isDebugEnabled()&&console.debug("[Ideatr] Logger initialized in DEBUG mode"),n.logDeployTimestamp().catch(()=>{})}static async logDeployTimestamp(){try{if(!n.app?.vault)return;let t=`${n.app.vault.configDir}/plugins/ideatr/deploy-timestamp.json`;if(!await n.app.vault.adapter.exists(t)){n.debug("Deploy timestamp file not found (this is normal for first deploy)");return}let s=await n.app.vault.adapter.read(t),i=JSON.parse(s),a=i.deployedAtReadable||i.deployedAt;console.debug(`[Ideatr] Last deployed: ${a}`),n.info(`Last deployed: ${a}`)}catch(e){n.debug("Could not read deploy timestamp:",e)}}static forceRecheckDebugFile(){n.app?.vault&&(n.debugFileChecked=!1,n.debugFileExists=!1,n.checkDebugFile(n.app.vault).catch(()=>{}))}static async checkDebugFile(e){if(n.debugFileChecked&&n.checkPromise){await n.checkPromise;return}n.debugFileChecked||(n.checkPromise=(async()=>{try{for(let t of n.DEBUG_FILE_NAMES)if(await e.adapter.exists(t)){n.debugFileExists=!0,n.debugFileChecked=!0,n.checkPromise=null;return}n.debugFileExists=!1}catch{n.debugFileExists=!1}finally{n.debugFileChecked=!0,n.checkPromise=null}})(),await n.checkPromise)}static isDebugEnabled(){return n.debugMode?!0:n.debugFileExists}static debug(...e){n.isDebugEnabled()&&console.debug("[Ideatr Debug]",...e)}static info(...e){n.isDebugEnabled()&&console.debug("[Ideatr]",...e)}static warn(...e){n.isDebugEnabled()&&console.warn("[Ideatr]",...e)}static error(...e){n.isDebugEnabled()&&console.error("[Ideatr]",...e)}static log(e,...t){n.isDebugEnabled()&&console.debug(`[Ideatr:${e}]`,...t)}};function le(n){if(!n||n.trim().length===0)return"";let t=n.split(`
`)[0].trim().substring(0,50).trim();return t=t.replace(/[^a-zA-Z0-9\s-]/g,""),t.length<3&&(t=n.substring(0,50).trim(),t=t.replace(/[^a-zA-Z0-9\s-]/g,"")),t}async function $u(n,e){if(!e?.complete||e.isAvailable&&!e.isAvailable())return le(n);try{let t=`Extract a concise, descriptive name or title for this idea.

Idea: "${n}"

CRITICAL REQUIREMENTS:
- Extract the CORE CONCEPT, not just the first words
- Focus on what makes this idea unique or identifiable
- Create a title that someone could use to quickly understand what this is about

Rules:
- Return ONLY the name/title (3-50 characters)
- No quotes, no explanation, no prefixes like "Title:" or "Name:"
- If the idea is a long description, extract the key concept (e.g., "AI puzzle game with monkeys" \u2192 "Monkey Puzzle Game" or "AI Monkey Puzzle")
- If the first line is already a good title, use it
- Make it descriptive but concise - should capture the essence in a few words

Examples:
- "AI generated puzzle full of interlinked monkeys that look similar, sort of a where's waldo of monkeys" \u2192 "Monkey Puzzle Game" or "AI Monkey Find"
- "notification app that sends alerts" \u2192 "Notification App" or "Alert System"
- "task manager for teams" \u2192 "Team Task Manager"

Name:`,s=(await e.complete(t,{temperature:.3,n_predict:50,stop:[`
`,".","!","?"]})).trim();return s=s.replace(/^["']|["']$/g,""),s=s.substring(0,50).trim(),s=s.replace(/[^a-zA-Z0-9\s-]/g,""),s.length<3?le(n):s}catch(t){return m.warn("LLM name extraction failed, using rule-based fallback:",t),le(n)}}var ma=class{generateQuery(e,t,r){if(!e||e.trim().length===0)return"";let s=e.trim(),i=this.extractKeyTerms(s),a=r||le(e);if(a&&a.trim().length>0&&a.length>=3){let o=a.trim();i.toLowerCase().includes(o.toLowerCase())||(i=`${o} ${i}`)}if(!t)return i;switch(t){case"saas":case"tool":case"ux":return`${i} app`;case"game":case"mechanic":return`${i} game`;case"hardware":case"brand":return`${i} product`;case"story":case"ip":return`${i} book`;default:return i}}generateQueryVariations(e,t,r){if(!e||e.trim().length===0)return[];let s=e.trim(),i=this.extractKeyTerms(s),a=r||le(e);if(a&&a.trim().length>0&&a.length>=3){let l=a.trim();i.toLowerCase().includes(l.toLowerCase())||(i=`${l} ${i}`)}let o=[];if(!t)return o.push(i),o.push(`${i} product`),o.push(`${i} service`),o;switch(t){case"saas":case"tool":case"ux":o.push(`${i} app`),o.push(`${i} software`),o.push(`${i} tool`);break;case"game":case"mechanic":o.push(`${i} game`),o.push(`${i} gameplay`),o.push(`${i} game mechanic`);break;case"hardware":case"brand":o.push(`${i} product`),o.push(`${i} hardware`),o.push(`${i} device`);break;case"story":case"ip":o.push(`${i} book`),o.push(`${i} novel`),o.push(`${i} story`);break;default:o.push(i),o.push(`${i} product`)}return o}extractKeyTerms(e){return e.split(/\s+/).filter(r=>{let s=r.toLowerCase();return!["a","an","the","is","are","was","were","to","of","in","on","at","for","with"].includes(s)}).slice(0,5).join(" ")||e.split(/\s+/).slice(0,3).join(" ")}};function Sf(n){switch(n){case"game":case"mechanic":return"game";case"story":case"ip":return"story";case"saas":case"tool":case"ux":return"app";case"hardware":case"brand":return"product";case"personal":case"":default:return"similar"}}function Bu(n,e,t){if(n.length===0)return[];let r=e||n.length,s=n.slice(0,r),i=t!==void 0?Sf(t):"product",a=i==="similar"?"Found similar:":`Found similar ${i}:`;return s.map(o=>{let l=[],c=o.title.length>100?o.title.substring(0,100)+"...":o.title;return l.push(`${a} ${c}`),l.push(`URL: ${o.url}`),o.date&&l.push(`Date: ${o.date}`),l.join(" | ")})}var Uu=require("obsidian"),ha=class extends Uu.Modal{results;onAccept;onEdit;onRetry;editedTags=[];constructor(e,t,r,s,i){super(e),this.results=t,this.onAccept=r,this.onEdit=s,this.onRetry=i,this.editedTags=[...t.tags]}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-classification-results-modal"),e.createEl("h2",{text:"Classification results"});let t=e.createEl("div",{cls:"ideatr-setting-item"});t.createEl("label",{text:"Category:",attr:{for:"ideatr-category-display"}});let r=t.createEl("div",{cls:"ideatr-category",text:this.results.category||"(none)"});this.results.category||r.addClass("ideatr-empty");let s=e.createEl("div",{cls:"ideatr-setting-item"});s.createEl("label",{text:"Tags:"});let i=s.createEl("div",{cls:"ideatr-tags-list"});if(this.editedTags.forEach((h,p)=>{let f=i.createEl("div",{cls:"ideatr-tag-item"});f.createEl("input",{attr:{type:"text",value:h,placeholder:"Tag name"},cls:"ideatr-tag-input"}).addEventListener("input",x=>{let g=x.target;this.editedTags[p]=g.value.trim()}),f.createEl("button",{text:"\xD7",cls:"ideatr-remove-tag"}).addEventListener("click",()=>{this.editedTags.splice(p,1),this.renderTags(i)})}),i.createEl("button",{text:"+ Add Tag",cls:"ideatr-add-tag"}).addEventListener("click",()=>{this.editedTags.push(""),this.renderTags(i)}),this.results.confidence!==void 0){let h=e.createEl("div",{cls:"ideatr-setting-item"});h.createEl("label",{text:"Confidence:"}),h.createEl("div",{cls:"ideatr-confidence-bar"}).createEl("div",{cls:"ideatr-confidence-fill",attr:{style:`width: ${(this.results.confidence*100).toFixed(0)}%`}}),h.createEl("span",{cls:"ideatr-confidence-text",text:`${(this.results.confidence*100).toFixed(0)}%`})}let o=e.createEl("div",{cls:"ideatr-button-container"});o.createEl("button",{text:"Accept",cls:"mod-cta"}).addEventListener("click",()=>this.handleAccept()),o.createEl("button",{text:"Edit in Note"}).addEventListener("click",()=>this.handleEdit()),o.createEl("button",{text:"Retry"}).addEventListener("click",()=>this.handleRetry()),o.createEl("button",{text:"Cancel",cls:"mod-cancel"}).addEventListener("click",()=>this.close())}renderTags(e){e.empty(),this.editedTags.forEach((r,s)=>{let i=e.createEl("div",{cls:"ideatr-tag-item"});i.createEl("input",{attr:{type:"text",value:r,placeholder:"Tag name"},cls:"ideatr-tag-input"}).addEventListener("input",l=>{let c=l.target;this.editedTags[s]=c.value.trim()}),i.createEl("button",{text:"\xD7",cls:"ideatr-remove-tag"}).addEventListener("click",()=>{this.editedTags.splice(s,1),this.renderTags(e)})}),e.createEl("button",{text:"+ Add Tag",cls:"ideatr-add-tag"}).addEventListener("click",()=>{this.editedTags.push(""),this.renderTags(e)})}handleAccept(){let e=this.editedTags.filter(r=>r.trim().length>0),t={...this.results,tags:e};this.onAccept(t),this.close()}handleEdit(){this.close(),this.onEdit()}handleRetry(){this.close(),this.onRetry()}onClose(){let{contentEl:e}=this;e.empty()}};ir();var ze=ua(require("fs/promises"));function ee(...n){return n.filter(e=>e.length>0).map(e=>e.replace(/\\/g,"/").replace(/\/+/g,"/")).join("/").replace(/\/$/,"")}function Yr(...n){let e=ee(...n);return e.startsWith("/")||/^[A-Za-z]:/.test(e)?e.replace(/\/+/g,"/"):e.replace(/\/+/g,"/")}function Zr(n){return n.startsWith("/")||/^[A-Za-z]:/.test(n)}var $n=require("obsidian");function es(){if($n.Platform.isMacOS)return"darwin";if($n.Platform.isWin)return"win32";if($n.Platform.isLinux)return"linux";if(typeof navigator<"u"){let n=navigator.platform.toLowerCase();if(n.includes("mac")||n.includes("darwin"))return"darwin";if(n.includes("win"))return"win32";if(n.includes("linux"))return"linux"}return"unknown"}function fa(){return $n.Platform.isMacOS?"arm64":"x64"}function ju(){if(typeof process<"u"&&process.env?.HOME)return process.env.HOME;if(typeof process<"u"&&process.env?.USERPROFILE)return process.env.USERPROFILE;throw new Error("Home directory not available. Use app.vault.configDir or vault paths instead.")}var Bn=require("fs"),Bc=ua(require("crypto"));var ve={"phi-3.5-mini":{key:"phi-3.5-mini",name:"Phi-3.5 Mini",badge:"EFFICIENT",fileName:"Phi-3.5-mini-instruct-Q8_0.gguf",url:"https://huggingface.co/bartowski/Phi-3.5-mini-instruct-GGUF/resolve/main/Phi-3.5-mini-instruct-Q8_0.gguf",sizeBytes:436e7,sizeMB:4060,ram:"6-8GB",quality:4,speed:5,description:"Fast, lightweight, and ideal for everyday tasks. Excellent at structured work like classification and tagging.",pros:["Fast","Accurate","Small download","Low RAM usage"],cons:["Less creative than larger models"],bestFor:"Most users",chatTemplate:"phi-3.5",sha256:"76fbf02f6fe92af57dbd818409bc8a0240026f1f3609bb405c3be94c973fb823"},"qwen-2.5-7b":{key:"qwen-2.5-7b",name:"Qwen 2.5 7B",badge:"VERSATILE",fileName:"Qwen2.5-7B-Instruct-Q8_0.gguf",url:"https://huggingface.co/bartowski/Qwen2.5-7B-Instruct-GGUF/resolve/main/Qwen2.5-7B-Instruct-Q8_0.gguf",sizeBytes:78e8,sizeMB:7800,ram:"10GB",quality:4.5,speed:4,description:"A well-rounded model with stronger reasoning. Great at handling more complex and multilingual tasks.",pros:["Higher accuracy","Better context understanding","Multilingual"],cons:["Larger download","More RAM needed"],bestFor:"Users with 16GB+ RAM who want better quality",chatTemplate:"qwen-2.5",sha256:"9c6a6e61664446321d9c0dd7ee28a0d03914277609e21bc0e1fce4abe780ce1b"},"llama-3.1-8b":{key:"llama-3.1-8b",name:"Llama 3.1 8B",badge:"RELIABLE",fileName:"Meta-Llama-3.1-8B-Instruct-Q8_0.gguf",url:"https://huggingface.co/bartowski/Meta-Llama-3.1-8B-Instruct-GGUF/resolve/main/Meta-Llama-3.1-8B-Instruct-Q8_0.gguf",sizeBytes:85e8,sizeMB:8500,ram:"10-12GB",quality:4.5,speed:3,description:"Meta's trusted and widely documented model. Excellent accuracy with strong community support.",pros:["Very accurate","Well-tested","Strong community"],cons:["Larger download","Slower inference"],bestFor:"Power users who want Meta's best",chatTemplate:"llama-3.1",sha256:"9da71c45c90a821809821244d4971e5e5dfad7eb091f0b8ff0546392393b6283"},"llama-3.3-70b":{key:"llama-3.3-70b",name:"Llama 3.3 70B",badge:"MAXIMUM",fileName:"Llama-3.3-70B-Instruct-Q4_K_M.gguf",url:"https://huggingface.co/bartowski/Llama-3.3-70B-Instruct-GGUF/resolve/main/Llama-3.3-70B-Instruct-Q4_K_M.gguf",sizeBytes:425e8,sizeMB:42500,ram:"48GB+",quality:5,speed:1,description:"Top-tier performance with near-GPT-4 quality. Requires a high-end desktop workstation or powerful laptop with substantial RAM.",pros:["Best possible quality","Near-perfect accuracy","Understands complex nuance"],cons:["Huge download (~42.5GB)","Requires 48GB+ RAM","Very slow on most hardware"],bestFor:"Desktop workstations with 64GB+ RAM",chatTemplate:"llama-3.1",sha256:"32df3baccb556f9840059b2528b2dee4d3d516b24afdfb9d0c56ff5f63e3a664"}},be=class{modelConfig;modelDir;modelPath;modelInfo;abortController=null;isDownloading=!1;downloadProgressCallback=null;activeHashOperations=0;hashOperationLock=Promise.resolve();constructor(e="phi-3.5-mini"){ve[e]||(m.warn(`Invalid model key: ${e}, falling back to phi-3.5-mini`),e="phi-3.5-mini"),this.modelConfig=ve[e];try{let t=ju();this.modelDir=ee(t,".ideatr","models"),this.modelPath=ee(this.modelDir,this.modelConfig.fileName)}catch(t){m.warn("Home directory not available, using fallback path:",t),this.modelDir=".ideatr/models",this.modelPath=ee(this.modelDir,this.modelConfig.fileName)}this.modelInfo={name:this.modelConfig.fileName,sizeBytes:this.modelConfig.sizeBytes,sizeMB:this.modelConfig.sizeMB,checksum:this.modelConfig.sha256||"",downloadUrl:this.modelConfig.url}}getModelPath(){return this.modelPath}getModelInfo(){return{...this.modelInfo}}getModelConfig(){return{...this.modelConfig}}getAvailableModels(){return ve}async isModelDownloaded(){try{return await ze.access(this.modelPath),!0}catch{return!1}}async downloadModel(e,t,r=!1){try{await ze.mkdir(this.modelDir,{recursive:!0})}catch(i){throw new Error(`Failed to create model directory: ${i}`)}if(await this.isModelDownloaded()&&!r)throw new Error("Model already downloaded");if(r&&await this.isModelDownloaded())try{await ze.unlink(this.modelPath)}catch(i){throw new Error(`Failed to remove existing model: ${i}`)}this.isDownloading=!0,this.downloadProgressCallback=e||null,t||(this.abortController=new AbortController);let s=t||this.abortController.signal;try{let i=await fetch(this.modelInfo.downloadUrl,{signal:s,headers:{Accept:"application/octet-stream","User-Agent":"Obsidian-IdeaTr/1.0 (Model Downloader)"}});if(!i.ok){if(i.status===401){let h=this.modelInfo.downloadUrl.match(/^https:\/\/huggingface\.co\/([^\/]+\/[^\/]+)\//),p=h?`https://huggingface.co/${h[1]}`:"https://huggingface.co";throw new Error(`Download failed: Authentication required (401). This model may require accepting terms on Hugging Face. Please visit ${p} to accept any required agreements, then try again.`)}throw new Error(`Download failed: ${i.status} ${i.statusText}`)}let a=i.headers.get("content-length"),o=a?parseInt(a,10):this.modelInfo.sizeBytes,l=o/(1024*1024);a&&(this.modelInfo.sizeBytes=o,this.modelInfo.sizeMB=l);let c=i.body?.getReader();if(!c)throw new Error("Response body is not readable");let d=(0,Bn.createWriteStream)(this.modelPath),u=0;try{for(;;){let{done:h,value:p}=await c.read();if(h)break;if(s.aborted)throw new Error("Download cancelled");await new Promise((S,x)=>{d.write(Buffer.from(p),g=>{g?x(g):S()})}),u+=p.length;let f=u/(1024*1024),y=u/o*100;e&&e(y,f,l)}if(await new Promise((h,p)=>{d.end(f=>{f?p(f):h()})}),u!==o)throw new Error(`Download incomplete: expected ${o} bytes, got ${u} bytes`)}catch(h){d.destroy();try{await ze.unlink(this.modelPath)}catch{}throw h}}catch(i){if(i instanceof Error&&i.name==="AbortError"){try{await ze.unlink(this.modelPath)}catch{}throw new Error("Download cancelled")}throw i}finally{this.isDownloading=!1,this.downloadProgressCallback=null,t||(this.abortController=null)}}isDownloadInProgress(){return this.isDownloading}getDownloadProgressCallback(){return this.downloadProgressCallback}cancelDownload(){this.abortController&&this.abortController.abort()}async verifyModelIntegrity(){try{if(!await this.isModelDownloaded())return!1;let t=(await ze.stat(this.modelPath)).size,r=t/(1024*1024);if(t===0)return m.warn("Model integrity check failed - file is empty"),!1;let s=this.modelInfo.sizeBytes,i=this.modelInfo.sizeMB,a=s*.8,o=s*1.2,l=t>=a&&t<=o;if(this.modelInfo.checksum&&this.modelInfo.checksum.trim().length>0){await this.hashOperationLock;let c;this.hashOperationLock=new Promise(d=>{c=d});try{let d=await new Promise((p,f)=>{this.activeHashOperations++;let y=typeof process<"u"?process.memoryUsage().rss:0;m.debug("HASH START",this.modelPath,"Active:",this.activeHashOperations);let S=Bc.createHash("sha256"),x=(0,Bn.createReadStream)(this.modelPath),g=()=>{x.destroyed||x.destroy(),this.activeHashOperations--;let E=typeof process<"u"?process.memoryUsage().rss:0;m.debug("HASH END",this.modelPath,"Active:",this.activeHashOperations,"Memory delta:",y>0?((E-y)/1024/1024).toFixed(2):"N/A","MB"),c()};x.on("data",E=>{let R=typeof E=="string"?Buffer.from(E):E;S.update(R)}),x.on("end",()=>{try{let E=S.digest("hex").toLowerCase();g(),p(E)}catch(E){g(),f(E)}}),x.on("error",E=>{g(),f(E)}),x.on("close",()=>{this.activeHashOperations>0&&this.activeHashOperations--})}),u=this.modelInfo.checksum.toLowerCase().trim();return d===u?(l||m.warn("Model integrity check - checksum matches but size outside expected range:",{expectedSizeMB:i.toFixed(2),actualSizeMB:r.toFixed(2)}),!0):(m.warn("Model integrity check failed - SHA256 checksum mismatch:",{expected:u.substring(0,16)+"...",calculated:d.substring(0,16)+"...",sizeInRange:l,modelPath:this.modelPath}),!1)}catch(d){throw c(),d}}return l||m.warn("Model integrity check - size outside expected range (no checksum available):",{expectedSizeMB:i.toFixed(2),actualSizeMB:r.toFixed(2),minSizeMB:(a/(1024*1024)).toFixed(2),maxSizeMB:(o/(1024*1024)).toFixed(2)}),l}catch(e){return console.error("Model integrity check error:",e),!1}}async calculateModelChecksum(){try{if(!await this.isModelDownloaded())return null;await this.hashOperationLock;let e;this.hashOperationLock=new Promise(t=>{e=t});try{return await new Promise((t,r)=>{this.activeHashOperations++;let s=typeof process<"u"?process.memoryUsage().rss:0;m.debug("HASH START",this.modelPath,"Active:",this.activeHashOperations);let i=Bc.createHash("sha256"),a=(0,Bn.createReadStream)(this.modelPath),o=()=>{a.destroyed||a.destroy(),this.activeHashOperations--;let l=typeof process<"u"?process.memoryUsage().rss:0;m.debug("HASH END",this.modelPath,"Active:",this.activeHashOperations,"Memory delta:",s>0?((l-s)/1024/1024).toFixed(2):"N/A","MB"),e()};a.on("data",l=>{let c=typeof l=="string"?Buffer.from(l):l;i.update(c)}),a.on("end",()=>{try{let l=i.digest("hex");o(),t(l)}catch(l){o(),r(l)}}),a.on("error",l=>{o(),r(l)}),a.on("close",()=>{this.activeHashOperations>0&&this.activeHashOperations--})})}catch(t){throw e(),t}}catch(e){return m.error("Failed to calculate model checksum:",e),null}}};var $e=class extends Error{constructor(t,r){super(t);this.cause=r;this.name="ClassificationError"}},lt=class extends $e{constructor(e="API request timed out"){super(e),this.name="APITimeoutError"}},Ee=class extends $e{constructor(e="Network error occurred"){super(e),this.name="NetworkError"}};var Vu=require("child_process"),Ie=require("obsidian");var te=ua(require("fs"));function Af(n){let e=n.trim();e=Ef(e),e=e.replace(/,\s*([}\]])/g,"$1"),e=e.replace(/,\s*$/,"");let t=0,r=0,s=!1,i=!1,a=-1;for(let o=0;o<e.length;o++){let l=e[o];if(/\s/.test(l)||(a=o),i){i=!1;continue}if(l==="\\"){i=!0;continue}if(l==='"'&&!i){s=!s;continue}s||(l==="{"?t++:l==="}"?t--:l==="["?r++:l==="]"&&r--)}for(e=e.trimEnd(),s&&a>=0&&(e+='"');t>0;)e+="}",t--;for(;r>0;)e+="]",r--;return e}function Ef(n){let e="",t=0,r=!1,s=!1;for(;t<n.length;){let i=n[t];if(s){e+=i,s=!1,t++;continue}if(i==="\\"){e+=i,s=!0,t++;continue}if(i==='"'&&!s){if(r=!r,e+=i,!r){let a=t+1;for(;a<n.length&&/\s/.test(n[a]);)a++;if(a<n.length){let o=n[a];if(!(n.substring(t+1,a).indexOf(",")!==-1)&&o==='"'){let d=t-1;for(;d>=0&&/\s/.test(n[d]);)d--;if(d>=0){let u=n[d];u!==":"&&(u===","||u==="{"||u==="["||u==='"'||u==="}"||u==="]")&&(e+=",")}else e+=","}}}t++;continue}if(r){e+=i,t++;continue}if((i==="}"||i==="]")&&t+1<n.length){e+=i;let a=t+1;for(;a<n.length&&/\s/.test(n[a]);)a++;if(a<n.length){let o=n[a];!(n.substring(t+1,a).indexOf(",")!==-1)&&(o==='"'||o==="{"||o==="[")&&(e+=",")}t++;continue}e+=i,t++}return e}function z(n,e=!1){let t=n.trim(),r=/```(?:json)?\s*([\s\S]*?)```/,s=t.match(r);s&&s[1]&&(t=s[1].trim()),t=t.replace(/^(?:Here'?s?|Here is|Response:|Output:).*?:\s*\n?\s*/i,""),t=t.replace(/^(?:Example:|Example format:|Example response:).*?:\s*\n?\s*/i,""),t=t.replace(/^Here is.*?:\s*\n?\s*/i,"");let i=t.indexOf("["),a=t.indexOf("{"),o=-1;if(e&&i!==-1?o=i:!e&&a!==-1?o=a:i!==-1&&a!==-1?o=Math.min(i,a):!e&&a===-1?o=-1:i!==-1?o=i:a!==-1&&(o=a),o!==-1&&o>0&&(t=t.substring(o)),t=t.trim(),e&&!t.startsWith("[")?t.startsWith("{")?t=`[${t}]`:t=`[${t}`:!e&&!t.startsWith("{")&&(t=`{${t}`),e&&t.startsWith("[")){let l=0,c=!1,d=!1,u=-1;for(let h=0;h<t.length;h++){let p=t[h];if(d){d=!1;continue}if(p==="\\"){d=!0;continue}if(p==='"'&&!d){c=!c;continue}if(!c){if(p==="[")l++;else if(p==="]"&&(l--,l===0)){u=h+1;break}}}u!==-1&&l===0&&(t=t.substring(0,u))}else if(!e&&t.startsWith("{")){let l=0,c=!1,d=!1,u=-1;for(let h=0;h<t.length;h++){let p=t[h];if(d){d=!1;continue}if(p==="\\"){d=!0;continue}if(p==='"'&&!d){c=!c;continue}if(!c){if(p==="{")l++;else if(p==="}"&&(l--,l===0)){u=h+1;break}}}u!==-1&&l===0&&(t=t.substring(0,u))}return Af(t)}function qu(){return{totalRAMGB:0,availableRAMGB:0,platform:es(),arch:fa()}}function If(n){let e=n.match(/(\d+)/);return e?parseInt(e[1],10):0}function ar(n,e){let t=ve[n];if(!t)return m.warn(`Unknown model key: ${n}`),{isCompatible:!0};let r=e||qu(),s=If(t.ram),i=r.totalRAMGB;if(i===0)return{isCompatible:!0,warning:`This model requires ${t.ram} RAM. Please ensure your system meets this requirement.`,recommendation:"Check your system's available RAM before downloading large models."};if(s>i)return{isCompatible:!1,warning:`This model requires ${t.ram} RAM, but your system has ${i.toFixed(1)}GB total RAM. The model may fail to load.`,recommendation:'Consider using a smaller model like "Phi-3.5 Mini" (requires 6-8GB RAM) instead.'};if(s>i*.8){let a=`This model requires ${t.ram} RAM. Your system has ${i.toFixed(1)}GB total RAM. The model may struggle or fail to load if other applications are using memory.`,o=`Ensure you have at least ${s}GB free RAM before loading this model.`;return{isCompatible:!0,warning:a,recommendation:o}}return{isCompatible:!0}}function ct(){let n=qu();return n.totalRAMGB>0?`System: ${n.platform} ${n.arch}, ${n.totalRAMGB.toFixed(1)}GB total RAM`:`System: ${n.platform} ${n.arch}`}var Gu=require("child_process");var ga=class{process=null;startTime=0;setProcess(e){this.process=e,this.startTime=e?Date.now():0}getHealth(){if(!this.process||this.process.exitCode!==null)return{isRunning:!1,pid:null,memoryUsageMB:null,cpuUsagePercent:null,uptimeSeconds:null};let e=(Date.now()-this.startTime)/1e3;return{isRunning:!0,pid:this.process.pid||null,memoryUsageMB:this.getMemoryUsage(),cpuUsagePercent:null,uptimeSeconds:e}}getMemoryUsage(){if(!this.process||!this.process.pid)return null;try{let e=(0,Gu.execSync)(`ps -o rss= -p ${this.process.pid}`,{encoding:"utf8",stdio:["ignore","pipe","ignore"]}).trim();if(e){let t=parseInt(e,10);if(!isNaN(t))return t/1024}}catch{}return null}isProcessAlive(){if(!this.process||!this.process.pid)return!1;try{return process.kill(this.process.pid,0),!0}catch{return!1}}logHealth(){let e=this.getHealth();m.debug("Process Health:",e)}getStatusString(){let e=this.getHealth();if(!e.isRunning)return"Not running";let t=[`PID: ${e.pid}`];if(e.uptimeSeconds!==null){let r=Math.floor(e.uptimeSeconds/60),s=Math.floor(e.uptimeSeconds%60);t.push(`Uptime: ${r}m ${s}s`)}return e.memoryUsageMB!==null&&t.push(`Memory: ${e.memoryUsageMB.toFixed(1)} MB`),t.join(", ")}};var zu=require("child_process");var ya=class{process=null;options;stdoutBuffer=[];stderrBuffer=[];maxBufferLines;constructor(e={}){this.options=e,this.maxBufferLines=e.maxBufferLines||1e3}start(e,t){if(this.process)throw new Error("Process already running");m.debug(`Starting process: ${e} ${t.join(" ")}`);let r={...this.options,detached:!1,stdio:"pipe"};return this.process=(0,zu.spawn)(e,t,r),this.setupListeners(),this.process}async stop(e="SIGTERM",t=2e3){if(this.process)return new Promise(r=>{if(!this.process){r();return}let s=this.process.pid;m.debug(`Stopping process ${s} with ${e}`);let i=setTimeout(()=>{if(this.process){m.warn(`Process ${s} did not exit in ${t}ms, force killing`);try{this.process.kill("SIGKILL")}catch(a){m.debug("Error force killing:",a)}}r()},t);this.process.once("exit",()=>{clearTimeout(i),m.debug(`Process ${s} exited`),r()});try{this.process.kill(e)}catch(a){m.debug("Error sending signal:",a),clearTimeout(i),r()}})}getProcess(){return this.process}isRunning(){return this.process!==null&&this.process.exitCode===null}getStdout(){return[...this.stdoutBuffer]}getStderr(){return[...this.stderrBuffer]}clearBuffers(){this.stdoutBuffer=[],this.stderrBuffer=[]}setupListeners(){this.process&&(this.process.stdout?.on("data",e=>{let t=e.toString();this.addToBuffer(this.stdoutBuffer,t),this.options.onStdout?.(t)}),this.process.stderr?.on("data",e=>{let t=e.toString();this.addToBuffer(this.stderrBuffer,t),this.options.onStderr?.(t)}),this.process.on("close",(e,t)=>{m.debug(`Process closed with code ${e} and signal ${t}`),this.process=null,this.options.onClose?.(e,t)}),this.process.on("error",e=>{m.error("Process error:",e),this.options.onError?.(e)}))}addToBuffer(e,t){let r=t.split(`
`);for(let s of r)s.trim()&&e.push(s);e.length>this.maxBufferLines&&e.splice(0,e.length-this.maxBufferLines)}};var F={IDLE_TIMEOUT:9e5,MAX_BUFFER_SIZE:1e3,GRACEFUL_SHUTDOWN_TIMEOUT:2e3,DEFAULT_CTX_SIZE:"2048",DEFAULT_PORT:8080,SIZE_THRESHOLD:{SMALL:5e3,MEDIUM:1e4,LARGE:2e4,HUGE:4e4},GPU_LAYERS:{SMALL:99,MEDIUM:75,LARGE:60,VERY_LARGE:40,HUGE:25},SPEED:{SMALL:50,MEDIUM:30,LARGE:20,HUGE:10},TIMEOUT:{BASE_OVERHEAD:5e3,MIN:{SMALL:15e3,MEDIUM:3e4,LARGE:45e3,HUGE:9e4},LOADING:{SMALL:12e4,MEDIUM:18e4,LARGE:24e4,HUGE:3e5}},TASK_MULTIPLIER:{EXPANSION:1.5,COMPLETION:1.2,CLASSIFICATION:1},MAX_RETRIES:2,RETRY_DELAY:1e3,HEALTH_CHECK_INTERVAL:3e4,MEMORY_HEADROOM_MB:4096},Uc={DEFAULT_MUTATION_COUNT:8,DEFAULT_EXPANSION_DETAIL:"detailed",DEFAULT_N_PREDICT:{CLASSIFICATION:128,COMPLETION:256,EXPANSION:3e3,MUTATION:4e3,REORGANIZATION:4e3}};var or={_string:'string ::= "\\"" ([^"\\\\] | "\\\\" (["\\\\/bfnrt] | "u" [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F]))* "\\""',_number:'number ::= ("-"? ([0-9] | [1-9] [0-9]*)) ("." [0-9]+)? ([eE] [-+]? [0-9]+)?',_boolean:'boolean ::= "true" | "false"',_null:'null ::= "null"',_array:'array ::= "[" (value ("," value)*)? "]"',_ws:"ws ::= [ \\t\\n]*",classification:`root ::= object
object ::= "{" ws "\\"category\\"" ws ":" ws string ws "," ws "\\"tags\\"" ws ":" ws string_list ws "}"
string ::= "\\"" ([^"\\\\] | "\\\\" (["\\\\/bfnrt] | "u" [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F]))* "\\""
string_list ::= "[" ws (string (ws "," ws string)*)? ws "]"
ws ::= [ \\t\\n]*`,mutations:`root ::= mutation_list
mutation_list ::= "[" ws (mutation (ws "," ws mutation)*)? ws "]"
mutation ::= "{" ws "\\"title\\"" ws ":" ws string ws "," ws "\\"description\\"" ws ":" ws string ws "," ws "\\"differences\\"" ws ":" ws string_list ws "}"
string ::= "\\"" ([^"\\\\] | "\\\\" (["\\\\/bfnrt] | "u" [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F]))* "\\""
string_list ::= "[" ws (string (ws "," ws string)*)? ws "]"
ws ::= [ \\t\\n]*`,clusterAnalysis:`root ::= object
object ::= "{" ws "\\"commonThemes\\"" ws ":" ws string_list ws "," ws "\\"commonPatterns\\"" ws ":" ws string_list ws "," ws "\\"relationshipExplanation\\"" ws ":" ws string ws "," ws "\\"synergies\\"" ws ":" ws string_list ws "," ws "\\"relevance\\"" ws ":" ws number ws ("," ws "\\"relationshipToOtherCluster\\"" ws ":" ws string)? ws "}"
string ::= "\\"" ([^"\\\\] | "\\\\" (["\\\\/bfnrt] | "u" [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F]))* "\\""
string_list ::= "[" ws (string (ws "," ws string)*)? ws "]"
number ::= ("-"? ([0-9] | [1-9] [0-9]*)) ("." [0-9]+)? ([eE] [-+]? [0-9]+)?
ws ::= [ \\t\\n]*`};var Fe=class n{static instance=null;static instanceLock=!1;settings;processManager=null;isServerReady=!1;idleTimeout=F.IDLE_TIMEOUT;idleTimer=null;lastUseTime=0;loadingState="not-loaded";modelManager;pluginDir=null;processHealthMonitor;isCleaningUp=!1;healthCheckTimer=null;constructor(e,t){this.settings=e,this.modelManager=new be(e.localModel||"phi-3.5-mini"),this.pluginDir=t||null,this.processHealthMonitor=new ga,e.keepModelLoaded&&(this.idleTimeout=0)}calculateGPULayers(){let e=this.settings.localModel||"phi-3.5-mini",t=ve[e];if(!t)return 35;let r=t.sizeMB;return r>=F.SIZE_THRESHOLD.HUGE?F.GPU_LAYERS.HUGE:r>=F.SIZE_THRESHOLD.LARGE?F.GPU_LAYERS.VERY_LARGE:r>=F.SIZE_THRESHOLD.MEDIUM?F.GPU_LAYERS.LARGE:r>=F.SIZE_THRESHOLD.SMALL?F.GPU_LAYERS.MEDIUM:F.GPU_LAYERS.SMALL}getRecommendedTimeout(e="completion",t=256){let r=this.settings.localModel||"phi-3.5-mini",s=ve[r];if(!s)return this.settings.llmTimeout;let i;s.sizeMB<F.SIZE_THRESHOLD.SMALL?i=F.SPEED.SMALL:s.sizeMB<F.SIZE_THRESHOLD.MEDIUM?i=F.SPEED.MEDIUM:s.sizeMB<F.SIZE_THRESHOLD.LARGE?i=F.SPEED.LARGE:i=F.SPEED.HUGE;let a=t/i*1e3,o=F.TIMEOUT.BASE_OVERHEAD,l=Math.round(a+o),c;s.sizeMB<F.SIZE_THRESHOLD.SMALL?c=F.TIMEOUT.MIN.SMALL:s.sizeMB<F.SIZE_THRESHOLD.MEDIUM?c=F.TIMEOUT.MIN.MEDIUM:s.sizeMB<F.SIZE_THRESHOLD.LARGE?c=F.TIMEOUT.MIN.LARGE:c=F.TIMEOUT.MIN.HUGE;let d=e==="expansion"?F.TASK_MULTIPLIER.EXPANSION:e==="completion"?F.TASK_MULTIPLIER.COMPLETION:F.TASK_MULTIPLIER.CLASSIFICATION,u=Math.round(Math.max(l,c)*d);return Math.max(this.settings.llmTimeout,u)}getModelLoadingTimeout(){let e=this.settings.localModel||"phi-3.5-mini",t=ve[e];if(!t)return F.TIMEOUT.LOADING.SMALL;let r=t.sizeMB;return r>=F.SIZE_THRESHOLD.HUGE?F.TIMEOUT.LOADING.HUGE:r>=F.SIZE_THRESHOLD.LARGE?F.TIMEOUT.LOADING.LARGE:r>=F.SIZE_THRESHOLD.MEDIUM?F.TIMEOUT.LOADING.MEDIUM:F.TIMEOUT.LOADING.SMALL}static getInstance(e,t){if(!n.instance){if(n.instanceLock)throw new Error("LlamaService instance is being created");n.instanceLock=!0,n.instance=new n(e,t),n.instanceLock=!1,m.debug("LlamaService singleton instance created")}return n.instance}updateSettings(e){let t=this.settings.localModel,r=e.localModel;this.settings=e,this.modelManager=new be(e.localModel||"phi-3.5-mini"),e.keepModelLoaded?this.idleTimeout=0:this.idleTimeout=F.IDLE_TIMEOUT,t!==r&&this.processManager?.isRunning()&&(m.debug(`Model changed from ${t} to ${r}, stopping old server`),this.stopServer())}static destroyInstance(){n.instance&&(m.debug("Destroying LlamaService singleton instance"),n.instance.cleanup(),n.instance=null)}getEffectiveBinaryPath(){if(this.settings.llamaBinaryPath)return this.settings.llamaBinaryPath;if(this.pluginDir){let t=`${es()}-${fa()}`,r=es()==="win32"?"llama-server.exe":"llama-server",s=ee(this.pluginDir,"binaries",t,r);try{if(te.existsSync(s))try{return te.accessSync(s,te.constants.X_OK),m.debug("Using bundled binary:",s),s}catch{try{return te.chmodSync(s,493),m.debug("Using bundled binary (made executable):",s),s}catch(i){return m.warn("Bundled binary exists but cannot be made executable:",s,i),s}}else m.warn("Bundled binary not found at:",s),m.warn("Expected platform:",t,"binary:",r)}catch(i){console.error(`[LlamaService] Error checking bundled binary: ${i}`)}}let e=["llama-server","server"];for(let t of e)try{let r=(0,Vu.execSync)(`which ${t}`,{encoding:"utf8",stdio:"pipe"}).trim();if(r&&te.existsSync(r))try{return te.accessSync(r,te.constants.X_OK),m.warn("Using fallback binary from PATH:",r,"(bundled binary not found)"),r}catch{}}catch{}return null}async getEffectiveModelPath(){let e=this.settings.localModel||"phi-3.5-mini";this.modelManager=new be(e);let t=this.modelManager.getModelConfig();if(m.debug("Looking for model:",t.name,`(key: ${e})`),m.debug("Expected filename:",t.fileName),this.settings.modelPath)if(te.existsSync(this.settings.modelPath)){if(this.settings.modelPath.endsWith(".gguf"))return m.debug("Using user-configured model path:",this.settings.modelPath),this.settings.modelPath;m.warn("Configured model path doesn't end with .gguf:",this.settings.modelPath)}else m.warn("Configured model path does not exist:",this.settings.modelPath);let r=this.modelManager.getModelPath();try{if(te.existsSync(r)&&r.endsWith(".gguf"))return m.debug("Using configured model at default location:",r),m.debug("Model:",t.name,`(${t.sizeMB}MB)`),r;{m.debug(`Exact filename not found: ${t.fileName}`),m.debug("Searching for similar model files...");let s=r.lastIndexOf("/"),i=s>=0?r.substring(0,s):".";if(te.existsSync(i)){let o=te.readdirSync(i).filter(d=>d.endsWith(".gguf"));m.debug(`Found ${o.length} GGUF files in directory:`,o);let l=t.name.toLowerCase(),c=e.split("-");for(let d of o){let u=d.toLowerCase(),h=l.split(" ").some(f=>f.length>2&&u.includes(f)),p=c.some(f=>f.length>2&&u.includes(f));if(h||p){let f=ee(i,d);return m.debug(`Found matching model file: ${d}`),m.debug("Using:",f),m.warn(`Using model file "${d}" instead of expected "${t.fileName}"`),m.warn("This may work, but the model might not match exactly. Consider renaming the file or downloading the correct model."),f}}m.warn(`Configured model "${t.name}" not found at: ${r}`),m.warn(`Expected filename: ${t.fileName}`),m.warn(`Available GGUF files in directory: ${o.join(", ")}`),m.warn("Please ensure the model filename matches, or download the model from Settings \u2192 AI Configuration \u2192 Local AI Model")}else m.warn(`Model directory does not exist: ${i}`)}}catch(s){m.error("Error checking model path:",s)}return null}async isServerAlive(){try{return(await(0,Ie.requestUrl)({url:`${this.settings.llamaServerUrl}/health`,method:"GET",throw:!1})).status===200}catch{return!1}}async killExistingServer(){this.processManager?.isRunning()&&(m.debug("Killing existing server before starting new one"),await this.processManager.stop("SIGTERM",2e3),this.processManager=null,this.isServerReady=!1,this.loadingState="not-loaded")}async startServer(){if(this.isCleaningUp)throw m.debug("Cannot start server - cleanup in progress"),new Error("Cannot start server during plugin cleanup");if(await this.killExistingServer(),await this.isServerAlive()){m.debug("Server already alive on port, reusing existing server"),this.isServerReady=!0,this.loadingState="ready";return}let t=this.getEffectiveBinaryPath(),r=await this.getEffectiveModelPath();if(!t)throw new Error("Llama binary path not configured. Please set it in settings or ensure bundled binary is available.");if(!r)throw new Error("Model path not configured. Please set it in settings or download a model.");if(!te.existsSync(t))throw new Error(`Llama binary not found at: ${t}. Please check the path in settings.`);if(!te.existsSync(r))throw new Error(`Model file not found at: ${r}. Please check the path in settings or download the model.`);if(es()!=="win32")try{te.accessSync(t,te.constants.X_OK)}catch{throw new Error(`Llama binary is not executable: ${t}. Please check file permissions.`)}this.loadingState="loading",m.debug("Starting Llama server..."),m.debug("Binary:",t),m.debug("Model:",r),m.debug("Port:",this.settings.llamaServerPort);let s=this.calculateGPULayers();if(m.debug("Calculated GPU layers:",s),this.loadingState==="loading"){let a=this.modelManager.getModelConfig().sizeMB/1024,o=a>=40?"2-5 minutes":a>=20?"1-3 minutes":"~30 seconds";new Ie.Notice(`Loading AI model... (${o})`)}try{this.processManager=new ya({maxBufferLines:F.MAX_BUFFER_SIZE,onStdout:o=>this.handleStdout(o),onStderr:o=>this.handleStderr(o),onClose:(o,l)=>this.handleClose(o,l,t,r),onError:o=>this.handleError(o,t,r)});let i=["-m",r,"--port",String(this.settings.llamaServerPort),"--ctx-size",F.DEFAULT_CTX_SIZE,"--n-gpu-layers",String(s),"--parallel",String(this.settings.concurrency)];m.debug("Starting server process with args:",i);let a=this.processManager.start(t,i);if(this.processHealthMonitor.setProcess(a),await new Promise(o=>setTimeout(o,2e3)),!a||a.exitCode!==null)throw this.loadingState="not-loaded",new Error("Server process exited immediately");this.startHealthCheck()}catch(i){m.error("[LlamaService] Failed to start Llama server:",i),this.loadingState="not-loaded",this.processManager=null;let a=i instanceof Error?i.message:String(i);throw a.includes("insufficient RAM")||a.includes("requires more RAM")||a.includes("failed to load model")?new Ie.Notice("Model too large for system RAM. Consider switching to a smaller model in Settings.",1e4):new Ie.Notice("Failed to start Llama AI Server"),i}}handleStdout(e){this.isCleaningUp||(m.debug("[Llama Server stdout]",e.trim()),(e.includes("HTTP server listening")||e.includes("server is listening")||e.includes("listening on http"))&&(this.loadingState="loading",m.debug("Server HTTP endpoint is listening (model may still be loading)")),(e.includes("main: model loaded")||e.includes("model loaded"))&&(this.isServerReady=!0,this.loadingState="ready",m.debug("Server is ready! (Model fully loaded)"),new Ie.Notice("Llama AI Server Started")))}handleStderr(e){if(this.isCleaningUp)return;let t=e.split(`
`).filter(s=>s.trim()),r=t.some(s=>(s.toLowerCase().includes("error")||s.toLowerCase().includes("failed")||s.toLowerCase().includes("fatal"))&&!s.toLowerCase().includes("ggml_metal")&&!s.toLowerCase().includes("system info")&&!s.toLowerCase().includes("llama_model_loader")&&!s.toLowerCase().includes("print_info")&&!s.toLowerCase().includes("load:")&&!s.toLowerCase().includes("llama_context")&&!s.toLowerCase().includes("main:"));for(let s of t)r&&(s.toLowerCase().includes("error")||s.toLowerCase().includes("failed")||s.toLowerCase().includes("fatal"))?m.error("[Llama Server stderr]",s.trim()):m.debug("[Llama Server stderr]",s.trim());(e.includes("HTTP server is listening")||e.includes("server is listening on http")||e.includes("main: server is listening"))&&(this.loadingState="loading",m.debug("Server HTTP endpoint is listening (model may still be loading)")),(e.includes("main: model loaded")||e.includes("model loaded"))&&(this.isServerReady=!0,this.loadingState="ready",m.debug("Server is ready! (Model fully loaded)"),new Ie.Notice("Llama AI Server Started"))}handleClose(e,t,r,s){if(this.isCleaningUp){m.debug("Server process closed during cleanup (expected)");return}m.debug("Server process closed event fired",{code:e,signal:t});let i=this.processManager?.getStderr().join(`
`)||"",a=this.processManager?.getStdout().join(`
`)||"";m.error("[LlamaService] Server process exited",{exitCode:e,signal:t,wasKilled:e===null,stderrLength:i.length,stdoutLength:a.length,binaryPath:r,modelPath:s}),(e===null||e!==0&&e!==null)&&i.length>0&&(m.error("[LlamaService] Full stderr output from crashed server:"),m.error(i)),this.processManager=null,this.isServerReady=!1,this.loadingState="not-loaded",this.lastUseTime=0,e!==0&&e!==null?m.error(`[LlamaService] Server exited with error code ${e}`):e===null&&m.error("[LlamaService] Server process was killed (SIGKILL or similar)")}handleError(e,t,r){m.error("[LlamaService] Failed to spawn server process:",e),m.error("[LlamaService] Spawn error details:",{binaryPath:t,modelPath:r,errorName:e.name,errorMessage:e.message}),this.processManager=null,this.loadingState="not-loaded",new Ie.Notice("Failed to start Llama AI Server - check binary path")}stopServer(){if(this.processManager?.getProcess()){let e=this.loadingState==="loading";m.debug("Stopping Llama server...",e?"(model was loading)":""),this.clearIdleTimer(),this.stopHealthCheck(),this.processManager.stop().then(()=>{this.processManager=null,this.processHealthMonitor.setProcess(null),this.isServerReady=!1,this.loadingState="not-loaded",m.debug("Llama server stopped")})}}cleanup(){m.debug("LlamaService cleanup started"),this.isCleaningUp=!0,this.clearIdleTimer(),this.stopHealthCheck(),this.processManager&&this.processManager.stop("SIGKILL",1e3).then(()=>{this.processManager=null,this.processHealthMonitor.setProcess(null)}),this.isServerReady=!1,this.loadingState="not-loaded",m.debug("LlamaService cleanup completed")}getProcessHealth(){return this.processHealthMonitor.getHealth()}unloadModel(){this.processManager?.isRunning()&&!this.settings.keepModelLoaded&&(m.debug("Unloading model due to idle timeout"),this.stopServer())}resetIdleTimer(){this.settings.keepModelLoaded||(this.idleTimer&&clearTimeout(this.idleTimer),this.lastUseTime=Date.now(),this.loadingState="ready",this.idleTimer=setTimeout(()=>{this.unloadModel()},this.idleTimeout))}clearIdleTimer(){this.idleTimer&&(clearTimeout(this.idleTimer),this.idleTimer=null)}async classify(e){if(!this.isAvailable())throw new Error("Llama provider is not enabled");if(!await this.ensureReady()){let a=this.getEffectiveBinaryPath(),o=await this.getEffectiveModelPath(),l="Llama binary or model path not found. ";throw!a&&!o?l+="Please configure paths in settings or install llama-server and download the model.":a?l+="Please configure model path in settings or download the model.":(l+=`Please configure llama binary path in settings or install llama-server.
`,l+=`Installation options:
`,l+=`  \u2022 Homebrew: brew install llama.cpp
`,l+=`  \u2022 Build from source: https://github.com/ggerganov/llama.cpp
`,l+="  \u2022 Or use Ollama via the Custom provider option in settings"),new Error(l)}this.resetIdleTimer();let r=this.constructPrompt(e),s=F.MAX_RETRIES,i=null;for(let a=0;a<=s;a++)try{if(a>0){if(!(this.processManager?.isRunning()??!1))m.warn("Server process not running, attempting restart..."),this.isServerReady=!1,await this.ensureReady(),await new Promise(h=>setTimeout(h,1e3));else if(!this.isServerReady){m.warn("Server process exists but not ready, waiting...");let h=0;for(;!this.isServerReady&&h<20;)await new Promise(p=>setTimeout(p,100)),h++}}let o=this.getRecommendedTimeout("classification",128),l=new Promise((u,h)=>{setTimeout(()=>h(new lt(`API request timed out after ${o}ms`)),o)}),c;try{c=await Promise.race([(0,Ie.requestUrl)({url:`${this.settings.llamaServerUrl}/completion`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:r,n_predict:128,temperature:.1,stop:["}"],grammar:or.classification})}),l])}catch(u){if(u instanceof lt)throw u;let h=u instanceof Error?u.message:String(u);throw h.includes("ECONNREFUSED")||h.includes("network")||h.includes("connection")?new Ee(`Connection failed: ${h}`):new Ee(`Request failed: ${h}`)}if(c.status<200||c.status>=300){if(c.status===503){if(this.processManager?.isRunning()??!1){if(m.warn(`Server returned 503 (attempt ${a+1}/${s+1})`),a<s){await new Promise(S=>setTimeout(S,1e3));continue}}else if(m.warn("Server returned 503 and process is not running, will restart and retry"),this.isServerReady=!1,a<s){await new Promise(S=>setTimeout(S,500));continue}let h=this.modelManager.getModelConfig(),p=ar(this.settings.localModel||"phi-3.5-mini"),f=ct(),y=`Model failed to load (503 Service Unavailable after ${s+1} attempts).

`;throw y+=`Model: ${h.name} (requires ${h.ram} RAM)
`,y+=`${f}

`,p.isCompatible?y+="Your system may not have enough free RAM to load this model. ":y+="This model requires more RAM than your system has. ",y+='Consider switching to a smaller model like "Phi-3.5 Mini" (requires 6-8GB RAM) in Settings \u2192 AI Configuration \u2192 Local AI Model.',new Ee(y)}throw new Ee(`Llama.cpp server error: ${c.status}`)}let d=typeof c.json=="function"?await c.json():c.json;if(!d||typeof d!="object")throw new $e("Invalid response format from server");return this.parseResponse(d.content)}catch(o){if(o instanceof Error){if(o instanceof lt||o.message.includes("timed out"))throw o;if(o instanceof Ee){if(i=o,a<s&&o.message.includes("503")){m.warn(`Network error on attempt ${a+1}, will retry...`);continue}throw o}if(i=o,a<s&&(o.message.includes("ECONNREFUSED")||o.message.includes("network")||o.message.includes("connection")||o.message.includes("failed to fetch"))){m.warn(`Connection error on attempt ${a+1}, will retry...`),await new Promise(l=>setTimeout(l,1e3));continue}throw new $e("Failed to classify idea",o)}i=new Error("Unknown error occurred")}throw i||new $e("Failed to classify idea after retries")}isAvailable(){return this.settings.llmProvider==="llama"}getLoadingState(){return this.loadingState}getIsServerReady(){return this.isServerReady}hasServerProcess(){return this.processManager?.isRunning()??!1}async ensureReady(){if(!this.isAvailable())return!1;let e=this.getEffectiveBinaryPath(),t=await this.getEffectiveModelPath();if(!e||!t)return!e&&!t?m.debug("Binary and model paths not found (checked defaults)"):e?m.debug("Model path not found (checked default location)"):(m.debug("Binary path not found (checked common locations)"),m.debug("To install llama-server on macOS:"),m.debug("  1. Install via Homebrew: brew install llama.cpp"),m.debug("  2. Or build from source: https://github.com/ggerganov/llama.cpp"),m.debug("  3. Or configure the binary path manually in settings"),m.debug("  4. Alternatively, use Ollama via the Custom provider option")),!1;if(this.processManager?.isRunning()&&this.isServerReady)return!0;if(this.processManager?.isRunning()&&!this.isServerReady){m.debug("Server process exists but not ready, waiting for model to load...");let s=this.getModelLoadingTimeout()/100,i=0;for(;!this.isServerReady&&i<s;)await new Promise(a=>setTimeout(a,100)),i++,i%100===0&&m.debug(`Still waiting for model to load... (${i/10}s)`);if(this.isServerReady)return!0;m.warn("Server process exists but never became ready, restarting..."),this.stopServer()}if(!this.processManager?.isRunning()){m.debug("Ensuring server is ready..."),await this.startServer();let r=this.getModelLoadingTimeout(),s=r/100,i=0;for(;!this.isServerReady&&i<s;)await new Promise(a=>setTimeout(a,100)),i++,i%100===0&&m.debug(`Waiting for model to load... (${i/10}s)`);if(!this.isServerReady){let a=Math.round(r/6e4);throw new Error(`Server started but model did not load in time (${a} minutes). The model may be too large for your system, or there may be insufficient memory.`)}}return!0}async complete(e,t){if(!this.isAvailable())throw new Error("Llama provider is not enabled");if(!await this.ensureReady()){let a=this.getEffectiveBinaryPath(),o=await this.getEffectiveModelPath(),l="Llama binary or model path not found. ";throw!a&&!o?l+="Please configure paths in settings or install llama-server and download the model.":a?l+="Please configure model path in settings or download the model.":(l+=`Please configure llama binary path in settings or install llama-server.
`,l+=`Installation options:
`,l+=`  \u2022 Homebrew: brew install llama.cpp
`,l+=`  \u2022 Build from source: https://github.com/ggerganov/llama.cpp
`,l+="  \u2022 Or use Ollama via the Custom provider option in settings"),new Error(l)}this.resetIdleTimer();let s=F.MAX_RETRIES,i=null;for(let a=0;a<=s;a++)try{if(a>0){if(!(this.processManager?.isRunning()??!1))m.warn("Server process not running, attempting restart..."),this.isServerReady=!1,await this.ensureReady(),await new Promise(f=>setTimeout(f,1e3));else if(!this.isServerReady){m.warn("Server process exists but not ready, waiting...");let f=0;for(;!this.isServerReady&&f<20;)await new Promise(y=>setTimeout(y,100)),f++}}let o=t?.n_predict||256,l=o>1e3,c=this.getRecommendedTimeout(l?"expansion":"completion",o),d=new Promise((p,f)=>{setTimeout(()=>f(new lt(`API request timed out after ${c}ms`)),c)}),u;try{u=await Promise.race([(0,Ie.requestUrl)({url:`${this.settings.llamaServerUrl}/completion`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,n_predict:t?.n_predict||256,temperature:t?.temperature??.7,stop:t?.stop||["}"],grammar:t?.grammar})}),d])}catch(p){if(p instanceof lt)throw p;let f=p instanceof Error?p.message:String(p);throw f.includes("ECONNREFUSED")||f.includes("network")||f.includes("connection")?new Ee(`Connection failed: ${f}`):new Ee(`Request failed: ${f}`)}if(u.status<200||u.status>=300){if(u.status===503){if(this.processManager?.isRunning()??!1){if(m.warn(`Server returned 503 (attempt ${a+1}/${s+1})`),a<s){await new Promise(g=>setTimeout(g,1e3));continue}}else if(m.warn("Server returned 503 and process is not running, will restart and retry"),this.isServerReady=!1,a<s){await new Promise(g=>setTimeout(g,500));continue}let f=this.modelManager.getModelConfig(),y=ar(this.settings.localModel||"phi-3.5-mini"),S=ct(),x=`Model failed to load (503 Service Unavailable after ${s+1} attempts).

`;throw x+=`Model: ${f.name} (requires ${f.ram} RAM)
`,x+=`${S}

`,y.isCompatible?x+="Your system may not have enough free RAM to load this model. ":x+="This model requires more RAM than your system has. ",x+='Consider switching to a smaller model like "Phi-3.5 Mini" (requires 6-8GB RAM) in Settings \u2192 AI Configuration \u2192 Local AI Model.',new Ee(x)}throw new Ee(`Llama.cpp server error: ${u.status}`)}let h=typeof u.json=="function"?await u.json():u.json;if(!h||typeof h!="object")throw new $e("Invalid response format from server");return h.content||""}catch(o){if(o instanceof Error){if(o instanceof lt||o.message.includes("timed out"))throw o;if(o instanceof Ee){if(i=o,a<s&&o.message.includes("503")){m.warn(`Network error on attempt ${a+1}, will retry...`);continue}throw o}if(i=o,a<s&&(o.message.includes("ECONNREFUSED")||o.message.includes("network")||o.message.includes("connection")||o.message.includes("failed to fetch"))){m.warn(`Connection error on attempt ${a+1}, will retry...`),await new Promise(l=>setTimeout(l,1e3));continue}throw new $e("Failed to complete request",o)}i=new Error("Unknown error occurred")}throw i||new $e("Failed to complete request after retries")}constructPrompt(e){return`Classify ideas into ONE category and generate 3-5 relevant tags.

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Format: JSON only, no markdown

Examples:

Input: "A game about baristas stuck in a time loop where you optimize workflow"
Output: {"category": "game", "tags": ["time-loop", "service-industry", "roguelike", "optimization"]}

Input: "SaaS tool for managing restaurant inventory with AI predictions"
Output: {"category": "saas", "tags": ["restaurant", "inventory", "ai", "b2b", "operations"]}

Input: "Story about a sentient spaceship that falls in love with an asteroid"
Output: {"category": "story", "tags": ["sci-fi", "romance", "ai", "space"]}

Input: "Hardware device that translates dog barks into English"
Output: {"category": "hardware", "tags": ["pets", "translation", "iot", "consumer"]}

Input: "${e}"
Output: {`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:.8}}catch(t){return m.warn("Failed to parse Llama response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}calculateMemoryLimit(){return this.modelManager.getModelConfig().sizeMB+F.MEMORY_HEADROOM_MB}startHealthCheck(){this.healthCheckTimer||(this.healthCheckTimer=setInterval(()=>{let e=this.processHealthMonitor.getHealth();if(e.memoryUsageMB){let t=this.calculateMemoryLimit();e.memoryUsageMB>t&&(m.warn(`Llama server memory usage (${e.memoryUsageMB.toFixed(0)}MB) exceeded limit (${t.toFixed(0)}MB). Restarting...`),new Ie.Notice("Restarting AI Server (Memory Limit Exceeded)"),this.restartServer())}},F.HEALTH_CHECK_INTERVAL))}stopHealthCheck(){this.healthCheckTimer&&(clearInterval(this.healthCheckTimer),this.healthCheckTimer=null)}async restartServer(){m.info("Restarting server..."),this.stopServer(),await new Promise(e=>setTimeout(e,2e3));try{await this.startServer()}catch(e){m.error("Failed to restart server:",e),new Ie.Notice("Failed to auto-restart AI Server")}}};var lr={mutations:n=>{let e=n.count||Uc.DEFAULT_MUTATION_COUNT,t=n.category||"general",r=n.tags&&n.tags.length>0?n.tags.join(", "):"none",s=n.focus?`

Focus: ${n.focus}`:"";return`Generate ${e} distinct variations of this idea.

Original Idea:
${n.ideaText}

Category: ${t}
Tags: ${r}${s}

Requirements:
- Each variation must be meaningfully different (audience, problem, business model, tech, scope).
- Variations should be interesting and viable.
- Avoid minor tweaks.

Output JSON array of objects with:
- title: Brief name (2-5 words)
- description: Clear explanation of difference (1-2 sentences)
- differences: 2-3 specific differences

Format: JSON array ONLY. No markdown.
[
  {
    "title": "Variation Name",
    "description": "Description...",
    "differences": ["Diff 1", "Diff 2"]
  }
]`},expansion:n=>{let e=n.category||"general",t=n.tags&&n.tags.length>0?n.tags.join(", "):"none",r=n.detailLevel||Uc.DEFAULT_EXPANSION_DETAIL;return`Expand this idea into a comprehensive description.

Original Idea:
${n.ideaText}

Category: ${e}
Tags: ${t}

Requirements:
- Preserve core concept.
- Add meaningful detail.
- Use markdown headers.
- Detail level: ${r}

Structure:
## Overview
Summary (2-4 sentences).

## Key Features / Mechanics
Main components.

## Goals / Objectives
Primary goals and success criteria.

## Potential Challenges
Technical, market, or resource challenges.

## Next Steps
Actionable initial steps.`},reorganization:n=>{let e=n.category||"general",t=n.tags&&n.tags.length>0?n.tags.join(", "):"none",r=n.targetStructure&&n.targetStructure.length>0?n.targetStructure.join(`
- `):"Logical sections with clear headings",s=n.preserveSections&&n.preserveSections.length>0?n.preserveSections.join(`
- `):"None";return`Reorganize this idea into a clear format.

Original Idea:
${n.ideaText}

Category: ${e}
Tags: ${t}

Requirements:
- Preserve ALL info.
- Organize logically.
- Use markdown.

Target structure:
- ${r}

Preserve exactly:
- ${s}`},clusterAnalysis:n=>{let e=n.clusterIdeas.map((s,i)=>`${i+1}. ${s.title}
   Category: ${s.category||"none"}
   Tags: ${s.tags?.join(", ")||"none"}
   Text: ${s.text.substring(0,200)}...`).join(`

`),t=n.otherClusterIdeas?`

Other Cluster:
${n.otherClusterIdeas.map((s,i)=>`${i+1}. ${s.title} (${s.category||"none"})`).join(`
`)}`:"",r=n.similarity!==void 0?`
Similarity: ${(n.similarity*100).toFixed(1)}%`:"";return`Analyze this cluster of ideas.

Cluster Ideas:
${e}${t}${r}

Analyze:
1. Common Themes
2. Common Patterns
3. Relationship Explanation (Why do they belong together?)
4. Potential Synergies${n.otherClusterIdeas?`
5. Relationship to Other Cluster`:""}

Output JSON ONLY:
{
  "commonThemes": ["Theme 1", "Theme 2"],
  "commonPatterns": ["Pattern 1", "Pattern 2"],
  "relationshipExplanation": "Explanation...",
  "synergies": ["Synergy 1", "Synergy 2"],${n.otherClusterIdeas?`
  "relationshipToOtherCluster": "Relation...",`:""}
  "relevance": 0.0-1.0
}`}};var ts=class{localLLM;cloudLLM;preferCloud;lastProvider=null;constructor(e,t,r){this.localLLM=e,this.cloudLLM=t,this.preferCloud=r}async classify(e){if(this.preferCloud&&this.cloudLLM?.isAvailable())try{let r=await this.cloudLLM.classify(e);return this.lastProvider="cloud",m.debug("Used cloud provider:",this.cloudLLM.name||"cloud"),r}catch(r){m.warn("Cloud provider failed, falling back to local:",r)}let t=await this.localLLM.classify(e);return this.lastProvider="local",m.debug("Used local provider"),t}isAvailable(){return this.localLLM.isAvailable()||(this.cloudLLM?.isAvailable()??!1)}async ensureReady(){if(this.preferCloud&&this.cloudLLM?.isAvailable()&&this.cloudLLM.ensureReady)try{if(await this.cloudLLM.ensureReady())return!0}catch(e){m.warn("Cloud provider ensureReady failed, falling back to local:",e)}return this.localLLM.isAvailable()&&this.localLLM.ensureReady?await this.localLLM.ensureReady():!1}getLastProvider(){return this.lastProvider}getLocalLLM(){return this.localLLM}getCloudLLM(){return this.cloudLLM}setCloudLLM(e){this.cloudLLM=e,this.lastProvider=null}setPreferCloud(e){this.preferCloud=e}async complete(e,t){if(this.preferCloud&&this.cloudLLM?.isAvailable()&&this.cloudLLM.complete)try{let r=await this.cloudLLM.complete(e,t);return this.lastProvider="cloud",r}catch(r){m.warn("Cloud provider failed, falling back to local:",r)}if(this.localLLM.complete){let r=await this.localLLM.complete(e,t);return this.lastProvider="local",r}throw new Error("No LLM service available with complete() method")}shouldUseLocalLLM(){return!(this.preferCloud&&this.cloudLLM?.isAvailable())}async generateMutations(e,t){let r=lr.mutations({ideaText:e,category:t?.category,tags:t?.tags,count:t?.count,focus:t?.focus}),s=this.shouldUseLocalLLM(),i={temperature:.8,n_predict:4e3,stop:[`
]`,"]"]};s&&(i.grammar=or.mutations);let a=await this.complete(r,i);if(!a||a.trim().length===0)throw new Error("LLM returned an empty response. The model may have stopped generating or encountered an error. Please try again.");try{let o=z(a,!0),l=JSON.parse(o);if(!Array.isArray(l))throw new Error("Response is not an array");let c=l.filter(d=>typeof d=="object"&&d!==null&&("text"in d||"title"in d||"description"in d)).map(d=>({title:d.title||d.text||"",description:d.description||"",differences:Array.isArray(d.differences)?d.differences:[]}));if(c.length>0)return c;throw new Error("No valid mutations found in response")}catch(o){throw m.warn("JSON parsing failed:",o),m.debug("Raw response:",a),new Error("Failed to parse mutations from AI response. Please try again.")}}async expandIdea(e,t){let r=lr.expansion({ideaText:e,category:t?.category,tags:t?.tags,detailLevel:t?.detailLevel}),s=await this.complete(r,{temperature:.7,n_predict:3e3}),i=this.parseExpansionStructure(s);return{expandedText:s,structure:i}}async reorganizeIdea(e,t){let r=lr.reorganization({ideaText:e,category:t?.category,tags:t?.tags,preserveSections:t?.preserveSections,targetStructure:t?.targetStructure}),s=await this.complete(r,{temperature:.5,n_predict:4e3}),i=this.analyzeReorganizationChanges(e,s);return{reorganizedText:s,changes:i,originalLength:e.length,reorganizedLength:s.length}}parseExpansionStructure(e){let t={},r=e.match(/## Overview\s*\n([\s\S]*?)(?=\n## |$)/);r&&(t.overview=r[1].trim());let s=e.match(/## (?:Key Features|Mechanics)\s*\n([\s\S]*?)(?=\n## |$)/);s&&(t.features=s[1].trim());let i=e.match(/## (?:Goals|Objectives)\s*\n([\s\S]*?)(?=\n## |$)/);i&&(t.goals=i[1].trim());let a=e.match(/## (?:Potential )?Challenges\s*\n([\s\S]*?)(?=\n## |$)/);a&&(t.challenges=a[1].trim());let o=e.match(/## Next Steps\s*\n([\s\S]*?)(?=\n## |$)/);return o&&(t.nextSteps=o[1].trim()),t}analyzeReorganizationChanges(e,t){let r=this.extractSections(e),s=this.extractSections(t),i=s.filter(l=>!r.includes(l)),a=r.filter(l=>!s.includes(l)),o=r.filter(l=>s.includes(l)&&s.indexOf(l)!==r.indexOf(l));return{sectionsAdded:i,sectionsRemoved:a,sectionsReorganized:o}}extractSections(e){let t=/^## (.+)$/gm,r=[],s;for(;(s=t.exec(e))!==null;)r.push(s[1].trim());return r}cleanup(){m.debug("HybridLLM cleanup started"),this.cloudLLM&&this.cloudLLM.cleanup?.(),m.debug("HybridLLM cleanup completed")}};var Hc=require("obsidian"),Un="ideatr-icon-purple",jc="ideatr-icon-green",qc="ideatr-icon-yellow",Gc="ideatr-icon-red";function Hn(n){return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <image href="${n}" width="24" height="24"/>
    </svg>`}function Cf(n){switch(n){case"connected":return jc;case"loading":return qc;case"not-connected":case"error":return Gc;default:return Un}}function Wu(n){let e=document.createElement("span");return n&&(e.className=n),(0,Hc.setIcon)(e,Un),e}function Ku(n,e){let t=document.createElement("span");return e&&(t.className=e),(0,Hc.setIcon)(t,Cf(n)),t}function Pf(n,e){if(!n)return{status:"not-connected",modelName:"No AI configured",provider:"none",details:"Please configure AI in settings"};if(!n.isAvailable())return{status:"not-connected",modelName:"AI not available",provider:"none",details:"AI service is not configured or enabled"};if(n instanceof ts){let t=n;if(e.preferCloud&&e.cloudProvider!=="none"&&(e.cloudProvider==="custom"?e.customEndpointUrl&&e.customEndpointUrl.trim().length>0:e.cloudProvider==="custom-model"?e.customModelProvider&&e.cloudApiKeys&&e.customModelProvider in e.cloudApiKeys&&(e.cloudApiKeys[e.customModelProvider]||"").trim().length>0:e.cloudApiKeys&&e.cloudProvider in e.cloudApiKeys&&(e.cloudApiKeys[e.cloudProvider]||"").trim().length>0)){let c=Xu(e);if(c.status==="connected")return c}let s=t.getLocalLLM();if(s instanceof Fe)return Ju(s,e);let i=e.localModel||"phi-3.5-mini",a=ve[i];return{status:"loading",modelName:a?a.name:"Unknown Model",provider:"hybrid",details:"Checking status..."}}return n instanceof Fe?Ju(n,e):Xu(e)}function Ju(n,e){let t=n,r=e.localModel||"phi-3.5-mini",s=ve[r],i=s?s.name:"Unknown Model",a=t.getLoadingState(),o=t.getIsServerReady(),l=t.hasServerProcess(),c,d;return a==="ready"&&o?(c="connected",d="Model loaded and ready"):a==="loading"||l&&!o?(c="loading",d="Loading model..."):a==="not-loaded"&&!l?(c="not-connected",d="Model not loaded"):(c="error",d="Connection issue"),{status:c,modelName:i,provider:"local",details:d}}function Xu(n){if(n.cloudProvider==="none")return{status:"not-connected",modelName:"Cloud AI not configured",provider:"cloud",details:"Please configure cloud AI in settings"};if(!(n.cloudProvider==="custom"?n.customEndpointUrl&&n.customEndpointUrl.trim().length>0:n.cloudProvider==="custom-model"?n.customModelProvider&&n.cloudApiKeys&&n.customModelProvider in n.cloudApiKeys&&(n.cloudApiKeys[n.customModelProvider]||"").trim().length>0:n.cloudApiKeys&&n.cloudProvider in n.cloudApiKeys&&(n.cloudApiKeys[n.cloudProvider]||"").trim().length>0))return{status:"not-connected",modelName:"Cloud AI not configured",provider:"cloud",details:"Please configure cloud AI in settings"};let t=n.cloudProvider;return n.cloudProvider==="openrouter"&&n.openRouterModel?t=`OpenRouter: ${n.openRouterModel}`:n.cloudProvider==="custom"&&n.customEndpointUrl?t=`Custom: ${n.customEndpointUrl}`:n.cloudProvider==="custom-model"&&n.customModelProvider&&n.customModel&&(t=`${n.customModelProvider}: ${n.customModel}`),{status:"connected",modelName:t.charAt(0).toUpperCase()+t.slice(1),provider:"cloud",details:"Cloud AI ready"}}function ba(n,e,t){let r=Pf(n,e),s=document.createElement("div");s.className="ideatr-model-status-indicator";let i=Ku(r.status,`ideatr-model-status-icon ideatr-model-status-${r.status}`);s.appendChild(i);let a=document.createElement("div");return a.className="ideatr-model-status-tooltip",a.textContent=`${r.modelName}${r.details?` - ${r.details}`:""}`,s.appendChild(a),s.setAttribute("title",`${r.modelName}${r.details?` - ${r.details}`:""}`),s}var H=class{ideaRepository;pathToIdCache=null;idToPathCache=null;idToTitleCache=null;constructor(e){this.ideaRepository=e}async buildCache(){if(!(this.pathToIdCache&&this.idToPathCache&&this.idToTitleCache)){this.pathToIdCache=new Map,this.idToPathCache=new Map,this.idToTitleCache=new Map;try{let e=await this.ideaRepository.getAllIdeas();for(let t of e){let r=`Ideas/${t.filename}`;if(t.frontmatter.id&&t.frontmatter.id!==0){this.pathToIdCache.set(r,t.frontmatter.id),this.idToPathCache.set(t.frontmatter.id,r);let s=t.filename.replace(/\.md$/,"");this.idToTitleCache.set(t.frontmatter.id,s)}}}catch(e){m.warn("Failed to build path-to-ID cache:",e)}}}async pathsToIds(e){await this.buildCache();let t=[];for(let r of e){let s=this.pathToIdCache?.get(r);s?t.push(s):m.warn(`Could not find ID for path: ${r}`)}return t}async idsToPaths(e){await this.buildCache();let t=[];for(let r of e){let s=this.idToPathCache?.get(r);s?t.push(s):m.warn(`Could not find path for ID: ${r}`)}return t}async idToTitle(e){return await this.buildCache(),this.idToTitleCache?.get(e)||null}async idsToTitles(e){await this.buildCache();let t=new Map;for(let r of e){let s=this.idToTitleCache?.get(r);s&&t.set(r,s)}return t}clearCache(){this.pathToIdCache=null,this.idToPathCache=null,this.idToTitleCache=null}};function Qu(n){return n.split("+").map(e=>{let t=e.trim().toLowerCase();return t==="cmd"||t==="meta"?"\u2318":t==="ctrl"?"\u2303":t==="alt"?"\u2325":t==="shift"?"\u21E7":t.charAt(0).toUpperCase()+t.slice(1)}).join(" ")}function Yu(n,e){let t=e.toLowerCase().split("+").map(c=>c.trim()),r=n.key.toLowerCase(),s=t.includes("cmd")||t.includes("meta"),i=t.includes("ctrl"),a=t.includes("alt"),o=t.includes("shift");if(s&&!n.metaKey||i&&!n.ctrlKey||a&&!n.altKey||o&&!n.shiftKey||!s&&n.metaKey||!i&&n.ctrlKey||!a&&n.altKey||!o&&n.shiftKey)return!1;let l=t.find(c=>!["cmd","meta","ctrl","alt","shift"].includes(c));if(l){if(l==="enter"&&r!=="enter"||l==="space"&&r!==" "||l==="escape"&&r!=="escape")return!1;if(l!=="enter"&&l!=="space"&&l!=="escape"){let c=r.toLowerCase(),d=l.toLowerCase();if(c!==d)return!1}}else return!1;return!0}var rs=class extends Ve.Modal{inputEl;errorEl;classificationEl;saveButton;ideateButton;fileManager;classificationService;duplicateDetector;webSearchService;searchQueryGenerator;nameVariantService;llmService;settings;ideaRepository;idConverter;onSuccess;isWarningShown=!1;duplicatePaths=[];classificationAbortController=null;isFirstClassification=!0;constructor(e,t,r,s,i,a,o,l,c,d,u){super(e),this.fileManager=t,this.classificationService=r,this.duplicateDetector=s,this.webSearchService=o,this.searchQueryGenerator=new ma,this.nameVariantService=l,this.llmService=c,this.settings=i,this.ideaRepository=d,this.idConverter=new H(this.ideaRepository),this.onSuccess=u}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-capture-modal");let t=e.createDiv({cls:"ideatr-capture-title-container"});t.createEl("h2",{text:"Capture idea"});let r=ba(this.llmService,this.settings,this.app);t.appendChild(r),this.inputEl=e.createEl("textarea",{attr:{placeholder:"Type your idea here...",rows:"6"}}),this.inputEl.addClass("ideatr-input"),this.errorEl=e.createEl("div",{cls:"ideatr-error ideatr-hidden"}),this.classificationEl=e.createEl("div",{cls:"ideatr-classification ideatr-hidden"});let s=e.createEl("div",{cls:"ideatr-button-container"}),a=s.createEl("div",{cls:"ideatr-help-text"}).createEl("p",{attr:{style:"font-size: 0.85em; color: var(--text-muted); margin: 0; display: flex; align-items: center; gap: 0.4em;"}}),o=Wu();o.addClass("ideatr-icon-muted"),a.appendChild(o),a.appendText(' Tip: Access other Ideatr features via Command Palette (search "Ideatr")');let l=s.createEl("div",{cls:"ideatr-button-group"});!this.settings.setupCompleted&&!this.classificationService.isAvailable()&&l.createEl("button",{text:"Classify now",cls:"mod-cta"}).addEventListener("click",()=>this.handleClassifyNow());let c=l.createDiv({cls:"ideatr-button-with-help"}),d=this.llmService?.isAvailable()??!1;if(this.ideateButton=c.createEl("button",{text:"Ideate",cls:"mod-cta ideatr-ideate-button"}),!d)this.ideateButton.disabled=!0,this.ideateButton.addClass("ideatr-ideate-button-disabled"),this.ideateButton.setAttribute("title","Ideate (AI service not available. Please configure AI in settings.)");else{let y=Qu(this.settings.captureIdeateShortcut||"cmd+enter");this.ideateButton.setAttribute("title",`Ideate (${y})`),this.ideateButton.addEventListener("click",()=>this.handleIdeate())}let u=he(this.app,"ideate-button","Learn about the Ideate button");c.appendChild(u);let h=l.createDiv({cls:"ideatr-button-with-help"});this.saveButton=h.createEl("button",{text:"Save",cls:"mod-cta"});let p=Qu(this.settings.captureSaveShortcut||"alt+enter");this.saveButton.setAttribute("title",`Save (${p})`),this.saveButton.addEventListener("click",()=>this.handleSubmit());let f=he(this.app,"save-button","Learn about the Save button");h.appendChild(f),this.inputEl.focus(),this.inputEl.addEventListener("keydown",y=>{let S=this.settings.captureIdeateShortcut||"cmd+enter";if(Yu(y,S)){y.preventDefault(),this.llmService?.isAvailable()&&this.ideateButton&&!this.ideateButton.disabled&&this.handleIdeate();return}let x=this.settings.captureSaveShortcut||"alt+enter";if(Yu(y,x)){y.preventDefault(),this.handleSubmit();return}this.isWarningShown&&(this.hideError(),this.isWarningShown=!1,this.saveButton.setText("Save"),this.ideateButton&&(this.ideateButton.textContent="Ideate"))})}async handleClassifyNow(){let e=this.inputEl.value,t=pa(e);if(!t.valid){this.showError(t.error||"Invalid input");return}this.classificationAbortController=new AbortController,this.showClassificationInProgress(this.isFirstClassification),this.isFirstClassification=!1;try{let r=await this.classificationService.classifyIdea(t.sanitizedText||e);if(this.classificationAbortController?.signal.aborted)return;this.showClassificationResults(r,null)}catch(r){if(this.classificationAbortController?.signal.aborted)return;console.error("Classification failed:",r),this.classificationEl.empty(),this.classificationEl.addClass("ideatr-visible"),this.classificationEl.removeClass("ideatr-hidden");let s="Classification unavailable. Please configure AI in settings.";if(r instanceof Error){let a=r.message.toLowerCase();a.includes("invalid api key")||a.includes("unauthorized")?s="Invalid API key. Please check your AI settings.":a.includes("rate limit")?s="Rate limit exceeded. Please try again later.":(a.includes("connection_refused")||a.includes("server not available"))&&(s="AI server not available. Please configure AI in settings.")}this.classificationEl.createEl("p",{text:s,cls:"ideatr-classification-error"}),this.classificationEl.createEl("button",{text:"Retry",cls:"mod-cta"}).addEventListener("click",()=>{this.handleClassifyNow()})}}async handleSubmit(){let e=this.inputEl.value,t=pa(e);if(!t.valid){this.showError(t.error||"Invalid input");return}if(!this.isWarningShown)try{let r=await this.duplicateDetector.checkDuplicate(e);if(r.isDuplicate){let s=r.duplicates.length,i=`Found ${s} similar idea${s>1?"s":""}. Press Save again to confirm.`;this.showError(i,!0),this.isWarningShown=!0,this.duplicatePaths=r.duplicates.map(a=>a.path),this.saveButton.textContent="Save Anyway";return}}catch(r){m.warn("Duplicate check failed:",r)}try{let r={text:t.sanitizedText||e,timestamp:new Date},s=await this.fileManager.createIdeaFile(r);new Ve.Notice("Idea captured!"),this.close(),this.onSuccess&&this.onSuccess(),this.processBackgroundTasks(s,r.text).catch(i=>{m.warn("Background processing failed:",i)})}catch(r){this.showError("Failed to save idea. Please try again."),console.error("Error creating idea file:",r)}}async handleIdeate(){let e=this.inputEl.value,t=pa(e);if(!t.valid){this.showError(t.error||"Invalid input");return}if(!this.llmService?.isAvailable()){this.showError("AI service is not available. Please configure AI in settings.");return}if(!this.isWarningShown)try{let s=await this.duplicateDetector.checkDuplicate(e);if(s.isDuplicate){let i=s.duplicates.length,a=`Found ${i} similar idea${i>1?"s":""}. Press Ideate again to confirm.`;this.showError(a,!0),this.isWarningShown=!0,this.duplicatePaths=s.duplicates.map(o=>o.path),this.ideateButton&&(this.ideateButton.textContent="Ideate Anyway");return}}catch(s){m.warn("Duplicate check failed:",s)}let r=null;try{this.showClassificationInProgress(!0),this.classificationAbortController=new AbortController;let s={text:t.sanitizedText||e,timestamp:new Date};r=await this.fileManager.createIdeaFile(s);let i=await this.classificationService.classifyIdea(s.text);if(this.classificationAbortController?.signal.aborted)return;let a="";if(this.llmService.complete)try{let d=`Generate a concise, descriptive title for this idea.

Idea: "${s.text}"

Requirements:
- 2-8 words maximum
- Descriptive and clear (captures the core concept)
- Not overly creative or abstract
- Should help someone quickly understand what this idea is about
- Extract the key concept, not just use the first words

Examples:
- "AI generated puzzle full of interlinked monkeys" \u2192 "AI Monkey Puzzle Game"
- "notification app that sends alerts" \u2192 "Notification App"
- "task manager for remote teams" \u2192 "Team Task Manager"

Title:`;a=(await this.llmService.complete(d,{temperature:.3,n_predict:50,stop:[`
`,".","!","?"]})).trim().replace(/^["']|["']$/g,"").substring(0,100)}catch(d){m.warn("Title generation failed, using fallback:",d),a=le(s.text)}else a=le(s.text);let o="";if(this.llmService.expandIdea)try{let d=`Expand this idea with related concepts, questions, and next steps.

Original Idea:
${s.text}

Category: ${i.category||"general"}
Tags: ${i.tags.join(", ")||"none"}

Generate a structured expansion with:

## Related Ideas
2-3 variations or related concepts that explore different angles or implementations. Each should be:
- Distinct from the original but clearly related
- Brief (1-2 sentences each)
- Practical and actionable

## Key Questions
3-4 important questions to explore. Focus on:
- Validation questions (who needs this? what problem does it solve?)
- Implementation questions (how would this work? what's needed?)
- Strategic questions (what are the risks? what's the market?)

## Next Steps
1-2 concrete, actionable next steps to move forward. Be specific and practical.

Format as markdown with the sections above. Keep it concise and actionable - each item should be brief but meaningful.

Response:`;this.llmService.complete&&(o=await this.llmService.complete(d,{temperature:.7,n_predict:800}))}catch(d){m.warn("Expansion generation failed:",d),o=""}if(this.classificationAbortController?.signal.aborted)return;let l=[...new Set([...i.related,...this.duplicatePaths])],c=await this.idConverter.pathsToIds(l);await this.fileManager.updateIdeaFrontmatter(r,{category:i.category,tags:i.tags,related:c}),await this.app.vault.process(r,d=>{let u=/^---\n[\s\S]*?\n---(\n\n?|\n?)/,h=d.match(u),p=h?d.substring(h[0].length):d,f="";return a&&(f+=`# ${a}

`),f+=p.trim(),o&&(f+=`

---

## Ideas & Questions

`+o.trim()),(h?d.substring(0,h[0].length):"")+f}),this.triggerValidation(r,s.text,i.category),new Ve.Notice("Idea processed with AI!"),this.close(),this.onSuccess&&this.onSuccess()}catch(s){if(this.classificationAbortController?.signal.aborted)return;r&&new Ve.Notice("Ideate command failed, but your idea has been saved to your list of ideas."),this.showError("Failed to process idea. Please try again."),console.error("Error processing idea:",s),this.classificationEl.empty(),this.classificationEl.addClass("ideatr-visible"),this.classificationEl.removeClass("ideatr-hidden"),this.classificationEl.createEl("p",{text:"Processing failed. Idea may have been saved without AI processing.",cls:"ideatr-classification-error"}),this.classificationEl.createEl("button",{text:"Continue",cls:"mod-cta"}).addEventListener("click",()=>{this.close(),this.onSuccess&&this.onSuccess()})}}showError(e,t=!1){this.errorEl.empty(),this.errorEl.setText(e),this.errorEl.addClass("ideatr-visible"),this.errorEl.removeClass("ideatr-hidden","ideatr-invisible"),t?(this.errorEl.addClass("ideatr-warning"),this.errorEl.removeClass("ideatr-error")):(this.errorEl.addClass("ideatr-error"),this.errorEl.removeClass("ideatr-warning"))}hideError(){this.errorEl.addClass("ideatr-hidden","ideatr-invisible"),this.errorEl.removeClass("ideatr-visible"),this.errorEl.removeClass("ideatr-warning"),this.errorEl.removeClass("ideatr-error")}showClassificationInProgress(e=!1){this.inputEl.addClass("ideatr-hidden"),this.inputEl.removeClass("ideatr-visible");let t=this.contentEl.querySelector(".ideatr-button-container");t&&(t.addClass("ideatr-hidden"),t.removeClass("ideatr-visible")),this.classificationEl.empty(),this.classificationEl.addClass("ideatr-visible"),this.classificationEl.removeClass("ideatr-hidden");let r=e?"Loading AI model (first use)... ~10 seconds":"Classifying idea... ~2-3 seconds";this.classificationEl.createEl("p",{text:r}).addClass("ideatr-classification-status"),this.classificationEl.createEl("button",{text:"Cancel",cls:"ideatr-cancel-classification"}).addEventListener("click",()=>{this.cancelClassification()})}cancelClassification(){this.classificationAbortController&&(this.classificationAbortController.abort(),this.classificationAbortController=null),this.classificationEl.empty(),this.classificationEl.addClass("ideatr-visible"),this.classificationEl.removeClass("ideatr-hidden"),this.classificationEl.createEl("p",{text:"Classification cancelled. Idea saved without classification.",cls:"ideatr-classification-status"}),this.classificationEl.createEl("button",{text:"Continue",cls:"mod-cta"}).addEventListener("click",()=>{this.close(),this.onSuccess&&this.onSuccess()})}handleClassificationError(e,t,r){let s="Classification unavailable. Idea saved without classification.",i=!0;if(e instanceof Error){let a=e.message.toLowerCase();a.includes("connection_refused")||a.includes("server not available")?s="AI server not available. Idea saved without classification.":a.includes("invalid api key")||a.includes("unauthorized")?(s="Invalid API key. Please check your AI settings. Idea saved without classification.",i=!0):a.includes("rate limit")?s="Rate limit exceeded. Please try again later. Idea saved without classification.":a.includes("timeout")?s="Classification timed out. Idea saved without classification.":(a.includes("network")||a.includes("fetch"))&&(s="Network error. Idea saved without classification.")}this.classificationEl.empty(),this.classificationEl.addClass("ideatr-visible"),this.classificationEl.removeClass("ideatr-hidden"),this.classificationEl.createEl("p",{text:s,cls:"ideatr-classification-error"}),i?this.classificationEl.createEl("button",{text:"Continue",cls:"mod-cta"}).addEventListener("click",()=>{this.triggerValidation(t,r,""),this.close(),this.onSuccess&&this.onSuccess()}):setTimeout(()=>{this.triggerValidation(t,r,""),this.close(),this.onSuccess&&this.onSuccess()},2e3)}async showClassificationResults(e,t){let r={category:e.category,tags:e.tags},s=[...e.related],i=[...this.duplicatePaths],a=new ha(this.app,r,async o=>{let l=[...new Set([...s,...i])],c={category:o.category,tags:o.tags,related:l};t?await this.acceptClassification(c,t):(new Ve.Notice("Classification complete. Save the idea to apply results."),a.close())},async()=>{let o=[...new Set([...s,...i])],l={category:r.category,tags:r.tags,related:o};t?await this.acceptClassification(l,t):(new Ve.Notice("Classification complete. Save the idea to apply results."),a.close())},async()=>{try{let o=this.inputEl.value,l=await this.classificationService.classifyIdea(o);a.close(),this.showClassificationResults(l,t)}catch(o){console.error("Retry classification failed:",o),new Ve.Notice("Failed to retry classification. Please try again.")}});a.open()}async acceptClassification(e,t){if(!t)return;let r=[...new Set([...e.related,...this.duplicatePaths])],s=await this.idConverter.pathsToIds(r);await this.fileManager.updateIdeaFrontmatter(t,{category:e.category,tags:e.tags,related:s}),new Ve.Notice("Classification applied"),this.close(),this.onSuccess&&this.onSuccess()}rejectClassification(){this.close(),this.onSuccess&&this.onSuccess()}async processBackgroundTasks(e,t){let r="";if(this.settings.autoClassify&&this.classificationService.isAvailable())try{let s=await this.classificationService.classifyIdea(t);r=s.category;let i=[...new Set([...s.related,...this.duplicatePaths])],a=await this.idConverter.pathsToIds(i);await this.fileManager.updateIdeaFrontmatter(e,{category:s.category,tags:s.tags,related:a})}catch(s){m.warn("Background classification failed:",s)}await this.triggerValidation(e,t,r)}async triggerValidation(e,t,r){let s=le(t),i=this.settings.enableWebSearch&&this.settings.autoSearchExistence,a=this.settings.enableNameVariants&&this.settings.autoGenerateVariants&&this.nameVariantService?.isAvailable();if(!i&&!a)return;let o=i?this.performWebSearch(t,r,s).catch(c=>(m.warn("Web search failed:",c),null)):Promise.resolve(null),l=a&&this.nameVariantService?this.nameVariantService.generateVariants(t).then(c=>{if(c.length>0){let d=this.nameVariantService.formatVariantsForMarkdown(c);return this.fileManager.appendToFileBody(e,"Name Variants",d)}return Promise.resolve()}).catch(c=>{m.warn("Name variant generation failed:",c)}):Promise.resolve(null);try{let[c,d]=await Promise.all([o,l]),u={};i&&(c===null?u["existence-check"]=["Search error: Validation failed"]:c.length>0&&(u["existence-check"]=Bu(c,this.settings.maxSearchResults,r))),Object.keys(u).length>0&&await this.fileManager.updateIdeaFrontmatter(e,u)}catch(c){m.warn("Validation orchestration failed:",c);let d={};i&&(d["existence-check"]=["Search error: Validation failed"]),Object.keys(d).length>0&&this.fileManager.updateIdeaFrontmatter(e,d).catch(u=>{m.error("Failed to store validation error state:",u)})}}async performWebSearch(e,t,r){if(!this.webSearchService.isAvailable())return[];try{let s=this.searchQueryGenerator.generateQuery(e,t,r);return!s||s.trim().length===0?[]:await this.webSearchService.search(s,t,this.settings.maxSearchResults)}catch(s){return m.warn("Web search failed:",s),[]}}onClose(){let{contentEl:e}=this;e.empty()}};var Ue=require("obsidian");var Be=class extends Error{constructor(t,r){super(t);this.code=r;this.name="ManagementError"}};function jn(n){switch(n){case"FILE_READ_ERROR":return"Failed to load ideas: some files could not be read. Please check your vault permissions.";case"FRONTMATTER_PARSE_ERROR":case"INVALID_FRONTMATTER":return"Some ideas have invalid frontmatter and were skipped. Check your idea metadata and try again.";case"VAULT_ACCESS_ERROR":return"Could not access the vault to load ideas. Please try again or restart Obsidian.";case"EMBEDDING_GENERATION_ERROR":case"EMBEDDING_TIMEOUT":case"EMBEDDING_UNAVAILABLE":return"Clustering is temporarily unavailable due to embedding errors. You can still use the dashboard table.";case"CLUSTERING_INSUFFICIENT_DATA":return"Not enough ideas to generate clusters yet. Capture a few more ideas and try again.";case"CLUSTERING_ALGORITHM_ERROR":return"Clustering failed due to an internal error. Try narrowing your idea set or disabling clustering in settings.";case"CLUSTERING_TOO_MANY_IDEAS":return"Too many ideas to cluster efficiently. Please filter to fewer ideas and try again.";case"VIEW_RENDERING_ERROR":case"GRAPH_RENDERING_ERROR":return"Failed to render the management view. Try closing and reopening the view.";case"VIEW_MEMORY_ERROR":return"Rendering the graph used too much memory. Try filtering to fewer ideas.";case"DIGEST_GENERATION_ERROR":return"Digest generation failed. Please try again or check your resurfacing settings.";case"DATE_PARSE_ERROR":return"Some ideas have invalid or missing created dates and were skipped. Check your idea frontmatter.";case"ELEVATION_VALIDATION_ERROR":return"Idea cannot be elevated. Please check that the idea is valid and not already elevated.";case"ELEVATION_FILE_MOVE_ERROR":return"Failed to move idea file to project folder. Please check vault permissions.";case"ELEVATION_FOLDER_CREATION_ERROR":return"Failed to create project folder structure. Please check vault permissions.";case"ELEVATION_FRONTMATTER_UPDATE_ERROR":return"Failed to update idea frontmatter during elevation. The project may have been created but metadata may be incomplete.";case"ELEVATION_PROJECT_NAME_COLLISION":return"A project with this name already exists. Please choose a different name.";default:return"An unexpected management error occurred. Please check the console for details."}}function Zu(n){return n.split(",").map(e=>e.trim()).filter(e=>e.length>0)}function ep(n,e){if(!n||!e)return;let t=new Date(n),r=new Date(e);if(!(isNaN(t.getTime())||isNaN(r.getTime())))return{start:t,end:r}}function tp(n,e,t){let r=t>0?t:n.length||1,s=Math.max(1,Math.ceil(n.length/r)),a=(Math.min(Math.max(1,e),s)-1)*r,o=a+r;return{pageItems:n.slice(a,o),totalPages:s}}function Rf(n){let e=0;for(let i=0;i<n.length;i++)e=e*31+n.charCodeAt(i)>>>0;return`hsl(${e%360}, 60%, 55%)`}function rp(n){let e=n.nodes.map(r=>({id:r.id,x:r.x,y:r.y,clusterId:r.clusterId,color:Rf(r.clusterId),title:_f(r),idea:r.idea})),t=n.edges.map(r=>({from:r.from,to:r.to,weight:r.weight}));return{nodes:e,edges:t,width:n.width,height:n.height}}function _f(n){let e=n.idea.filename.replace(/\.md$/,""),t=n.idea.frontmatter.category||"Uncategorized";return`${e} [${t}]`}function wa(n,e,t={}){let{nodes:r,edges:s,width:i,height:a}=rp(e),o=e;n.empty();let l=n.createDiv({cls:"ideatr-graph-wrapper"}),c="http://www.w3.org/2000/svg",d=document.createElementNS(c,"svg");d.setAttribute("viewBox",`0 0 ${i} ${a}`),d.setAttribute("width",t.mini?"220":String(i)),d.setAttribute("height",t.mini?"180":String(a)),d.classList.add("ideatr-graph-svg"),l.appendChild(d);for(let p of s){let f=r.find(x=>x.id===p.from),y=r.find(x=>x.id===p.to);if(!f||!y)continue;let S=document.createElementNS(c,"line");S.setAttribute("x1",String(f.x)),S.setAttribute("y1",String(f.y)),S.setAttribute("x2",String(y.x)),S.setAttribute("y2",String(y.y)),S.setAttribute("stroke","var(--text-muted)"),S.setAttribute("stroke-width",String(1+p.weight)),S.setAttribute("stroke-opacity","0.4"),d.appendChild(S)}let u=document.createElement("div");u.classList.add("ideatr-graph-tooltip"),u.style.display="none",u.style.position="absolute",u.style.pointerEvents="none",u.style.zIndex="1000",l.appendChild(u);let h=null;for(let p of r){let f=document.createElementNS(c,"g");f.setAttribute("transform",`translate(${p.x}, ${p.y})`),f.classList.add("ideatr-graph-node");let y=document.createElementNS(c,"circle");if(y.setAttribute("r",t.mini?"8":"10"),y.setAttribute("fill",p.color),y.setAttribute("stroke","var(--background-primary-alt)"),y.setAttribute("stroke-width","1"),f.appendChild(y),!t.mini){let S=document.createElementNS(c,"text");S.textContent=p.title,S.setAttribute("x","12"),S.setAttribute("y","4"),S.classList.add("ideatr-graph-label"),f.appendChild(S)}if(t.onNodeClick&&(f.style.cursor="pointer",f.addEventListener("click",()=>{t.onNodeClick?.(p.id)})),t.onNodeContextMenu&&f.addEventListener("contextmenu",S=>{S.preventDefault(),t.onNodeContextMenu?.(p.id,S)}),t.onNodeHover&&p.idea){let S=o.nodes.find(x=>x.id===p.id);f.addEventListener("mouseenter",x=>{h=p.id,S&&t.onNodeHover?.(S),u.style.display="block",Tf(u,p.idea),sp(u,x,l)}),f.addEventListener("mousemove",x=>{h===p.id&&sp(u,x,l)}),f.addEventListener("mouseleave",()=>{h=null,u.style.display="none",t.onNodeHover?.(null)})}d.appendChild(f)}}function Tf(n,e){let t=e.filename.replace(/\.md$/,""),r=e.frontmatter.category||"Uncategorized",s=e.frontmatter.tags.length>0?e.frontmatter.tags.join(", "):"No tags",i=e.body.length>150?e.body.substring(0,150)+"...":e.body,a=e.frontmatter.created;n.empty(),n.createDiv("ideatr-tooltip-header").createEl("strong",{text:t});let l=n.createDiv("ideatr-tooltip-meta");l.createEl("span",{text:`Category: ${r}`}),l.createEl("span",{text:`Created: ${a}`});let c=n.createDiv("ideatr-tooltip-tags");c.textContent=`Tags: ${s}`;let d=n.createDiv("ideatr-tooltip-preview");d.textContent=i||"(No content)"}function sp(n,e,t){let r=t.getBoundingClientRect(),s=n.getBoundingClientRect(),i=e.clientX-r.left+15,a=e.clientY-r.top-10,o=r.width-s.width-10,l=r.height-s.height-10;n.style.left=`${Math.min(i,o)}px`,n.style.top=`${Math.max(10,Math.min(a,l))}px`}ir();var np=require("obsidian"),zc=class extends np.Modal{message;resolve;constructor(e,t,r){super(e),this.message=t,this.resolve=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Confirm"}),e.createEl("p",{text:this.message});let t=e.createDiv({cls:"modal-button-container"}),r=t.createEl("button",{text:"Confirm",cls:"mod-cta"});r.onclick=()=>{this.resolve(!0),this.close()};let s=t.createEl("button",{text:"Cancel"});s.onclick=()=>{this.resolve(!1),this.close()}}onClose(){let{contentEl:e}=this;e.empty(),this.resolve(!1)}};async function Ce(n,e){return new Promise(t=>{new zc(n,e,t).open()})}var va=class extends Ue.ItemView{ideaRepository;clusteringService;resurfacingService;projectElevationService;ideas=[];filteredIdeas=[];filters={};sortColumn=null;sortDirection="asc";isLoading=!1;currentPage=1;itemsPerPage;persistFilters;constructor(e,t,r,s,i,a=50,o=!1){super(e),this.ideaRepository=t,this.clusteringService=r,this.resurfacingService=s,this.projectElevationService=i,this.itemsPerPage=a,this.persistFilters=o}getViewType(){return"ideatr-dashboard"}getDisplayText(){return"Ideatr Dashboard"}getIcon(){return"lightbulb"}async onOpen(){let e=this.contentEl;e.empty(),this.persistFilters&&this.loadFilterState();let t=e.createDiv("dashboard-header"),r=t.createDiv({cls:"dashboard-title-container"});r.createEl("h2",{text:"Ideatr dashboard"});let s=he(this.app,"dashboard","Learn about the Dashboard");r.appendChild(s),t.createDiv("dashboard-toolbar").createEl("button",{text:"Refresh"}).addEventListener("click",()=>this.refresh());let o=e.createDiv("dashboard-filters"),l=o.createDiv({cls:"dashboard-filters-title"});l.createEl("h3",{text:"Filters"});let c=he(this.app,"filters","Learn about Dashboard Filters");l.appendChild(c),this.createFilterUI(o);let d=e.createDiv("dashboard-side-panels");if(this.clusteringService){let y=d.createDiv("dashboard-panel clusters-panel"),S=y.createDiv({cls:"dashboard-panel-title"});S.createEl("h3",{text:"Clusters"});let x=he(this.app,"clusters","Learn about Clusters");S.appendChild(x),this.renderClustersMiniGraph(y)}if(this.resurfacingService){let y=d.createDiv("dashboard-panel resurfacing-panel"),S=y.createDiv({cls:"dashboard-panel-title"});S.createEl("h3",{text:"Old ideas"});let x=he(this.app,"resurfacing","Learn about Resurfacing");S.appendChild(x),this.renderResurfacingPanel(y)}let u=d.createDiv("dashboard-panel triage-panel"),h=u.createDiv({cls:"dashboard-panel-title"});h.createEl("h3",{text:"Triage inbox"});let p=he(this.app,"triage-inbox","Learn about Triage Inbox");h.appendChild(p),this.renderTriageInbox(u);let f=e.createDiv("dashboard-table-container");this.renderTable(f),await this.loadIdeas()}async onClose(){}createFilterUI(e){let t=e.createDiv("filter-item");t.createEl("label",{text:"Search:",attr:{for:"dashboard-search"}});let r=t.createEl("input",{type:"text",attr:{id:"dashboard-search"},placeholder:"Search ideas..."});r.addEventListener("input",g=>{let E=g.target.value;this.filters.searchText=E||void 0,this.applyFilters()});let s=e.createDiv("filter-item");s.createEl("label",{text:"Category:"});let i=s.createEl("input",{type:"text",placeholder:"Filter by category (comma-separated)..."});i.addEventListener("input",g=>{let R=g.target.value.split(",").map(M=>M.trim()).filter(M=>M.length>0);this.filters.categories=R.length>0?R:void 0,this.applyFilters()});let a=e.createDiv("filter-item");a.createEl("label",{text:"Tags:"});let o=a.createEl("input",{type:"text",placeholder:"Filter by tags (comma-separated)..."});o.addEventListener("input",g=>{let E=g.target.value,R=Zu(E);this.filters.tags=R.length>0?R:void 0,this.applyFilters()});let l=e.createDiv("filter-item");l.createEl("label",{text:"Status:"});let c=l.createEl("input",{type:"text",placeholder:"Filter by status..."});c.addEventListener("input",g=>{let E=g.target.value.trim();this.filters.status=E||void 0,this.applyFilters()});let d=e.createDiv("filter-item date-range");d.createEl("label",{text:"Created between:"});let u=d.createEl("input",{type:"date"}),h=d.createEl("input",{type:"date"}),p=()=>{this.filters.dateRange=ep(u.value||void 0,h.value||void 0),this.applyFilters()};u.addEventListener("change",p),h.addEventListener("change",p);let y=e.createDiv("filter-item").createEl("label"),S=y.createEl("input",{type:"checkbox"});y.appendText(" Show only uncategorized ideas"),S.addEventListener("change",g=>{let E=g.target.checked;this.filters.uncategorized=E||void 0,this.applyFilters()}),e.createEl("button",{text:"Clear filters"}).addEventListener("click",()=>{this.filters={},r.value="",i.value="",o.value="",c.value="",u.value="",h.value="",S.checked=!1,this.applyFilters()}),this.persistFilters&&this.restoreFilterUIValues(r,i,o,c,u,h,S)}restoreFilterUIValues(e,t,r,s,i,a,o){this.filters.searchText&&(e.value=this.filters.searchText),this.filters.categories&&this.filters.categories.length>0&&(t.value=this.filters.categories.join(", ")),this.filters.tags&&this.filters.tags.length>0&&(r.value=this.filters.tags.join(", ")),this.filters.status&&(s.value=this.filters.status),this.filters.dateRange&&(i.value=this.filters.dateRange.start.toISOString().split("T")[0],a.value=this.filters.dateRange.end.toISOString().split("T")[0]),this.filters.uncategorized&&(o.checked=!0)}renderTable(e){if(e.empty(),this.isLoading){e.createEl("div",{text:"Loading ideas..."});return}if(this.filteredIdeas.length===0){e.createEl("div",{text:"No ideas found."});return}let t=e.createEl("table",{cls:"dashboard-table"}),s=t.createEl("thead").createEl("tr");this.createTableHeader(s,"Date","created"),this.createTableHeader(s,"Category","category"),this.createTableHeader(s,"Tags","tags"),this.createTableHeader(s,"Status","status"),this.createTableHeader(s,"Title","title"),this.projectElevationService&&s.createEl("th",{text:"Actions"});let i=t.createEl("tbody"),{pageItems:a,totalPages:o}=tp(this.filteredIdeas,this.currentPage,this.itemsPerPage);for(let u of a){let h=i.createEl("tr");h.addEventListener("click",()=>this.openIdea(u));let p=h.createEl("td");p.textContent=u.frontmatter.created;let f=h.createEl("td");f.textContent=u.frontmatter.category||"Uncategorized";let y=h.createEl("td");y.textContent=u.frontmatter.tags.join(", ")||"";let S=h.createEl("td");S.textContent=u.frontmatter.status;let x=h.createEl("td"),g=u.body.substring(0,50);if(x.textContent=g||u.filename,u.body.length>50&&(x.textContent+="..."),this.projectElevationService){let E=h.createEl("td",{cls:"actions-cell"});this.projectElevationService.canElevate(u)?E.createEl("button",{text:"Elevate",cls:"elevate-btn"}).addEventListener("click",M=>{M.stopPropagation(),this.elevateIdea(u)}):E.textContent="-"}}let l=e.createDiv("dashboard-pagination");l.createSpan({text:`Page ${this.currentPage} of ${o}`});let c=this,d=(u,h)=>{let p=l.createEl("button",{text:u});return p.addEventListener("click",()=>{let f=c.currentPage+h,y=Math.min(Math.max(1,f),o);y!==c.currentPage&&(c.currentPage=y,c.renderTable(e))}),p};d("Prev",-1),d("Next",1)}createTableHeader(e,t,r){let s=e.createEl("th");s.textContent=t,s.addClass("ideatr-cursor-pointer"),s.addEventListener("click",()=>this.sortBy(r)),this.sortColumn===r&&(s.textContent+=this.sortDirection==="asc"?" \u2191":" \u2193")}sortBy(e){this.sortColumn===e?this.sortDirection=this.sortDirection==="asc"?"desc":"asc":(this.sortColumn=e,this.sortDirection="asc"),this.filteredIdeas.sort((t,r)=>{let s,i;switch(e){case"created":s=new Date(t.frontmatter.created).getTime(),i=new Date(r.frontmatter.created).getTime();break;case"category":s=t.frontmatter.category||"",i=r.frontmatter.category||"";break;case"status":s=t.frontmatter.status,i=r.frontmatter.status;break;case"title":s=t.body||t.filename,i=r.body||r.filename;break;default:return 0}return s<i?this.sortDirection==="asc"?-1:1:s>i?this.sortDirection==="asc"?1:-1:0}),this.renderTable(this.contentEl.querySelector(".dashboard-table-container"))}async loadIdeas(){this.isLoading=!0,this.renderTable(this.contentEl.querySelector(".dashboard-table-container"));try{if(this.ideas=await this.ideaRepository.getAllIdeas(),this.applyFilters(),this.clusteringService){let t=this.contentEl.querySelector(".clusters-panel");t&&this.renderClustersMiniGraph(t)}if(this.resurfacingService){let t=this.contentEl.querySelector(".resurfacing-panel");t&&this.renderResurfacingPanel(t)}let e=this.contentEl.querySelector(".triage-panel");e&&this.renderTriageInbox(e)}catch(e){console.error("Failed to load ideas:",e);let t=this.contentEl.querySelector(".dashboard-table-container");t.empty();let r="Failed to load ideas. Please try again.";e instanceof Be&&(r=jn(e.code),new Ue.Notice(r)),t.createEl("div",{text:r})}finally{this.isLoading=!1}}async applyFilters(){try{this.filteredIdeas=await this.ideaRepository.getIdeasByFilter(this.filters),this.currentPage=1,this.renderTable(this.contentEl.querySelector(".dashboard-table-container")),this.persistFilters&&await this.saveFilterState()}catch(e){console.error("Failed to apply filters:",e);let t=this.contentEl.querySelector(".dashboard-table-container");t.empty();let r="Failed to apply dashboard filters.";e instanceof Be&&(r=jn(e.code),new Ue.Notice(r)),t.createEl("div",{text:r})}}loadFilterState(){try{let e=this.leaf.getViewState();e.state&&e.state.filters&&(this.filters=e.state.filters)}catch(e){m.warn("Failed to load persisted filter state:",e)}}async saveFilterState(){try{await this.leaf.setViewState({type:"ideatr-dashboard",state:{filters:this.filters}})}catch(e){m.warn("Failed to save filter state:",e)}}async refresh(){await this.ideaRepository.refresh(),await this.loadIdeas()}openIdea(e){this.app.vault.getAbstractFileByPath(`Ideas/${e.filename}`)&&this.app.workspace.openLinkText(`Ideas/${e.filename}`,"",!1)}async renderClustersMiniGraph(e){e.empty(),e.createEl("div",{text:"Loading clusters...",cls:"loading"});try{if(this.ideas.length<2){e.empty(),e.createEl("div",{text:"Need at least 2 ideas for clustering."});return}let t=await this.clusteringService.clusterIdeas(this.ideas),r=this.app.plugins?this.app.plugins?.getPlugin("ideatr")?.graphLayoutService?.layoutGraph(t,220,180):null;if(e.empty(),e.createEl("div",{text:`${t.length} clusters found`,cls:"cluster-summary"}),r){let i=e.createDiv("clusters-mini-graph");wa(i,r,{mini:!0,onNodeClick:a=>{let o=r.nodes.find(l=>l.id===a);o&&this.openIdea(o.idea)},onNodeHover:a=>{}})}e.createEl("button",{text:"Open full graph"}).addEventListener("click",()=>{this.app.workspace.getLeaf(!1).setViewState({type:"ideatr-graph",active:!0})})}catch(t){console.error("Failed to load clusters:",t),e.empty(),e.createEl("div",{text:"Failed to load clusters."})}}async renderResurfacingPanel(e){e.empty(),e.createEl("div",{text:"Loading old ideas...",cls:"loading"});try{let t=await this.resurfacingService.identifyOldIdeas();if(e.empty(),t.length===0){e.createEl("div",{text:"No old ideas found."});return}e.createEl("div",{text:`${t.length} old ideas need attention`,cls:"resurfacing-summary"});let r=e.createEl("ul",{cls:"resurfacing-list"});for(let i of t.slice(0,5)){let a=r.createEl("li"),o=this.calculateAge(i.frontmatter.created);a.textContent=`${i.filename.replace(".md","")} (${o} days old)`,a.addClass("ideatr-cursor-pointer"),a.addEventListener("click",()=>this.openIdea(i))}t.length>5&&r.createEl("li",{text:`... and ${t.length-5} more`}),e.createEl("button",{text:"Generate digest"}).addEventListener("click",async()=>{try{let i=await this.resurfacingService.generateDigest(),a=`Ideas/.ideatr-digest-${Date.now()}.md`;await this.app.vault.create(a,i.summary),this.app.vault.getAbstractFileByPath(a)&&await this.app.workspace.openLinkText(a,"",!1)}catch(i){console.error("Failed to generate digest:",i)}})}catch(t){console.error("Failed to load resurfacing panel:",t),e.empty(),e.createEl("div",{text:"Failed to load old ideas."})}}renderTriageInbox(e){e.empty();let t=this.filteredIdeas.filter(s=>!s.frontmatter.category||s.frontmatter.category==="");if(t.length===0){e.createEl("div",{text:"All ideas are categorized!"});return}e.createEl("div",{text:`${t.length} uncategorized ideas`,cls:"triage-summary"});let r=e.createEl("ul",{cls:"triage-list"});for(let s of t.slice(0,10)){let i=r.createEl("li");i.textContent=s.filename.replace(".md",""),i.addClass("ideatr-cursor-pointer"),i.addEventListener("click",()=>this.openIdea(s))}t.length>10&&r.createEl("li",{text:`... and ${t.length-10} more`})}calculateAge(e){try{let t=new Date(e),s=Math.abs(new Date().getTime()-t.getTime());return Math.ceil(s/(1e3*60*60*24))}catch{return 0}}async elevateIdea(e){if(!this.projectElevationService){new Ue.Notice("Elevation service not available.");return}if(!this.projectElevationService.canElevate(e)){new Ue.Notice("This idea cannot be elevated. It may already be elevated or have invalid frontmatter.");return}let t=this.projectElevationService.generateProjectName(e);if(await Ce(this.app,`Elevate idea to project?

Project name: ${t}

The idea file will be moved to Projects/${t}/README.md
Original file will be deleted.`))try{new Ue.Notice("Elevating idea to project...");let s=await this.projectElevationService.elevateIdea(e);s.success?(new Ue.Notice(`Idea elevated to project: ${s.projectPath}`),await this.ideaRepository.refresh(),await this.loadIdeas(),s.warnings&&s.warnings.length>0&&m.warn("Elevation warnings:",s.warnings)):(new Ue.Notice(`Failed to elevate idea: ${s.error||"Unknown error"}`),s.warnings&&s.warnings.length>0&&m.warn("Elevation warnings:",s.warnings))}catch(s){console.error("Failed to elevate idea:",s),new Ue.Notice("Failed to elevate idea. Please try again.")}}};var We=require("obsidian");ir();var xa=class extends We.ItemView{clusteringService;graphLayoutService;ideaRepository;projectElevationService;ideas=[];isLoading=!1;currentLayout=null;constructor(e,t,r,s,i){super(e),this.clusteringService=t,this.graphLayoutService=r,this.ideaRepository=s,this.projectElevationService=i}getViewType(){return"ideatr-graph"}getDisplayText(){return"Ideatr Graph"}getIcon(){return"git-branch"}async onOpen(){let e=this.contentEl;e.empty();let t=e.createDiv("graph-header"),r=t.createDiv({cls:"graph-title-container"});r.createEl("h2",{text:"Idea clusters"});let s=he(this.app,"graph-view","Learn about Graph View");r.appendChild(s),t.createDiv("graph-toolbar").createEl("button",{text:"Refresh"}).addEventListener("click",()=>this.refresh());let o=e.createDiv("graph-container");this.renderGraph(o),await this.loadGraph()}async onClose(){}renderGraph(e){if(e.empty(),this.isLoading){e.createEl("div",{text:"Generating clusters..."});return}if(this.ideas.length===0){e.createEl("div",{text:"No ideas found."});return}if(this.ideas.length<2){e.createEl("div",{text:"Need at least 2 ideas to create clusters."});return}}async loadGraph(){this.isLoading=!0;let e=this.contentEl.querySelector(".graph-container");this.renderGraph(e);try{if(this.ideas=await this.ideaRepository.getAllIdeas(),this.ideas.length>=2){let t=await this.clusteringService.clusterIdeas(this.ideas),r=this.graphLayoutService.layoutGraph(t,800,600);this.currentLayout=r,wa(e,r,{onNodeClick:s=>{let i=r.nodes.find(a=>a.id===s);i&&this.openIdea(i.idea)},onNodeHover:s=>{},onNodeContextMenu:(s,i)=>{this.showNodeContextMenu(s,i)},mini:!1})}else this.renderGraph(e)}catch(t){console.error("Failed to load graph:",t),e.empty();let r="Failed to load graph. Please try again.";t instanceof Be&&(r=jn(t.code),new We.Notice(r)),e.createEl("div",{text:r})}finally{this.isLoading=!1}}async refresh(){await this.ideaRepository.refresh(),await this.loadGraph()}openIdea(e){this.app.vault.getAbstractFileByPath(`Ideas/${e.filename}`)&&this.app.workspace.openLinkText(`Ideas/${e.filename}`,"",!1)}showNodeContextMenu(e,t){if(!this.currentLayout)return;let r=this.currentLayout.nodes.find(l=>l.id===e);if(!r)return;let s=document.querySelector(".ideatr-graph-context-menu");s&&s.remove();let i=document.createElement("div");i.classList.add("ideatr-graph-context-menu"),i.setCssProps({left:`${t.clientX}px`,top:`${t.clientY}px`}),i.createEl("button",{text:"Open idea",cls:"context-menu-item"}).addEventListener("click",()=>{this.openIdea(r.idea),i.remove()}),this.projectElevationService&&this.projectElevationService.canElevate(r.idea)&&i.createEl("button",{text:"Elevate to project",cls:"context-menu-item"}).addEventListener("click",()=>{this.elevateIdea(r.idea),i.remove()}),document.body.appendChild(i);let o=l=>{i.contains(l.target)||(i.remove(),document.removeEventListener("click",o))};setTimeout(()=>{document.addEventListener("click",o)},0)}async elevateIdea(e){if(!this.projectElevationService){new We.Notice("Elevation service not available.");return}if(!this.projectElevationService.canElevate(e)){new We.Notice("This idea cannot be elevated. It may already be elevated or have invalid frontmatter.");return}let t=this.projectElevationService.generateProjectName(e);if(await Ce(this.app,`Elevate idea to project?

Project name: ${t}

The idea file will be moved to Projects/${t}/README.md
Original file will be deleted.`))try{new We.Notice("Elevating idea to project...");let s=await this.projectElevationService.elevateIdea(e);s.success?(new We.Notice(`Idea elevated to project: ${s.projectPath}`),await this.ideaRepository.refresh(),await this.loadGraph(),s.warnings&&s.warnings.length>0&&m.warn("Elevation warnings:",s.warnings)):(new We.Notice(`Failed to elevate idea: ${s.error||"Unknown error"}`),s.warnings&&s.warnings.length>0&&m.warn("Elevation warnings:",s.warnings))}catch(s){console.error("Failed to elevate idea:",s),new We.Notice("Failed to elevate idea. Please try again.")}}};var $h=require("obsidian");var Se=require("obsidian");var Q=class{constructor(e,t,r){this.app=e;this.plugin=t;this.settingsTab=r}settingsTab;async saveSettings(){await this.plugin.saveSettings()}refresh(){this.settingsTab&&this.settingsTab.display&&this.settingsTab.display()}};var Ct=require("obsidian");var cr=require("obsidian"),Sa=class extends cr.Modal{modelManager;progressBar;progressText;cancelButton;errorMessage;modelInfo;retryButton=null;isDownloading=!1;downloadStartTime=0;isWarning=!1;allowBackgroundDownload=!1;constructor(e,t){super(e),this.modelManager=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-download-modal"),e.createEl("h2",{text:"Download AI model"});let t=this.modelManager.getModelInfo();this.modelInfo=e.createEl("div",{cls:"ideatr-model-info"}),this.modelInfo.createEl("p",{text:`Model: ${t.name}`}),this.modelInfo.createEl("p",{text:`Size: ${t.sizeMB.toFixed(1)} MB (${(t.sizeMB/1024).toFixed(2)} GB)`}),this.modelInfo.createEl("p",{text:`Storage: ${this.modelManager.getModelPath()}`});let r=e.createEl("div",{cls:"ideatr-progress-container"});this.progressBar=r.createEl("div",{cls:"ideatr-progress-bar"}),this.progressBar.createEl("div",{cls:"ideatr-progress-bar-fill"}).setCssProps({width:"0%"}),this.progressText=r.createEl("div",{cls:"ideatr-progress-text"}),this.progressText.textContent="Preparing download...",this.errorMessage=e.createEl("div",{cls:"ideatr-error ideatr-hidden",attr:{style:"margin-top: 10px;"}});let i=e.createEl("div",{cls:"ideatr-button-container"}),a=i.createEl("button",{text:"Download in Background",cls:"mod-cta"});a.style.marginRight="10px",a.addEventListener("click",()=>{this.allowBackgroundDownload=!0,new cr.Notice("Download will continue in background. You'll be notified when it completes."),this.close()}),this.cancelButton=i.createEl("button",{text:"Cancel",cls:"mod-cancel"}),this.cancelButton.addEventListener("click",()=>this.handleCancel()),this.startDownload()}async startDownload(e=!1){if(!this.isDownloading){this.isDownloading=!0,this.downloadStartTime=Date.now(),this.cancelButton.textContent="Cancel",this.errorMessage.addClass("ideatr-hidden"),this.errorMessage.removeClass("ideatr-visible"),this.isWarning=!1,this.progressText.textContent=e?"Re-downloading model...":"Starting download...";try{await this.modelManager.downloadModel((r,s,i)=>{this.isDownloading&&this.updateProgress(r,s,i)},void 0,e),new cr.Notice("Model download complete! Verifying..."),await this.modelManager.verifyModelIntegrity()?(this.isDownloading&&(this.progressText.textContent="Download complete and verified!",this.cancelButton.textContent="Close",this.cancelButton.removeClass("mod-cancel"),this.cancelButton.addClass("mod-cta")),new cr.Notice("Model downloaded and verified successfully!"),this.isDownloading&&setTimeout(()=>{this.close()},2e3)):this.isDownloading?(this.showError("Downloaded file failed integrity check. Please try again."),this.showRetryButton()):new cr.Notice("Model download failed integrity check. Please try again.",5e3)}catch(t){let r=t instanceof Error?t.message:"Download failed";r==="Model already downloaded"?(this.showWarning("Model is already downloaded. You can download again to replace it."),this.showRetryButton("Download again anyway")):(this.showError(r),this.showRetryButton())}finally{this.isDownloading=!1}}}updateProgress(e,t,r){let s=this.progressBar.querySelector(".ideatr-progress-bar-fill");s&&s.setCssProps({width:`${Math.min(100,Math.max(0,e))}%`});let i=Math.round(e),a=(t/1024).toFixed(2),o=(r/1024).toFixed(2),l=r-t,c=this.downloadStartTime>0?(Date.now()-this.downloadStartTime)/1e3:0,d=t>0&&c>0?t/c:0,u=d>0?l/d:0,h=Math.ceil(u/60),p="";if(h>0&&e>0&&e<100&&h<1e5)if(h<60)p=` \u2022 ETA: ~${h} minute${h!==1?"s":""}`;else{let f=Math.floor(h/60),y=h%60;p=` \u2022 ETA: ~${f} hour${f!==1?"s":""}${y>0?` ${y} minute${y!==1?"s":""}`:""}`}this.progressText.textContent=`Downloading: ${i}% (${a} GB / ${o} GB)${p}`}showError(e){this.isWarning=!1,this.errorMessage.empty(),this.errorMessage.addClass("ideatr-visible ideatr-error-color"),this.errorMessage.removeClass("ideatr-hidden"),this.progressText.textContent="Download failed";let t=/(https?:\/\/[^\s]+)/g;e.split(t).forEach(i=>{i.match(/^https?:\/\//)?this.errorMessage.createEl("a",{text:i,href:i,attr:{target:"_blank",rel:"noopener noreferrer"}}).addClass("ideatr-link-accent"):i.trim()&&this.errorMessage.createEl("span",{text:i})});let s=this.progressBar.querySelector(".ideatr-progress-bar-fill");s&&(s.addClass("ideatr-progress-bar-fill"),s.setCssProps({width:"0%"}))}showWarning(e){this.isWarning=!0,this.errorMessage.empty(),this.errorMessage.addClass("ideatr-visible"),this.errorMessage.removeClass("ideatr-hidden"),this.errorMessage.addClass("ideatr-warning-color"),this.progressText.textContent="Model already exists",this.errorMessage.createEl("span",{text:e});let t=this.progressBar.querySelector(".ideatr-progress-bar-fill");t&&(t.addClass("ideatr-progress-bar-fill"),t.setCssProps({width:"0%"}))}showRetryButton(e="Retry"){if(this.retryButton)return;let t=this.contentEl.querySelector(".ideatr-button-container");t&&(this.retryButton=t.createEl("button",{text:e,cls:"mod-cta"}),this.retryButton.addEventListener("click",()=>{this.retryButton&&(this.retryButton.remove(),this.retryButton=null),this.startDownload(this.isWarning)}))}handleCancel(){this.isDownloading?(this.modelManager.cancelDownload(),this.isDownloading=!1,this.progressText.textContent="Download cancelled",this.cancelButton.textContent="Close"):this.close()}onClose(){let{contentEl:e}=this;this.isDownloading&&!this.allowBackgroundDownload&&this.modelManager.cancelDownload(),e.empty(),this.isDownloading=!1,this.retryButton=null,this.allowBackgroundDownload=!1}};function ip(n){return{name:n.name,badge:n.badge,description:n.description,quality:n.quality,speed:n.speed,pros:n.pros,cons:n.cons,bestFor:n.bestFor,sizeMB:n.sizeMB,ram:n.ram}}function ap(n){return{name:n.name,badge:n.badge,description:n.description,quality:n.quality,speed:n.speed,pros:n.pros,cons:n.cons,bestFor:n.bestFor,cost:n.cost,costEstimate:n.costEstimate}}function Vc(n,e,t=!1){let r=n.createDiv({cls:"model-comparison-card"});r.style.cssText="border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 0.75em; margin-bottom: 0.75em;";let s=r.createDiv({cls:"model-comparison-header"});s.style.cssText="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5em;";let i=s.createEl("strong",{text:e.name});i.style.cssText="font-size: 0.95em;";let a=s.createEl("span",{text:e.badge,cls:"model-comparison-badge"});a.style.cssText="background: var(--text-accent); color: var(--text-on-accent); padding: 0.15em 0.4em; border-radius: 3px; font-size: 0.7em; font-weight: bold;";let o=r.createDiv({cls:"model-comparison-stats"});if(o.style.cssText="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4em 1em; margin-bottom: 0.5em; font-size: 0.85em;",o.createEl("div",{text:`\u2B50 ${e.quality}/5`}),o.createEl("div",{text:`\u26A1 ${e.speed}/5`}),t&&e.sizeMB)o.createEl("div",{text:`\u{1F4E6} ${(e.sizeMB/1e3).toFixed(1)}GB`}),e.ram&&o.createEl("div",{text:`\u{1F4BE} ${e.ram}`});else if(!t&&e.costEstimate&&(o.createEl("div",{text:`\u{1F4B0} ${e.costEstimate}`}),e.cost)){let u=e.cost.charAt(0).toUpperCase()+e.cost.slice(1);o.createEl("div",{text:`\u{1F4B5} ${u}`})}let l=r.createEl("p",{text:e.description,cls:"model-comparison-description"});l.style.cssText="margin: 0.4em 0; color: var(--text-muted); font-size: 0.85em; line-height: 1.4;";let c=r.createDiv({cls:"model-comparison-details"});if(c.style.cssText="display: flex; gap: 1em; margin-top: 0.4em; font-size: 0.8em;",e.pros.length>0){let u=c.createDiv({cls:"model-comparison-pros"});u.style.cssText="flex: 1;",u.createEl("strong",{text:"\u2713 "}),u.appendText(e.pros.join(", "))}if(e.cons.length>0){let u=c.createDiv({cls:"model-comparison-cons"});u.style.cssText="flex: 1; color: var(--text-muted);",u.createEl("strong",{text:"\u2717 "}),u.appendText(e.cons.join(", "))}let d=r.createDiv({cls:"model-comparison-best-for"});return d.style.cssText="margin-top: 0.4em; padding-top: 0.4em; border-top: 1px solid var(--background-modifier-border); font-size: 0.8em; color: var(--text-muted);",d.createEl("strong",{text:"Best for: "}),d.appendText(e.bestFor),r}function op(n,e,t,r=!1){if(t.length===0)return;let s=n.createDiv({cls:"model-comparison-group"});s.style.cssText="margin-bottom: 1.5em;";let i=s.createEl("h5",{text:e});i.style.cssText="margin: 0 0 0.75em 0; font-size: 0.95em; font-weight: 600;";for(let a of t)Vc(s,a,r)}function Aa(n=14){let e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("xmlns",e),t.setAttribute("width",String(n)),t.setAttribute("height",String(n)),t.setAttribute("viewBox","0 0 24 24"),t.setAttribute("fill","none"),t.setAttribute("stroke","currentColor"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round");let r=document.createElementNS(e,"path");return r.setAttribute("d","M20 6L9 17l-5-5"),t.appendChild(r),t}function qn(n=16){let e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("xmlns",e),t.setAttribute("width",String(n)),t.setAttribute("height",String(n)),t.setAttribute("viewBox","0 0 24 24"),t.setAttribute("fill","none"),t.setAttribute("stroke","currentColor"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round");let r=document.createElementNS(e,"circle");r.setAttribute("cx","12"),r.setAttribute("cy","12"),r.setAttribute("r","10"),t.appendChild(r);let s=document.createElementNS(e,"line");s.setAttribute("x1","12"),s.setAttribute("y1","8"),s.setAttribute("x2","12"),s.setAttribute("y2","12"),t.appendChild(s);let i=document.createElementNS(e,"line");return i.setAttribute("x1","12"),i.setAttribute("y1","16"),i.setAttribute("x2","12.01"),i.setAttribute("y2","16"),t.appendChild(i),t}var ss=class extends Ct.Modal{settings;onComplete;constructor(e,t,r,s){super(e),this.settings=r,this.onComplete=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-setup-modal"),e.createEl("h2",{text:"Manage AI models"}),e.createEl("p",{text:"Choose how you want to use AI for idea enhancement:",cls:"ideatr-setup-description"});let t=e.createEl("div",{cls:"ideatr-setup-option"});t.createEl("h3",{text:"Download AI model"});let i=(new be("phi-3.5-mini").getModelConfig().sizeMB/1024).toFixed(1);t.createEl("p",{text:`Download a local AI model (${i} GB for default model) for offline, free AI idea enhancement including classification, expansion, and more. Choose from multiple models optimized for different needs.`});let a=t.createEl("ul",{cls:"ideatr-setup-features"});a.createEl("li",{text:"\u2705 Works offline"}),a.createEl("li",{text:"\u2705 Free to use"}),a.createEl("li",{text:"\u2705 No API keys needed"}),a.createEl("li",{text:`\u26A0\uFE0F Requires ${i} GB download (varies by model)`}),t.createEl("button",{text:"Choose & Download Model",cls:"mod-cta"}).addEventListener("click",()=>this.handleDownloadOption());let l=e.createEl("div",{cls:"ideatr-setup-option"});l.createEl("h3",{text:"Use my API key"}),l.createEl("p",{text:"Use a cloud AI provider (Anthropic, OpenAI, etc.) for better quality and faster responses."});let c=l.createEl("ul",{cls:"ideatr-setup-features"});c.createEl("li",{text:"\u2705 Better quality results"}),c.createEl("li",{text:"\u2705 Faster responses"}),c.createEl("li",{text:"\u2705 No local storage needed"}),c.createEl("li",{text:"\u26A0\uFE0F Requires API key (paid)"}),l.createEl("button",{text:"Enter API key",cls:"mod-cta"}).addEventListener("click",()=>this.handleApiKeyOption());let u=e.createEl("div",{cls:"ideatr-setup-option"});u.createEl("h3",{text:"Skip for Now"}),u.createEl("p",{text:"Continue without AI. You can set up AI later in settings."}),u.createEl("button",{text:"Skip setup",cls:"mod-cancel"}).addEventListener("click",()=>this.handleSkipOption())}async handleDownloadOption(){this.contentEl.empty(),this.contentEl.createEl("h2",{text:"Choose AI model"}),this.contentEl.createEl("p",{text:"Select which model to download. You can change this later in settings.",cls:"model-selection-intro"});let t=new be().getAvailableModels();for(let r of Object.keys(t)){let s=t[r],i=this.contentEl.createDiv({cls:"model-option-card"}),a=ip(s);Vc(i,a,!0);let o=new Ct.Setting(i);o.addButton(l=>{l.setButtonText(`Select ${s.name}`).setCta().onClick(async()=>{let d=r,u=ar(r);if(u.isCompatible){if(u.warning){let h=ct();if(!await Ce(this.app,`${u.warning}

${u.recommendation||""}

${h}

Do you want to proceed?`))return}}else{let h=ct(),p=`${u.warning}

${u.recommendation||""}

${h}

Do you want to proceed anyway?`;if(!await Ce(this.app,p))return}this.settings.localModel=d,await this.startDownload(r)});let c=o.controlEl;if(c){let d=document.createElement("div");d.className="model-status-indicator";let u=document.createElement("span");u.className="model-status-text",u.textContent="Checking...",d.appendChild(u),c.insertBefore(d,c.firstChild),(async()=>{try{let h=new be(r);if(await h.isModelDownloaded()){let f=await h.verifyModelIntegrity();d.empty();let y=document.createElement("span");y.className=`model-status-icon ${f?"model-status-valid":"model-status-invalid"}`,y.title=f?"File verified":"File verification failed";let S=f?Aa(16):qn(16);y.appendChild(S),d.appendChild(y)}else d.empty()}catch(h){console.error("Error verifying model integrity:",h),d.empty();let p=document.createElement("span");p.className="model-status-icon model-status-invalid",p.title="Verification error";let f=qn(16);p.appendChild(f),d.appendChild(p)}})()}})}}async startDownload(e){let t=new be(e),r=new Sa(this.app,t),s=r.close.bind(r);r.close=()=>{s(),t.isModelDownloaded().then(i=>{i&&(this.settings.setupCompleted=!0,this.settings.modelDownloaded=!0,this.settings.llmProvider="llama",this.settings.modelPath=t.getModelPath(),this.onComplete(),this.close())})},r.open()}handleApiKeyOption(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-setup-modal"),e.createEl("h2",{text:"Enter API key"}),e.createEl("p",{text:"Enter your API key for a cloud AI provider. You can configure this later in settings.",cls:"ideatr-setup-description"});let t=e.createEl("div",{cls:"ideatr-setting-item"});t.createEl("label",{text:"Provider:",attr:{for:"ideatr-provider-select"}});let r=t.createEl("select",{attr:{id:"ideatr-provider-select"}});r.createEl("option",{text:"Anthropic (Claude)",attr:{value:"anthropic"}}),r.createEl("option",{text:"OpenAI (GPT)",attr:{value:"openai"}}),r.createEl("option",{text:"Skip for now",attr:{value:"none"}});let s=e.createEl("div",{cls:"ideatr-setting-item"});s.createEl("label",{text:"API Key:",attr:{for:"ideatr-api-key-input"}});let i=s.createEl("input",{attr:{id:"ideatr-api-key-input",type:"password",placeholder:"Enter your API key"}});e.createEl("p",{text:"Note: API keys are stored in plain text in Obsidian settings. Keep your vault secure.",cls:"ideatr-help-text"});let a=e.createEl("div",{cls:"ideatr-button-container"});a.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>{let d=r.value,u=i.value;if(d==="none"){this.handleSkipOption();return}if(!u.trim()){new Ct.Notice("Please enter an API key");return}this.handleApiKeySubmit(u,d)}),a.createEl("button",{text:"Back"}).addEventListener("click",()=>{this.onOpen()}),a.createEl("button",{text:"Cancel",cls:"mod-cancel"}).addEventListener("click",()=>{this.handleSkipOption()})}handleApiKeySubmit(e,t){this.settings.cloudApiKeys||(this.settings.cloudApiKeys={anthropic:"",openai:"",gemini:"",groq:"",openrouter:""}),this.settings.cloudApiKeys[t]=e,this.settings.cloudProvider=t,this.settings.preferCloud=!0,this.settings.llmProvider=t,this.settings.setupCompleted=!0,new Ct.Notice("API key saved. Cloud AI setup complete!"),this.onComplete(),this.close()}handleSkipOption(){this.settings.setupCompleted=!0,this.settings.llmProvider="none",this.onComplete(),this.close(),new Ct.Notice("Setup skipped. You can configure AI later in settings.")}onClose(){let{contentEl:e}=this;e.empty()}};function lp(n){let e=n.cloudApiKeys&&Object.values(n.cloudApiKeys).some(r=>r&&r.length>0),t=n.cloudApiKey&&n.cloudApiKey.length>0;return!n.setupCompleted&&!n.modelDownloaded&&!e&&!t}ir();var Ea=class extends Q{async getDownloadedModels(){let e=[];for(let t of Object.keys(ve))await new be(t).isModelDownloaded()&&e.push(t);return e}display(e){let t=e.createDiv({cls:"settings-section-title"});t.createEl("h2",{text:"AI Configuration"});let r=he(this.app,"getting-started","Learn about AI Configuration");if(t.appendChild(r),new Se.Setting(e).setName("Local AI").setDesc("Use local AI model for idea enhancement (offline, free)").addToggle(s=>s.setValue(this.plugin.settings.llmProvider==="llama").onChange(async i=>{this.plugin.settings.llmProvider=i?"llama":"none",await this.saveSettings(),this.refresh()})),this.plugin.settings.llmProvider==="llama"){new Se.Setting(e).setName("Local AI Model").setDesc('Select which downloaded model to use. Use "Manage AI Models" to download new models or see all available options.').addDropdown(o=>{o.addOption("loading","Loading..."),o.setValue("loading"),o.setDisabled(!0),(async()=>{let l=await this.getDownloadedModels(),c=o.selectEl;for(;c.firstChild;)c.removeChild(c.firstChild);if(l.length===0)o.addOption("none","No models downloaded"),o.setValue("none"),o.setDisabled(!0),new Se.Notice('No models downloaded. Use "Manage AI Models" to download a model.',5e3);else{for(let h of l){let p=ve[h],f=`${p.name} [${p.badge}] (~${(p.sizeMB/1e3).toFixed(1)}GB, ${p.ram} RAM)`;o.addOption(h,f)}let d=this.plugin.settings.localModel||"phi-3.5-mini",u=l.includes(d)?d:l[0];o.setValue(u),o.setDisabled(!1),u!==d&&(this.plugin.settings.localModel=u,this.saveSettings())}})(),o.onChange(async l=>{if(l==="none"||l==="loading")return;let c=l,d=ar(c);if(d.isCompatible){if(d.warning){let u=ct();new Se.Notice(`${d.warning} ${u}`,8e3)}}else{let u=ct(),h=`${d.warning}

${d.recommendation||""}

${u}

Do you want to proceed anyway?`;if(!await Ce(this.app,h)){let f=await this.getDownloadedModels(),y=f.includes(this.plugin.settings.localModel||"phi-3.5-mini")?this.plugin.settings.localModel||"phi-3.5-mini":f[0];o.setValue(y);return}}this.plugin.settings.localModel=c,await this.saveSettings(),this.refresh()})});let s=new be(this.plugin.settings.localModel||"phi-3.5-mini"),i=s.getModelConfig();new Se.Setting(e).setName("Model Information").setDesc(`${i.description}
Size: ${(i.sizeMB/1e3).toFixed(1)}GB | RAM: ${i.ram} | Quality: ${i.quality}/5 | Speed: ${i.speed}/5`).setDisabled(!0);let a=new Se.Setting(e).setName("Model Status").setDisabled(!0);(async()=>{let o=await s.isModelDownloaded(),l=o?`Model downloaded: ${i.name}`:"Model not downloaded";if(o){let c=await s.verifyModelIntegrity(),d=a.descEl;if(d){d.empty(),d.createSpan({text:l+" "});let u=d.createSpan({cls:`model-status-icon ${c?"model-status-valid":"model-status-invalid"}`,attr:{title:c?"File verified":"File verification failed"}}),h=c?Aa(14):qn(14);u.appendChild(h)}}else a.setDesc(l)})(),new Se.Setting(e).setName("Manage AI Models").setDesc("Download a new model, switch between models, or configure cloud AI providers").addButton(o=>o.setButtonText("Manage AI Models").setCta().onClick(async()=>{new ss(this.app,s,this.plugin.settings,async()=>{await this.saveSettings(),this.refresh()}).open()})),new Se.Setting(e).setName("Keep model loaded").setDesc("Keep the AI model loaded in memory (uses ~4GB RAM, but faster responses)").addToggle(o=>o.setValue(this.plugin.settings.keepModelLoaded).onChange(async l=>{this.plugin.settings.keepModelLoaded=l,await this.saveSettings()})),new Se.Setting(e).setName("Preload on startup").setDesc("Automatically load the AI model when Obsidian starts").addToggle(o=>o.setValue(this.plugin.settings.preloadOnStartup).onChange(async l=>{this.plugin.settings.preloadOnStartup=l,await this.saveSettings()})),new Se.Setting(e).setName("Ensure LLM Ready").setDesc("Manually ensure the AI model is ready now. Not needed in most cases (model auto-starts when you use AI features), but helpful if: the model stopped unexpectedly, you want to test your configuration, or you prefer to preload before using features.").addButton(o=>o.setButtonText("Ensure Ready").setCta().onClick(async()=>{o.setDisabled(!0),o.setButtonText("Preparing...");try{await this.plugin.ensureLLMReady(),new Se.Notice("AI model is ready"),setTimeout(()=>{o.setDisabled(!1),o.setButtonText("Ensure Ready")},2e3)}catch{new Se.Notice("Failed to prepare model. Check console for details."),o.setDisabled(!1),o.setButtonText("Ensure Ready")}}))}}};var se=require("obsidian");function P(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t}function w(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}var Wc=function(){let{crypto:n}=globalThis;if(n?.randomUUID)return Wc=n.randomUUID.bind(n),n.randomUUID();let e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^t()&15>>+r/4).toString(16))};function dt(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}var Gn=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){let e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};var _=class extends Error{},ce=class n extends _{constructor(e,t,r,s){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.requestID=s?.get("request-id"),this.error=t}static makeMessage(e,t,r){let s=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new Pt({message:r,cause:Gn(t)});let i=t;return e===400?new is(e,i,r,s):e===401?new as(e,i,r,s):e===403?new os(e,i,r,s):e===404?new ls(e,i,r,s):e===409?new cs(e,i,r,s):e===422?new ds(e,i,r,s):e===429?new us(e,i,r,s):e>=500?new ps(e,i,r,s):new n(e,i,r,s)}},fe=class extends ce{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Pt=class extends ce{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},ns=class extends Pt{constructor({message:e}={}){super({message:e??"Request timed out."})}},is=class extends ce{},as=class extends ce{},os=class extends ce{},ls=class extends ce{},cs=class extends ce{},ds=class extends ce{},us=class extends ce{},ps=class extends ce{};var kf=/^[a-z][a-z0-9+.-]*:/i,cp=n=>kf.test(n),Kc=n=>(Kc=Array.isArray,Kc(n)),Jc=Kc;function Ia(n){return typeof n!="object"?{}:n??{}}function dp(n){if(!n)return!0;for(let e in n)return!1;return!0}function up(n,e){return Object.prototype.hasOwnProperty.call(n,e)}var pp=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new _(`${n} must be an integer`);if(e<0)throw new _(`${n} must be a positive integer`);return e};var Ca=n=>{try{return JSON.parse(n)}catch{return}};var mp=n=>new Promise(e=>setTimeout(e,n));var Rt="0.71.0";var yp=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Lf(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}var Ff=()=>{let n=Lf();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":fp(Deno.build.os),"X-Stainless-Arch":hp(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":fp(globalThis.process.platform??"unknown"),"X-Stainless-Arch":hp(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let e=Df();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Rt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Df(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}var hp=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",fp=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),gp,bp=()=>gp??(gp=Ff());function wp(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Xc(...n){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function Pa(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return Xc({start(){},async pull(t){let{done:r,value:s}=await e.next();r?t.close():t.enqueue(s)},async cancel(){await e.return?.()}})}function zn(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function vp(n){if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await n[Symbol.asyncIterator]().return?.();return}let e=n.getReader(),t=e.cancel();e.releaseLock(),await t}var xp=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});function Ep(n){let e=0;for(let s of n)e+=s.length;let t=new Uint8Array(e),r=0;for(let s of n)t.set(s,r),r+=s.length;return t}var Sp;function Vn(n){let e;return(Sp??(e=new globalThis.TextEncoder,Sp=e.encode.bind(e)))(n)}var Ap;function Qc(n){let e;return(Ap??(e=new globalThis.TextDecoder,Ap=e.decode.bind(e)))(n)}var Pe,Re,ut=class{constructor(){Pe.set(this,void 0),Re.set(this,void 0),P(this,Pe,new Uint8Array,"f"),P(this,Re,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Vn(e):e;P(this,Pe,Ep([w(this,Pe,"f"),t]),"f");let r=[],s;for(;(s=$f(w(this,Pe,"f"),w(this,Re,"f")))!=null;){if(s.carriage&&w(this,Re,"f")==null){P(this,Re,s.index,"f");continue}if(w(this,Re,"f")!=null&&(s.index!==w(this,Re,"f")+1||s.carriage)){r.push(Qc(w(this,Pe,"f").subarray(0,w(this,Re,"f")-1))),P(this,Pe,w(this,Pe,"f").subarray(w(this,Re,"f")),"f"),P(this,Re,null,"f");continue}let i=w(this,Re,"f")!==null?s.preceding-1:s.preceding,a=Qc(w(this,Pe,"f").subarray(0,i));r.push(a),P(this,Pe,w(this,Pe,"f").subarray(s.index),"f"),P(this,Re,null,"f")}return r}flush(){return w(this,Pe,"f").length?this.decode(`
`):[]}};Pe=new WeakMap,Re=new WeakMap;ut.NEWLINE_CHARS=new Set([`
`,"\r"]);ut.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function $f(n,e){for(let s=e??0;s<n.length;s++){if(n[s]===10)return{preceding:s,index:s+1,carriage:!1};if(n[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function Ip(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var _a={off:0,error:200,warn:300,info:400,debug:500},Yc=(n,e,t)=>{if(n){if(up(_a,n))return n;de(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(_a))}`)}};function Wn(){}function Ra(n,e,t){return!e||_a[n]>_a[t]?Wn:e[n].bind(e)}var Bf={error:Wn,warn:Wn,info:Wn,debug:Wn},Cp=new WeakMap;function de(n){let e=n.logger,t=n.logLevel??"off";if(!e)return Bf;let r=Cp.get(e);if(r&&r[0]===t)return r[1];let s={error:Ra("error",e,t),warn:Ra("warn",e,t),info:Ra("info",e,t),debug:Ra("debug",e,t)};return Cp.set(e,[t,s]),s}var pt=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var Kn,Ke=class n{constructor(e,t,r){this.iterator=e,Kn.set(this,void 0),this.controller=t,P(this,Kn,r,"f")}static fromSSEResponse(e,t,r){let s=!1,i=r?de(r):console;async function*a(){if(s)throw new _("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let l of Uf(e,t)){if(l.event==="completion")try{yield JSON.parse(l.data)}catch(c){throw i.error("Could not parse message into JSON:",l.data),i.error("From chunk:",l.raw),c}if(l.event==="message_start"||l.event==="message_delta"||l.event==="message_stop"||l.event==="content_block_start"||l.event==="content_block_delta"||l.event==="content_block_stop")try{yield JSON.parse(l.data)}catch(c){throw i.error("Could not parse message into JSON:",l.data),i.error("From chunk:",l.raw),c}if(l.event!=="ping"&&l.event==="error")throw new ce(void 0,Ca(l.data)??l.data,void 0,e.headers)}o=!0}catch(l){if(dt(l))return;throw l}finally{o||t.abort()}}return new n(a,t,r)}static fromReadableStream(e,t,r){let s=!1;async function*i(){let o=new ut,l=zn(e);for await(let c of l)for(let d of o.decode(c))yield d;for(let c of o.flush())yield c}async function*a(){if(s)throw new _("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let l of i())o||l&&(yield JSON.parse(l));o=!0}catch(l){if(dt(l))return;throw l}finally{o||t.abort()}}return new n(a,t,r)}[(Kn=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){let a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new n(()=>s(e),this.controller,w(this,Kn,"f")),new n(()=>s(t),this.controller,w(this,Kn,"f"))]}toReadableStream(){let e=this,t;return Xc({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:s,done:i}=await t.next();if(i)return r.close();let a=Vn(JSON.stringify(s)+`
`);r.enqueue(a)}catch(s){r.error(s)}},async cancel(){await t.return?.()}})}};async function*Uf(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new _("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new _("Attempted to iterate over a response with no body");let t=new Zc,r=new ut,s=zn(n.body);for await(let i of Hf(s))for(let a of r.decode(i)){let o=t.decode(a);o&&(yield o)}for(let i of r.flush()){let a=t.decode(i);a&&(yield a)}}async function*Hf(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Vn(t):t,s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let i;for(;(i=Ip(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var Zc=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=jf(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}};function jf(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function Ta(n,e){let{response:t,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,a=await(async()=>{if(e.options.stream)return de(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Ke.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let l=t.headers.get("content-type")?.split(";")[0]?.trim();if(l?.includes("application/json")||l?.endsWith("+json")){let u=await t.json();return ed(u,t)}return await t.text()})();return de(n).debug(`[${r}] response parsed`,pt({retryOfRequestLogID:s,url:t.url,status:t.status,body:a,durationMs:Date.now()-i})),a}function ed(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var Jn,dr=class n extends Promise{constructor(e,t,r=Ta){super(s=>{s(null)}),this.responsePromise=t,this.parseResponse=r,Jn.set(this,void 0),P(this,Jn,e,"f")}_thenUnwrap(e){return new n(w(this,Jn,"f"),this.responsePromise,async(t,r)=>ed(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(w(this,Jn,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};Jn=new WeakMap;var Ma,ka=class{constructor(e,t,r,s){Ma.set(this,void 0),P(this,Ma,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new _("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await w(this,Ma,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ma=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Xn=class extends dr{constructor(e,t,r){super(e,t,async(s,i)=>new r(s,i.response,await Ta(s,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},De=class extends ka{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){if(this.options.query?.before_id){let t=this.first_id;return t?{...this.options,query:{...Ia(this.options.query),before_id:t}}:null}let e=this.last_id;return e?{...this.options,query:{...Ia(this.options.query),after_id:e}}:null}};var ms=class extends ka{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.next_page=r.next_page||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.next_page;return e?{...this.options,query:{...Ia(this.options.query),page:e}}:null}};var rd=()=>{if(typeof File>"u"){let{process:n}=globalThis,e=typeof n?.versions?.node=="string"&&parseInt(n.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function ur(n,e,t){return rd(),new File(n,e??"unknown_file",t)}function Qn(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}var sd=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function";var hs=async(n,e)=>({...n,body:await zf(n.body,e)}),Pp=new WeakMap;function Gf(n){let e=typeof n=="function"?n:n.fetch,t=Pp.get(e);if(t)return t;let r=(async()=>{try{let s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return Pp.set(e,r),r}var zf=async(n,e)=>{if(!await Gf(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(n||{}).map(([r,s])=>td(t,r,s))),t},Vf=n=>n instanceof Blob&&"name"in n;var td=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response){let r={},s=t.headers.get("Content-Type");s&&(r={type:s}),n.append(e,ur([await t.blob()],Qn(t),r))}else if(sd(t))n.append(e,ur([await new Response(Pa(t)).blob()],Qn(t)));else if(Vf(t))n.append(e,ur([t],Qn(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(r=>td(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>td(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Rp=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Wf=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Rp(n),Kf=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function La(n,e,t){if(rd(),n=await n,e||(e=Qn(n)),Wf(n))return n instanceof File&&e==null&&t==null?n:ur([await n.arrayBuffer()],e??n.name,{type:n.type,lastModified:n.lastModified,...t});if(Kf(n)){let s=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),ur(await nd(s),e,t)}let r=await nd(n);if(!t?.type){let s=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(t={...t,type:s})}return ur(r,e,t)}async function nd(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Rp(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(sd(n))for await(let t of n)e.push(...await nd(t));else{let t=n?.constructor?.name;throw new Error(`Unexpected data type: ${typeof n}${t?`; constructor: ${t}`:""}${Jf(n)}`)}return e}function Jf(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}var W=class{constructor(e){this._client=e}};var _p=Symbol.for("brand.privateNullableHeaders");function*Qf(n){if(!n)return;if(_p in n){let{values:r,nulls:s}=n;yield*r.entries();for(let i of s)yield[i,null];return}let e=!1,t;n instanceof Headers?t=n.entries():Jc(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let r of t){let s=r[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");let i=Jc(r[1])?r[1]:[r[1]],a=!1;for(let o of i)o!==void 0&&(e&&!a&&(a=!0,yield[s,null]),yield[s,o])}}var L=n=>{let e=new Headers,t=new Set;for(let r of n){let s=new Set;for(let[i,a]of Qf(r)){let o=i.toLowerCase();s.has(o)||(e.delete(i),s.add(o)),a===null?(e.delete(i),t.add(o)):(e.append(i,a),t.delete(o))}}return{[_p]:!0,values:e,nulls:t}};function Mp(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Tp=Object.freeze(Object.create(null)),Yf=(n=Mp)=>function(t,...r){if(t.length===1)return t[0];let s=!1,i=[],a=t.reduce((d,u,h)=>{/[?#]/.test(u)&&(s=!0);let p=r[h],f=(s?encodeURIComponent:n)(""+p);return h!==r.length&&(p==null||typeof p=="object"&&p.toString===Object.getPrototypeOf(Object.getPrototypeOf(p.hasOwnProperty??Tp)??Tp)?.toString)&&(f=p+"",i.push({start:d.length+u.length,length:f.length,error:`Value of type ${Object.prototype.toString.call(p).slice(8,-1)} is not a valid path parameter`})),d+u+(h===r.length?"":f)},""),o=a.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,c;for(;(c=l.exec(o))!==null;)i.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(i.sort((d,u)=>d.start-u.start),i.length>0){let d=0,u=i.reduce((h,p)=>{let f=" ".repeat(p.start-d),y="^".repeat(p.length);return d=p.start+p.length,h+f+y},"");throw new _(`Path parameters result in path with invalid segments:
${i.map(h=>h.error).join(`
`)}
${a}
${u}`)}return a},K=Yf(Mp);var fs=class extends W{list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/files",De,{query:s,...t,headers:L([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},t?.headers])})}delete(e,t={},r){let{betas:s}=t??{};return this._client.delete(K`/v1/files/${e}`,{...r,headers:L([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},r?.headers])})}download(e,t={},r){let{betas:s}=t??{};return this._client.get(K`/v1/files/${e}/content`,{...r,headers:L([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},r?.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},r){let{betas:s}=t??{};return this._client.get(K`/v1/files/${e}`,{...r,headers:L([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},r?.headers])})}upload(e,t){let{betas:r,...s}=e;return this._client.post("/v1/files",hs({body:s,...t,headers:L([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},t?.headers])},this._client))}};var gs=class extends W{retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(K`/v1/models/${e}?beta=true`,{...r,headers:L([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/models?beta=true",De,{query:s,...t,headers:L([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers])})}};var Fa={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192};function id(n,e){return!e||!("parse"in(e.output_format??{}))?{...n,content:n.content.map(t=>t.type==="text"?{...t,parsed:null}:t),parsed_output:null}:ad(n,e)}function ad(n,e){let t=null,r=n.content.map(s=>{if(s.type==="text"){let i=tg(e,s.text);return t===null&&(t=i),{...s,parsed:i}}return s});return{...n,content:r,parsed_output:t}}function tg(n,e){if(n.output_format?.type!=="json_schema")return null;try{return"parse"in n.output_format?n.output_format.parse(e):JSON.parse(e)}catch(t){throw new _(`Failed to parse structured output: ${t}`)}}var rg=n=>{let e=0,t=[];for(;e<n.length;){let r=n[e];if(r==="\\"){e++;continue}if(r==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(r==="["){t.push({type:"paren",value:"["}),e++;continue}if(r==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(r===":"){t.push({type:"separator",value:":"}),e++;continue}if(r===","){t.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let o="",l=!1;for(r=n[++e];r!=='"';){if(e===n.length){l=!0;break}if(r==="\\"){if(e++,e===n.length){l=!0;break}o+=r+n[e],r=n[++e]}else o+=r,r=n[++e]}r=n[++e],l||t.push({type:"string",value:o});continue}if(r&&/\s/.test(r)){e++;continue}let i=/[0-9]/;if(r&&i.test(r)||r==="-"||r==="."){let o="";for(r==="-"&&(o+=r,r=n[++e]);r&&i.test(r)||r===".";)o+=r,r=n[++e];t.push({type:"number",value:o});continue}let a=/[a-z]/i;if(r&&a.test(r)){let o="";for(;r&&a.test(r)&&e!==n.length;)o+=r,r=n[++e];if(o=="true"||o=="false"||o==="null")t.push({type:"name",value:o});else{e++;continue}continue}e++}return t},ys=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),ys(n);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),ys(n);case"string":let r=n[n.length-2];if(r?.type==="delimiter")return n=n.slice(0,n.length-1),ys(n);if(r?.type==="brace"&&r.value==="{")return n=n.slice(0,n.length-1),ys(n);break;case"delimiter":return n=n.slice(0,n.length-1),ys(n);break}return n},sg=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},ng=n=>{let e="";return n.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Da=n=>JSON.parse(ng(sg(ys(rg(n)))));var Oe,_t,bs,Yn,Oa,Zn,ei,Na,ti,mt,ri,$a,Ba,ws,Ua,Ha,od,kp,ja,ld,cd,dd,Lp,Fp="__json_buf";function Dp(n){return n.type==="tool_use"||n.type==="server_tool_use"||n.type==="mcp_tool_use"}var qa=class n{constructor(e){Oe.add(this),this.messages=[],this.receivedMessages=[],_t.set(this,void 0),bs.set(this,null),this.controller=new AbortController,Yn.set(this,void 0),Oa.set(this,()=>{}),Zn.set(this,()=>{}),ei.set(this,void 0),Na.set(this,()=>{}),ti.set(this,()=>{}),mt.set(this,{}),ri.set(this,!1),$a.set(this,!1),Ba.set(this,!1),ws.set(this,!1),Ua.set(this,void 0),Ha.set(this,void 0),ja.set(this,t=>{if(P(this,$a,!0,"f"),dt(t)&&(t=new fe),t instanceof fe)return P(this,Ba,!0,"f"),this._emit("abort",t);if(t instanceof _)return this._emit("error",t);if(t instanceof Error){let r=new _(t.message);return r.cause=t,this._emit("error",r)}return this._emit("error",new _(String(t)))}),P(this,Yn,new Promise((t,r)=>{P(this,Oa,t,"f"),P(this,Zn,r,"f")}),"f"),P(this,ei,new Promise((t,r)=>{P(this,Na,t,"f"),P(this,ti,r,"f")}),"f"),w(this,Yn,"f").catch(()=>{}),w(this,ei,"f").catch(()=>{}),P(this,bs,e,"f")}get response(){return w(this,Ua,"f")}get request_id(){return w(this,Ha,"f")}async withResponse(){let e=await w(this,Yn,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){let s=new n(t);for(let i of t.messages)s._addMessageParam(i);return P(s,bs,{...t,stream:!0},"f"),s._run(()=>s._createMessage(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},w(this,ja,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){let s=r?.signal,i;s&&(s.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),s.addEventListener("abort",i));try{w(this,Oe,"m",ld).call(this);let{response:a,data:o}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(a);for await(let l of o)w(this,Oe,"m",cd).call(this,l);if(o.controller.signal?.aborted)throw new fe;w(this,Oe,"m",dd).call(this)}finally{s&&i&&s.removeEventListener("abort",i)}}_connected(e){this.ended||(P(this,Ua,e,"f"),P(this,Ha,e?.headers.get("request-id"),"f"),w(this,Oa,"f").call(this,e),this._emit("connect"))}get ended(){return w(this,ri,"f")}get errored(){return w(this,$a,"f")}get aborted(){return w(this,Ba,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,mt,"f")[e]||(w(this,mt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=w(this,mt,"f")[e];if(!r)return this;let s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(w(this,mt,"f")[e]||(w(this,mt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{P(this,ws,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){P(this,ws,!0,"f"),await w(this,ei,"f")}get currentMessage(){return w(this,_t,"f")}async finalMessage(){return await this.done(),w(this,Oe,"m",od).call(this)}async finalText(){return await this.done(),w(this,Oe,"m",kp).call(this)}_emit(e,...t){if(w(this,ri,"f"))return;e==="end"&&(P(this,ri,!0,"f"),w(this,Na,"f").call(this));let r=w(this,mt,"f")[e];if(r&&(w(this,mt,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!w(this,ws,"f")&&!r?.length&&Promise.reject(s),w(this,Zn,"f").call(this,s),w(this,ti,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!w(this,ws,"f")&&!r?.length&&Promise.reject(s),w(this,Zn,"f").call(this,s),w(this,ti,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",w(this,Oe,"m",od).call(this))}async _fromReadableStream(e,t){let r=t?.signal,s;r&&(r.aborted&&this.controller.abort(),s=this.controller.abort.bind(this.controller),r.addEventListener("abort",s));try{w(this,Oe,"m",ld).call(this),this._connected(null);let i=Ke.fromReadableStream(e,this.controller);for await(let a of i)w(this,Oe,"m",cd).call(this,a);if(i.controller.signal?.aborted)throw new fe;w(this,Oe,"m",dd).call(this)}finally{r&&s&&r.removeEventListener("abort",s)}}[(_t=new WeakMap,bs=new WeakMap,Yn=new WeakMap,Oa=new WeakMap,Zn=new WeakMap,ei=new WeakMap,Na=new WeakMap,ti=new WeakMap,mt=new WeakMap,ri=new WeakMap,$a=new WeakMap,Ba=new WeakMap,ws=new WeakMap,Ua=new WeakMap,Ha=new WeakMap,ja=new WeakMap,Oe=new WeakSet,od=function(){if(this.receivedMessages.length===0)throw new _("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},kp=function(){if(this.receivedMessages.length===0)throw new _("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new _("stream ended without producing a content block with type=text");return t.join(" ")},ld=function(){this.ended||P(this,_t,void 0,"f")},cd=function(t){if(this.ended)return;let r=w(this,Oe,"m",Lp).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{let s=r.content.at(-1);switch(t.delta.type){case"text_delta":{s.type==="text"&&this._emit("text",t.delta.text,s.text||"");break}case"citations_delta":{s.type==="text"&&this._emit("citation",t.delta.citation,s.citations??[]);break}case"input_json_delta":{Dp(s)&&s.input&&this._emit("inputJson",t.delta.partial_json,s.input);break}case"thinking_delta":{s.type==="thinking"&&this._emit("thinking",t.delta.thinking,s.thinking);break}case"signature_delta":{s.type==="thinking"&&this._emit("signature",s.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(id(r,w(this,bs,"f")),!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{P(this,_t,r,"f");break}case"content_block_start":case"message_delta":break}},dd=function(){if(this.ended)throw new _("stream has ended, this shouldn't happen");let t=w(this,_t,"f");if(!t)throw new _("request ended without sending any chunks");return P(this,_t,void 0,"f"),id(t,w(this,bs,"f"))},Lp=function(t){let r=w(this,_t,"f");if(t.type==="message_start"){if(r)throw new _(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new _(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.container=t.delta.container,r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r.context_management=t.context_management,t.usage.input_tokens!=null&&(r.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(r.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(r.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(r.usage.server_tool_use=t.usage.server_tool_use),r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{let s=r.content.at(t.index);switch(t.delta.type){case"text_delta":{s?.type==="text"&&(r.content[t.index]={...s,text:(s.text||"")+t.delta.text});break}case"citations_delta":{s?.type==="text"&&(r.content[t.index]={...s,citations:[...s.citations??[],t.delta.citation]});break}case"input_json_delta":{if(s&&Dp(s)){let i=s[Fp]||"";i+=t.delta.partial_json;let a={...s};if(Object.defineProperty(a,Fp,{value:i,enumerable:!1,writable:!0}),i)try{a.input=Da(i)}catch(o){let l=new _(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${o}. JSON: ${i}`);w(this,ja,"f").call(this,l)}r.content[t.index]=a}break}case"thinking_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,thinking:s.thinking+t.delta.thinking});break}case"signature_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,signature:t.delta.signature});break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("streamEvent",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ke(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Op=`You have been working on the task described above but have not yet completed it. Write a continuation summary that will allow you (or another instance of yourself) to resume work efficiently in a future context window where the conversation history will be replaced with this summary. Your summary should be structured, concise, and actionable. Include:
1. Task Overview
The user's core request and success criteria
Any clarifications or constraints they specified
2. Current State
What has been completed so far
Files created, modified, or analyzed (with paths if relevant)
Key outputs or artifacts produced
3. Important Discoveries
Technical constraints or requirements uncovered
Decisions made and their rationale
Errors encountered and how they were resolved
What approaches were tried that didn't work (and why)
4. Next Steps
Specific actions needed to complete the task
Any blockers or open questions to resolve
Priority order if multiple steps remain
5. Context to Preserve
User preferences or style requirements
Domain-specific details that aren't obvious
Any promises made to the user
Be concise but complete\u2014err on the side of including information that would prevent duplicate work or repeated mistakes. Write in a way that enables immediate resumption of the task.
Wrap your summary in <summary></summary> tags.`;var si,vs,pr,ne,ni,_e,ht,Tt,ii,Np,ud;function $p(){let n,e;return{promise:new Promise((r,s)=>{n=r,e=s}),resolve:n,reject:e}}var xs=class{constructor(e,t,r){si.add(this),this.client=e,vs.set(this,!1),pr.set(this,!1),ne.set(this,void 0),ni.set(this,void 0),_e.set(this,void 0),ht.set(this,void 0),Tt.set(this,void 0),ii.set(this,0),P(this,ne,{params:{...t,messages:structuredClone(t.messages)}},"f"),P(this,ni,{...r,headers:L([{"x-stainless-helper":"BetaToolRunner"},r?.headers])},"f"),P(this,Tt,$p(),"f")}async*[(vs=new WeakMap,pr=new WeakMap,ne=new WeakMap,ni=new WeakMap,_e=new WeakMap,ht=new WeakMap,Tt=new WeakMap,ii=new WeakMap,si=new WeakSet,Np=async function(){let t=w(this,ne,"f").params.compactionControl;if(!t||!t.enabled)return!1;let r=0;if(w(this,_e,"f")!==void 0)try{let c=await w(this,_e,"f");r=c.usage.input_tokens+(c.usage.cache_creation_input_tokens??0)+(c.usage.cache_read_input_tokens??0)+c.usage.output_tokens}catch{return!1}let s=t.contextTokenThreshold??1e5;if(r<s)return!1;let i=t.model??w(this,ne,"f").params.model,a=t.summaryPrompt??Op,o=w(this,ne,"f").params.messages;if(o[o.length-1].role==="assistant"){let c=o[o.length-1];if(Array.isArray(c.content)){let d=c.content.filter(u=>u.type!=="tool_use");d.length===0?o.pop():c.content=d}}let l=await this.client.beta.messages.create({model:i,messages:[...o,{role:"user",content:[{type:"text",text:a}]}],max_tokens:w(this,ne,"f").params.max_tokens},{headers:{"x-stainless-helper":"compaction"}});if(l.content[0]?.type!=="text")throw new _("Expected text response for compaction");return w(this,ne,"f").params.messages=[{role:"user",content:l.content}],!0},Symbol.asyncIterator)](){var e;if(w(this,vs,"f"))throw new _("Cannot iterate over a consumed stream");P(this,vs,!0,"f"),P(this,pr,!0,"f"),P(this,ht,void 0,"f");try{for(;;){let t;try{if(w(this,ne,"f").params.max_iterations&&w(this,ii,"f")>=w(this,ne,"f").params.max_iterations)break;P(this,pr,!1,"f"),P(this,ht,void 0,"f"),P(this,ii,(e=w(this,ii,"f"),e++,e),"f"),P(this,_e,void 0,"f");let{max_iterations:r,compactionControl:s,...i}=w(this,ne,"f").params;if(i.stream?(t=this.client.beta.messages.stream({...i},w(this,ni,"f")),P(this,_e,t.finalMessage(),"f"),w(this,_e,"f").catch(()=>{}),yield t):(P(this,_e,this.client.beta.messages.create({...i,stream:!1},w(this,ni,"f")),"f"),yield w(this,_e,"f")),!await w(this,si,"m",Np).call(this)){if(!w(this,pr,"f")){let{role:l,content:c}=await w(this,_e,"f");w(this,ne,"f").params.messages.push({role:l,content:c})}let o=await w(this,si,"m",ud).call(this,w(this,ne,"f").params.messages.at(-1));if(o)w(this,ne,"f").params.messages.push(o);else if(!w(this,pr,"f"))break}}finally{t&&t.abort()}}if(!w(this,_e,"f"))throw new _("ToolRunner concluded without a message from the server");w(this,Tt,"f").resolve(await w(this,_e,"f"))}catch(t){throw P(this,vs,!1,"f"),w(this,Tt,"f").promise.catch(()=>{}),w(this,Tt,"f").reject(t),P(this,Tt,$p(),"f"),t}}setMessagesParams(e){typeof e=="function"?w(this,ne,"f").params=e(w(this,ne,"f").params):w(this,ne,"f").params=e,P(this,pr,!0,"f"),P(this,ht,void 0,"f")}async generateToolResponse(){let e=await w(this,_e,"f")??this.params.messages.at(-1);return e?w(this,si,"m",ud).call(this,e):null}done(){return w(this,Tt,"f").promise}async runUntilDone(){if(!w(this,vs,"f"))for await(let e of this);return this.done()}get params(){return w(this,ne,"f").params}pushMessages(...e){this.setMessagesParams(t=>({...t,messages:[...t.messages,...e]}))}then(e,t){return this.runUntilDone().then(e,t)}};ud=async function(e){return w(this,ht,"f")!==void 0?w(this,ht,"f"):(P(this,ht,ag(w(this,ne,"f").params,e),"f"),w(this,ht,"f"))};async function ag(n,e=n.messages.at(-1)){if(!e||e.role!=="assistant"||!e.content||typeof e.content=="string")return null;let t=e.content.filter(s=>s.type==="tool_use");return t.length===0?null:{role:"user",content:await Promise.all(t.map(async s=>{let i=n.tools.find(a=>("name"in a?a.name:a.mcp_server_name)===s.name);if(!i||!("run"in i))return{type:"tool_result",tool_use_id:s.id,content:`Error: Tool '${s.name}' not found`,is_error:!0};try{let a=s.input;"parse"in i&&i.parse&&(a=i.parse(a));let o=await i.run(a);return{type:"tool_result",tool_use_id:s.id,content:o}}catch(a){return{type:"tool_result",tool_use_id:s.id,content:`Error: ${a instanceof Error?a.message:String(a)}`,is_error:!0}}}))}}var Ss=class n{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new ut;for await(let t of this.iterator)for(let r of e.decode(t))yield JSON.parse(r);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new _("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new _("Attempted to iterate over a response with no body");return new n(zn(e.body),t)}};var As=class extends W{create(e,t){let{betas:r,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...t,headers:L([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},t?.headers])})}retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(K`/v1/messages/batches/${e}?beta=true`,{...r,headers:L([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",De,{query:s,...t,headers:L([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},t?.headers])})}delete(e,t={},r){let{betas:s}=t??{};return this._client.delete(K`/v1/messages/batches/${e}?beta=true`,{...r,headers:L([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},r?.headers])})}cancel(e,t={},r){let{betas:s}=t??{};return this._client.post(K`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:L([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},r?.headers])})}async results(e,t={},r){let s=await this.retrieve(e);if(!s.results_url)throw new _(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);let{betas:i}=t??{};return this._client.get(s.results_url,{...r,headers:L([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},r?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((a,o)=>Ss.fromResponse(o.response,o.controller))}};var Bp={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"},Mt=class extends W{constructor(){super(...arguments),this.batches=new As(this._client)}create(e,t){let{betas:r,...s}=e;s.model in Bp&&console.warn(`The model '${s.model}' is deprecated and will reach end-of-life on ${Bp[s.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let i=this._client._options.timeout;if(!s.stream&&i==null){let a=Fa[s.model]??void 0;i=this._client.calculateNonstreamingTimeout(s.max_tokens,a)}return this._client.post("/v1/messages?beta=true",{body:s,timeout:i??6e5,...t,headers:L([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}parse(e,t){return t={...t,headers:L([{"anthropic-beta":[...e.betas??[],"structured-outputs-2025-11-13"].toString()},t?.headers])},this.create(e,t).then(r=>ad(r,e))}stream(e,t){return qa.createMessage(this,e,t)}countTokens(e,t){let{betas:r,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...t,headers:L([{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString()},t?.headers])})}toolRunner(e,t){return new xs(this._client,e,t)}};Mt.Batches=As;Mt.BetaToolRunner=xs;var Es=class extends W{create(e,t={},r){let{betas:s,...i}=t??{};return this._client.post(K`/v1/skills/${e}/versions?beta=true`,hs({body:i,...r,headers:L([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])},this._client))}retrieve(e,t,r){let{skill_id:s,betas:i}=t;return this._client.get(K`/v1/skills/${s}/versions/${e}?beta=true`,{...r,headers:L([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}list(e,t={},r){let{betas:s,...i}=t??{};return this._client.getAPIList(K`/v1/skills/${e}/versions?beta=true`,ms,{query:i,...r,headers:L([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])})}delete(e,t,r){let{skill_id:s,betas:i}=t;return this._client.delete(K`/v1/skills/${s}/versions/${e}?beta=true`,{...r,headers:L([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}};var mr=class extends W{constructor(){super(...arguments),this.versions=new Es(this._client)}create(e={},t){let{betas:r,...s}=e??{};return this._client.post("/v1/skills?beta=true",hs({body:s,...t,headers:L([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},t?.headers])},this._client))}retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(K`/v1/skills/${e}?beta=true`,{...r,headers:L([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/skills?beta=true",ms,{query:s,...t,headers:L([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},t?.headers])})}delete(e,t={},r){let{betas:s}=t??{};return this._client.delete(K`/v1/skills/${e}?beta=true`,{...r,headers:L([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},r?.headers])})}};mr.Versions=Es;var He=class extends W{constructor(){super(...arguments),this.models=new gs(this._client),this.messages=new Mt(this._client),this.files=new fs(this._client),this.skills=new mr(this._client)}};He.Models=gs;He.Messages=Mt;He.Files=fs;He.Skills=mr;var hr=class extends W{create(e,t){let{betas:r,...s}=e;return this._client.post("/v1/complete",{body:s,timeout:this._client._options.timeout??6e5,...t,headers:L([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}};var Ne,kt,ai,Ga,oi,li,za,ci,ft,di,Va,Wa,Is,Ka,Ja,pd,Up,md,hd,fd,gd,Hp,jp="__json_buf";function qp(n){return n.type==="tool_use"||n.type==="server_tool_use"}var Xa=class n{constructor(){Ne.add(this),this.messages=[],this.receivedMessages=[],kt.set(this,void 0),this.controller=new AbortController,ai.set(this,void 0),Ga.set(this,()=>{}),oi.set(this,()=>{}),li.set(this,void 0),za.set(this,()=>{}),ci.set(this,()=>{}),ft.set(this,{}),di.set(this,!1),Va.set(this,!1),Wa.set(this,!1),Is.set(this,!1),Ka.set(this,void 0),Ja.set(this,void 0),md.set(this,e=>{if(P(this,Va,!0,"f"),dt(e)&&(e=new fe),e instanceof fe)return P(this,Wa,!0,"f"),this._emit("abort",e);if(e instanceof _)return this._emit("error",e);if(e instanceof Error){let t=new _(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new _(String(e)))}),P(this,ai,new Promise((e,t)=>{P(this,Ga,e,"f"),P(this,oi,t,"f")}),"f"),P(this,li,new Promise((e,t)=>{P(this,za,e,"f"),P(this,ci,t,"f")}),"f"),w(this,ai,"f").catch(()=>{}),w(this,li,"f").catch(()=>{})}get response(){return w(this,Ka,"f")}get request_id(){return w(this,Ja,"f")}async withResponse(){let e=await w(this,ai,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){let s=new n;for(let i of t.messages)s._addMessageParam(i);return s._run(()=>s._createMessage(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},w(this,md,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){let s=r?.signal,i;s&&(s.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),s.addEventListener("abort",i));try{w(this,Ne,"m",hd).call(this);let{response:a,data:o}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(a);for await(let l of o)w(this,Ne,"m",fd).call(this,l);if(o.controller.signal?.aborted)throw new fe;w(this,Ne,"m",gd).call(this)}finally{s&&i&&s.removeEventListener("abort",i)}}_connected(e){this.ended||(P(this,Ka,e,"f"),P(this,Ja,e?.headers.get("request-id"),"f"),w(this,Ga,"f").call(this,e),this._emit("connect"))}get ended(){return w(this,di,"f")}get errored(){return w(this,Va,"f")}get aborted(){return w(this,Wa,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,ft,"f")[e]||(w(this,ft,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=w(this,ft,"f")[e];if(!r)return this;let s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(w(this,ft,"f")[e]||(w(this,ft,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{P(this,Is,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){P(this,Is,!0,"f"),await w(this,li,"f")}get currentMessage(){return w(this,kt,"f")}async finalMessage(){return await this.done(),w(this,Ne,"m",pd).call(this)}async finalText(){return await this.done(),w(this,Ne,"m",Up).call(this)}_emit(e,...t){if(w(this,di,"f"))return;e==="end"&&(P(this,di,!0,"f"),w(this,za,"f").call(this));let r=w(this,ft,"f")[e];if(r&&(w(this,ft,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!w(this,Is,"f")&&!r?.length&&Promise.reject(s),w(this,oi,"f").call(this,s),w(this,ci,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!w(this,Is,"f")&&!r?.length&&Promise.reject(s),w(this,oi,"f").call(this,s),w(this,ci,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",w(this,Ne,"m",pd).call(this))}async _fromReadableStream(e,t){let r=t?.signal,s;r&&(r.aborted&&this.controller.abort(),s=this.controller.abort.bind(this.controller),r.addEventListener("abort",s));try{w(this,Ne,"m",hd).call(this),this._connected(null);let i=Ke.fromReadableStream(e,this.controller);for await(let a of i)w(this,Ne,"m",fd).call(this,a);if(i.controller.signal?.aborted)throw new fe;w(this,Ne,"m",gd).call(this)}finally{r&&s&&r.removeEventListener("abort",s)}}[(kt=new WeakMap,ai=new WeakMap,Ga=new WeakMap,oi=new WeakMap,li=new WeakMap,za=new WeakMap,ci=new WeakMap,ft=new WeakMap,di=new WeakMap,Va=new WeakMap,Wa=new WeakMap,Is=new WeakMap,Ka=new WeakMap,Ja=new WeakMap,md=new WeakMap,Ne=new WeakSet,pd=function(){if(this.receivedMessages.length===0)throw new _("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Up=function(){if(this.receivedMessages.length===0)throw new _("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new _("stream ended without producing a content block with type=text");return t.join(" ")},hd=function(){this.ended||P(this,kt,void 0,"f")},fd=function(t){if(this.ended)return;let r=w(this,Ne,"m",Hp).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{let s=r.content.at(-1);switch(t.delta.type){case"text_delta":{s.type==="text"&&this._emit("text",t.delta.text,s.text||"");break}case"citations_delta":{s.type==="text"&&this._emit("citation",t.delta.citation,s.citations??[]);break}case"input_json_delta":{qp(s)&&s.input&&this._emit("inputJson",t.delta.partial_json,s.input);break}case"thinking_delta":{s.type==="thinking"&&this._emit("thinking",t.delta.thinking,s.thinking);break}case"signature_delta":{s.type==="thinking"&&this._emit("signature",s.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{P(this,kt,r,"f");break}case"content_block_start":case"message_delta":break}},gd=function(){if(this.ended)throw new _("stream has ended, this shouldn't happen");let t=w(this,kt,"f");if(!t)throw new _("request ended without sending any chunks");return P(this,kt,void 0,"f"),t},Hp=function(t){let r=w(this,kt,"f");if(t.type==="message_start"){if(r)throw new _(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new _(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(r.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(r.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(r.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(r.usage.server_tool_use=t.usage.server_tool_use),r;case"content_block_start":return r.content.push({...t.content_block}),r;case"content_block_delta":{let s=r.content.at(t.index);switch(t.delta.type){case"text_delta":{s?.type==="text"&&(r.content[t.index]={...s,text:(s.text||"")+t.delta.text});break}case"citations_delta":{s?.type==="text"&&(r.content[t.index]={...s,citations:[...s.citations??[],t.delta.citation]});break}case"input_json_delta":{if(s&&qp(s)){let i=s[jp]||"";i+=t.delta.partial_json;let a={...s};Object.defineProperty(a,jp,{value:i,enumerable:!1,writable:!0}),i&&(a.input=Da(i)),r.content[t.index]=a}break}case"thinking_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,thinking:s.thinking+t.delta.thinking});break}case"signature_delta":{s?.type==="thinking"&&(r.content[t.index]={...s,signature:t.delta.signature});break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("streamEvent",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ke(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Cs=class extends W{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(K`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",De,{query:e,...t})}delete(e,t){return this._client.delete(K`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(K`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let r=await this.retrieve(e);if(!r.results_url)throw new _(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);return this._client.get(r.results_url,{...t,headers:L([{Accept:"application/binary"},t?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((s,i)=>Ss.fromResponse(i.response,i.controller))}};var Lt=class extends W{constructor(){super(...arguments),this.batches=new Cs(this._client)}create(e,t){e.model in Gp&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Gp[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let r=this._client._options.timeout;if(!e.stream&&r==null){let s=Fa[e.model]??void 0;r=this._client.calculateNonstreamingTimeout(e.max_tokens,s)}return this._client.post("/v1/messages",{body:e,timeout:r??6e5,...t,stream:e.stream??!1})}stream(e,t){return Xa.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},Gp={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};Lt.Batches=Cs;var fr=class extends W{retrieve(e,t={},r){let{betas:s}=t??{};return this._client.get(K`/v1/models/${e}`,{...r,headers:L([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},r?.headers])})}list(e={},t){let{betas:r,...s}=e??{};return this._client.getAPIList("/v1/models",De,{query:s,...t,headers:L([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers])})}};var ui=n=>{if(typeof globalThis.process<"u")return globalThis.process.env?.[n]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(n)?.trim()};var yd,bd,Qa,zp,Vp="\\n\\nHuman:",Wp="\\n\\nAssistant:",X=class{constructor({baseURL:e=ui("ANTHROPIC_BASE_URL"),apiKey:t=ui("ANTHROPIC_API_KEY")??null,authToken:r=ui("ANTHROPIC_AUTH_TOKEN")??null,...s}={}){yd.add(this),Qa.set(this,void 0);let i={apiKey:t,authToken:r,...s,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&yp())throw new _(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=i.baseURL,this.timeout=i.timeout??bd.DEFAULT_TIMEOUT,this.logger=i.logger??console;let a="warn";this.logLevel=a,this.logLevel=Yc(i.logLevel,"ClientOptions.logLevel",this)??Yc(ui("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??a,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??wp(),P(this,Qa,xp,"f"),this._options=i,this.apiKey=typeof t=="string"?t:null,this.authToken=r}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.get("x-api-key")||e.get("authorization"))&&!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}async authHeaders(e){return L([await this.apiKeyAuth(e),await this.bearerAuth(e)])}async apiKeyAuth(e){if(this.apiKey!=null)return L([{"X-Api-Key":this.apiKey}])}async bearerAuth(e){if(this.authToken!=null)return L([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new _(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${Rt}`}defaultIdempotencyKey(){return`stainless-node-retry-${Wc()}`}makeStatusError(e,t,r,s){return ce.generate(e,t,r,s)}buildURL(e,t,r){let s=!w(this,yd,"m",zp).call(this)&&r||this.baseURL,i=cp(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return dp(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new _("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new dr(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,r){let s=await e,i=s.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(s);let{req:a,url:o,timeout:l}=await this.buildRequest(s,{retryCount:i-t});await this.prepareRequest(a,{url:o,options:s});let c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),d=r===void 0?"":`, retryOf: ${r}`,u=Date.now();if(de(this).debug(`[${c}] sending request`,pt({retryOfRequestLogID:r,method:s.method,url:o,options:s,headers:a.headers})),s.signal?.aborted)throw new fe;let h=new AbortController,p=await this.fetchWithTimeout(o,a,l,h).catch(Gn),f=Date.now();if(p instanceof globalThis.Error){let x=`retrying, ${t} attempts remaining`;if(s.signal?.aborted)throw new fe;let g=dt(p)||/timed? ?out/i.test(String(p)+("cause"in p?String(p.cause):""));if(t)return de(this).info(`[${c}] connection ${g?"timed out":"failed"} - ${x}`),de(this).debug(`[${c}] connection ${g?"timed out":"failed"} (${x})`,pt({retryOfRequestLogID:r,url:o,durationMs:f-u,message:p.message})),this.retryRequest(s,t,r??c);throw de(this).info(`[${c}] connection ${g?"timed out":"failed"} - error; no more retries left`),de(this).debug(`[${c}] connection ${g?"timed out":"failed"} (error; no more retries left)`,pt({retryOfRequestLogID:r,url:o,durationMs:f-u,message:p.message})),g?new ns:new Pt({cause:p})}let y=[...p.headers.entries()].filter(([x])=>x==="request-id").map(([x,g])=>", "+x+": "+JSON.stringify(g)).join(""),S=`[${c}${d}${y}] ${a.method} ${o} ${p.ok?"succeeded":"failed"} with status ${p.status} in ${f-u}ms`;if(!p.ok){let x=await this.shouldRetry(p);if(t&&x){let O=`retrying, ${t} attempts remaining`;return await vp(p.body),de(this).info(`${S} - ${O}`),de(this).debug(`[${c}] response error (${O})`,pt({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,durationMs:f-u})),this.retryRequest(s,t,r??c,p.headers)}let g=x?"error; no more retries left":"error; not retryable";de(this).info(`${S} - ${g}`);let E=await p.text().catch(O=>Gn(O).message),R=Ca(E),M=R?void 0:E;throw de(this).debug(`[${c}] response error (${g})`,pt({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,message:M,durationMs:Date.now()-u})),this.makeStatusError(p.status,R,M,p.headers)}return de(this).info(S),de(this).debug(`[${c}] response start`,pt({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,durationMs:f-u})),{response:p,options:s,controller:h,requestLogID:c,retryOfRequestLogID:r,startTime:u}}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}requestAPIList(e,t){let r=this.makeRequest(t,null,void 0);return new Xn(this,r,e)}async fetchWithTimeout(e,t,r,s){let{signal:i,method:a,...o}=t||{};i&&i.addEventListener("abort",()=>s.abort());let l=setTimeout(()=>s.abort(),r),c=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,d={signal:s.signal,...c?{duplex:"half"}:{},method:"GET",...o};a&&(d.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,d)}finally{clearTimeout(l)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r,s){let i,a=s?.get("retry-after-ms");if(a){let l=parseFloat(a);Number.isNaN(l)||(i=l)}let o=s?.get("retry-after");if(o&&!i){let l=parseFloat(o);Number.isNaN(l)?i=Date.parse(o)-Date.now():i=l*1e3}if(!(i&&0<=i&&i<60*1e3)){let l=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,l)}return await mp(i),this.makeRequest(e,t-1,r)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new _("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}async buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:s,path:i,query:a,defaultBaseURL:o}=r,l=this.buildURL(i,a,o);"timeout"in r&&pp("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let{bodyHeaders:c,body:d}=this.buildBody({options:r}),u=await this.buildHeaders({options:e,method:s,bodyHeaders:c,retryCount:t});return{req:{method:s,headers:u,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&d instanceof globalThis.ReadableStream&&{duplex:"half"},...d&&{body:d},...this.fetchOptions??{},...r.fetchOptions??{}},url:l,timeout:r.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:r,retryCount:s}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let a=L([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...bp(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let r=L([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Pa(e)}:w(this,Qa,"f").call(this,{body:e,headers:r})}};bd=X,Qa=new WeakMap,yd=new WeakSet,zp=function(){return this.baseURL!=="https://api.anthropic.com"};X.Anthropic=bd;X.HUMAN_PROMPT=Vp;X.AI_PROMPT=Wp;X.DEFAULT_TIMEOUT=6e5;X.AnthropicError=_;X.APIError=ce;X.APIConnectionError=Pt;X.APIConnectionTimeoutError=ns;X.APIUserAbortError=fe;X.NotFoundError=ls;X.ConflictError=cs;X.RateLimitError=us;X.BadRequestError=is;X.AuthenticationError=as;X.InternalServerError=ps;X.PermissionDeniedError=os;X.UnprocessableEntityError=ds;X.toFile=La;var Je=class extends X{constructor(){super(...arguments),this.completions=new hr(this),this.messages=new Lt(this),this.models=new fr(this),this.beta=new He(this)}};Je.Completions=hr;Je.Messages=Lt;Je.Models=fr;Je.Beta=He;var pi=class{name="Anthropic";client=null;apiKey;model;constructor(e,t){this.apiKey=e,this.model=t||"claude-3-5-haiku-20241022"}getClient(){if(!this.client&&this.apiKey&&this.apiKey.trim().length>0)try{this.client=new Je({apiKey:this.apiKey})}catch(e){throw m.warn("Failed to initialize Anthropic client:",e),new Error("Failed to initialize Anthropic client")}if(!this.client)throw new Error("Anthropic client not initialized");return this.client}authenticate(e){return Promise.resolve(e.trim().length>0&&e.startsWith("sk-"))}isAvailable(){return this.apiKey.trim().length>0}async classify(e){if(!this.isAvailable())throw new Error("Anthropic provider is not available");let t=this.constructPrompt(e);try{let i=(await this.getClient().messages.create({model:this.model,max_tokens:256,messages:[{role:"user",content:t}]})).content[0];if(i.type!=="text")throw new Error("Unexpected response type from Anthropic API");return this.parseResponse(i.text)}catch(r){let s=r;if(s?.status===429||s?.response?.status===429)throw new Error("Rate limit exceeded. Please try again later.");if(s?.status===401||s?.response?.status===401)throw new Error("Invalid API key. Please check your Anthropic API key.");let i="Unknown error";try{let a=String(r);a!=="[object Object]"?i=a:s?.name&&(i=`${s.name}: API request failed`)}catch{i="Unknown error"}throw new Error(`Anthropic API error: ${i}`)}}constructPrompt(e){return`Classify this idea into one category and suggest 2-4 relevant tags.

Idea: "${e}"

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Rules:
- Choose the single best category
- Tags should be specific and relevant (2-4 tags)
- Use lowercase for category and tags

Example response:
{
  "category": "game",
  "tags": ["rpg", "fantasy", "multiplayer"]
}

Response:`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:r.confidence||.8}}catch(t){return m.warn("Failed to parse Anthropic response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}};function T(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t}function b(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}var wd=function(){let{crypto:n}=globalThis;if(n?.randomUUID)return wd=n.randomUUID.bind(n),n.randomUUID();let e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^t()&15>>+r/4).toString(16))};function mi(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}var hi=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){let e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};var C=class extends Error{},ie=class n extends C{constructor(e,t,r,s){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.requestID=s?.get("x-request-id"),this.error=t;let i=t;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,r){let s=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new Ft({message:r,cause:hi(t)});let i=t?.error;return e===400?new Ps(e,i,r,s):e===401?new Rs(e,i,r,s):e===403?new _s(e,i,r,s):e===404?new Ts(e,i,r,s):e===409?new Ms(e,i,r,s):e===422?new ks(e,i,r,s):e===429?new Ls(e,i,r,s):e>=500?new Fs(e,i,r,s):new n(e,i,r,s)}},re=class extends ie{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Ft=class extends ie{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},Dt=class extends Ft{constructor({message:e}={}){super({message:e??"Request timed out."})}},Ps=class extends ie{},Rs=class extends ie{},_s=class extends ie{},Ts=class extends ie{},Ms=class extends ie{},ks=class extends ie{},Ls=class extends ie{},Fs=class extends ie{},Ds=class extends C{constructor(){super("Could not parse response content as the length limit was reached")}},Os=class extends C{constructor(){super("Could not parse response content as the request was rejected by the content filter")}},Xe=class extends Error{constructor(e){super(e)}};var hg=/^[a-z][a-z0-9+.-]*:/i,Kp=n=>hg.test(n),we=n=>(we=Array.isArray,we(n)),vd=we;function xd(n){return typeof n!="object"?{}:n??{}}function Jp(n){if(!n)return!0;for(let e in n)return!1;return!0}function Xp(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function fi(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var Qp=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new C(`${n} must be an integer`);if(e<0)throw new C(`${n} must be a positive integer`);return e};var Yp=n=>{try{return JSON.parse(n)}catch{return}};var Qe=n=>new Promise(e=>setTimeout(e,n));var Ot="6.9.1";var rm=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function fg(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}var gg=()=>{let n=fg();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ot,"X-Stainless-OS":em(Deno.build.os),"X-Stainless-Arch":Zp(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ot,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ot,"X-Stainless-OS":em(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Zp(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let e=yg();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ot,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ot,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function yg(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}var Zp=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",em=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),tm,sm=()=>tm??(tm=gg());function nm(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Sd(...n){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function Ya(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return Sd({start(){},async pull(t){let{done:r,value:s}=await e.next();r?t.close():t.enqueue(s)},async cancel(){await e.return?.()}})}function Ad(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function im(n){if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await n[Symbol.asyncIterator]().return?.();return}let e=n.getReader(),t=e.cancel();e.releaseLock(),await t}var am=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});var Za="RFC3986",Ed=n=>String(n),eo={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:Ed},Id="RFC1738";var to=(n,e)=>(to=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),to(n,e)),Ye=(()=>{let n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})();var Cd=1024,om=(n,e,t,r,s)=>{if(n.length===0)return n;let i=n;if(typeof n=="symbol"?i=Symbol.prototype.toString.call(n):typeof n!="string"&&(i=String(n)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=Cd){let l=i.length>=Cd?i.slice(o,o+Cd):i,c=[];for(let d=0;d<l.length;++d){let u=l.charCodeAt(d);if(u===45||u===46||u===95||u===126||u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||s===Id&&(u===40||u===41)){c[c.length]=l.charAt(d);continue}if(u<128){c[c.length]=Ye[u];continue}if(u<2048){c[c.length]=Ye[192|u>>6]+Ye[128|u&63];continue}if(u<55296||u>=57344){c[c.length]=Ye[224|u>>12]+Ye[128|u>>6&63]+Ye[128|u&63];continue}d+=1,u=65536+((u&1023)<<10|l.charCodeAt(d)&1023),c[c.length]=Ye[240|u>>18]+Ye[128|u>>12&63]+Ye[128|u>>6&63]+Ye[128|u&63]}a+=c.join("")}return a};function lm(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function Pd(n,e){if(we(n)){let t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}var dm={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},um=function(n,e){Array.prototype.push.apply(n,we(e)?e:[e])},cm,ae={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:om,encodeValuesOnly:!1,format:Za,formatter:Ed,indices:!1,serializeDate(n){return(cm??(cm=Function.prototype.call.bind(Date.prototype.toISOString)))(n)},skipNulls:!1,strictNullHandling:!1};function vg(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}var Rd={};function pm(n,e,t,r,s,i,a,o,l,c,d,u,h,p,f,y,S,x){let g=n,E=x,R=0,M=!1;for(;(E=E.get(Rd))!==void 0&&!M;){let $=E.get(n);if(R+=1,typeof $<"u"){if($===R)throw new RangeError("Cyclic object value");M=!0}typeof E.get(Rd)>"u"&&(R=0)}if(typeof c=="function"?g=c(e,g):g instanceof Date?g=h?.(g):t==="comma"&&we(g)&&(g=Pd(g,function($){return $ instanceof Date?h?.($):$})),g===null){if(i)return l&&!y?l(e,ae.encoder,S,"key",p):e;g=""}if(vg(g)||lm(g)){if(l){let $=y?e:l(e,ae.encoder,S,"key",p);return[f?.($)+"="+f?.(l(g,ae.encoder,S,"value",p))]}return[f?.(e)+"="+f?.(String(g))]}let B=[];if(typeof g>"u")return B;let O;if(t==="comma"&&we(g))y&&l&&(g=Pd(g,l)),O=[{value:g.length>0?g.join(",")||null:void 0}];else if(we(c))O=c;else{let $=Object.keys(g);O=d?$.sort(d):$}let U=o?String(e).replace(/\./g,"%2E"):String(e),q=r&&we(g)&&g.length===1?U+"[]":U;if(s&&we(g)&&g.length===0)return q+"[]";for(let $=0;$<O.length;++$){let G=O[$],ca=typeof G=="object"&&typeof G.value<"u"?G.value:g[G];if(a&&ca===null)continue;let On=u&&o?G.replace(/\./g,"%2E"):G,hf=we(g)?typeof t=="function"?t(q,On):q:q+(u?"."+On:"["+On+"]");x.set(n,R);let Ou=new WeakMap;Ou.set(Rd,x),um(B,pm(ca,hf,t,r,s,i,a,o,t==="comma"&&y&&we(g)?null:l,c,d,u,h,p,f,y,S,Ou))}return B}function xg(n=ae){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=n.charset||ae.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Za;if(typeof n.format<"u"){if(!to(eo,n.format))throw new TypeError("Unknown format option provided.");t=n.format}let r=eo[t],s=ae.filter;(typeof n.filter=="function"||we(n.filter))&&(s=n.filter);let i;if(n.arrayFormat&&n.arrayFormat in dm?i=n.arrayFormat:"indices"in n?i=n.indices?"indices":"repeat":i=ae.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let a=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:ae.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:ae.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:ae.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:ae.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?ae.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:ae.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:ae.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:ae.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:ae.encodeValuesOnly,filter:s,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:ae.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:ae.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:ae.strictNullHandling}}function _d(n,e={}){let t=n,r=xg(e),s,i;typeof r.filter=="function"?(i=r.filter,t=i("",t)):we(r.filter)&&(i=r.filter,s=i);let a=[];if(typeof t!="object"||t===null)return"";let o=dm[r.arrayFormat],l=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(t)),r.sort&&s.sort(r.sort);let c=new WeakMap;for(let h=0;h<s.length;++h){let p=s[h];r.skipNulls&&t[p]===null||um(a,pm(t[p],p,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}let d=a.join(r.delimiter),u=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?u+="utf8=%26%2310003%3B&":u+="utf8=%E2%9C%93&"),d.length>0?u+d:""}function fm(n){let e=0;for(let s of n)e+=s.length;let t=new Uint8Array(e),r=0;for(let s of n)t.set(s,r),r+=s.length;return t}var mm;function Ns(n){let e;return(mm??(e=new globalThis.TextEncoder,mm=e.encode.bind(e)))(n)}var hm;function Td(n){let e;return(hm??(e=new globalThis.TextDecoder,hm=e.decode.bind(e)))(n)}var Te,Me,gr=class{constructor(){Te.set(this,void 0),Me.set(this,void 0),T(this,Te,new Uint8Array,"f"),T(this,Me,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Ns(e):e;T(this,Te,fm([b(this,Te,"f"),t]),"f");let r=[],s;for(;(s=Ag(b(this,Te,"f"),b(this,Me,"f")))!=null;){if(s.carriage&&b(this,Me,"f")==null){T(this,Me,s.index,"f");continue}if(b(this,Me,"f")!=null&&(s.index!==b(this,Me,"f")+1||s.carriage)){r.push(Td(b(this,Te,"f").subarray(0,b(this,Me,"f")-1))),T(this,Te,b(this,Te,"f").subarray(b(this,Me,"f")),"f"),T(this,Me,null,"f");continue}let i=b(this,Me,"f")!==null?s.preceding-1:s.preceding,a=Td(b(this,Te,"f").subarray(0,i));r.push(a),T(this,Te,b(this,Te,"f").subarray(s.index),"f"),T(this,Me,null,"f")}return r}flush(){return b(this,Te,"f").length?this.decode(`
`):[]}};Te=new WeakMap,Me=new WeakMap;gr.NEWLINE_CHARS=new Set([`
`,"\r"]);gr.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Ag(n,e){for(let s=e??0;s<n.length;s++){if(n[s]===10)return{preceding:s,index:s+1,carriage:!1};if(n[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function gm(n){for(let r=0;r<n.length-1;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var so={off:0,error:200,warn:300,info:400,debug:500},Md=(n,e,t)=>{if(n){if(Xp(so,n))return n;Z(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(so))}`)}};function gi(){}function ro(n,e,t){return!e||so[n]>so[t]?gi:e[n].bind(e)}var Eg={error:gi,warn:gi,info:gi,debug:gi},ym=new WeakMap;function Z(n){let e=n.logger,t=n.logLevel??"off";if(!e)return Eg;let r=ym.get(e);if(r&&r[0]===t)return r[1];let s={error:ro("error",e,t),warn:ro("warn",e,t),info:ro("info",e,t),debug:ro("debug",e,t)};return ym.set(e,[t,s]),s}var gt=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var yi,Ze=class n{constructor(e,t,r){this.iterator=e,yi.set(this,void 0),this.controller=t,T(this,yi,r,"f")}static fromSSEResponse(e,t,r){let s=!1,i=r?Z(r):console;async function*a(){if(s)throw new C("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let l of Ig(e,t))if(!o){if(l.data.startsWith("[DONE]")){o=!0;continue}if(l.event===null||!l.event.startsWith("thread.")){let c;try{c=JSON.parse(l.data)}catch(d){throw i.error("Could not parse message into JSON:",l.data),i.error("From chunk:",l.raw),d}if(c&&c.error)throw new ie(void 0,c.error,void 0,e.headers);yield c}else{let c;try{c=JSON.parse(l.data)}catch(d){throw console.error("Could not parse message into JSON:",l.data),console.error("From chunk:",l.raw),d}if(l.event=="error")throw new ie(void 0,c.error,c.message,void 0);yield{event:l.event,data:c}}}o=!0}catch(l){if(mi(l))return;throw l}finally{o||t.abort()}}return new n(a,t,r)}static fromReadableStream(e,t,r){let s=!1;async function*i(){let o=new gr,l=Ad(e);for await(let c of l)for(let d of o.decode(c))yield d;for(let c of o.flush())yield c}async function*a(){if(s)throw new C("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let l of i())o||l&&(yield JSON.parse(l));o=!0}catch(l){if(mi(l))return;throw l}finally{o||t.abort()}}return new n(a,t,r)}[(yi=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){let a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new n(()=>s(e),this.controller,b(this,yi,"f")),new n(()=>s(t),this.controller,b(this,yi,"f"))]}toReadableStream(){let e=this,t;return Sd({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:s,done:i}=await t.next();if(i)return r.close();let a=Ns(JSON.stringify(s)+`
`);r.enqueue(a)}catch(s){r.error(s)}},async cancel(){await t.return?.()}})}};async function*Ig(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new C("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new C("Attempted to iterate over a response with no body");let t=new kd,r=new gr,s=Ad(n.body);for await(let i of Cg(s))for(let a of r.decode(i)){let o=t.decode(a);o&&(yield o)}for(let i of r.flush()){let a=t.decode(i);a&&(yield a)}}async function*Cg(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Ns(t):t,s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let i;for(;(i=gm(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var kd=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=Pg(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}};function Pg(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function no(n,e){let{response:t,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,a=await(async()=>{if(e.options.stream)return Z(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,n):Ze.fromSSEResponse(t,e.controller,n);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let l=t.headers.get("content-type")?.split(";")[0]?.trim();if(l?.includes("application/json")||l?.endsWith("+json")){let u=await t.json();return Ld(u,t)}return await t.text()})();return Z(n).debug(`[${r}] response parsed`,gt({retryOfRequestLogID:s,url:t.url,status:t.status,body:a,durationMs:Date.now()-i})),a}function Ld(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var bi,yr=class n extends Promise{constructor(e,t,r=no){super(s=>{s(null)}),this.responsePromise=t,this.parseResponse=r,bi.set(this,void 0),T(this,bi,e,"f")}_thenUnwrap(e){return new n(b(this,bi,"f"),this.responsePromise,async(t,r)=>Ld(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(b(this,bi,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};bi=new WeakMap;var io,wi=class{constructor(e,t,r,s){io.set(this,void 0),T(this,io,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new C("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await b(this,io,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(io=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},vi=class extends yr{constructor(e,t,r){super(e,t,async(s,i)=>new r(s,i.response,await no(s,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},et=class extends wi{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}},D=class extends wi{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...xd(this.options.query),after:t}}:null}},yt=class extends wi{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.last_id=r.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.last_id;return e?{...this.options,query:{...xd(this.options.query),after:e}}:null}};var Od=()=>{if(typeof File>"u"){let{process:n}=globalThis,e=typeof n?.versions?.node=="string"&&parseInt(n.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function $s(n,e,t){return Od(),new File(n,e??"unknown_file",t)}function xi(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}var ao=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Nd=async(n,e)=>Fd(n.body)?{...n,body:await wm(n.body,e)}:n,ke=async(n,e)=>({...n,body:await wm(n.body,e)}),bm=new WeakMap;function _g(n){let e=typeof n=="function"?n:n.fetch,t=bm.get(e);if(t)return t;let r=(async()=>{try{let s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return bm.set(e,r),r}var wm=async(n,e)=>{if(!await _g(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(n||{}).map(([r,s])=>Dd(t,r,s))),t},vm=n=>n instanceof Blob&&"name"in n,Tg=n=>typeof n=="object"&&n!==null&&(n instanceof Response||ao(n)||vm(n)),Fd=n=>{if(Tg(n))return!0;if(Array.isArray(n))return n.some(Fd);if(n&&typeof n=="object"){for(let e in n)if(Fd(n[e]))return!0}return!1},Dd=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response)n.append(e,$s([await t.blob()],xi(t)));else if(ao(t))n.append(e,$s([await new Response(Ya(t)).blob()],xi(t)));else if(vm(t))n.append(e,t,xi(t));else if(Array.isArray(t))await Promise.all(t.map(r=>Dd(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>Dd(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var xm=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Mg=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&xm(n),kg=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function oo(n,e,t){if(Od(),n=await n,Mg(n))return n instanceof File?n:$s([await n.arrayBuffer()],n.name);if(kg(n)){let s=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),$s(await $d(s),e,t)}let r=await $d(n);if(e||(e=xi(n)),!t?.type){let s=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(t={...t,type:s})}return $s(r,e,t)}async function $d(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(xm(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(ao(n))for await(let t of n)e.push(...await $d(t));else{let t=n?.constructor?.name;throw new Error(`Unexpected data type: ${typeof n}${t?`; constructor: ${t}`:""}${Lg(n)}`)}return e}function Lg(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}var A=class{constructor(e){this._client=e}};function Am(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Sm=Object.freeze(Object.create(null)),Dg=(n=Am)=>function(t,...r){if(t.length===1)return t[0];let s=!1,i=[],a=t.reduce((d,u,h)=>{/[?#]/.test(u)&&(s=!0);let p=r[h],f=(s?encodeURIComponent:n)(""+p);return h!==r.length&&(p==null||typeof p=="object"&&p.toString===Object.getPrototypeOf(Object.getPrototypeOf(p.hasOwnProperty??Sm)??Sm)?.toString)&&(f=p+"",i.push({start:d.length+u.length,length:f.length,error:`Value of type ${Object.prototype.toString.call(p).slice(8,-1)} is not a valid path parameter`})),d+u+(h===r.length?"":f)},""),o=a.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,c;for(;(c=l.exec(o))!==null;)i.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(i.sort((d,u)=>d.start-u.start),i.length>0){let d=0,u=i.reduce((h,p)=>{let f=" ".repeat(p.start-d),y="^".repeat(p.length);return d=p.start+p.length,h+f+y},"");throw new C(`Path parameters result in path with invalid segments:
${i.map(h=>h.error).join(`
`)}
${a}
${u}`)}return a},v=Dg(Am);var br=class extends A{list(e,t={},r){return this._client.getAPIList(v`/chat/completions/${e}/messages`,D,{query:t,...r})}};function Si(n){return n!==void 0&&"function"in n&&n.function!==void 0}function Ai(n){return n?.$brand==="auto-parseable-response-format"}function wr(n){return n?.$brand==="auto-parseable-tool"}function Em(n,e){return!e||!Bd(e)?{...n,choices:n.choices.map(t=>(Cm(t.message.tool_calls),{...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Ei(n,e)}function Ei(n,e){let t=n.choices.map(r=>{if(r.finish_reason==="length")throw new Ds;if(r.finish_reason==="content_filter")throw new Os;return Cm(r.message.tool_calls),{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:r.message.tool_calls?.map(s=>Bg(e,s))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?$g(e,r.message.content):null}}});return{...n,choices:t}}function $g(n,e){return n.response_format?.type!=="json_schema"?null:n.response_format?.type==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function Bg(n,e){let t=n.tools?.find(r=>Si(r)&&r.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:wr(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function Im(n,e){if(!n||!("tools"in n)||!n.tools)return!1;let t=n.tools?.find(r=>Si(r)&&r.function?.name===e.function.name);return Si(t)&&(wr(t)||t?.function.strict||!1)}function Bd(n){return Ai(n.response_format)?!0:n.tools?.some(e=>wr(e)||e.type==="function"&&e.function.strict===!0)??!1}function Cm(n){for(let e of n||[])if(e.type!=="function")throw new C(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function Pm(n){for(let e of n??[]){if(e.type!=="function")throw new C(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new C(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Bs=n=>n?.role==="assistant",Ud=n=>n?.role==="tool";var Hd,lo,co,Ii,Ci,uo,Pi,bt,Ri,po,mo,Us,Rm,Nt=class{constructor(){Hd.add(this),this.controller=new AbortController,lo.set(this,void 0),co.set(this,()=>{}),Ii.set(this,()=>{}),Ci.set(this,void 0),uo.set(this,()=>{}),Pi.set(this,()=>{}),bt.set(this,{}),Ri.set(this,!1),po.set(this,!1),mo.set(this,!1),Us.set(this,!1),T(this,lo,new Promise((e,t)=>{T(this,co,e,"f"),T(this,Ii,t,"f")}),"f"),T(this,Ci,new Promise((e,t)=>{T(this,uo,e,"f"),T(this,Pi,t,"f")}),"f"),b(this,lo,"f").catch(()=>{}),b(this,Ci,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},b(this,Hd,"m",Rm).bind(this))},0)}_connected(){this.ended||(b(this,co,"f").call(this),this._emit("connect"))}get ended(){return b(this,Ri,"f")}get errored(){return b(this,po,"f")}get aborted(){return b(this,mo,"f")}abort(){this.controller.abort()}on(e,t){return(b(this,bt,"f")[e]||(b(this,bt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=b(this,bt,"f")[e];if(!r)return this;let s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(b(this,bt,"f")[e]||(b(this,bt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{T(this,Us,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){T(this,Us,!0,"f"),await b(this,Ci,"f")}_emit(e,...t){if(b(this,Ri,"f"))return;e==="end"&&(T(this,Ri,!0,"f"),b(this,uo,"f").call(this));let r=b(this,bt,"f")[e];if(r&&(b(this,bt,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!b(this,Us,"f")&&!r?.length&&Promise.reject(s),b(this,Ii,"f").call(this,s),b(this,Pi,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!b(this,Us,"f")&&!r?.length&&Promise.reject(s),b(this,Ii,"f").call(this,s),b(this,Pi,"f").call(this,s),this._emit("end")}}_emitFinal(){}};lo=new WeakMap,co=new WeakMap,Ii=new WeakMap,Ci=new WeakMap,uo=new WeakMap,Pi=new WeakMap,bt=new WeakMap,Ri=new WeakMap,po=new WeakMap,mo=new WeakMap,Us=new WeakMap,Hd=new WeakSet,Rm=function(e){if(T(this,po,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new re),e instanceof re)return T(this,mo,!0,"f"),this._emit("abort",e);if(e instanceof C)return this._emit("error",e);if(e instanceof Error){let t=new C(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new C(String(e)))};function _m(n){return typeof n.parse=="function"}var xe,jd,ho,qd,Gd,zd,Tm,Mm,Ug=10,Hs=class extends Nt{constructor(){super(...arguments),xe.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),Ud(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Bs(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionToolCall",r.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new C("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),b(this,xe,"m",jd).call(this)}async finalMessage(){return await this.done(),b(this,xe,"m",ho).call(this)}async finalFunctionToolCall(){return await this.done(),b(this,xe,"m",qd).call(this)}async finalFunctionToolCallResult(){return await this.done(),b(this,xe,"m",Gd).call(this)}async totalUsage(){return await this.done(),b(this,xe,"m",zd).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=b(this,xe,"m",ho).call(this);t&&this._emit("finalMessage",t);let r=b(this,xe,"m",jd).call(this);r&&this._emit("finalContent",r);let s=b(this,xe,"m",qd).call(this);s&&this._emit("finalFunctionToolCall",s);let i=b(this,xe,"m",Gd).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",b(this,xe,"m",zd).call(this))}async _createChatCompletion(e,t,r){let s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),b(this,xe,"m",Tm).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Ei(i,t))}async _runChatCompletion(e,t,r){for(let s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runTools(e,t,r){let s="tool",{tool_choice:i="auto",stream:a,...o}=t,l=typeof i!="string"&&i.type==="function"&&i?.function?.name,{maxChatCompletions:c=Ug}=r||{},d=t.tools.map(p=>{if(wr(p)){if(!p.$callback)throw new C("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:p.$callback,name:p.function.name,description:p.function.description||"",parameters:p.function.parameters,parse:p.$parseRaw,strict:!0}}}return p}),u={};for(let p of d)p.type==="function"&&(u[p.function.name||p.function.function.name]=p.function);let h="tools"in t?d.map(p=>p.type==="function"?{type:"function",function:{name:p.function.name||p.function.function.name,parameters:p.function.parameters,description:p.function.description,strict:p.function.strict}}:p):void 0;for(let p of t.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){let y=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},r)).choices[0]?.message;if(!y)throw new C("missing message in ChatCompletion response");if(!y.tool_calls?.length)return;for(let S of y.tool_calls){if(S.type!=="function")continue;let x=S.id,{name:g,arguments:E}=S.function,R=u[g];if(R){if(l&&l!==g){let U=`Invalid tool_call: ${JSON.stringify(g)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:s,tool_call_id:x,content:U});continue}}else{let U=`Invalid tool_call: ${JSON.stringify(g)}. Available options are: ${Object.keys(u).map(q=>JSON.stringify(q)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:x,content:U});continue}let M;try{M=_m(R)?await R.parse(E):E}catch(U){let q=U instanceof Error?U.message:String(U);this._addMessage({role:s,tool_call_id:x,content:q});continue}let B=await R.function(M,this),O=b(this,xe,"m",Mm).call(this,B);if(this._addMessage({role:s,tool_call_id:x,content:O}),l)return}}}};xe=new WeakSet,jd=function(){return b(this,xe,"m",ho).call(this).content??null},ho=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(Bs(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new C("stream ended without producing a ChatCompletionMessage with role=assistant")},qd=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Bs(t)&&t?.tool_calls?.length)return t.tool_calls.filter(r=>r.type==="function").at(-1)?.function}},Gd=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Ud(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>r.role==="assistant"&&r.tool_calls?.some(s=>s.type==="function"&&s.id===t.tool_call_id)))return t.content}},zd=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Tm=function(e){if(e.n!=null&&e.n>1)throw new C("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Mm=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var _i=class n extends Hs{static runTools(e,t,r){let s=new n,i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e,t=!0){super._addMessage(e,t),Bs(e)&&e.content&&this._emit("content",e.content)}};var ue={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},Vd=class extends Error{},Wd=class extends Error{};function Hg(n,e=ue.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return jg(n.trim(),e)}var jg=(n,e)=>{let t=n.length,r=0,s=h=>{throw new Vd(`${h} at position ${r}`)},i=h=>{throw new Wd(`${h} at position ${r}`)},a=()=>(u(),r>=t&&s("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?l():n[r]==="["?c():n.substring(r,r+4)==="null"||ue.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||ue.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||ue.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||ue.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||ue.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||ue.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):d()),o=()=>{let h=r,p=!1;for(r++;r<t&&(n[r]!=='"'||p&&n[r-1]==="\\");)p=n[r]==="\\"?!p:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(p)))}catch(f){i(String(f))}else if(ue.STR&e)try{return JSON.parse(n.substring(h,r-Number(p))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},l=()=>{r++,u();let h={};try{for(;n[r]!=="}";){if(u(),r>=t&&ue.OBJ&e)return h;let p=o();u(),r++;try{let f=a();Object.defineProperty(h,p,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(ue.OBJ&e)return h;throw f}u(),n[r]===","&&r++}}catch{if(ue.OBJ&e)return h;s("Expected '}' at end of object")}return r++,h},c=()=>{r++;let h=[];try{for(;n[r]!=="]";)h.push(a()),u(),n[r]===","&&r++}catch{if(ue.ARR&e)return h;s("Expected ']' at end of array")}return r++,h},d=()=>{if(r===0){n==="-"&&ue.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n)}catch(p){if(ue.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}i(String(p))}}let h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(ue.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch{n.substring(h,r)==="-"&&ue.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(f){i(String(f))}}},u=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return a()},Kd=n=>Hg(n,ue.ALL^ue.NUM);var oe,wt,js,$t,Jd,fo,Xd,Qd,Yd,go,Zd,km,vr=class n extends Hs{constructor(e){super(),oe.add(this),wt.set(this,void 0),js.set(this,void 0),$t.set(this,void 0),T(this,wt,e,"f"),T(this,js,[],"f")}get currentChatCompletionSnapshot(){return b(this,$t,"f")}static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let s=new n(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){super._createChatCompletion;let s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),b(this,oe,"m",Jd).call(this);let i=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let a of i)b(this,oe,"m",Xd).call(this,a);if(i.controller.signal?.aborted)throw new re;return this._addChatCompletion(b(this,oe,"m",go).call(this))}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),b(this,oe,"m",Jd).call(this),this._connected();let s=Ze.fromReadableStream(e,this.controller),i;for await(let a of s)i&&i!==a.id&&this._addChatCompletion(b(this,oe,"m",go).call(this)),b(this,oe,"m",Xd).call(this,a),i=a.id;if(s.controller.signal?.aborted)throw new re;return this._addChatCompletion(b(this,oe,"m",go).call(this))}[(wt=new WeakMap,js=new WeakMap,$t=new WeakMap,oe=new WeakSet,Jd=function(){this.ended||T(this,$t,void 0,"f")},fo=function(t){let r=b(this,js,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},b(this,js,"f")[t.index]=r,r)},Xd=function(t){if(this.ended)return;let r=b(this,oe,"m",km).call(this,t);this._emit("chunk",t,r);for(let s of t.choices){let i=r.choices[s.index];s.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",s.delta.content,i.message.content),this._emit("content.delta",{delta:s.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),s.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:s.delta.refusal,snapshot:i.message.refusal}),s.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:s.logprobs?.content,snapshot:i.logprobs?.content??[]}),s.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:s.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});let a=b(this,oe,"m",fo).call(this,i);i.finish_reason&&(b(this,oe,"m",Yd).call(this,i),a.current_tool_call_index!=null&&b(this,oe,"m",Qd).call(this,i,a.current_tool_call_index));for(let o of s.delta.tool_calls??[])a.current_tool_call_index!==o.index&&(b(this,oe,"m",Yd).call(this,i),a.current_tool_call_index!=null&&b(this,oe,"m",Qd).call(this,i,a.current_tool_call_index)),a.current_tool_call_index=o.index;for(let o of s.delta.tool_calls??[]){let l=i.message.tool_calls?.[o.index];l?.type&&(l?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:l.function?.name,index:o.index,arguments:l.function.arguments,parsed_arguments:l.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(l?.type,void 0))}}},Qd=function(t,r){if(b(this,oe,"m",fo).call(this,t).done_tool_calls.has(r))return;let i=t.message.tool_calls?.[r];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){let a=b(this,wt,"f")?.tools?.find(o=>Si(o)&&o.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:r,arguments:i.function.arguments,parsed_arguments:wr(a)?a.$parseRaw(i.function.arguments):a?.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Yd=function(t){let r=b(this,oe,"m",fo).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;let s=b(this,oe,"m",Zd).call(this);this._emit("content.done",{content:t.message.content,parsed:s?s.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},go=function(){if(this.ended)throw new C("stream has ended, this shouldn't happen");let t=b(this,$t,"f");if(!t)throw new C("request ended without sending any chunks");return T(this,$t,void 0,"f"),T(this,js,[],"f"),qg(t,b(this,wt,"f"))},Zd=function(){let t=b(this,wt,"f")?.response_format;return Ai(t)?t:null},km=function(t){var r,s,i,a;let o=b(this,$t,"f"),{choices:l,...c}=t;o?Object.assign(o,c):o=T(this,$t,{...c,choices:[]},"f");for(let{delta:d,finish_reason:u,index:h,logprobs:p=null,...f}of t.choices){let y=o.choices[h];if(y||(y=o.choices[h]={finish_reason:u,index:h,message:{},logprobs:p,...f}),p)if(!y.logprobs)y.logprobs=Object.assign({},p);else{let{content:B,refusal:O,...U}=p;Object.assign(y.logprobs,U),B&&((r=y.logprobs).content??(r.content=[]),y.logprobs.content.push(...B)),O&&((s=y.logprobs).refusal??(s.refusal=[]),y.logprobs.refusal.push(...O))}if(u&&(y.finish_reason=u,b(this,wt,"f")&&Bd(b(this,wt,"f")))){if(u==="length")throw new Ds;if(u==="content_filter")throw new Os}if(Object.assign(y,f),!d)continue;let{content:S,refusal:x,function_call:g,role:E,tool_calls:R,...M}=d;if(Object.assign(y.message,M),x&&(y.message.refusal=(y.message.refusal||"")+x),E&&(y.message.role=E),g&&(y.message.function_call?(g.name&&(y.message.function_call.name=g.name),g.arguments&&((i=y.message.function_call).arguments??(i.arguments=""),y.message.function_call.arguments+=g.arguments)):y.message.function_call=g),S&&(y.message.content=(y.message.content||"")+S,!y.message.refusal&&b(this,oe,"m",Zd).call(this)&&(y.message.parsed=Kd(y.message.content))),R){y.message.tool_calls||(y.message.tool_calls=[]);for(let{index:B,id:O,type:U,function:q,...$}of R){let G=(a=y.message.tool_calls)[B]??(a[B]={});Object.assign(G,$),O&&(G.id=O),U&&(G.type=U),q&&(G.function??(G.function={name:q.name??"",arguments:""})),q?.name&&(G.function.name=q.name),q?.arguments&&(G.function.arguments+=q.arguments,Im(b(this,wt,"f"),G)&&(G.function.parsed_arguments=Kd(G.function.arguments)))}}}return o},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ze(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function qg(n,e){let{id:t,choices:r,created:s,model:i,system_fingerprint:a,...o}=n,l={...o,id:t,choices:r.map(({message:c,finish_reason:d,index:u,logprobs:h,...p})=>{if(!d)throw new C(`missing finish_reason for choice ${u}`);let{content:f=null,function_call:y,tool_calls:S,...x}=c,g=c.role;if(!g)throw new C(`missing role for choice ${u}`);if(y){let{arguments:E,name:R}=y;if(E==null)throw new C(`missing function_call.arguments for choice ${u}`);if(!R)throw new C(`missing function_call.name for choice ${u}`);return{...p,message:{content:f,function_call:{arguments:E,name:R},role:g,refusal:c.refusal??null},finish_reason:d,index:u,logprobs:h}}return S?{...p,index:u,finish_reason:d,logprobs:h,message:{...x,role:g,content:f,refusal:c.refusal??null,tool_calls:S.map((E,R)=>{let{function:M,type:B,id:O,...U}=E,{arguments:q,name:$,...G}=M||{};if(O==null)throw new C(`missing choices[${u}].tool_calls[${R}].id
${yo(n)}`);if(B==null)throw new C(`missing choices[${u}].tool_calls[${R}].type
${yo(n)}`);if($==null)throw new C(`missing choices[${u}].tool_calls[${R}].function.name
${yo(n)}`);if(q==null)throw new C(`missing choices[${u}].tool_calls[${R}].function.arguments
${yo(n)}`);return{...U,id:O,type:B,function:{...G,name:$,arguments:q}}})}}:{...p,message:{...x,content:f,role:g,refusal:c.refusal??null},finish_reason:d,index:u,logprobs:h}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return Em(l,e)}function yo(n){return JSON.stringify(n)}var Ti=class n extends vr{static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,r){let s=new n(t),i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}};var vt=class extends A{constructor(){super(...arguments),this.messages=new br(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(v`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(v`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/chat/completions",D,{query:e,...t})}delete(e,t){return this._client.delete(v`/chat/completions/${e}`,t)}parse(e,t){return Pm(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(r=>Ei(r,e))}runTools(e,t){return e.stream?Ti.runTools(this._client,e,t):_i.runTools(this._client,e,t)}stream(e,t){return vr.createChatCompletion(this._client,e,t)}};vt.Messages=br;var Bt=class extends A{constructor(){super(...arguments),this.completions=new vt(this._client)}};Bt.Completions=vt;var Lm=Symbol("brand.privateNullableHeaders");function*zg(n){if(!n)return;if(Lm in n){let{values:r,nulls:s}=n;yield*r.entries();for(let i of s)yield[i,null];return}let e=!1,t;n instanceof Headers?t=n.entries():vd(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let r of t){let s=r[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");let i=vd(r[1])?r[1]:[r[1]],a=!1;for(let o of i)o!==void 0&&(e&&!a&&(a=!0,yield[s,null]),yield[s,o])}}var I=n=>{let e=new Headers,t=new Set;for(let r of n){let s=new Set;for(let[i,a]of zg(r)){let o=i.toLowerCase();s.has(o)||(e.delete(i),s.add(o)),a===null?(e.delete(i),t.add(o)):(e.append(i,a),t.delete(o))}}return{[Lm]:!0,values:e,nulls:t}};var qs=class extends A{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:I([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}};var Gs=class extends A{create(e,t){return this._client.post("/audio/transcriptions",ke({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}};var zs=class extends A{create(e,t){return this._client.post("/audio/translations",ke({body:e,...t,__metadata:{model:e.model}},this._client))}};var tt=class extends A{constructor(){super(...arguments),this.transcriptions=new Gs(this._client),this.translations=new zs(this._client),this.speech=new qs(this._client)}};tt.Transcriptions=Gs;tt.Translations=zs;tt.Speech=qs;var xr=class extends A{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(v`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",D,{query:e,...t})}cancel(e,t){return this._client.post(v`/batches/${e}/cancel`,t)}};var Vs=class extends A{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(v`/assistants/${e}`,{...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,r){return this._client.post(v`/assistants/${e}`,{body:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",D,{query:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(v`/assistants/${e}`,{...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}};var Ws=class extends A{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}};var Ks=class extends A{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}};var Ut=class extends A{constructor(){super(...arguments),this.sessions=new Ws(this._client),this.transcriptionSessions=new Ks(this._client)}};Ut.Sessions=Ws;Ut.TranscriptionSessions=Ks;var Js=class extends A{create(e,t){return this._client.post("/chatkit/sessions",{body:e,...t,headers:I([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}cancel(e,t){return this._client.post(v`/chatkit/sessions/${e}/cancel`,{...t,headers:I([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}};var Xs=class extends A{retrieve(e,t){return this._client.get(v`/chatkit/threads/${e}`,{...t,headers:I([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}list(e={},t){return this._client.getAPIList("/chatkit/threads",yt,{query:e,...t,headers:I([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}delete(e,t){return this._client.delete(v`/chatkit/threads/${e}`,{...t,headers:I([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}listItems(e,t={},r){return this._client.getAPIList(v`/chatkit/threads/${e}/items`,yt,{query:t,...r,headers:I([{"OpenAI-Beta":"chatkit_beta=v1"},r?.headers])})}};var Ht=class extends A{constructor(){super(...arguments),this.sessions=new Js(this._client),this.threads=new Xs(this._client)}};Ht.Sessions=Js;Ht.Threads=Xs;var Qs=class extends A{create(e,t,r){return this._client.post(v`/threads/${e}/messages`,{body:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}retrieve(e,t,r){let{thread_id:s}=t;return this._client.get(v`/threads/${s}/messages/${e}`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}update(e,t,r){let{thread_id:s,...i}=t;return this._client.post(v`/threads/${s}/messages/${e}`,{body:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t={},r){return this._client.getAPIList(v`/threads/${e}/messages`,D,{query:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}delete(e,t,r){let{thread_id:s}=t;return this._client.delete(v`/threads/${s}/messages/${e}`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}};var Ys=class extends A{retrieve(e,t,r){let{thread_id:s,run_id:i,...a}=t;return this._client.get(v`/threads/${s}/runs/${i}/steps/${e}`,{query:a,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t,r){let{thread_id:s,...i}=t;return this._client.getAPIList(v`/threads/${s}/runs/${e}/steps`,D,{query:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}};var Fm=n=>{if(typeof Buffer<"u"){let e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{let e=atob(n),t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return Array.from(new Float32Array(r.buffer))}};var jt=n=>{if(typeof globalThis.process<"u")return globalThis.process.env?.[n]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(n)?.trim()};var ge,Ar,eu,rt,bo,je,Er,Zs,Sr,xo,Le,wo,vo,Li,Mi,ki,Dm,Om,Nm,$m,Bm,Um,Hm,xt=class extends Nt{constructor(){super(...arguments),ge.add(this),eu.set(this,[]),rt.set(this,{}),bo.set(this,{}),je.set(this,void 0),Er.set(this,void 0),Zs.set(this,void 0),Sr.set(this,void 0),xo.set(this,void 0),Le.set(this,void 0),wo.set(this,void 0),vo.set(this,void 0),Li.set(this,void 0)}[(eu=new WeakMap,rt=new WeakMap,bo=new WeakMap,je=new WeakMap,Er=new WeakMap,Zs=new WeakMap,Sr=new WeakMap,xo=new WeakMap,Le=new WeakMap,wo=new WeakMap,vo=new WeakMap,Li=new WeakMap,ge=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new Ar;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let s=Ze.fromReadableStream(e,this.controller);for await(let i of s)b(this,ge,"m",Mi).call(this,i);if(s.controller.signal?.aborted)throw new re;return this._addRun(b(this,ge,"m",ki).call(this))}toReadableStream(){return new Ze(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,s){let i=new Ar;return i._run(()=>i._runToolAssistantStream(e,t,r,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...r,stream:!0},o=await e.submitToolOutputs(t,a,{...s,signal:this.controller.signal});this._connected();for await(let l of o)b(this,ge,"m",Mi).call(this,l);if(o.controller.signal?.aborted)throw new re;return this._addRun(b(this,ge,"m",ki).call(this))}static createThreadAssistantStream(e,t,r){let s=new Ar;return s._run(()=>s._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,r,s){let i=new Ar;return i._run(()=>i._runAssistantStream(e,t,r,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return b(this,wo,"f")}currentRun(){return b(this,vo,"f")}currentMessageSnapshot(){return b(this,je,"f")}currentRunStepSnapshot(){return b(this,Li,"f")}async finalRunSteps(){return await this.done(),Object.values(b(this,rt,"f"))}async finalMessages(){return await this.done(),Object.values(b(this,bo,"f"))}async finalRun(){if(await this.done(),!b(this,Er,"f"))throw Error("Final run was not received.");return b(this,Er,"f")}async _createThreadAssistantStream(e,t,r){let s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...t,stream:!0},a=await e.createAndRun(i,{...r,signal:this.controller.signal});this._connected();for await(let o of a)b(this,ge,"m",Mi).call(this,o);if(a.controller.signal?.aborted)throw new re;return this._addRun(b(this,ge,"m",ki).call(this))}async _createAssistantStream(e,t,r,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...r,stream:!0},o=await e.create(t,a,{...s,signal:this.controller.signal});this._connected();for await(let l of o)b(this,ge,"m",Mi).call(this,l);if(o.controller.signal?.aborted)throw new re;return this._addRun(b(this,ge,"m",ki).call(this))}static accumulateDelta(e,t){for(let[r,s]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let i=e[r];if(i==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(fi(i)&&fi(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(let a of s){if(!fi(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);let o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let l=i[o];l==null?i.push(a):i[o]=this.accumulateDelta(l,a)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${i}`);e[r]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,s){return await this._createAssistantStream(t,e,r,s)}async _runToolAssistantStream(e,t,r,s){return await this._createToolAssistantStream(t,e,r,s)}};Ar=xt,Mi=function(e){if(!this.ended)switch(T(this,wo,e,"f"),b(this,ge,"m",Nm).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":b(this,ge,"m",Hm).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":b(this,ge,"m",Om).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":b(this,ge,"m",Dm).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier");default:}},ki=function(){if(this.ended)throw new C("stream has ended, this shouldn't happen");if(!b(this,Er,"f"))throw Error("Final run has not been received");return b(this,Er,"f")},Dm=function(e){let[t,r]=b(this,ge,"m",Bm).call(this,e,b(this,je,"f"));T(this,je,t,"f"),b(this,bo,"f")[t.id]=t;for(let s of r){let i=t.content[s.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let s of e.data.delta.content){if(s.type=="text"&&s.text){let i=s.text,a=t.content[s.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=b(this,Zs,"f")){if(b(this,Sr,"f"))switch(b(this,Sr,"f").type){case"text":this._emit("textDone",b(this,Sr,"f").text,b(this,je,"f"));break;case"image_file":this._emit("imageFileDone",b(this,Sr,"f").image_file,b(this,je,"f"));break}T(this,Zs,s.index,"f")}T(this,Sr,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(b(this,Zs,"f")!==void 0){let s=e.data.content[b(this,Zs,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,b(this,je,"f"));break;case"text":this._emit("textDone",s.text,b(this,je,"f"));break}}b(this,je,"f")&&this._emit("messageDone",e.data),T(this,je,void 0,"f")}},Om=function(e){let t=b(this,ge,"m",$m).call(this,e);switch(T(this,Li,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let i of r.step_details.tool_calls)i.index==b(this,xo,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(b(this,Le,"f")&&this._emit("toolCallDone",b(this,Le,"f")),T(this,xo,i.index,"f"),T(this,Le,t.step_details.tool_calls[i.index],"f"),b(this,Le,"f")&&this._emit("toolCallCreated",b(this,Le,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":T(this,Li,void 0,"f"),e.data.step_details.type=="tool_calls"&&b(this,Le,"f")&&(this._emit("toolCallDone",b(this,Le,"f")),T(this,Le,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},Nm=function(e){b(this,eu,"f").push(e),this._emit("event",e)},$m=function(e){switch(e.event){case"thread.run.step.created":return b(this,rt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=b(this,rt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let s=Ar.accumulateDelta(t,r.delta);b(this,rt,"f")[e.data.id]=s}return b(this,rt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":b(this,rt,"f")[e.data.id]=e.data;break}if(b(this,rt,"f")[e.data.id])return b(this,rt,"f")[e.data.id];throw new Error("No snapshot available")},Bm=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(let i of s.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=b(this,ge,"m",Um).call(this,i,a)}else t.content[i.index]=i,r.push(i);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Um=function(e,t){return Ar.accumulateDelta(t,e)},Hm=function(e){switch(T(this,vo,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":T(this,Er,e.data,"f"),b(this,Le,"f")&&(this._emit("toolCallDone",b(this,Le,"f")),T(this,Le,void 0,"f"));break;case"thread.run.cancelling":break}};var Ir=class extends A{constructor(){super(...arguments),this.steps=new Ys(this._client)}create(e,t,r){let{include:s,...i}=t;return this._client.post(v`/threads/${e}/runs`,{query:{include:s},body:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers]),stream:t.stream??!1})}retrieve(e,t,r){let{thread_id:s}=t;return this._client.get(v`/threads/${s}/runs/${e}`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}update(e,t,r){let{thread_id:s,...i}=t;return this._client.post(v`/threads/${s}/runs/${e}`,{body:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t={},r){return this._client.getAPIList(v`/threads/${e}/runs`,D,{query:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}cancel(e,t,r){let{thread_id:s}=t;return this._client.post(v`/threads/${s}/runs/${e}/cancel`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async createAndPoll(e,t,r){let s=await this.create(e,t,r);return await this.poll(s.id,{thread_id:e},r)}createAndStream(e,t,r){return xt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let s=I([r?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":r?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:i,response:a}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...s}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let l=a.headers.get("openai-poll-after-ms");if(l){let c=parseInt(l);isNaN(c)||(o=c)}}await Qe(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,r){return xt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r){let{thread_id:s,...i}=t;return this._client.post(v`/threads/${s}/runs/${e}/submit_tool_outputs`,{body:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,r){let s=await this.submitToolOutputs(e,t,r);return await this.poll(s.id,t,r)}submitToolOutputsStream(e,t,r){return xt.createToolAssistantStream(e,this._client.beta.threads.runs,t,r)}};Ir.Steps=Ys;var qt=class extends A{constructor(){super(...arguments),this.runs=new Ir(this._client),this.messages=new Qs(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(v`/threads/${e}`,{...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,r){return this._client.post(v`/threads/${e}`,{body:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}delete(e,t){return this._client.delete(v`/threads/${e}`,{...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.id,{thread_id:r.thread_id},t)}createAndRunStream(e,t){return xt.createThreadAssistantStream(e,this._client.beta.threads,t)}};qt.Runs=Ir;qt.Messages=Qs;var qe=class extends A{constructor(){super(...arguments),this.realtime=new Ut(this._client),this.chatkit=new Ht(this._client),this.assistants=new Vs(this._client),this.threads=new qt(this._client)}};qe.Realtime=Ut;qe.ChatKit=Ht;qe.Assistants=Vs;qe.Threads=qt;var Cr=class extends A{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};var en=class extends A{retrieve(e,t,r){let{container_id:s}=t;return this._client.get(v`/containers/${s}/files/${e}/content`,{...r,headers:I([{Accept:"application/binary"},r?.headers]),__binaryResponse:!0})}};var Pr=class extends A{constructor(){super(...arguments),this.content=new en(this._client)}create(e,t,r){return this._client.post(v`/containers/${e}/files`,ke({body:t,...r},this._client))}retrieve(e,t,r){let{container_id:s}=t;return this._client.get(v`/containers/${s}/files/${e}`,r)}list(e,t={},r){return this._client.getAPIList(v`/containers/${e}/files`,D,{query:t,...r})}delete(e,t,r){let{container_id:s}=t;return this._client.delete(v`/containers/${s}/files/${e}`,{...r,headers:I([{Accept:"*/*"},r?.headers])})}};Pr.Content=en;var Gt=class extends A{constructor(){super(...arguments),this.files=new Pr(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(v`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",D,{query:e,...t})}delete(e,t){return this._client.delete(v`/containers/${e}`,{...t,headers:I([{Accept:"*/*"},t?.headers])})}};Gt.Files=Pr;var tn=class extends A{create(e,t,r){let{include:s,...i}=t;return this._client.post(v`/conversations/${e}/items`,{query:{include:s},body:i,...r})}retrieve(e,t,r){let{conversation_id:s,...i}=t;return this._client.get(v`/conversations/${s}/items/${e}`,{query:i,...r})}list(e,t={},r){return this._client.getAPIList(v`/conversations/${e}/items`,yt,{query:t,...r})}delete(e,t,r){let{conversation_id:s}=t;return this._client.delete(v`/conversations/${s}/items/${e}`,r)}};var zt=class extends A{constructor(){super(...arguments),this.items=new tn(this._client)}create(e={},t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(v`/conversations/${e}`,t)}update(e,t,r){return this._client.post(v`/conversations/${e}`,{body:t,...r})}delete(e,t){return this._client.delete(v`/conversations/${e}`,t)}};zt.Items=tn;var Rr=class extends A{create(e,t){let r=!!e.encoding_format,s=r?e.encoding_format:"base64";r&&Z(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return r?i:(Z(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{let l=o.embedding;o.embedding=Fm(l)}),a)))}};var rn=class extends A{retrieve(e,t,r){let{eval_id:s,run_id:i}=t;return this._client.get(v`/evals/${s}/runs/${i}/output_items/${e}`,r)}list(e,t,r){let{eval_id:s,...i}=t;return this._client.getAPIList(v`/evals/${s}/runs/${e}/output_items`,D,{query:i,...r})}};var _r=class extends A{constructor(){super(...arguments),this.outputItems=new rn(this._client)}create(e,t,r){return this._client.post(v`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){let{eval_id:s}=t;return this._client.get(v`/evals/${s}/runs/${e}`,r)}list(e,t={},r){return this._client.getAPIList(v`/evals/${e}/runs`,D,{query:t,...r})}delete(e,t,r){let{eval_id:s}=t;return this._client.delete(v`/evals/${s}/runs/${e}`,r)}cancel(e,t,r){let{eval_id:s}=t;return this._client.post(v`/evals/${s}/runs/${e}`,r)}};_r.OutputItems=rn;var Vt=class extends A{constructor(){super(...arguments),this.runs=new _r(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(v`/evals/${e}`,t)}update(e,t,r){return this._client.post(v`/evals/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/evals",D,{query:e,...t})}delete(e,t){return this._client.delete(v`/evals/${e}`,t)}};Vt.Runs=_r;var Tr=class extends A{create(e,t){return this._client.post("/files",ke({body:e,...t},this._client))}retrieve(e,t){return this._client.get(v`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",D,{query:e,...t})}delete(e,t){return this._client.delete(v`/files/${e}`,t)}content(e,t){return this._client.get(v`/files/${e}/content`,{...t,headers:I([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let s=new Set(["processed","error","deleted"]),i=Date.now(),a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Qe(t),a=await this.retrieve(e),Date.now()-i>r)throw new Dt({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}};var sn=class extends A{};var nn=class extends A{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};var Mr=class extends A{constructor(){super(...arguments),this.graders=new nn(this._client)}};Mr.Graders=nn;var an=class extends A{create(e,t,r){return this._client.getAPIList(v`/fine_tuning/checkpoints/${e}/permissions`,et,{body:t,method:"post",...r})}retrieve(e,t={},r){return this._client.get(v`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}delete(e,t,r){let{fine_tuned_model_checkpoint:s}=t;return this._client.delete(v`/fine_tuning/checkpoints/${s}/permissions/${e}`,r)}};var kr=class extends A{constructor(){super(...arguments),this.permissions=new an(this._client)}};kr.Permissions=an;var on=class extends A{list(e,t={},r){return this._client.getAPIList(v`/fine_tuning/jobs/${e}/checkpoints`,D,{query:t,...r})}};var Lr=class extends A{constructor(){super(...arguments),this.checkpoints=new on(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(v`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",D,{query:e,...t})}cancel(e,t){return this._client.post(v`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return this._client.getAPIList(v`/fine_tuning/jobs/${e}/events`,D,{query:t,...r})}pause(e,t){return this._client.post(v`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(v`/fine_tuning/jobs/${e}/resume`,t)}};Lr.Checkpoints=on;var Ge=class extends A{constructor(){super(...arguments),this.methods=new sn(this._client),this.jobs=new Lr(this._client),this.checkpoints=new kr(this._client),this.alpha=new Mr(this._client)}};Ge.Methods=sn;Ge.Jobs=Lr;Ge.Checkpoints=kr;Ge.Alpha=Mr;var ln=class extends A{};var Wt=class extends A{constructor(){super(...arguments),this.graderModels=new ln(this._client)}};Wt.GraderModels=ln;var Fr=class extends A{createVariation(e,t){return this._client.post("/images/variations",ke({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",ke({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}};var Dr=class extends A{retrieve(e,t){return this._client.get(v`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",et,e)}delete(e,t){return this._client.delete(v`/models/${e}`,t)}};var Or=class extends A{create(e,t){return this._client.post("/moderations",{body:e,...t})}};var cn=class extends A{accept(e,t,r){return this._client.post(v`/realtime/calls/${e}/accept`,{body:t,...r,headers:I([{Accept:"*/*"},r?.headers])})}hangup(e,t){return this._client.post(v`/realtime/calls/${e}/hangup`,{...t,headers:I([{Accept:"*/*"},t?.headers])})}refer(e,t,r){return this._client.post(v`/realtime/calls/${e}/refer`,{body:t,...r,headers:I([{Accept:"*/*"},r?.headers])})}reject(e,t={},r){return this._client.post(v`/realtime/calls/${e}/reject`,{body:t,...r,headers:I([{Accept:"*/*"},r?.headers])})}};var dn=class extends A{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}};var St=class extends A{constructor(){super(...arguments),this.clientSecrets=new dn(this._client),this.calls=new cn(this._client)}};St.ClientSecrets=dn;St.Calls=cn;function jm(n,e){return!e||!Sy(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(r=>({...r,parsed:null}))}:t)}:tu(n,e)}function tu(n,e){let t=n.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:Iy(e,s)};if(s.type==="message"){let i=s.content.map(a=>a.type==="output_text"?{...a,parsed:xy(e,a.text)}:a);return{...s,content:i}}return s}),r=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||So(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(let s of r.output)if(s.type==="message"){for(let i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),r}function xy(n,e){return n.text?.format?.type!=="json_schema"?null:"$parseRaw"in n.text?.format?(n.text?.format).$parseRaw(e):JSON.parse(e)}function Sy(n){return!!Ai(n.text?.format)}function Ay(n){return n?.$brand==="auto-parseable-tool"}function Ey(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function Iy(n,e){let t=Ey(n.tools??[],e.name);return{...e,...e,parsed_arguments:Ay(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function So(n){let e=[];for(let t of n.output)if(t.type==="message")for(let r of t.content)r.type==="output_text"&&e.push(r.text);n.output_text=e.join("")}var un,Ao,Kt,Eo,qm,Gm,zm,Vm,Io=class n extends Nt{constructor(e){super(),un.add(this),Ao.set(this,void 0),Kt.set(this,void 0),Eo.set(this,void 0),T(this,Ao,e,"f")}static createResponse(e,t,r){let s=new n(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,r){let s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),b(this,un,"m",qm).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(let o of i)b(this,un,"m",Gm).call(this,o,a);if(i.controller.signal?.aborted)throw new re;return b(this,un,"m",zm).call(this)}[(Ao=new WeakMap,Kt=new WeakMap,Eo=new WeakMap,un=new WeakSet,qm=function(){this.ended||T(this,Kt,void 0,"f")},Gm=function(t,r){if(this.ended)return;let s=(a,o)=>{(r==null||o.sequence_number>r)&&this._emit(a,o)},i=b(this,un,"m",Vm).call(this,t);switch(s("event",t),t.type){case"response.output_text.delta":{let a=i.output[t.output_index];if(!a)throw new C(`missing output at index ${t.output_index}`);if(a.type==="message"){let o=a.content[t.content_index];if(!o)throw new C(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new C(`expected content to be 'output_text', got ${o.type}`);s("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{let a=i.output[t.output_index];if(!a)throw new C(`missing output at index ${t.output_index}`);a.type==="function_call"&&s("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:s(t.type,t);break}},zm=function(){if(this.ended)throw new C("stream has ended, this shouldn't happen");let t=b(this,Kt,"f");if(!t)throw new C("request ended without sending any events");T(this,Kt,void 0,"f");let r=Cy(t,b(this,Ao,"f"));return T(this,Eo,r,"f"),r},Vm=function(t){let r=b(this,Kt,"f");if(!r){if(t.type!=="response.created")throw new C(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return r=T(this,Kt,t.response,"f"),r}switch(t.type){case"response.output_item.added":{r.output.push(t.item);break}case"response.content_part.added":{let s=r.output[t.output_index];if(!s)throw new C(`missing output at index ${t.output_index}`);let i=s.type,a=t.part;i==="message"&&a.type!=="reasoning_text"?s.content.push(a):i==="reasoning"&&a.type==="reasoning_text"&&(s.content||(s.content=[]),s.content.push(a));break}case"response.output_text.delta":{let s=r.output[t.output_index];if(!s)throw new C(`missing output at index ${t.output_index}`);if(s.type==="message"){let i=s.content[t.content_index];if(!i)throw new C(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new C(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{let s=r.output[t.output_index];if(!s)throw new C(`missing output at index ${t.output_index}`);s.type==="function_call"&&(s.arguments+=t.delta);break}case"response.reasoning_text.delta":{let s=r.output[t.output_index];if(!s)throw new C(`missing output at index ${t.output_index}`);if(s.type==="reasoning"){let i=s.content?.[t.content_index];if(!i)throw new C(`missing content at index ${t.content_index}`);if(i.type!=="reasoning_text")throw new C(`expected content to be 'reasoning_text', got ${i.type}`);i.text+=t.delta}break}case"response.completed":{T(this,Kt,t.response,"f");break}}return r},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=b(this,Eo,"f");if(!e)throw new C("stream ended without producing a ChatCompletion");return e}};function Cy(n,e){return jm(n,e)}var pn=class extends A{list(e,t={},r){return this._client.getAPIList(v`/responses/${e}/input_items`,D,{query:t,...r})}};var mn=class extends A{count(e={},t){return this._client.post("/responses/input_tokens",{body:e,...t})}};var At=class extends A{constructor(){super(...arguments),this.inputItems=new pn(this._client),this.inputTokens=new mn(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&So(r),r))}retrieve(e,t={},r){return this._client.get(v`/responses/${e}`,{query:t,...r,stream:t?.stream??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&So(s),s))}delete(e,t){return this._client.delete(v`/responses/${e}`,{...t,headers:I([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(r=>tu(r,e))}stream(e,t){return Io.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(v`/responses/${e}/cancel`,t)}};At.InputItems=pn;At.InputTokens=mn;var hn=class extends A{create(e,t,r){return this._client.post(v`/uploads/${e}/parts`,ke({body:t,...r},this._client))}};var Jt=class extends A{constructor(){super(...arguments),this.parts=new hn(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(v`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(v`/uploads/${e}/complete`,{body:t,...r})}};Jt.Parts=hn;var Wm=async n=>{let e=await Promise.allSettled(n),t=e.filter(s=>s.status==="rejected");if(t.length){for(let s of t)console.error(s.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let r=[];for(let s of e)s.status==="fulfilled"&&r.push(s.value);return r};var fn=class extends A{create(e,t,r){return this._client.post(v`/vector_stores/${e}/file_batches`,{body:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}retrieve(e,t,r){let{vector_store_id:s}=t;return this._client.get(v`/vector_stores/${s}/file_batches/${e}`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}cancel(e,t,r){let{vector_store_id:s}=t;return this._client.post(v`/vector_stores/${s}/file_batches/${e}/cancel`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async createAndPoll(e,t,r){let s=await this.create(e,t);return await this.poll(e,s.id,r)}listFiles(e,t,r){let{vector_store_id:s,...i}=t;return this._client.getAPIList(v`/vector_stores/${s}/file_batches/${e}/files`,D,{query:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async poll(e,t,r){let s=I([r?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":r?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:i,response:a}=await this.retrieve(t,{vector_store_id:e},{...r,headers:s}).withResponse();switch(i.status){case"in_progress":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let l=a.headers.get("openai-poll-after-ms");if(l){let c=parseInt(l);isNaN(c)||(o=c)}}await Qe(o);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},s){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=s?.maxConcurrency??5,a=Math.min(i,t.length),o=this._client,l=t.values(),c=[...r];async function d(h){for(let p of h){let f=await o.files.create({file:p,purpose:"assistants"},s);c.push(f.id)}}let u=Array(a).fill(l).map(d);return await Wm(u),await this.createAndPoll(e,{file_ids:c})}};var gn=class extends A{create(e,t,r){return this._client.post(v`/vector_stores/${e}/files`,{body:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}retrieve(e,t,r){let{vector_store_id:s}=t;return this._client.get(v`/vector_stores/${s}/files/${e}`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}update(e,t,r){let{vector_store_id:s,...i}=t;return this._client.post(v`/vector_stores/${s}/files/${e}`,{body:i,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t={},r){return this._client.getAPIList(v`/vector_stores/${e}/files`,D,{query:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}delete(e,t,r){let{vector_store_id:s}=t;return this._client.delete(v`/vector_stores/${s}/files/${e}`,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async createAndPoll(e,t,r){let s=await this.create(e,t,r);return await this.poll(e,s.id,r)}async poll(e,t,r){let s=I([r?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":r?.pollIntervalMs?.toString()??void 0}]);for(;;){let i=await this.retrieve(t,{vector_store_id:e},{...r,headers:s}).withResponse(),a=i.data;switch(a.status){case"in_progress":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let l=i.response.headers.get("openai-poll-after-ms");if(l){let c=parseInt(l);isNaN(c)||(o=c)}}await Qe(o);break;case"failed":case"completed":return a}}}async upload(e,t,r){let s=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,t,r){let s=await this.upload(e,t,r);return await this.poll(e,s.id,r)}content(e,t,r){let{vector_store_id:s}=t;return this._client.getAPIList(v`/vector_stores/${s}/files/${e}/content`,et,{...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}};var Et=class extends A{constructor(){super(...arguments),this.files=new gn(this._client),this.fileBatches=new fn(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(v`/vector_stores/${e}`,{...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,r){return this._client.post(v`/vector_stores/${e}`,{body:t,...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",D,{query:e,...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(v`/vector_stores/${e}`,{...t,headers:I([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,r){return this._client.getAPIList(v`/vector_stores/${e}/search`,et,{body:t,method:"post",...r,headers:I([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}};Et.Files=gn;Et.FileBatches=fn;var Nr=class extends A{create(e,t){return this._client.post("/videos",Nd({body:e,...t},this._client))}retrieve(e,t){return this._client.get(v`/videos/${e}`,t)}list(e={},t){return this._client.getAPIList("/videos",yt,{query:e,...t})}delete(e,t){return this._client.delete(v`/videos/${e}`,t)}downloadContent(e,t={},r){return this._client.get(v`/videos/${e}/content`,{query:t,...r,headers:I([{Accept:"application/binary"},r?.headers]),__binaryResponse:!0})}remix(e,t,r){return this._client.post(v`/videos/${e}/remix`,Nd({body:t,...r},this._client))}};var yn,Km,Co,$r=class extends A{constructor(){super(...arguments),yn.add(this)}async unwrap(e,t,r=this._client.webhookSecret,s=300){return await this.verifySignature(e,t,r,s),JSON.parse(e)}async verifySignature(e,t,r=this._client.webhookSecret,s=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");b(this,yn,"m",Km).call(this,r);let i=I([t]).values,a=b(this,yn,"m",Co).call(this,i,"webhook-signature"),o=b(this,yn,"m",Co).call(this,i,"webhook-timestamp"),l=b(this,yn,"m",Co).call(this,i,"webhook-id"),c=parseInt(o,10);if(isNaN(c))throw new Xe("Invalid webhook timestamp format");let d=Math.floor(Date.now()/1e3);if(d-c>s)throw new Xe("Webhook timestamp is too old");if(c>d+s)throw new Xe("Webhook timestamp is too new");let u=a.split(" ").map(y=>y.startsWith("v1,")?y.substring(3):y),h=r.startsWith("whsec_")?Buffer.from(r.replace("whsec_",""),"base64"):Buffer.from(r,"utf-8"),p=l?`${l}.${o}.${e}`:`${o}.${e}`,f=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(let y of u)try{let S=Buffer.from(y,"base64");if(await crypto.subtle.verify("HMAC",f,S,new TextEncoder().encode(p)))return}catch{continue}throw new Xe("The given webhook signature does not match the expected signature")}};yn=new WeakSet,Km=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Co=function(e,t){if(!e)throw new Error("Headers are required");let r=e.get(t);if(r==null)throw new Error(`Missing required header: ${t}`);return r};var ru,su,Po,Jm,k=class{constructor({baseURL:e=jt("OPENAI_BASE_URL"),apiKey:t=jt("OPENAI_API_KEY"),organization:r=jt("OPENAI_ORG_ID")??null,project:s=jt("OPENAI_PROJECT_ID")??null,webhookSecret:i=jt("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(ru.add(this),Po.set(this,void 0),this.completions=new Cr(this),this.chat=new Bt(this),this.embeddings=new Rr(this),this.files=new Tr(this),this.images=new Fr(this),this.audio=new tt(this),this.moderations=new Or(this),this.models=new Dr(this),this.fineTuning=new Ge(this),this.graders=new Wt(this),this.vectorStores=new Et(this),this.webhooks=new $r(this),this.beta=new qe(this),this.batches=new xr(this),this.uploads=new Jt(this),this.responses=new At(this),this.realtime=new St(this),this.conversations=new zt(this),this.evals=new Vt(this),this.containers=new Gt(this),this.videos=new Nr(this),t===void 0)throw new C("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");let o={apiKey:t,organization:r,project:s,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&rm())throw new C(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??su.DEFAULT_TIMEOUT,this.logger=o.logger??console;let l="warn";this.logLevel=l,this.logLevel=Md(o.logLevel,"ClientOptions.logLevel",this)??Md(jt("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??l,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??nm(),T(this,Po,am,"f"),this._options=o,this.apiKey=typeof t=="string"?t:"Missing Key",this.organization=r,this.project=s,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return I([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return _d(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Ot}`}defaultIdempotencyKey(){return`stainless-node-retry-${wd()}`}makeStatusError(e,t,r,s){return ie.generate(e,t,r,s)}async _callApiKey(){let e=this._options.apiKey;if(typeof e!="function")return!1;let t;try{t=await e()}catch(r){throw r instanceof C?r:new C(`Failed to get token from 'apiKey' function: ${r.message}`,{cause:r})}if(typeof t!="string"||!t)throw new C(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,r){let s=!b(this,ru,"m",Jm).call(this)&&r||this.baseURL,i=Kp(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Jp(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:r}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new yr(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,r){let s=await e,i=s.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(s);let{req:a,url:o,timeout:l}=await this.buildRequest(s,{retryCount:i-t});await this.prepareRequest(a,{url:o,options:s});let c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),d=r===void 0?"":`, retryOf: ${r}`,u=Date.now();if(Z(this).debug(`[${c}] sending request`,gt({retryOfRequestLogID:r,method:s.method,url:o,options:s,headers:a.headers})),s.signal?.aborted)throw new re;let h=new AbortController,p=await this.fetchWithTimeout(o,a,l,h).catch(hi),f=Date.now();if(p instanceof globalThis.Error){let x=`retrying, ${t} attempts remaining`;if(s.signal?.aborted)throw new re;let g=mi(p)||/timed? ?out/i.test(String(p)+("cause"in p?String(p.cause):""));if(t)return Z(this).info(`[${c}] connection ${g?"timed out":"failed"} - ${x}`),Z(this).debug(`[${c}] connection ${g?"timed out":"failed"} (${x})`,gt({retryOfRequestLogID:r,url:o,durationMs:f-u,message:p.message})),this.retryRequest(s,t,r??c);throw Z(this).info(`[${c}] connection ${g?"timed out":"failed"} - error; no more retries left`),Z(this).debug(`[${c}] connection ${g?"timed out":"failed"} (error; no more retries left)`,gt({retryOfRequestLogID:r,url:o,durationMs:f-u,message:p.message})),g?new Dt:new Ft({cause:p})}let y=[...p.headers.entries()].filter(([x])=>x==="x-request-id").map(([x,g])=>", "+x+": "+JSON.stringify(g)).join(""),S=`[${c}${d}${y}] ${a.method} ${o} ${p.ok?"succeeded":"failed"} with status ${p.status} in ${f-u}ms`;if(!p.ok){let x=await this.shouldRetry(p);if(t&&x){let O=`retrying, ${t} attempts remaining`;return await im(p.body),Z(this).info(`${S} - ${O}`),Z(this).debug(`[${c}] response error (${O})`,gt({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,durationMs:f-u})),this.retryRequest(s,t,r??c,p.headers)}let g=x?"error; no more retries left":"error; not retryable";Z(this).info(`${S} - ${g}`);let E=await p.text().catch(O=>hi(O).message),R=Yp(E),M=R?void 0:E;throw Z(this).debug(`[${c}] response error (${g})`,gt({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,message:M,durationMs:Date.now()-u})),this.makeStatusError(p.status,R,M,p.headers)}return Z(this).info(S),Z(this).debug(`[${c}] response start`,gt({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,durationMs:f-u})),{response:p,options:s,controller:h,requestLogID:c,retryOfRequestLogID:r,startTime:u}}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}requestAPIList(e,t){let r=this.makeRequest(t,null,void 0);return new vi(this,r,e)}async fetchWithTimeout(e,t,r,s){let{signal:i,method:a,...o}=t||{};i&&i.addEventListener("abort",()=>s.abort());let l=setTimeout(()=>s.abort(),r),c=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,d={signal:s.signal,...c?{duplex:"half"}:{},method:"GET",...o};a&&(d.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,d)}finally{clearTimeout(l)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r,s){let i,a=s?.get("retry-after-ms");if(a){let l=parseFloat(a);Number.isNaN(l)||(i=l)}let o=s?.get("retry-after");if(o&&!i){let l=parseFloat(o);Number.isNaN(l)?i=Date.parse(o)-Date.now():i=l*1e3}if(!(i&&0<=i&&i<60*1e3)){let l=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,l)}return await Qe(i),this.makeRequest(e,t-1,r)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}async buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:s,path:i,query:a,defaultBaseURL:o}=r,l=this.buildURL(i,a,o);"timeout"in r&&Qp("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let{bodyHeaders:c,body:d}=this.buildBody({options:r}),u=await this.buildHeaders({options:e,method:s,bodyHeaders:c,retryCount:t});return{req:{method:s,headers:u,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&d instanceof globalThis.ReadableStream&&{duplex:"half"},...d&&{body:d},...this.fetchOptions??{},...r.fetchOptions??{}},url:l,timeout:r.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:r,retryCount:s}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let a=I([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...sm(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let r=I([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Ya(e)}:b(this,Po,"f").call(this,{body:e,headers:r})}};su=k,Po=new WeakMap,ru=new WeakSet,Jm=function(){return this.baseURL!=="https://api.openai.com/v1"};k.OpenAI=su;k.DEFAULT_TIMEOUT=6e5;k.OpenAIError=C;k.APIError=ie;k.APIConnectionError=Ft;k.APIConnectionTimeoutError=Dt;k.APIUserAbortError=re;k.NotFoundError=Ts;k.ConflictError=Ms;k.RateLimitError=Ls;k.BadRequestError=Ps;k.AuthenticationError=Rs;k.InternalServerError=Fs;k.PermissionDeniedError=_s;k.UnprocessableEntityError=ks;k.InvalidWebhookSignatureError=Xe;k.toFile=oo;k.Completions=Cr;k.Chat=Bt;k.Embeddings=Rr;k.Files=Tr;k.Images=Fr;k.Audio=tt;k.Moderations=Or;k.Models=Dr;k.FineTuning=Ge;k.Graders=Wt;k.VectorStores=Et;k.Webhooks=$r;k.Beta=qe;k.Batches=xr;k.Uploads=Jt;k.Responses=At;k.Realtime=St;k.Conversations=zt;k.Evals=Vt;k.Containers=Gt;k.Videos=Nr;var Fi=class{name="OpenAI";client=null;apiKey;model;constructor(e,t){this.apiKey=e,this.model=t||"gpt-4o-mini"}getClient(){if(!this.client&&this.apiKey&&this.apiKey.trim().length>0)try{this.client=new k({apiKey:this.apiKey})}catch(e){throw m.warn("Failed to initialize OpenAI client:",e),new Error("Failed to initialize OpenAI client")}if(!this.client)throw new Error("OpenAI client not initialized");return this.client}authenticate(e){return Promise.resolve(e.trim().length>0&&e.startsWith("sk-"))}isAvailable(){return this.apiKey.trim().length>0}async classify(e){if(!this.isAvailable())throw new Error("OpenAI provider is not available");let t=this.constructPrompt(e);try{let i=(await this.getClient().chat.completions.create({model:this.model,messages:[{role:"user",content:t}],max_tokens:256,temperature:.1})).choices[0]?.message?.content;if(!i)throw new Error("No content in OpenAI response");return this.parseResponse(i)}catch(r){let s=r;if(s?.status===429||s?.response?.status===429)throw new Error("Rate limit exceeded. Please try again later.");if(s?.status===401||s?.response?.status===401)throw new Error("Invalid API key. Please check your OpenAI API key.");if(r instanceof Error){let i=r.message||"Unknown error";throw new Error(`OpenAI API error: ${i}`)}throw new Error("OpenAI API error: Request failed")}}constructPrompt(e){return`Classify this idea into one category and suggest 2-4 relevant tags.

Idea: "${e}"

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Rules:
- Choose the single best category
- Tags should be specific and relevant (2-4 tags)
- Use lowercase for category and tags

Example response:
{
  "category": "game",
  "tags": ["rpg", "fantasy", "multiplayer"]
}

Response:`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:r.confidence||.8}}catch(t){return m.warn("Failed to parse OpenAI response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}};var Xm;(function(n){n.STRING="string",n.NUMBER="number",n.INTEGER="integer",n.BOOLEAN="boolean",n.ARRAY="array",n.OBJECT="object"})(Xm||(Xm={}));var Qm;(function(n){n.LANGUAGE_UNSPECIFIED="language_unspecified",n.PYTHON="python"})(Qm||(Qm={}));var Ym;(function(n){n.OUTCOME_UNSPECIFIED="outcome_unspecified",n.OUTCOME_OK="outcome_ok",n.OUTCOME_FAILED="outcome_failed",n.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(Ym||(Ym={}));var Zm=["user","model","function","system"],eh;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",n.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(eh||(eh={}));var th;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(th||(th={}));var rh;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(rh||(rh={}));var sh;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(sh||(sh={}));var Di;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.SPII="SPII",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.OTHER="OTHER"})(Di||(Di={}));var nh;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(nh||(nh={}));var ih;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(ih||(ih={}));var ah;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(ah||(ah={}));var pe=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},Xt=class extends pe{constructor(e,t){super(e),this.response=t}},_o=class extends pe{constructor(e,t,r,s){super(e),this.status=t,this.statusText=r,this.errorDetails=s}},st=class extends pe{},To=class extends pe{};var Ly="https://generativelanguage.googleapis.com",Fy="v1beta",Dy="0.24.1",Oy="genai-js",Br;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(Br||(Br={}));var nu=class{constructor(e,t,r,s,i){this.model=e,this.task=t,this.apiKey=r,this.stream=s,this.requestOptions=i}toString(){var e,t;let r=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||Fy,i=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||Ly}/${r}/${this.model}:${this.task}`;return this.stream&&(i+="?alt=sse"),i}};function Ny(n){let e=[];return n?.apiClient&&e.push(n.apiClient),e.push(`${Oy}/${Dy}`),e.join(" ")}async function $y(n){var e;let t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",Ny(n.requestOptions)),t.append("x-goog-api-key",n.apiKey);let r=(e=n.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(r){if(!(r instanceof Headers))try{r=new Headers(r)}catch(s){throw new st(`unable to convert customHeaders value ${JSON.stringify(r)} to Headers: ${s.message}`)}for(let[s,i]of r.entries()){if(s==="x-goog-api-key")throw new st(`Cannot set reserved header name ${s}`);if(s==="x-goog-api-client")throw new st(`Header name ${s} can only be set using the apiClient field`);t.append(s,i)}}return t}async function By(n,e,t,r,s,i){let a=new nu(n,e,t,r,i);return{url:a.toString(),fetchOptions:Object.assign(Object.assign({},qy(i)),{method:"POST",headers:await $y(a),body:s})}}async function $i(n,e,t,r,s,i={},a=fetch){let{url:o,fetchOptions:l}=await By(n,e,t,r,s,i);return Uy(o,l,a)}async function Uy(n,e,t=fetch){let r;try{r=await t(n,e)}catch(s){Hy(s,n)}return r.ok||await jy(r,n),r}function Hy(n,e){let t=n;throw t.name==="AbortError"?(t=new To(`Request aborted when fetching ${e.toString()}: ${n.message}`),t.stack=n.stack):n instanceof _o||n instanceof st||(t=new pe(`Error fetching from ${e.toString()}: ${n.message}`),t.stack=n.stack),t}async function jy(n,e){let t="",r;try{let s=await n.json();t=s.error.message,s.error.details&&(t+=` ${JSON.stringify(s.error.details)}`,r=s.error.details)}catch{}throw new _o(`Error fetching from ${e.toString()}: [${n.status} ${n.statusText}] ${t}`,n.status,n.statusText,r)}function qy(n){let e={};if(n?.signal!==void 0||n?.timeout>=0){let t=new AbortController;n?.timeout>=0&&setTimeout(()=>t.abort(),n.timeout),n?.signal&&n.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function au(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Ro(n.candidates[0]))throw new Xt(`${Qt(n)}`,n);return Gy(n)}else if(n.promptFeedback)throw new Xt(`Text not available. ${Qt(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Ro(n.candidates[0]))throw new Xt(`${Qt(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),oh(n)[0]}else if(n.promptFeedback)throw new Xt(`Function call not available. ${Qt(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Ro(n.candidates[0]))throw new Xt(`${Qt(n)}`,n);return oh(n)}else if(n.promptFeedback)throw new Xt(`Function call not available. ${Qt(n)}`,n)},n}function Gy(n){var e,t,r,s;let i=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let a of(s=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||s===void 0?void 0:s.parts)a.text&&i.push(a.text),a.executableCode&&i.push("\n```"+a.executableCode.language+`
`+a.executableCode.code+"\n```\n"),a.codeExecutionResult&&i.push("\n```\n"+a.codeExecutionResult.output+"\n```\n");return i.length>0?i.join(""):""}function oh(n){var e,t,r,s;let i=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let a of(s=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||s===void 0?void 0:s.parts)a.functionCall&&i.push(a.functionCall);if(i.length>0)return i}var zy=[Di.RECITATION,Di.SAFETY,Di.LANGUAGE];function Ro(n){return!!n.finishReason&&zy.includes(n.finishReason)}function Qt(n){var e,t,r;let s="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)s+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(s+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(s+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){let i=n.candidates[0];Ro(i)&&(s+=`Candidate was blocked due to ${i.finishReason}`,i.finishMessage&&(s+=`: ${i.finishMessage}`))}return s}function Oi(n){return this instanceof Oi?(this.v=n,this):new Oi(n)}function Vy(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),s,i=[];return s={},a("next"),a("throw"),a("return"),s[Symbol.asyncIterator]=function(){return this},s;function a(h){r[h]&&(s[h]=function(p){return new Promise(function(f,y){i.push([h,p,f,y])>1||o(h,p)})})}function o(h,p){try{l(r[h](p))}catch(f){u(i[0][3],f)}}function l(h){h.value instanceof Oi?Promise.resolve(h.value.v).then(c,d):u(i[0][2],h)}function c(h){o("next",h)}function d(h){o("throw",h)}function u(h,p){h(p),i.shift(),i.length&&o(i[0][0],i[0][1])}}var lh=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Wy(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=Xy(e),[r,s]=t.tee();return{stream:Jy(r),response:Ky(s)}}async function Ky(n){let e=[],t=n.getReader();for(;;){let{done:r,value:s}=await t.read();if(r)return au(Qy(e));e.push(s)}}function Jy(n){return Vy(this,arguments,function*(){let t=n.getReader();for(;;){let{value:r,done:s}=yield Oi(t.read());if(s)break;yield yield Oi(au(r))}})}function Xy(n){let e=n.getReader();return new ReadableStream({start(r){let s="";return i();function i(){return e.read().then(({value:a,done:o})=>{if(o){if(s.trim()){r.error(new pe("Failed to parse stream"));return}r.close();return}s+=a;let l=s.match(lh),c;for(;l;){try{c=JSON.parse(l[1])}catch{r.error(new pe(`Error parsing JSON response: "${l[1]}"`));return}r.enqueue(c),s=s.substring(l[0].length),l=s.match(lh)}return i()}).catch(a=>{let o=a;throw o.stack=a.stack,o.name==="AbortError"?o=new To("Request aborted when reading from the stream"):o=new pe("Error reading from the stream"),o})}}})}function Qy(n){let e=n[n.length-1],t={promptFeedback:e?.promptFeedback};for(let r of n){if(r.candidates){let s=0;for(let i of r.candidates)if(t.candidates||(t.candidates=[]),t.candidates[s]||(t.candidates[s]={index:s}),t.candidates[s].citationMetadata=i.citationMetadata,t.candidates[s].groundingMetadata=i.groundingMetadata,t.candidates[s].finishReason=i.finishReason,t.candidates[s].finishMessage=i.finishMessage,t.candidates[s].safetyRatings=i.safetyRatings,i.content&&i.content.parts){t.candidates[s].content||(t.candidates[s].content={role:i.content.role||"user",parts:[]});let a={};for(let o of i.content.parts)o.text&&(a.text=o.text),o.functionCall&&(a.functionCall=o.functionCall),o.executableCode&&(a.executableCode=o.executableCode),o.codeExecutionResult&&(a.codeExecutionResult=o.codeExecutionResult),Object.keys(a).length===0&&(a.text=""),t.candidates[s].content.parts.push(a)}s++}r.usageMetadata&&(t.usageMetadata=r.usageMetadata)}return t}async function mh(n,e,t,r){let s=await $i(e,Br.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),r);return Wy(s)}async function hh(n,e,t,r){let i=await(await $i(e,Br.GENERATE_CONTENT,n,!1,JSON.stringify(t),r)).json();return{response:au(i)}}function fh(n){if(n!=null){if(typeof n=="string")return{role:"system",parts:[{text:n}]};if(n.text)return{role:"system",parts:[n]};if(n.parts)return n.role?n:{role:"system",parts:n.parts}}}function Ni(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(let t of n)typeof t=="string"?e.push({text:t}):e.push(t);return Yy(e)}function Yy(n){let e={role:"user",parts:[]},t={role:"function",parts:[]},r=!1,s=!1;for(let i of n)"functionResponse"in i?(t.parts.push(i),s=!0):(e.parts.push(i),r=!0);if(r&&s)throw new pe("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!s)throw new pe("No content is provided for sending chat message.");return r?e:t}function Zy(n,e){var t;let r={model:e?.model,generationConfig:e?.generationConfig,safetySettings:e?.safetySettings,tools:e?.tools,toolConfig:e?.toolConfig,systemInstruction:e?.systemInstruction,cachedContent:(t=e?.cachedContent)===null||t===void 0?void 0:t.name,contents:[]},s=n.generateContentRequest!=null;if(n.contents){if(s)throw new st("CountTokensRequest must have one of contents or generateContentRequest, not both.");r.contents=n.contents}else if(s)r=Object.assign(Object.assign({},r),n.generateContentRequest);else{let i=Ni(n);r.contents=[i]}return{generateContentRequest:r}}function ch(n){let e;return n.contents?e=n:e={contents:[Ni(n)]},n.systemInstruction&&(e.systemInstruction=fh(n.systemInstruction)),e}function eb(n){return typeof n=="string"||Array.isArray(n)?{content:Ni(n)}:n}var dh=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],tb={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function rb(n){let e=!1;for(let t of n){let{role:r,parts:s}=t;if(!e&&r!=="user")throw new pe(`First content should be with role 'user', got ${r}`);if(!Zm.includes(r))throw new pe(`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(Zm)}`);if(!Array.isArray(s))throw new pe("Content should have 'parts' property with an array of Parts");if(s.length===0)throw new pe("Each Content should have at least one part");let i={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let o of s)for(let l of dh)l in o&&(i[l]+=1);let a=tb[r];for(let o of dh)if(!a.includes(o)&&i[o]>0)throw new pe(`Content with role '${r}' can't contain '${o}' part`);e=!0}}function uh(n){var e;if(n.candidates===void 0||n.candidates.length===0)return!1;let t=(e=n.candidates[0])===null||e===void 0?void 0:e.content;if(t===void 0||t.parts===void 0||t.parts.length===0)return!1;for(let r of t.parts)if(r===void 0||Object.keys(r).length===0||r.text!==void 0&&r.text==="")return!1;return!0}var ph="SILENT_ERROR",iu=class{constructor(e,t,r,s={}){this.model=t,this.params=r,this._requestOptions=s,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r?.history&&(rb(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var r,s,i,a,o,l;await this._sendPromise;let c=Ni(e),d={safetySettings:(r=this.params)===null||r===void 0?void 0:r.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(i=this.params)===null||i===void 0?void 0:i.tools,toolConfig:(a=this.params)===null||a===void 0?void 0:a.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(l=this.params)===null||l===void 0?void 0:l.cachedContent,contents:[...this._history,c]},u=Object.assign(Object.assign({},this._requestOptions),t),h;return this._sendPromise=this._sendPromise.then(()=>hh(this._apiKey,this.model,d,u)).then(p=>{var f;if(uh(p.response)){this._history.push(c);let y=Object.assign({parts:[],role:"model"},(f=p.response.candidates)===null||f===void 0?void 0:f[0].content);this._history.push(y)}else{let y=Qt(p.response);y&&console.warn(`sendMessage() was unsuccessful. ${y}. Inspect response object for details.`)}h=p}).catch(p=>{throw this._sendPromise=Promise.resolve(),p}),await this._sendPromise,h}async sendMessageStream(e,t={}){var r,s,i,a,o,l;await this._sendPromise;let c=Ni(e),d={safetySettings:(r=this.params)===null||r===void 0?void 0:r.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(i=this.params)===null||i===void 0?void 0:i.tools,toolConfig:(a=this.params)===null||a===void 0?void 0:a.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(l=this.params)===null||l===void 0?void 0:l.cachedContent,contents:[...this._history,c]},u=Object.assign(Object.assign({},this._requestOptions),t),h=mh(this._apiKey,this.model,d,u);return this._sendPromise=this._sendPromise.then(()=>h).catch(p=>{throw new Error(ph)}).then(p=>p.response).then(p=>{if(uh(p)){this._history.push(c);let f=Object.assign({},p.candidates[0].content);f.role||(f.role="model"),this._history.push(f)}else{let f=Qt(p);f&&console.warn(`sendMessageStream() was unsuccessful. ${f}. Inspect response object for details.`)}}).catch(p=>{p.message!==ph&&console.error(p)}),h}};async function sb(n,e,t,r){return(await $i(e,Br.COUNT_TOKENS,n,!1,JSON.stringify(t),r)).json()}async function nb(n,e,t,r){return(await $i(e,Br.EMBED_CONTENT,n,!1,JSON.stringify(t),r)).json()}async function ib(n,e,t,r){let s=t.requests.map(a=>Object.assign(Object.assign({},a),{model:e}));return(await $i(e,Br.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:s}),r)).json()}var Mo=class{constructor(e,t,r={}){this.apiKey=e,this._requestOptions=r,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=fh(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var r;let s=ch(e),i=Object.assign(Object.assign({},this._requestOptions),t);return hh(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(r=this.cachedContent)===null||r===void 0?void 0:r.name},s),i)}async generateContentStream(e,t={}){var r;let s=ch(e),i=Object.assign(Object.assign({},this._requestOptions),t);return mh(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(r=this.cachedContent)===null||r===void 0?void 0:r.name},s),i)}startChat(e){var t;return new iu(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let r=Zy(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),t);return sb(this.apiKey,this.model,r,s)}async embedContent(e,t={}){let r=eb(e),s=Object.assign(Object.assign({},this._requestOptions),t);return nb(this.apiKey,this.model,r,s)}async batchEmbedContents(e,t={}){let r=Object.assign(Object.assign({},this._requestOptions),t);return ib(this.apiKey,this.model,e,r)}};var ko=class{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new pe("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Mo(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,r){if(!e.name)throw new st("Cached content must contain a `name` field.");if(!e.model)throw new st("Cached content must contain a `model` field.");let s=["model","systemInstruction"];for(let a of s)if(t?.[a]&&e[a]&&t?.[a]!==e[a]){if(a==="model"){let o=t.model.startsWith("models/")?t.model.replace("models/",""):t.model,l=e.model.startsWith("models/")?e.model.replace("models/",""):e.model;if(o===l)continue}throw new st(`Different value for "${a}" specified in modelParams (${t[a]}) and cachedContent (${e[a]})`)}let i=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new Mo(this.apiKey,i,r)}};var Bi=class{name="Gemini";client=null;apiKey;model;constructor(e,t){this.apiKey=e,this.model=t||"gemini-1.5-flash"}getClient(){if(!this.client&&this.apiKey&&this.apiKey.trim().length>0)try{this.client=new ko(this.apiKey)}catch(e){throw m.warn("Failed to initialize Gemini client:",e),new Error("Failed to initialize Gemini client")}if(!this.client)throw new Error("Gemini client not initialized");return this.client}authenticate(e){return Promise.resolve(e.trim().length>0)}isAvailable(){return this.apiKey.trim().length>0}async classify(e){if(!this.isAvailable())throw new Error("Gemini provider is not available");let t=this.constructPrompt(e);try{let o=(await(await this.getClient().getGenerativeModel({model:this.model}).generateContent(t)).response).text();return this.parseResponse(o)}catch(r){let s=r;if(s?.status===429||s?.response?.status===429)throw new Error("Rate limit exceeded. Please try again later.");if(s?.status===401||s?.response?.status===401)throw new Error("Invalid API key. Please check your Gemini API key.");if(r instanceof Error){let i=r.message||"Unknown error";throw new Error(`Gemini API error: ${i}`)}throw new Error("Gemini API error: Request failed")}}constructPrompt(e){return`Classify this idea into one category and suggest 2-4 relevant tags.

Idea: "${e}"

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Rules:
- Choose the single best category
- Tags should be specific and relevant (2-4 tags)
- Use lowercase for category and tags

Example response:
{
  "category": "game",
  "tags": ["rpg", "fantasy", "multiplayer"]
}

Response:`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:r.confidence||.8}}catch(t){return m.warn("Failed to parse Gemini response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}};var Ur="0.37.0";var gh=!1,Hr,ou,ab,ob,lb,lu,cb,Lo,cu,du,uu,Fo,pu;function yh(n,e={auto:!1}){if(gh)throw new Error(`you must \`import 'groq-sdk/shims/${n.kind}'\` before importing anything else from groq-sdk`);if(Hr)throw new Error(`can't \`import 'groq-sdk/shims/${n.kind}'\` after \`import 'groq-sdk/shims/${Hr}'\``);gh=e.auto,Hr=n.kind,ou=n.fetch,ab=n.Request,ob=n.Response,lb=n.Headers,lu=n.FormData,cb=n.Blob,Lo=n.File,cu=n.ReadableStream,du=n.getMultipartRequestOptions,uu=n.getDefaultAgent,Fo=n.fileFromPath,pu=n.isFsReadStream}var Do=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function bh({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n",t,r,s,i;try{t=fetch,r=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new Do(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:a=>!1}}var mu=()=>{Hr||yh(bh(),{auto:!0})};mu();var ye=class extends Error{},me=class n extends ye{constructor(e,t,r,s){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.error=t}static makeMessage(e,t,r){let s=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new Yt({message:r,cause:Oo(t)});let i=t;return e===400?new Ui(e,i,r,s):e===401?new Hi(e,i,r,s):e===403?new ji(e,i,r,s):e===404?new qi(e,i,r,s):e===409?new Gi(e,i,r,s):e===422?new zi(e,i,r,s):e===429?new Vi(e,i,r,s):e>=500?new Wi(e,i,r,s):new n(e,i,r,s)}},jr=class extends me{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Yt=class extends me{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},bn=class extends Yt{constructor({message:e}={}){super({message:e??"Request timed out."})}},Ui=class extends me{},Hi=class extends me{},ji=class extends me{},qi=class extends me{},Gi=class extends me{},zi=class extends me{},Vi=class extends me{},Wi=class extends me{};var No=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1,s=new hu;async function*i(){if(!e.body)throw t.abort(),new ye("Attempted to iterate over a response with no body");let o=new wn,l=wh(e.body);for await(let c of l)for(let d of o.decode(c)){let u=s.decode(d);u&&(yield u)}for(let c of o.flush()){let d=s.decode(c);d&&(yield d)}}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(let l of i())if(!o){if(l.data.startsWith("[DONE]")){o=!0;continue}if(l.event===null||l.event==="error"){let c;try{c=JSON.parse(l.data)}catch(d){throw console.error("Could not parse message into JSON:",l.data),console.error("From chunk:",l.raw),d}if(c&&c.error)throw new me(c.error.status_code,c.error,c.error.message,void 0);yield c}}o=!0}catch(l){if(l instanceof Error&&l.name==="AbortError")return;throw l}finally{o||t.abort()}}return new n(a,t)}static fromReadableStream(e,t){let r=!1;async function*s(){let a=new wn,o=wh(e);for await(let l of o)for(let c of a.decode(l))yield c;for(let l of a.flush())yield l}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(let o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new n(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){let a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new n(()=>s(e),this.controller),new n(()=>s(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new cu({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{let{value:i,done:a}=await t.next();if(a)return s.close();let o=r.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){await t.return?.()}})}},hu=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=pb(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}},wn=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),s=t.split(n.NEWLINE_REGEXP);return s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new ye(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new ye(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new ye("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};wn.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]);wn.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function pb(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function wh(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var vh=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",xh=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Ki(n),Ki=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",mb=n=>xh(n)||vh(n)||pu(n);async function yu(n,e,t){if(n=await n,xh(n))return n;if(vh(n)){let s=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=Ki(s)?[await s.arrayBuffer()]:[s];return new Lo(i,e,t)}let r=await hb(n);if(e||(e=gb(n)??"unknown_file"),!t?.type){let s=r[0]?.type;typeof s=="string"&&(t={...t,type:s})}return new Lo(r,e,t)}async function hb(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Ki(n))e.push(await n.arrayBuffer());else if(yb(n))for await(let t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${fb(n)}`);return e}function fb(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function gb(n){return fu(n.name)||fu(n.filename)||fu(n.path)?.split(/[\\/]/).pop()}var fu=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},yb=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",bu=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var qr=async n=>{let e=await Sh(n.body);return du(e,n)},Sh=async n=>{let e=new lu;return await Promise.all(Object.entries(n||{}).map(([t,r])=>gu(e,t,r))),e};var gu=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(mb(t)){let r=await yu(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>gu(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>gu(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Rh=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},_h=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Uo,$o;mu();async function Th(n){let{response:e}=n;if(n.options.stream)return vn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):No.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let r=e.headers.get("content-type")?.split(";")[0]?.trim();if(r?.includes("application/json")||r?.endsWith("+json")){let a=await e.json();return vn("response",e.status,e.url,e.headers,a),a}let i=await e.text();return vn("response",e.status,e.url,e.headers,i),i}var Ho=class n extends Promise{constructor(e,t=Th){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t),t))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},jo=class{constructor({baseURL:e,baseURLOverridden:t,maxRetries:r=2,timeout:s=6e4,httpAgent:i,fetch:a}){Uo.set(this,void 0),this.baseURL=e,Rh(this,Uo,t,"f"),this.maxRetries=wu("maxRetries",r),this.timeout=wu("timeout",s),this.httpAgent=i,this.fetch=a??ou}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json",...["head","get"].includes(e.method)?{}:{"Content-Type":"application/json"},"User-Agent":this.getUserAgent(),...Sb(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${_b()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async s=>{let i=s&&Ki(s?.body)?new DataView(await s.body.arrayBuffer()):s?.body instanceof DataView?s.body:s?.body instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s?.body)?new DataView(s.body.buffer):s?.body;return{method:e,path:t,...s,body:i}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}async buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:s,path:i,query:a,defaultBaseURL:o,headers:l={}}=r,c=ArrayBuffer.isView(r.body)||r.__binaryRequest&&typeof r.body=="string"?r.body:bu(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,d=this.calculateContentLength(c),u=this.buildURL(i,a,o);"timeout"in r&&wu("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let h=r.httpAgent??this.httpAgent??uu(u),p=r.timeout+1e3;typeof h?.options?.timeout=="number"&&p>(h.options.timeout??0)&&(h.options.timeout=p),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),l[this.idempotencyHeader]=e.idempotencyKey);let f=this.buildHeaders({options:r,headers:l,contentLength:d,retryCount:t});return{req:{method:s,...c&&{body:c},headers:f,...h&&{agent:h},signal:r.signal??null},url:u,timeout:r.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:s}){let i={};r&&(i["content-length"]=r);let a=this.defaultHeaders(e);return Ph(i,a),Ph(i,t),bu(e.body)&&Hr!=="node"&&delete i["content-type"],Bo(a,"x-stainless-retry-count")===void 0&&Bo(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(s)),Bo(a,"x-stainless-timeout")===void 0&&Bo(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return me.generate(e,t,r,s)}request(e,t=null){return new Ho(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e,s=r.maxRetries??this.maxRetries;t==null&&(t=s),await this.prepareOptions(r);let{req:i,url:a,timeout:o}=await this.buildRequest(r,{retryCount:s-t});if(await this.prepareRequest(i,{url:a,options:r}),vn("request",a,r,i.headers),r.signal?.aborted)throw new jr;let l=new AbortController,c=await this.fetchWithTimeout(a,i,o,l).catch(Oo);if(c instanceof Error){if(r.signal?.aborted)throw new jr;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new bn:new Yt({cause:c})}let d=wb(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){let S=`retrying, ${t} attempts remaining`;return vn(`response (error; ${S})`,c.status,a,d),this.retryRequest(r,t,d)}let u=await c.text().catch(S=>Oo(S).message),h=Ab(u),p=h?void 0:u;throw vn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,d,p),this.makeStatusError(c.status,h,p,d)}return{response:c,options:r,controller:l}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new vu(this,r,e)}buildURL(e,t,r){let s=!_h(this,Uo,"f")&&r||this.baseURL,i=Ib(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Pb(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new ye(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){let{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());let o=setTimeout(()=>s.abort(),r),l={signal:s.signal,...a};return l.method&&(l.method=l.method.toUpperCase()),this.fetch.call(void 0,e,l).finally(()=>{clearTimeout(o)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let s,i=r?.["retry-after-ms"];if(i){let o=parseFloat(i);Number.isNaN(o)||(s=o)}let a=r?.["retry-after"];if(a&&!s){let o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){let o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Cb(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ur}`}};Uo=new WeakMap;var Ah=class{constructor(e,t,r,s){$o.set(this,void 0),Rh(this,$o,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new ye("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[s,i]of r)e.url.searchParams.set(s,i);t.query=void 0,t.path=e.url.toString()}return await _h(this,$o,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[($o=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},vu=class extends Ho{constructor(e,t,r){super(t,async s=>new r(e,s.response,await Th(s),s.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},wb=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}});var vb=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ur,"X-Stainless-OS":Ih(Deno.build.os),"X-Stainless-Arch":Eh(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ur,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ur,"X-Stainless-OS":Ih(process.platform),"X-Stainless-Arch":Eh(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=xb();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ur,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ur,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function xb(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}var Eh=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Ih=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Ch,Sb=()=>Ch??(Ch=vb()),Ab=n=>{try{return JSON.parse(n)}catch{return}},Eb=/^[a-z][a-z0-9+.-]*:/i,Ib=n=>Eb.test(n),Cb=n=>new Promise(e=>setTimeout(e,n)),wu=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new ye(`${n} must be an integer`);if(e<0)throw new ye(`${n} must be a positive integer`);return e},Oo=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)};var xu=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function Pb(n){if(!n)return!0;for(let e in n)return!1;return!0}function Rb(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Ph(n,e){for(let t in e){if(!Rb(e,t))continue;let r=t.toLowerCase();if(!r)continue;let s=e[t];s===null?delete n[r]:s!==void 0&&(n[r]=s)}}function vn(n,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`Groq:DEBUG:${n}`,...e)}var _b=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Mh=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Tb=n=>typeof n?.get=="function";var Bo=(n,e)=>{let t=e.toLowerCase();if(Tb(n)){let r=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(s,i,a)=>i+a.toUpperCase());for(let s of[e,t,e.toUpperCase(),r]){let i=n.get(s);if(i)return i}}for(let[r,s]of Object.entries(n))if(r.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};var J=class{constructor(e){this._client=e}};var xn=class extends J{create(e,t){return this._client.post("/openai/v1/audio/speech",{body:e,...t,headers:{Accept:"audio/wav",...t?.headers},__binaryResponse:!0})}};var Sn=class extends J{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",qr({body:e,...t}))}};var An=class extends J{create(e,t){return this._client.post("/openai/v1/audio/translations",qr({body:e,...t}))}};var nt=class extends J{constructor(){super(...arguments),this.speech=new xn(this._client),this.transcriptions=new Sn(this._client),this.translations=new An(this._client)}};nt.Speech=xn;nt.Transcriptions=Sn;nt.Translations=An;var Gr=class extends J{create(e,t){return this._client.post("/openai/v1/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/openai/v1/batches/${e}`,t)}list(e){return this._client.get("/openai/v1/batches",e)}cancel(e,t){return this._client.post(`/openai/v1/batches/${e}/cancel`,t)}};var En=class extends J{create(e,t){return this._client.post("/openai/v1/chat/completions",{body:e,...t,stream:e.stream??!1})}};var Zt=class extends J{constructor(){super(...arguments),this.completions=new En(this._client)}};Zt.Completions=En;var zr=class extends J{};var Vr=class extends J{create(e,t){return this._client.post("/openai/v1/embeddings",{body:e,...t})}};var Wr=class extends J{create(e,t){return this._client.post("/openai/v1/files",qr({body:e,...t}))}list(e){return this._client.get("/openai/v1/files",e)}delete(e,t){return this._client.delete(`/openai/v1/files/${e}`,t)}content(e,t){return this._client.get(`/openai/v1/files/${e}/content`,{...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}info(e,t){return this._client.get(`/openai/v1/files/${e}`,t)}};var Kr=class extends J{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,t)}};var kh,Lh,Ob,j=class extends jo{constructor({baseURL:e=xu("GROQ_BASE_URL"),apiKey:t=xu("GROQ_API_KEY"),...r}={}){if(t===void 0)throw new ye("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");let s={apiKey:t,...r,baseURL:e||"https://api.groq.com"};if(!s.dangerouslyAllowBrowser&&Mh())throw new ye(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:s.baseURL,baseURLOverridden:e?e!=="https://api.groq.com":!1,timeout:s.timeout??6e4,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),kh.add(this),this.completions=new zr(this),this.chat=new Zt(this),this.embeddings=new Vr(this),this.audio=new nt(this),this.models=new Kr(this),this.batches=new Gr(this),this.files=new Wr(this),this._options=s,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};Lh=j,kh=new WeakSet,Ob=function(){return this.baseURL!=="https://api.groq.com"};j.Groq=Lh;j.DEFAULT_TIMEOUT=6e4;j.GroqError=ye;j.APIError=me;j.APIConnectionError=Yt;j.APIConnectionTimeoutError=bn;j.APIUserAbortError=jr;j.NotFoundError=qi;j.ConflictError=Gi;j.RateLimitError=Vi;j.BadRequestError=Ui;j.AuthenticationError=Hi;j.InternalServerError=Wi;j.PermissionDeniedError=ji;j.UnprocessableEntityError=zi;j.toFile=yu;j.fileFromPath=Fo;j.Completions=zr;j.Chat=Zt;j.Embeddings=Vr;j.Audio=nt;j.Models=Kr;j.Batches=Gr;j.Files=Wr;var Fh=j;var Ji=class{name="Groq";client=null;apiKey;model;constructor(e,t){this.apiKey=e,this.model=t||"llama-3.3-70b-versatile"}getClient(){if(!this.client&&this.apiKey&&this.apiKey.trim().length>0)try{this.client=new Fh({apiKey:this.apiKey,dangerouslyAllowBrowser:!0})}catch(e){throw m.warn("Failed to initialize Groq client:",e),new Error("Failed to initialize Groq client")}if(!this.client)throw new Error("Groq client not initialized");return this.client}authenticate(e){return Promise.resolve(e.trim().length>0)}isAvailable(){return this.apiKey.trim().length>0}async classify(e){if(!this.isAvailable())throw new Error("Groq provider is not available");let t=this.constructPrompt(e);try{let i=(await this.getClient().chat.completions.create({model:this.model,messages:[{role:"user",content:t}],max_tokens:256,temperature:.1})).choices[0]?.message?.content;if(!i)throw new Error("No content in Groq response");return this.parseResponse(i)}catch(r){let s=r;if(s?.status===429||s?.response?.status===429)throw new Error("Rate limit exceeded. Please try again later.");if(s?.status===401||s?.response?.status===401)throw new Error("Invalid API key. Please check your Groq API key.");if(r instanceof Error){let i=r.message||"Unknown error";throw new Error(`Groq API error: ${i}`)}throw new Error("Groq API error: Request failed")}}constructPrompt(e){return`Classify this idea into one category and suggest 2-4 relevant tags.

Idea: "${e}"

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Rules:
- Choose the single best category
- Tags should be specific and relevant (2-4 tags)
- Use lowercase for category and tags

Example response:
{
  "category": "game",
  "tags": ["rpg", "fantasy", "multiplayer"]
}

Response:`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:r.confidence||.8}}catch(t){return m.warn("Failed to parse Groq response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}};var Dh=require("obsidian");var Go=class{name="OpenRouter";apiKey;model;baseUrl="https://openrouter.ai/api/v1/chat/completions";constructor(e,t){this.apiKey=e,this.model=t||"openai/gpt-4o-mini"}authenticate(e){return Promise.resolve(e.trim().length>0)}isAvailable(){return this.apiKey.trim().length>0}async classify(e){if(!this.isAvailable())throw new Error("OpenRouter provider is not available");let t=this.constructPrompt(e);try{let r=await(0,Dh.requestUrl)({url:this.baseUrl,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"https://github.com/FallingWithStyle/obsidian-ideatr","X-Title":"Ideatr"},body:JSON.stringify({model:this.model,messages:[{role:"user",content:t}],max_tokens:256,temperature:.1}),throw:!1});if(r.status<200||r.status>=300){if(r.status===429)throw new Error("Rate limit exceeded. Please try again later.");if(r.status===401)throw new Error("Invalid API key. Please check your OpenRouter API key.");let a=(typeof r.json=="function"?await r.json():r.json)||{};throw new Error(`OpenRouter API error: ${a.error||"Request failed"}`)}let i=(typeof r.json=="function"?await r.json():r.json).choices?.[0]?.message?.content;if(!i)throw new Error("No content in OpenRouter response");return this.parseResponse(i)}catch(r){throw r instanceof Error?r.message.includes("Rate limit")||r.message.includes("Invalid API key")?r:new Error(`OpenRouter API error: ${r.message}`):new Error("OpenRouter API error: Request failed")}}constructPrompt(e){return`Classify this idea into one category and suggest 2-4 relevant tags.

Idea: "${e}"

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Rules:
- Choose the single best category
- Tags should be specific and relevant (2-4 tags)
- Use lowercase for category and tags

Example response:
{
  "category": "game",
  "tags": ["rpg", "fantasy", "multiplayer"]
}

Response:`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:r.confidence||.8}}catch(t){return m.warn("Failed to parse OpenRouter response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}};var Oh=require("obsidian");var zo=class{name="Custom Endpoint";endpointUrl;format;constructor(e,t="ollama"){this.endpointUrl=e,this.format=t}authenticate(e){try{return new URL(e),Promise.resolve(e.trim().length>0)}catch{return Promise.resolve(!1)}}isAvailable(){return this.endpointUrl.trim().length>0}async classify(e){if(!this.isAvailable())throw new Error("Custom endpoint provider is not available");let t=this.constructPrompt(e);try{let r,s;this.format==="ollama"?(r={model:"llama3.2",messages:[{role:"user",content:t}],stream:!1},s="message.content"):(r={model:"gpt-4o-mini",messages:[{role:"user",content:t}],max_tokens:256,temperature:.1},s="choices[0].message.content");let i=await(0,Oh.requestUrl)({url:this.endpointUrl,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),throw:!1});if(i.status<200||i.status>=300){let l=(typeof i.json=="function"?await i.json():i.json)||{};throw new Error(`Custom endpoint error: ${l.error||"Request failed"}`)}let a=typeof i.json=="function"?await i.json():i.json,o;if(s==="message.content"?o=a.message?.content||"":o=a.choices?.[0]?.message?.content||"",!o)throw new Error("No content in custom endpoint response");return this.parseResponse(o)}catch(r){throw r instanceof Error?new Error(`Custom endpoint error: ${r.message}`):new Error("Custom endpoint error: Request failed")}}constructPrompt(e){return`Classify this idea into one category and suggest 2-4 relevant tags.

Idea: "${e}"

Categories: game, saas, tool, story, mechanic, hardware, ip, brand, ux, personal

Rules:
- Choose the single best category
- Tags should be specific and relevant (2-4 tags)
- Use lowercase for category and tags

Example response:
{
  "category": "game",
  "tags": ["rpg", "fantasy", "multiplayer"]
}

Response:`}parseResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return{category:this.validateCategory(r.category),tags:Array.isArray(r.tags)?r.tags.slice(0,5):[],confidence:r.confidence||.8}}catch(t){return m.warn("Failed to parse custom endpoint response:",e,t),{category:"",tags:[],confidence:0}}}validateCategory(e){let t=["game","saas","tool","story","mechanic","hardware","ip","brand","ux","personal"],r=e?.toLowerCase().trim();return t.includes(r)?r:""}};var It=class{static createProvider(e,t,r){switch(e){case"anthropic":return new pi(t,r?.customModel);case"openai":return new Fi(t,r?.customModel);case"gemini":return new Bi(t,r?.customModel);case"groq":return new Ji(t,r?.customModel);case"openrouter":return new Go(t,r?.openRouterModel);case"custom":if(!r?.customEndpointUrl)throw new Error("Custom endpoint URL is required for custom provider");let s=r.customEndpointUrl.includes("/v1/chat/completions")?"openai":"ollama";return new zo(r.customEndpointUrl,s);case"custom-model":if(!r?.customModelProvider||!r?.customModel)throw new Error("Custom model provider and model are required for custom-model provider");let i=r.customModelProvider;switch(i){case"anthropic":return new pi(t,r.customModel);case"openai":return new Fi(t,r.customModel);case"gemini":return new Bi(t,r.customModel);case"groq":return new Ji(t,r.customModel);default:throw new Error(`Unsupported custom model provider: ${i}`)}case"none":throw new Error('Cannot create provider for type "none"');default:throw new Error(`Unknown provider type: ${e}`)}}};var Nb={"anthropic-haiku":{key:"anthropic-haiku",name:"Claude 3.5 Haiku",badge:"EFFICIENT",provider:"anthropic",modelId:"claude-3-5-haiku-20241022",description:"Fast, cost-effective model ideal for classification tasks. Excellent at structured work like categorization and tagging.",quality:4,speed:5,cost:"low",costEstimate:"~$0.002 per idea",pros:["Fast","Cost-effective","Good accuracy","Low latency"],cons:["Less nuanced than larger models"],bestFor:"Most users"},"anthropic-sonnet":{key:"anthropic-sonnet",name:"Claude 3.5 Sonnet",badge:"BALANCED",provider:"anthropic",modelId:"claude-3-5-sonnet-20241022",description:"Balanced performance with better reasoning and accuracy. Great for complex or nuanced classification tasks.",quality:4.5,speed:4,cost:"medium",costEstimate:"~$0.015 per idea",pros:["Better reasoning","Higher accuracy","Handles complexity well"],cons:["More expensive","Slightly slower"],bestFor:"Users who want better quality"},"anthropic-opus":{key:"anthropic-opus",name:"Claude 3 Opus",badge:"PREMIUM",provider:"anthropic",modelId:"claude-3-opus-20240229",description:"Highest quality model for complex or nuanced classification. Best for edge cases and ambiguous ideas.",quality:5,speed:2,cost:"high",costEstimate:"~$0.15 per idea",pros:["Best quality","Excellent reasoning","Handles edge cases"],cons:["Expensive","Slower","Overkill for simple tasks"],bestFor:"Power users with complex ideas"},"openai-mini":{key:"openai-mini",name:"GPT-4o Mini",badge:"EFFICIENT",provider:"openai",modelId:"gpt-4o-mini",description:"Fast, cost-effective model ideal for classification tasks. Excellent at structured work like categorization and tagging.",quality:4,speed:5,cost:"low",costEstimate:"~$0.001 per idea",pros:["Very fast","Most cost-effective","Good accuracy","Low latency"],cons:["Less nuanced than GPT-4o"],bestFor:"Most users"},"openai-4o":{key:"openai-4o",name:"GPT-4o",badge:"BALANCED",provider:"openai",modelId:"gpt-4o",description:"High-quality model with excellent reasoning capabilities. Great for complex or nuanced classification tasks.",quality:4.5,speed:4,cost:"medium",costEstimate:"~$0.01 per idea",pros:["Better reasoning","Higher accuracy","Handles complexity well"],cons:["More expensive","Slightly slower"],bestFor:"Users who want better quality"},"gemini-flash":{key:"gemini-flash",name:"Gemini 1.5 Flash",badge:"EFFICIENT",provider:"gemini",modelId:"gemini-1.5-flash",description:"Fast, cost-effective model ideal for classification tasks. Excellent at structured work like categorization and tagging.",quality:4,speed:5,cost:"low",costEstimate:"~$0.0005 per idea",pros:["Very fast","Most cost-effective","Good accuracy","Low latency"],cons:["Less nuanced than Pro"],bestFor:"Most users"},"gemini-pro":{key:"gemini-pro",name:"Gemini 1.5 Pro",badge:"BALANCED",provider:"gemini",modelId:"gemini-1.5-pro",description:"High-quality model with better reasoning and accuracy. Great for complex or nuanced classification tasks.",quality:4.5,speed:4,cost:"medium",costEstimate:"~$0.005 per idea",pros:["Better reasoning","Higher accuracy","Handles complexity well"],cons:["More expensive","Slightly slower"],bestFor:"Users who want better quality"},"groq-llama-70b":{key:"groq-llama-70b",name:"Llama 3.3 70B Versatile",badge:"BALANCED",provider:"groq",modelId:"llama-3.3-70b-versatile",description:"High-quality model with excellent reasoning. Fast inference via Groq's infrastructure.",quality:4.5,speed:5,cost:"low",costEstimate:"Free (via Groq)",pros:["Free","Very fast","High quality","Excellent reasoning"],cons:["Requires Groq API key"],bestFor:"Users who want free high-quality AI"},"groq-mixtral":{key:"groq-mixtral",name:"Mixtral 8x7B",badge:"VERSATILE",provider:"groq",modelId:"mixtral-8x7b-32768",description:"High-quality mixture-of-experts model. Fast inference via Groq's infrastructure.",quality:4.5,speed:5,cost:"low",costEstimate:"Free (via Groq)",pros:["Free","Very fast","High quality","Mixture-of-experts"],cons:["Requires Groq API key"],bestFor:"Users who want free high-quality AI"}};function Xi(n){return Object.values(Nb).filter(e=>e.provider===n)}var Vo=class extends Q{showComparison=!1;display(e){e.createEl("h3",{text:"Cloud AI"});let r=e.createDiv({cls:"cloud-model-comparison-container"}).createEl("button",{text:this.showComparison?"\u25BC Hide Model Comparison":"\u25B6 Show Model Comparison",cls:"mod-link"});r.style.marginBottom="1em",r.addEventListener("click",()=>{this.showComparison=!this.showComparison,r.textContent=this.showComparison?"\u25BC Hide Model Comparison":"\u25B6 Show Model Comparison";let a=e.querySelector(".cloud-model-comparison-section");a&&(a.style.display=this.showComparison?"block":"none")});let s=e.createDiv({cls:"cloud-model-comparison-section"});s.style.display="none",this.renderModelComparison(s),new se.Setting(e).setName("Enable Cloud AI").setDesc("Use cloud AI providers for better quality and faster responses (requires API key)").addToggle(a=>a.setValue(this.plugin.settings.cloudProvider!=="none").onChange(async o=>{o?(this.plugin.settings.cloudProvider==="none"&&(this.plugin.settings.cloudProvider="anthropic"),this.plugin.settings.preferCloud=!0):(this.plugin.settings.cloudProvider="none",this.plugin.settings.preferCloud=!1),await this.saveSettings(),this.refresh()}));let i=this.plugin.settings.cloudApiKeys&&Object.values(this.plugin.settings.cloudApiKeys).some(a=>a&&a.length>0)||this.plugin.settings.cloudApiKey&&this.plugin.settings.cloudApiKey.length>0;if((this.plugin.settings.cloudProvider!=="none"||i)&&(new se.Setting(e).setName("Cloud Provider").setDesc("Select the cloud AI provider").addDropdown(a=>{a.addOption("anthropic","Anthropic (Claude 3.5 Haiku)").addOption("openai","OpenAI (GPT-4o Mini)").addOption("gemini","Google Gemini (Gemini 1.5 Flash)").addOption("groq","Groq (Llama 3.3 70B)").addOption("openrouter","OpenRouter (Multiple Models)").addOption("custom","Custom Endpoint (Ollama/LM Studio)").addOption("none","None").setValue(this.plugin.settings.cloudProvider==="none"?"none":this.plugin.settings.cloudProvider).onChange(async o=>{this.plugin.settings.cloudProvider=o,await this.saveSettings(),this.refresh()})}),this.plugin.settings.cloudProvider!=="none")){if(this.plugin.settings.cloudProvider!=="custom"){let a={anthropic:"Anthropic",openai:"OpenAI",gemini:"Google Gemini",groq:"Groq",openrouter:"OpenRouter"},o={anthropic:"https://console.anthropic.com/",openai:"https://platform.openai.com/api-keys",gemini:"https://makersuite.google.com/app/apikey",groq:"https://console.groq.com/keys",openrouter:"https://openrouter.ai/keys"},l=this.plugin.settings.cloudProvider,c="";this.plugin.settings.cloudApiKeys&&l in this.plugin.settings.cloudApiKeys&&(c=this.plugin.settings.cloudApiKeys[l]||""),!c&&this.plugin.settings.cloudApiKey&&this.plugin.settings.cloudProvider===l&&(c=this.plugin.settings.cloudApiKey),new se.Setting(e).setName("API Key").setDesc(`Enter your ${a[this.plugin.settings.cloudProvider]||"provider"} API key`).addText(S=>{S.setPlaceholder("sk-...").setValue(c),S.inputEl.setAttribute("type","password"),S.onChange(async x=>{this.plugin.settings.cloudApiKeys||(this.plugin.settings.cloudApiKeys={anthropic:"",openai:"",gemini:"",groq:"",openrouter:""}),l in this.plugin.settings.cloudApiKeys&&(this.plugin.settings.cloudApiKeys[l]=x),await this.saveSettings()})});let d=e.createDiv("setting-item-description");d.style.marginTop="5px";let u=a[this.plugin.settings.cloudProvider]||"provider",h=o[this.plugin.settings.cloudProvider]||"#";d.createEl("a",{href:h,text:`Get your ${u} API key`,attr:{target:"_blank"}});let f={anthropic:"~$0.002 per idea (Claude 3.5 Haiku)",openai:"~$0.001 per idea (GPT-4o Mini)",gemini:"~$0.0005 per idea (Gemini 1.5 Flash)",groq:"Free (Llama 3.3 70B)",openrouter:"Varies by model (see OpenRouter pricing)"}[this.plugin.settings.cloudProvider]||"Varies",y=e.createDiv("setting-item-description");y.style.marginTop="5px",y.style.color="var(--text-muted)",y.textContent=`Cost estimate: ${f}`,new se.Setting(e).setName("Test Connection").setDesc("Verify your API key is valid").addButton(S=>S.setButtonText("Test Connection").onClick(async()=>{let x=this.plugin.settings.cloudProvider,g=this.plugin.settings.cloudApiKeys&&x in this.plugin.settings.cloudApiKeys?(this.plugin.settings.cloudApiKeys[x]||"").trim():"";if(!g){new se.Notice("Please enter an API key first");return}S.setButtonText("Testing..."),S.setDisabled(!0);try{let E=It.createProvider(this.plugin.settings.cloudProvider,g,{openRouterModel:this.plugin.settings.openRouterModel,customEndpointUrl:this.plugin.settings.customEndpointUrl});if(!await E.authenticate(g)){new se.Notice("Authentication failed: Invalid API key format");return}let M=await E.classify("Test idea for connection verification");M&&(M.category||M.tags.length>0)?new se.Notice(`\u2713 Connection successful! Provider: ${E.name}`):new se.Notice("Connection test completed, but got unexpected response")}catch(E){console.error("Connection test failed:",E);let R=E instanceof Error?E.message:"Unknown error";new se.Notice(`Connection failed: ${R}`)}finally{S.setButtonText("Test Connection"),S.setDisabled(!1)}}))}if(this.plugin.settings.cloudProvider==="openrouter"&&new se.Setting(e).setName("Model").setDesc("Select the model to use via OpenRouter").addText(a=>a.setPlaceholder("openai/gpt-4o-mini").setValue(this.plugin.settings.openRouterModel||"openai/gpt-4o-mini").onChange(async o=>{this.plugin.settings.openRouterModel=o,await this.saveSettings()})),this.plugin.settings.cloudProvider==="custom"){new se.Setting(e).setName("Endpoint URL").setDesc("Enter your custom endpoint URL (e.g., http://localhost:11434/api/chat for Ollama)").addText(o=>o.setPlaceholder("http://localhost:11434/api/chat").setValue(this.plugin.settings.customEndpointUrl||"").onChange(async l=>{this.plugin.settings.customEndpointUrl=l,await this.saveSettings()}));let a=e.createDiv("setting-item-description");a.style.marginTop="5px",a.style.color="var(--text-muted)",a.textContent="Cost estimate: Free (self-hosted)",new se.Setting(e).setName("Test Connection").setDesc("Verify your custom endpoint is accessible").addButton(o=>o.setButtonText("Test Connection").onClick(async()=>{let l=this.plugin.settings.customEndpointUrl.trim();if(!l){new se.Notice("Please enter an endpoint URL first");return}o.setButtonText("Testing..."),o.setDisabled(!0);try{let c=It.createProvider("custom","",{customEndpointUrl:l});if(!await c.authenticate(l)){new se.Notice("Authentication failed: Invalid endpoint URL");return}let u=await c.classify("Test idea for connection verification");u&&(u.category||u.tags.length>0)?new se.Notice(`\u2713 Connection successful! Provider: ${c.name}`):new se.Notice("Connection test completed, but got unexpected response")}catch(c){console.error("Connection test failed:",c);let d=c instanceof Error?c.message:"Unknown error";new se.Notice(`Connection failed: ${d}`)}finally{o.setButtonText("Test Connection"),o.setDisabled(!1)}}))}new se.Setting(e).setName("Prefer Cloud AI").setDesc("Use cloud AI when available, fallback to local AI on failure").addToggle(a=>a.setValue(this.plugin.settings.preferCloud).onChange(async o=>{this.plugin.settings.preferCloud=o,await this.saveSettings()}))}}renderModelComparison(e){e.empty(),e.createEl("h4",{text:"Cloud AI model comparison"}),e.createEl("p",{text:"Compare default cloud AI models to find the best fit for your needs. All models are validated for Ideatr's classification and tagging tasks.",cls:"cloud-model-comparison-intro"}),e.querySelector(".cloud-model-comparison-intro")?.setAttribute("style","margin-bottom: 1em; color: var(--text-muted); font-size: 0.9em;");let t={Anthropic:Xi("anthropic"),OpenAI:Xi("openai"),"Google Gemini":Xi("gemini"),Groq:Xi("groq")};for(let[r,s]of Object.entries(t)){if(s.length===0)continue;let i=s.map(ap);op(e,r,i,!1)}}};var er=require("obsidian");var Wo=class extends Q{display(e){new er.Setting(e).setName("Enable Web Search").setDesc("Search for similar ideas/products/services on the web").addToggle(t=>t.setValue(this.plugin.settings.enableWebSearch).onChange(async r=>{this.plugin.settings.enableWebSearch=r,await this.saveSettings()})),new er.Setting(e).setName("Auto-search existence on capture").setDesc("Automatically search for similar items when capturing ideas").addToggle(t=>t.setValue(this.plugin.settings.autoSearchExistence).onChange(async r=>{this.plugin.settings.autoSearchExistence=r,await this.saveSettings()})),new er.Setting(e).setName("Web Search Provider").setDesc("Select the web search provider to use").addDropdown(t=>t.addOption("google","Google").addOption("duckduckgo","DuckDuckGo").addOption("none","None").setValue(this.plugin.settings.webSearchProvider).onChange(async r=>{this.plugin.settings.webSearchProvider=r,await this.saveSettings(),this.refresh()})),this.plugin.settings.webSearchProvider==="google"&&(new er.Setting(e).setName("Google API Key").setDesc("Google Custom Search API key").addText(t=>t.setPlaceholder("Enter your Google API key").setValue(this.plugin.settings.googleSearchApiKey).onChange(async r=>{this.plugin.settings.googleSearchApiKey=r,await this.saveSettings()})),new er.Setting(e).setName("Google Search Engine ID").setDesc("Google Custom Search Engine ID (CSE ID)").addText(t=>t.setPlaceholder("Enter your Google CSE ID").setValue(this.plugin.settings.googleSearchEngineId).onChange(async r=>{this.plugin.settings.googleSearchEngineId=r,await this.saveSettings()}))),new er.Setting(e).setName("Web search timeout (ms)").setDesc("Maximum time to wait for web search response").addText(t=>t.setPlaceholder("15000").setValue(String(this.plugin.settings.webSearchTimeout)).onChange(async r=>{let s=Number(r);!isNaN(s)&&s>0&&(this.plugin.settings.webSearchTimeout=s,await this.saveSettings())})),new er.Setting(e).setName("Max search results (1-10)").setDesc("Maximum number of search results to store in frontmatter").addText(t=>t.setPlaceholder("5").setValue(String(this.plugin.settings.maxSearchResults)).onChange(async r=>{let s=Number(r);!isNaN(s)&&s>=1&&s<=10&&(this.plugin.settings.maxSearchResults=s,await this.saveSettings())}))}};var it=require("obsidian");var Ko=class extends Q{display(e){new it.Setting(e).setName("Enable Name Variants").setDesc("Generate name variants for ideas").addToggle(t=>t.setValue(this.plugin.settings.enableNameVariants).onChange(async r=>{this.plugin.settings.enableNameVariants=r,await this.saveSettings()})),new it.Setting(e).setName("Auto-generate variants on capture").setDesc("Automatically generate name variants when capturing ideas").addToggle(t=>t.setValue(this.plugin.settings.autoGenerateVariants).onChange(async r=>{this.plugin.settings.autoGenerateVariants=r,await this.saveSettings()})),new it.Setting(e).setName("Max variants (5-10)").setDesc("Maximum number of name variants to generate").addText(t=>t.setPlaceholder("8").setValue(String(this.plugin.settings.maxVariants)).onChange(async r=>{let s=Number(r);!isNaN(s)&&s>=5&&s<=10&&(this.plugin.settings.maxVariants=s,await this.saveSettings())})),new it.Setting(e).setName("Use LLM for name extraction").setDesc("Use AI to intelligently extract idea names (more accurate but slower)").addToggle(t=>t.setValue(this.plugin.settings.useLLMForNameExtraction).onChange(async r=>{this.plugin.settings.useLLMForNameExtraction=r,await this.saveSettings()})),new it.Setting(e).setName("Cache max size").setDesc("Maximum number of cached variants (0 = unlimited)").addText(t=>t.setPlaceholder("100").setValue(String(this.plugin.settings.variantCacheMaxSize||0)).onChange(async r=>{let s=Number(r);!isNaN(s)&&s>=0&&(this.plugin.settings.variantCacheMaxSize=s,await this.saveSettings())})),new it.Setting(e).setName("Persist cache to disk").setDesc("Save variant cache to disk (survives plugin reloads)").addToggle(t=>t.setValue(this.plugin.settings.variantCachePersist).onChange(async r=>{this.plugin.settings.variantCachePersist=r,await this.saveSettings()})),new it.Setting(e).setName("Clear variant cache").setDesc("Clear all cached name variants").addButton(t=>t.setButtonText("Clear Cache").setCta().onClick(async()=>{this.plugin.nameVariantService&&(this.plugin.nameVariantService.clearCache(),new it.Notice("Variant cache cleared"))}))}};var Su=require("obsidian");var Jo=class extends Q{display(e){new Su.Setting(e).setName("Enable Scaffolds").setDesc("Generate scaffold templates for ideas").addToggle(t=>t.setValue(this.plugin.settings.enableScaffolds).onChange(async r=>{this.plugin.settings.enableScaffolds=r,await this.saveSettings()})),new Su.Setting(e).setName("Scaffold default action").setDesc("Default action when generating scaffold: append to current note or create new note").addDropdown(t=>t.addOption("append","Append to current note").addOption("new-note","Create new note").setValue(this.plugin.settings.scaffoldDefaultAction).onChange(async r=>{this.plugin.settings.scaffoldDefaultAction=r,await this.saveSettings()}))}};var Qi=require("obsidian");var Xo=class extends Q{display(e){new Qi.Setting(e).setName("Enable Project Elevation").setDesc("Allow elevating ideas to full projects").addToggle(s=>s.setValue(this.plugin.settings.enableElevation).onChange(async i=>{this.plugin.settings.enableElevation=i,await this.saveSettings()})),new Qi.Setting(e).setName("Projects Directory").setDesc("Directory where elevated projects will be created (relative to vault root)").addText(s=>s.setPlaceholder("Projects").setValue(this.plugin.settings.elevationProjectsDirectory).onChange(async i=>{let a=i.trim().replace(/^\/+|\/+$/g,"").replace(/\s+/g,"-");this.plugin.settings.elevationProjectsDirectory=a||"Projects",await this.saveSettings()})),new Qi.Setting(e).setName("Default Folders").setDesc("Comma-separated list of folders to create in each elevated project (e.g., docs,notes,assets)").addText(s=>s.setPlaceholder("docs,notes,assets").setValue(this.plugin.settings.elevationDefaultFolders).onChange(async i=>{let a=i.split(",").map(o=>o.trim().replace(/[^a-zA-Z0-9_-]/g,"")).filter(o=>o.length>0).join(",");this.plugin.settings.elevationDefaultFolders=a||"docs,notes,assets",await this.saveSettings()})),new Qi.Setting(e).setName("Create Project Metadata").setDesc("Create project metadata file for future project management integrations (planned expansion)").addToggle(s=>s.setValue(this.plugin.settings.elevationCreateDevraMetadata).onChange(async i=>{this.plugin.settings.elevationCreateDevraMetadata=i,await this.saveSettings()}));let t=e.createDiv("setting-item-description");t.style.marginTop="10px",t.style.padding="10px",t.style.backgroundColor="var(--background-secondary)",t.style.borderRadius="4px";let r=this.plugin.settings.elevationProjectsDirectory||"Projects";t.createEl("strong",{text:"About project elevation:"}),t.createEl("br"),t.createEl("span",{text:`Elevating an idea moves it from the Ideas/ directory to a project folder structure in ${r}/. The original idea file becomes the project's README.md, and default folders are created automatically.`}),t.createEl("br"),t.createEl("br"),t.createEl("strong",{text:"Note:"}),t.createEl("span",{text:" Folder structure customization is planned for v2. Currently, the default structure is used for all projects."})}};var Jr=require("obsidian");var Qo=class extends Q{display(e){new Jr.Setting(e).setName("Enable error logging").setDesc("Collect error logs for bug reports. Logs are stored locally and only sent if you choose to include them.").addToggle(t=>t.setValue(this.plugin.settings.errorLoggingEnabled).onChange(async r=>{this.plugin.settings.errorLoggingEnabled=r,await this.saveSettings(),this.plugin.errorLogService&&this.plugin.errorLogService.updateSettings({enabled:r,maxEntries:this.plugin.settings.errorLogMaxEntries,retentionDays:this.plugin.settings.errorLogRetentionDays})})),new Jr.Setting(e).setName("Maximum log entries").setDesc("Maximum number of error log entries to keep in memory (default: 50)").addText(t=>t.setPlaceholder("50").setValue(String(this.plugin.settings.errorLogMaxEntries)).onChange(async r=>{let s=Number(r);!isNaN(s)&&s>0&&s<=500&&(this.plugin.settings.errorLogMaxEntries=s,await this.saveSettings(),this.plugin.errorLogService&&this.plugin.errorLogService.updateSettings({enabled:this.plugin.settings.errorLoggingEnabled,maxEntries:s,retentionDays:this.plugin.settings.errorLogRetentionDays}))})),new Jr.Setting(e).setName("Log retention (days)").setDesc("Number of days to retain error logs (default: 7)").addText(t=>t.setPlaceholder("7").setValue(String(this.plugin.settings.errorLogRetentionDays)).onChange(async r=>{let s=Number(r);!isNaN(s)&&s>0&&s<=30&&(this.plugin.settings.errorLogRetentionDays=s,await this.saveSettings(),this.plugin.errorLogService&&this.plugin.errorLogService.updateSettings({enabled:this.plugin.settings.errorLoggingEnabled,maxEntries:this.plugin.settings.errorLogMaxEntries,retentionDays:s}))})),new Jr.Setting(e).setName("Clear error logs").setDesc("Clear all stored error logs").addButton(t=>t.setButtonText("Clear Logs").onClick(()=>{this.plugin.errorLogService&&(this.plugin.errorLogService.clearLogs(),new Jr.Notice("Error logs cleared"))}))}};var tr=require("obsidian");var at=require("obsidian");var Yo=class extends at.Modal{errorLogService;systemInfo;requestType="feature";description="";includeErrorLogs=!1;includeSystemInfo=!0;constructor(e,t,r){super(e),this.systemInfo=t,this.errorLogService=r}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-feedback-modal"),e.createEl("h2",{text:"Submit feedback"}),e.createEl("p",{text:"Help improve Ideatr by submitting a feature request or bug report.",cls:"ideatr-feedback-description"});let t=e.createEl("div",{cls:"ideatr-setting-item"});t.createEl("label",{text:"Type:",attr:{for:"ideatr-request-type"},cls:"ideatr-label"});let r=t.createEl("select",{attr:{id:"ideatr-request-type"},cls:"ideatr-select"});r.createEl("option",{text:"Feature request",attr:{value:"feature"}}),r.createEl("option",{text:"Bug report",attr:{value:"bug"}}),r.createEl("option",{text:"Performance issue",attr:{value:"performance"}}),r.value=this.requestType,r.addEventListener("change",x=>{this.requestType=x.target.value,this.updateDescriptionPlaceholder()});let s=e.createEl("div",{cls:"ideatr-setting-item"});s.createEl("label",{text:"Description:",attr:{for:"ideatr-description"},cls:"ideatr-label"});let i=s.createEl("textarea",{attr:{id:"ideatr-description",rows:"8",placeholder:this.getDescriptionPlaceholder()},cls:"ideatr-textarea"});i.value=this.description,i.addEventListener("input",x=>{this.description=x.target.value});let a=e.createEl("div",{cls:"ideatr-feedback-options"});a.createEl("h3",{text:"Additional information (optional)"});let o=a.createEl("div",{cls:"ideatr-checkbox-item"}),l=o.createEl("input",{attr:{type:"checkbox",id:"ideatr-include-system-info",checked:this.includeSystemInfo}});if(o.createEl("label",{text:"Include system information (Obsidian version, plugin version, OS)",attr:{for:"ideatr-include-system-info"}}),l.addEventListener("change",x=>{this.includeSystemInfo=x.target.checked}),this.errorLogService){let x=a.createEl("div",{cls:"ideatr-checkbox-item"}),g=x.createEl("input",{attr:{type:"checkbox",id:"ideatr-include-error-logs",checked:this.includeErrorLogs}});x.createEl("label",{text:"Include recent error logs (last 7 days, sanitized)",attr:{for:"ideatr-include-error-logs"}}),g.addEventListener("change",R=>{this.includeErrorLogs=R.target.checked});let E=this.errorLogService.getRecentLogs();E.length>0&&a.createEl("p",{text:`${E.length} error log${E.length>1?"s":""} available`,cls:"ideatr-help-text"}).addClass("ideatr-log-count")}let c=e.createEl("div",{cls:"ideatr-feedback-preview"});c.createEl("h3",{text:"Preview"});let d=c.createEl("textarea",{attr:{id:"ideatr-preview",rows:"12",readonly:"true"},cls:"ideatr-textarea"});d.addClass("ideatr-preview-textarea");let u=()=>{d.value=this.generateIssueContent()};if(r.addEventListener("change",u),i.addEventListener("input",u),l.addEventListener("change",u),this.errorLogService){let x=e.querySelector("#ideatr-include-error-logs");x&&x.addEventListener("change",u)}u();let h=e.createEl("div",{cls:"ideatr-button-container"});h.createEl("button",{text:"Copy to Clipboard",cls:"mod-cta"}).addEventListener("click",()=>this.handleCopyToClipboard()),h.createEl("button",{text:"Open email",cls:"mod-cta"}).addEventListener("click",()=>this.handleOpenEmail()),h.createEl("button",{text:"Open GitHub issue",cls:"mod-cta"}).addEventListener("click",()=>this.handleOpenGitHub()),h.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close())}getDescriptionPlaceholder(){return this.requestType==="bug"?`Describe the bug:

1. What happened?
2. What did you expect to happen?
3. Steps to reproduce:
   - Step 1
   - Step 2
   - Step 3`:this.requestType==="performance"?`Describe the performance issue:

- What operation is slow?
- How long does it take?
- When did you first notice this?
- Any patterns (specific features, large vaults, etc.)?`:`Describe your feature request:

- What problem does this solve?
- How would you like it to work?
- Any additional context or examples?`}updateDescriptionPlaceholder(){let e=this.contentEl.querySelector("#ideatr-description");e&&(e.placeholder=this.getDescriptionPlaceholder())}generateIssueContent(){let t=`## ${this.requestType==="bug"?"Bug Report":this.requestType==="performance"?"Performance Issue":"Feature Request"}

`;if(this.description.trim()?t+=`${this.description}

`:t+=`[Please describe your ${this.requestType==="bug"?"bug":"feature request"} here]

`,this.includeSystemInfo&&(t+=`## System Information

`,t+=`- **Obsidian Version:** ${this.systemInfo.obsidianVersion}
`,t+=`- **Ideatr Version:** ${this.systemInfo.pluginVersion}
`,t+=`- **Platform:** ${this.systemInfo.platform}
`,t+=`- **OS:** ${this.systemInfo.os}

`),this.includeErrorLogs&&this.errorLogService){let r=this.errorLogService.getRecentLogs();r.length>0&&(t+=this.errorLogService.formatLogsForIssue(r),t+=`

`)}return t.trim()}generateIssueTitle(){let e=this.requestType==="bug"?"[Bug]":this.requestType==="performance"?"[Performance]":"[Feature]",t=this.description.trim();if(t){let s=t.split(`
`)[0].trim(),i=s.length>50?s.substring(0,47)+"...":s;return`${e} ${i}`}let r=this.requestType==="bug"?"Bug report":this.requestType==="performance"?"Performance issue":"Feature request";return`${e} ${r}`}async handleCopyToClipboard(){if(!this.description.trim()){new at.Notice("Please enter a description first");return}let e=this.generateIssueContent();try{if(navigator.clipboard)await navigator.clipboard.writeText(e);else throw new Error("Clipboard API not available");new at.Notice("Content copied to clipboard! Paste it into a GitHub issue.")}catch(t){m.error("Failed to copy to clipboard:",t),new at.Notice("Failed to copy to clipboard. Please copy manually from the preview.")}}handleOpenEmail(){if(!this.description.trim()){new at.Notice("Please enter a description first");return}let e=this.generateEmailSubject(),t=this.generateIssueContent(),r=encodeURIComponent(e),s=encodeURIComponent(t),i=`mailto:ideatr@paraphlabs.com?subject=${r}&body=${s}`;window.location.href=i,new at.Notice("Opening email client...")}generateEmailSubject(){let e=this.requestType==="bug"?"[Bug]":this.requestType==="performance"?"[Performance]":"[Feature]",t=this.description.trim();if(t){let s=t.split(`
`)[0].trim(),i=s.length>60?s.substring(0,57)+"...":s;return`${e} ${i}`}let r=this.requestType==="bug"?"Bug report":this.requestType==="performance"?"Performance issue":"Feature request";return`${e} ${r}`}handleOpenGitHub(){if(!this.description.trim()){new at.Notice("Please enter a description first");return}let e=encodeURIComponent(this.generateIssueTitle()),t=encodeURIComponent(this.generateIssueContent()),r=this.requestType==="bug"?"bug":this.requestType==="performance"?"performance":"enhancement",s=`https://github.com/FallingWithStyle/obsidian-ideatr/issues/new?title=${e}&body=${t}&labels=${r}`;window.open(s,"_blank"),new at.Notice("Opening GitHub issue page...")}onClose(){let{contentEl:e}=this;e.empty()}};var Zo=class extends Q{display(e){new tr.Setting(e).setName("View existing issues").setDesc("Browse and search existing bug reports and feature requests on GitHub").addButton(t=>t.setButtonText("View Issues").onClick(()=>{window.open("https://github.com/FallingWithStyle/obsidian-ideatr/issues","_blank")})),new tr.Setting(e).setName("Submit Feedback").setDesc("Report bugs, suggest features, or report performance issues. Error logs can be included to help diagnose issues.").addButton(t=>t.setButtonText("Submit Feedback").setCta().onClick(()=>{let r="Unknown";try{r=this.app.appVersion||this.app.version||"Unknown"}catch{r="Unknown"}let s={obsidianVersion:r,pluginVersion:this.plugin.manifest.version,platform:tr.Platform.isMobile?"mobile":"desktop",os:tr.Platform.isMacOS?"Mac":tr.Platform.isWin?"Windows":tr.Platform.isLinux?"Linux":"Unknown"};new Yo(this.app,s,this.plugin.errorLogService).open()}))}};var tl=require("obsidian");function $b(n){let e=[];n.metaKey&&e.push("cmd"),n.ctrlKey&&e.push("ctrl"),n.altKey&&e.push("alt"),n.shiftKey&&e.push("shift");let t=n.key.toLowerCase();return t===" "?e.push("space"):t==="enter"?e.push("enter"):t==="escape"?e.push("escape"):t==="tab"?e.push("tab"):t==="backspace"?e.push("backspace"):t==="delete"?e.push("delete"):t==="arrowup"?e.push("arrowup"):t==="arrowdown"?e.push("arrowdown"):t==="arrowleft"?e.push("arrowleft"):t==="arrowright"?e.push("arrowright"):(t.length,e.push(t)),e.join("+")}function Yi(n){return n?n.split("+").map(e=>{let t=e.trim().toLowerCase();return t==="cmd"||t==="meta"?"\u2318":t==="ctrl"?"\u2303":t==="alt"?"\u2325":t==="shift"?"\u21E7":t==="space"?"Space":t==="enter"?"Enter":t==="escape"?"Esc":t==="tab"?"Tab":t==="backspace"?"Backspace":t==="delete"?"Delete":t==="arrowup"?"\u2191":t==="arrowdown"?"\u2193":t==="arrowleft"?"\u2190":t==="arrowright"?"\u2192":t.charAt(0).toUpperCase()+t.slice(1)}).join(" "):""}function el(n,e,t){let r=!1,s=e||"";e?(n.value=Yi(e),s=e):n.value="",n.placeholder="Click and press keys...",n.style.cursor="text",n.style.fontFamily="monospace",n.addEventListener("focus",()=>{r=!0,n.value="",n.placeholder="Press keys...",n.style.backgroundColor="var(--background-modifier-active-hover)"}),n.addEventListener("blur",()=>{r=!1,n.style.backgroundColor="",s?n.value=Yi(s):(n.value=e?Yi(e):"",n.placeholder="Click and press keys...")}),n.addEventListener("keydown",i=>{if(!r||(i.preventDefault(),i.stopPropagation(),["Meta","Control","Alt","Shift"].includes(i.key)))return;let a=$b(i);s=a,n.value=Yi(a),t(a)}),n.addEventListener("keyup",i=>{r&&!i.metaKey&&!i.ctrlKey&&!i.altKey&&!i.shiftKey&&s&&(n.value=Yi(s))})}var rl=class extends Q{display(e){e.createEl("h3",{text:"Capture modal shortcuts"}),new tl.Setting(e).setName("Capture Idea Hotkey").setDesc(`Keyboard shortcut for opening the Capture Idea modal. Click the field and press your desired key combination. Note: This setting stores your preference. To actually bind the hotkey, you must also set it in Obsidian's Hotkeys settings (Settings \u2192 Hotkeys \u2192 search for "Capture Idea").`).addText(t=>{el(t.inputEl,this.plugin.settings.captureIdeaHotkey,async r=>{this.plugin.settings.captureIdeaHotkey=r,await this.saveSettings()})}),new tl.Setting(e).setName("Save Shortcut").setDesc("Keyboard shortcut for the Save button in the Capture Idea modal. Click the field and press your desired key combination.").addText(t=>{el(t.inputEl,this.plugin.settings.captureSaveShortcut,async r=>{this.plugin.settings.captureSaveShortcut=r,await this.saveSettings()})}),new tl.Setting(e).setName("Ideate Shortcut").setDesc("Keyboard shortcut for the Ideate button in the Capture Idea modal. Click the field and press your desired key combination.").addText(t=>{el(t.inputEl,this.plugin.settings.captureIdeateShortcut,async r=>{this.plugin.settings.captureIdeateShortcut=r,await this.saveSettings()})})}};var ta=require("obsidian");var Y=require("obsidian"),rr=ua(require("fs"));var In=class{constructor(e,t){this.app=e;this.pluginDir=t}getTutorialVaultPath(){return"Tutorials"}findTutorialFolder(){let e="Tutorials",t="tutorials",r=this.app.vault.getAbstractFileByPath(e);if(r instanceof Y.TFolder)return r;let s=this.app.vault.getAbstractFileByPath(t);return s instanceof Y.TFolder?s:null}async getBundledTutorialFiles(){let e=new Map;if(this.pluginDir){let t=ee(this.pluginDir,"tutorials");try{if(rr.existsSync(t)&&rr.statSync(t).isDirectory()){let r=rr.readdirSync(t);for(let s of r)if(s.endsWith(".md")){let i=ee(t,s);try{let a=rr.readFileSync(i,"utf-8");e.set(s,a)}catch(a){console.warn(`Error reading tutorial file ${s}:`,a)}}}}catch(r){console.warn("Error reading tutorial directory from plugin:",r)}}if(e.size===0)try{let t=this.findTutorialFolder();if(t instanceof Y.TFolder&&t.children){for(let r of t.children)if(r instanceof Y.TFile&&r.name.endsWith(".md"))try{let s=await this.app.vault.read(r);e.set(r.name,s)}catch(s){console.warn(`Error reading tutorial file ${r.name}:`,s)}}}catch(t){console.warn("Error reading tutorial directory from vault:",t)}return e}async resetTutorials(e=!1){try{let t=await this.getBundledTutorialFiles();if(t.size===0)return new Y.Notice("Tutorial files not found in plugin directory. They may need to be manually restored."),!1;let r=this.getTutorialVaultPath();if(!this.app.vault.getAbstractFileByPath(r))try{await this.app.vault.createFolder(r)}catch(a){let o=a instanceof Error?a.message:String(a);if(o.includes("already exists")||o.includes("Folder already exists")){let l=this.app.vault.getAbstractFileByPath(r)}else if(!this.app.vault.getAbstractFileByPath(r))throw a}let i=0;for(let[a,o]of t.entries()){let l=`${r}/${a}`,c=this.app.vault.getAbstractFileByPath(l);if(c&&c instanceof Y.TFile)e&&(await this.app.vault.modify(c,o),i++);else try{await this.app.vault.create(l,o),i++}catch(d){let u=d instanceof Error?d.message:String(d);if(u.includes("already exists")||u.includes("File already exists")){if(e){let h=this.app.vault.getAbstractFileByPath(l);h&&h instanceof Y.TFile&&(await this.app.vault.modify(h,o),i++)}}else throw d}}return i>0?new Y.Notice(`Tutorials reset successfully! ${i} files restored.`):e&&new Y.Notice("All tutorial files already exist. No changes made."),!0}catch(t){let r=t instanceof Error?t.message:String(t);return!r.includes("already exists")&&!r.includes("File already exists")&&(console.error("Error resetting tutorials:",t),e&&new Y.Notice(`Failed to reset tutorials: ${r}`)),!1}}async deleteTutorials(){try{let e=await this.findTutorialFolder();if(!e)return new Y.Notice("No tutorial files found to delete."),!1;let t=e.path,r=[],s=i=>{i instanceof Y.TFile&&i.path.startsWith(t)&&r.push(i),i instanceof Y.TFolder&&i.children&&i.children.forEach(a=>s(a))};if(s(e),r.length===0)return new Y.Notice("No tutorial files found to delete."),!1;for(let i of r)await this.app.fileManager.trashFile(i);try{e instanceof Y.TFolder&&(!e.children||e.children.length===0)&&await this.app.vault.delete(e,!0)}catch{}return new Y.Notice(`Tutorials deleted successfully! ${r.length} files removed.`),!0}catch(e){return console.error("Error deleting tutorials:",e),new Y.Notice(`Failed to delete tutorials: ${e instanceof Error?e.message:"Unknown error"}`),!1}}tutorialsExistInVault(){let e="Tutorials/00-Index.md",t="tutorials/00-Index.md";return this.app.vault.getAbstractFileByPath(e)instanceof Y.TFile?!0:this.app.vault.getAbstractFileByPath(t)instanceof Y.TFile}async bundledTutorialsAvailable(){return(await this.getBundledTutorialFiles()).size>0}};var sl=class extends Q{tutorialManager;constructor(e,t,r){super(e,t,r);let s=e.vault.adapter.basePath||e.vault.configDir,i=Zr(e.vault.configDir)?e.vault.configDir:ee(s,e.vault.configDir),a=Yr(ee(i,"plugins",t.manifest.id));this.tutorialManager=new In(e,a)}display(e){e.createEl("h2",{text:"Tutorials"}),new ta.Setting(e).setName("Open Tutorials").setDesc("Open the tutorial index to browse all available guides").addButton(t=>t.setButtonText("Open Tutorials").setCta().onClick(async()=>{let{TutorialService:r}=await Promise.resolve().then(()=>(Au(),Nh));await new r(this.app).openIndex()})),new ta.Setting(e).setName("Reset Tutorials").setDesc("Restore tutorial files from the plugin. Use this if tutorials were deleted, modified, or corrupted.").addButton(t=>t.setButtonText("Reset Tutorials").setWarning().onClick(async()=>{t.setDisabled(!0),t.setButtonText("Resetting...");try{await this.tutorialManager.resetTutorials(!0)&&setTimeout(()=>this.refresh(),1e3)}finally{t.setDisabled(!1),t.setButtonText("Reset Tutorials")}})),new ta.Setting(e).setName("Delete Tutorials").setDesc('Remove all tutorial files from your vault. You can restore them later using "Reset Tutorials".').addButton(t=>t.setButtonText("Delete Tutorials").setWarning().onClick(async()=>{if(await Ce(this.app,'Are you sure you want to delete all tutorial files? You can restore them later using "Reset Tutorials".')){t.setDisabled(!0),t.setButtonText("Deleting...");try{await this.tutorialManager.deleteTutorials()&&setTimeout(()=>this.refresh(),1e3)}finally{t.setDisabled(!1),t.setButtonText("Delete Tutorials")}}})),this.displayStatus(e)}async displayStatus(e){let t=e.createDiv("tutorial-status"),r=this.tutorialManager.tutorialsExistInVault(),s=await this.tutorialManager.bundledTutorialsAvailable(),i="",a="";r?(i="Tutorials: Installed",a="Tutorial files are available in your vault."):s?(i="Tutorials: Not Installed",a="Tutorial files are not in your vault, but can be restored from the plugin."):(i="Tutorials: Unavailable",a="Tutorial files are not available. They may need to be manually added."),new ta.Setting(t).setName("Status").setDesc(a).setDisabled(!0).addText(o=>o.setValue(i))}};ir();var Bh={llmProvider:"llama",llamaServerUrl:"http://127.0.0.1:8080",llamaBinaryPath:"",modelPath:"",llamaServerPort:8080,concurrency:1,llmTimeout:1e4,autoClassify:!0,enableDomainCheck:!0,autoCheckDomains:!1,enableProspectr:!1,prospectrUrl:"http://localhost:3000",domainCheckTimeout:1e4,enableWebSearch:!0,autoSearchExistence:!1,webSearchProvider:"google",googleSearchApiKey:"",googleSearchEngineId:"",webSearchTimeout:15e3,maxSearchResults:5,enableNameVariants:!0,autoGenerateVariants:!1,maxVariants:8,useLLMForNameExtraction:!1,variantCacheMaxSize:100,variantCachePersist:!0,enableScaffolds:!0,scaffoldDefaultAction:"append",dashboardDefaultView:"table",dashboardItemsPerPage:50,dashboardAutoRefresh:!0,dashboardPersistFilters:!0,enableClustering:!0,clusteringAlgorithm:"hierarchical",maxClusters:0,clusterColorScheme:"category",clusteringSimilarityThreshold:.3,enableResurfacing:!0,resurfacingThresholdDays:7,resurfacingFrequency:"manual",resurfacingTime:"09:00",autoGenerateDigest:!1,digestIncludeSummary:!0,digestMaxIdeas:0,enableElevation:!0,elevationProjectsDirectory:"Projects",elevationCreateDevraMetadata:!0,elevationDefaultFolders:"docs,notes,assets",setupCompleted:!1,modelDownloaded:!1,keepModelLoaded:!1,preloadOnStartup:!1,localModel:"phi-3.5-mini",preferCloud:!1,cloudProvider:"none",cloudApiKeys:{anthropic:"",openai:"",gemini:"",groq:"",openrouter:""},customEndpointUrl:"",openRouterModel:"",customModelProvider:void 0,customModel:void 0,moveArchivedToFolder:!1,errorLoggingEnabled:!0,errorLogMaxEntries:50,errorLogRetentionDays:7,debugMode:!1,captureIdeaHotkey:"cmd+i",captureSaveShortcut:"alt+enter",captureIdeateShortcut:"cmd+enter"},nl=class extends $h.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Ideatr settings"});let t=e.createDiv({cls:"ideatr-beta-notice"});t.style.cssText="background: var(--background-modifier-border); padding: 1em; border-radius: 4px; margin-bottom: 1.5em; border-left: 3px solid var(--text-accent);";let r=t.createEl("strong",{text:"\u26A0\uFE0F Ideatr is in Beta"});r.style.cssText="display: block; margin-bottom: 0.5em; color: var(--text-accent);";let s=t.createEl("p",{text:"Ideatr is currently in beta. AI technology involves many moving parts, so things might not work as expected 100% of the time. We'd love to hear from you!"});s.style.cssText="margin: 0.5em 0;";let i=t.createDiv();i.style.cssText="margin-top: 0.75em; display: flex; gap: 0.5em; flex-wrap: wrap;";let a=i.createEl("a",{text:"\u{1F4DD} Report Bug or Request Feature",href:"#ideatr-feedback-section"});a.style.cssText="color: var(--text-accent); text-decoration: none; cursor: pointer;",a.addEventListener("click",$=>{$.preventDefault(),setTimeout(()=>{let G=e.querySelector("#ideatr-feedback-section");G&&G.scrollIntoView({behavior:"smooth",block:"start"})},100)});let o=i.createEl("a",{text:"\u{1F5FA}\uFE0F View Planned Features",href:"https://github.com/FallingWithStyle/obsidian-ideatr#roadmap",attr:{target:"_blank",rel:"noopener"}});o.style.cssText="color: var(--text-accent); text-decoration: none;";let l=i.createEl("a",{text:"\u{1F41B} GitHub Issues",href:"https://github.com/FallingWithStyle/obsidian-ideatr/issues",attr:{target:"_blank",rel:"noopener"}});l.style.cssText="color: var(--text-accent); text-decoration: none;";let c=new Ea(this.app,this.plugin,this),d=new Vo(this.app,this.plugin,this),u=new Wo(this.app,this.plugin,this),h=new Ko(this.app,this.plugin,this),p=new Jo(this.app,this.plugin,this),f=new Xo(this.app,this.plugin,this),y=new Qo(this.app,this.plugin,this),S=new Zo(this.app,this.plugin,this),x=new rl(this.app,this.plugin,this),g=new sl(this.app,this.plugin,this);c.display(e),d.display(e);let E=e.createDiv({cls:"settings-section-title"});E.createEl("h2",{text:"Validation tools"});let R=he(this.app,"validation","Learn about Validation Tools");E.appendChild(R),u.display(e);let M=e.createDiv({cls:"settings-section-title"});M.createEl("h2",{text:"Transformation tools"});let B=he(this.app,"transformation","Learn about Transformation Tools");M.appendChild(B),h.display(e),p.display(e),f.display(e),e.createDiv({cls:"settings-section-title",attr:{id:"ideatr-feedback-section"}}).createEl("h2",{text:"Feedback & support"}),S.display(e),e.createEl("h3",{text:"Error logging"}),y.display(e);let U=e.createDiv({cls:"settings-section-title"});U.createEl("h2",{text:"Capture modal"});let q=he(this.app,"capture-workflows","Learn about Capture Modal");U.appendChild(q),x.display(e),g.display(e)}};var Ll=require("obsidian");function Cn(n,e){return`${Eu(n)}.md`}function Eu(n){let e=n.trim().replace(/[:*?"<>|/\\]/g,"").replace(/\s+/g," ").trim();return e.length>100&&(e=e.substring(0,100).trim()),e.length===0&&(e="Untitled"),e}function Uh(n,e){return`${n.replace(/\.md$/,"")}-${e}.md`}function Iu(){let n=Date.now(),e=Math.floor(Math.random()*1e4);return n*1e4+e}function Hh(n){return n.length===0?1:Math.max(...n)+1}function il(n){let e=Iu(),t=0,r=10;for(;n.includes(e)&&t<r;)e=Hh(n),t++;return n.includes(e)?Hh(n):e}function ol(n,e){let t=e?il(e):Iu();return{type:"idea",status:"captured",created:Bb(n.timestamp),id:t,category:"",tags:[],related:[],domains:[],"existence-check":[]}}function Pn(n){let e=["---",`type: ${n.type}`,`status: ${n.status}`,`created: ${n.created}`,`id: ${n.id??0}`,`category: ${n.category||""}`,`tags: ${al(n.tags)}`,`related: ${al(n.related)}`,`domains: ${al(n.domains)}`,`existence-check: ${al(n["existence-check"])}`];return n.elevated&&e.push(`elevated: ${n.elevated}`),n.projectPath&&e.push(`projectPath: ${n.projectPath}`),n.codename&&e.push(`codename: ${n.codename}`),e.push("---"),e.join(`
`)}function Bb(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${r}`}function al(n){return n.length===0?"[]":`[${n.join(", ")}]`}var ll="Ideas",Xr=class{vault;constructor(e){this.vault=e}async createIdeaFile(e){await this.ensureIdeasDirectory();let t=Cn(e.text,e.timestamp),r=`${ll}/${t}`;r=this.resolveCollision(r);let s=ol(e),a=`${Pn(s)}

${e.text}`;return await this.vault.create(r,a)}async ensureIdeasDirectory(){this.vault.getAbstractFileByPath(ll)||await this.vault.createFolder(ll)}resolveCollision(e){let t=e,r=2;for(;this.vault.getAbstractFileByPath(t);){let s=e.split("/").pop()||"",i=Uh(s,r);t=`${ll}/${i}`,r++}return t}fileExists(e){return this.vault.getAbstractFileByPath(e)!==null}async updateIdeaFrontmatter(e,t){await this.vault.process(e,r=>{let s=/^---\n([\s\S]*?)\n---/,i=r.match(s);if(!i)return m.warn("No frontmatter found in file:",e.path),r;let a=i[1],o=(l,c)=>{let d=Array.isArray(c)?`[${c.join(", ")}]`:c,u=new RegExp(`^${l}:.*$`,"m");u.test(a)?a=a.replace(u,`${l}: ${d}`):a+=`
${l}: ${d}`};return Object.entries(t).forEach(([l,c])=>{o(l,c)}),r.replace(s,`---
${a}
---`)})}async appendToFileBody(e,t,r,s=!0){await this.vault.process(e,i=>{let a=this.findSectionInContent(i,t);if(a&&s){let o=i.substring(0,a.start),l=i.substring(a.end);return this.ensureSpacing(o,"before")+r+this.ensureSpacing(l,"after")}else if(a&&!s){let o=i.substring(0,a.end),l=i.substring(a.end);return this.ensureSpacing(o,"before")+`

`+r+this.ensureSpacing(l,"after")}else return this.ensureSpacing(i,"before")+`

`+r})}findSectionInContent(e,t){let r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(`^##\\s+${r}\\s*$`,"im"),i=e.match(s);if(!i||i.index===void 0)return null;let a=i.index,o=a+i[0].length,l=e.substring(o),c=l.match(/^##\s+/m);if(c&&c.index!==void 0)return{start:a,end:o+c.index};let d=/\n\n(?![\s]*[-*|])/,u=l.match(d);if(u&&u.index!==void 0){let h=l.substring(u.index+2);if(h.trim()&&!h.match(/^\s*[-*|]/))return{start:a,end:o+u.index}}return{start:a,end:e.length}}ensureSpacing(e,t="before"){return t==="before"?e.endsWith(`
`)?e:e+`
`:e.startsWith(`
`)?e:`
`+e}};var cl=class{vault;IDEAS_DIR="Ideas/";MIN_SIMILARITY_THRESHOLD=.15;constructor(e){this.vault=e}async findRelatedNotes(e,t=5){let s=this.vault.getMarkdownFiles().filter(o=>o.path.startsWith(this.IDEAS_DIR));if(s.length===0)return[];let i=[];for(let o of s)try{let l=await this.vault.cachedRead(o),c=this.extractBodyText(l),d=this.calculateSimilarity(e,c);d>=this.MIN_SIMILARITY_THRESHOLD&&i.push({file:o,similarity:d})}catch(l){m.warn(`Failed to read file ${o.path}:`,l)}return i.sort((o,l)=>l.similarity-o.similarity),i.slice(0,t).map(({file:o,similarity:l})=>({path:o.path,title:o.basename,similarity:l}))}extractBodyText(e){let t=/^---\n[\s\S]*?\n---(\n\n?|\n?)/,r=e.match(t);return(r?e.substring(r[0].length):e).trim()}calculateSimilarity(e,t){if(!e||!t)return 0;let r=this.tokenize(e),s=this.tokenize(t);if(r.size===0||s.size===0)return 0;let i=new Set([...r].filter(c=>s.has(c))),a=new Set([...r,...s]);if(a.size===0)return 0;let o=i.size/a.size,l=i.size/Math.min(r.size,s.size);return Math.min(o*(1+l*.3),1)}tokenize(e){let t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","are","was","were","been","be","have","has","had","do","does","did","will","would","could","should","may","might","must","can","this","that","these","those","i","you","he","she","it","we","they","what","which","who","when","where","why","how","all","each","every","some","any","no","other","another","such","only","just","more","most","very","much","many","few","little","own","same","so","than","too","also"]),a=e.toLowerCase().replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1").replace(/#{1,6}\s+/g,"").replace(/\*\*([^\*]+)\*\*/g,"$1").replace(/\*([^\*]+)\*/g,"$1").replace(/`([^`]+)`/g,"$1").replace(/[^\w\s]/g," ").split(/\s+/).map(o=>o.trim()).filter(o=>o.length>3&&!t.has(o));return new Set(a)}};var dl=class{llmService;searchService;constructor(e,t){this.llmService=e,this.searchService=t}isAvailable(){return this.llmService.isAvailable()}async classifyIdea(e){let t={category:"",tags:[],related:[]},r=[];return this.llmService.isAvailable()&&r.push(this.llmService.classify(e).then(s=>{t.category=s.category,t.tags=[...new Set(s.tags)]}).catch(s=>{m.warn("LLM classification failed:",s)})),r.push(this.searchService.findRelatedNotes(e,3).then(s=>{t.related=s.map(i=>i.path)}).catch(s=>{m.warn("Related note search failed:",s)})),await Promise.all(r),t}};var ul=class{searchService;DEFAULT_THRESHOLD=.75;constructor(e){this.searchService=e}async checkDuplicate(e,t){let r=t??this.DEFAULT_THRESHOLD;if(!e||e.trim().length===0)return{isDuplicate:!1,duplicates:[],threshold:r};let i=(await this.searchService.findRelatedNotes(e,10)).filter(a=>a.similarity!==void 0&&a.similarity>=r);return{isDuplicate:i.length>0,duplicates:i,threshold:r}}};var pl=class{prospectrService;constructor(e){this.prospectrService=e}extractDomains(e){let t=/\b([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.(?:[a-zA-Z]{2,}))\b/g,r=e.match(t);if(!r)return[];let s=/["']([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})["']/g,i=e.match(s);i&&i.forEach(l=>{let c=l.replace(/["']/g,"");r.includes(c)||r.push(c)});let a=/domain(?:s)?:\s*([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi,o=e.match(a);return o&&o.forEach(l=>{let c=l.replace(/domain(?:s)?:\s*/i,"").trim();c&&!r.includes(c)&&r.push(c)}),[...new Set(r.map(l=>l.toLowerCase().trim()))]}async checkDomains(e,t){let r=this.extractDomains(e);if(r.length===0)return[];if(!this.prospectrService.isAvailable())return r.map(s=>({domain:s,available:!1,error:"Prospectr service is not available",checkedAt:new Date().toISOString()}));try{return await this.prospectrService.checkDomainsAvailability(r)}catch(s){return m.warn("Domain checking failed:",s),r.map(i=>({domain:i,available:!1,error:s instanceof Error?s.message:"Unknown error",checkedAt:new Date().toISOString()}))}}};var ml=class{prospectrUrl;isEnabled;timeout;constructor(e="http://localhost:3000",t=1e4){this.prospectrUrl=e,this.timeout=t,this.isEnabled=!1}isAvailable(){return this.prospectrUrl,this.timeout,this.isEnabled}async checkDomainAvailability(e){return this.isAvailable()?{domain:e,available:!1,error:"Domain checking service is not yet implemented",checkedAt:new Date().toISOString()}:{domain:e,available:!1,error:"Prospectr service is not available",checkedAt:new Date().toISOString()}}async checkDomainsAvailability(e){return await Promise.all(e.map(r=>this.checkDomainAvailability(r)))}};var jh=require("obsidian");var hl=class{settings;constructor(e){this.settings=e}isAvailable(){return this.settings.webSearchProvider==="none"?!1:this.settings.webSearchProvider==="google"?!!(this.settings.googleSearchApiKey&&this.settings.googleSearchEngineId):!1}async search(e,t,r){if(!this.isAvailable()||!e||e.trim().length===0)return[];let s=r||this.settings.maxSearchResults||5;try{let i=await this.performSearch(e,s);return this.processResults(i,e)}catch(i){return m.warn("Web search failed:",i),[]}}async performSearch(e,t){if(this.settings.webSearchProvider!=="google")throw new Error("Only Google Custom Search is currently supported");let r=this.settings.googleSearchApiKey,s=this.settings.googleSearchEngineId,i=`https://www.googleapis.com/customsearch/v1?key=${r}&cx=${s}&q=${encodeURIComponent(e)}&num=${Math.min(t,10)}`,a=new Promise((o,l)=>{setTimeout(()=>l(new Error(`Timeout: Request exceeded ${this.settings.webSearchTimeout}ms`)),this.settings.webSearchTimeout)});try{let o=await Promise.race([(0,jh.requestUrl)({url:i,method:"GET",throw:!1}),a]);if(o.status<200||o.status>=300)throw o.status===429?new Error("API rate limit exceeded"):new Error(`HTTP ${o.status}: Request failed`);return(typeof o.json=="function"?await o.json():o.json).items||[]}catch(o){throw o instanceof Error&&o.message.includes("Timeout")||o instanceof Error?o:new Error(String(o))}}processResults(e,t){if(!e||e.length===0)return[];let s=t.toLowerCase().split(/\s+/),i=e.map(a=>{let o=a.title||"",l=a.snippet||"",c=a.link||"",d;if(a.pagemap?.metatags){for(let h of a.pagemap.metatags)if(h["article:published_time"]){d=h["article:published_time"].split("T")[0];break}}let u=this.calculateRelevance(o,l,s);return{title:o,url:c,snippet:l,date:d,relevance:u}});return i.sort((a,o)=>(o.relevance||0)-(a.relevance||0)),i.filter(a=>(a.relevance||0)>=.3)}calculateRelevance(e,t,r){let s=e.toLowerCase(),i=t.toLowerCase(),a=`${s} ${i}`,o=0,l=0;for(let d of r)a.includes(d)&&(l++,s.includes(d)?o+=.3:o+=.1);let c=l/r.length;return o=Math.min(o+c*.2,1),Math.round(o*100)/100}};var fl=class{cache;ttl;maxSize;statistics;constructor(e=24*60*60*1e3,t=0){this.cache=new Map,this.ttl=e,this.maxSize=t,this.statistics={hits:0,misses:0}}get(e){let t=this.normalizeKey(e),r=this.cache.get(t);return r?Date.now()-r.timestamp>this.ttl?(this.cache.delete(t),this.statistics.misses++,null):(this.statistics.hits++,r.variants):(this.statistics.misses++,null)}set(e,t,r){let s=this.normalizeKey(e);this.maxSize>0&&this.cache.size>=this.maxSize&&!this.cache.has(s)&&this.evictOldest(),this.cache.set(s,{variants:t,timestamp:Date.now(),quality:r})}clearExpired(){let e=Date.now(),t=0;for(let[r,s]of this.cache.entries())e-s.timestamp>this.ttl&&(this.cache.delete(r),t++);return t}clear(){this.cache.clear(),this.statistics={hits:0,misses:0}}size(){return this.cache.size}getStatistics(){let e=this.statistics.hits+this.statistics.misses,t=e>0?this.statistics.hits/e:0,r=null,s=null;for(let i of this.cache.values())(r===null||i.timestamp<r)&&(r=i.timestamp),(s===null||i.timestamp>s)&&(s=i.timestamp);return{totalEntries:this.cache.size,totalHits:this.statistics.hits,totalMisses:this.statistics.misses,hitRate:Math.round(t*100)/100,oldestEntry:r,newestEntry:s}}resetStatistics(){this.statistics={hits:0,misses:0}}loadFromData(e){this.cache.clear();let t=Date.now();for(let[r,s]of Object.entries(e))t-s.timestamp<=this.ttl&&this.cache.set(r,s)}toData(){let e={};for(let[t,r]of this.cache.entries())e[t]=r;return e}evictOldest(){let e=null,t=Date.now();for(let[r,s]of this.cache.entries())s.timestamp<t&&(t=s.timestamp,e=r);e&&this.cache.delete(e)}normalizeKey(e){return e.toLowerCase().trim()}};function Ub(n){return{synonym:"synonym",short:"short","domain-hack":"domain name",phonetic:"phonetic",portmanteau:"portmanteau","made-up":"made-up"}[n]||n}function qh(n,e=10){if(n.length===0)return`## Name Variants

(No variants generated)`;let t=new Map;for(let i of n){let a=i.text.toLowerCase();t.has(a)||t.set(a,i)}return`## Name Variants

${Array.from(t.values()).sort((i,a)=>i.text.localeCompare(a.text)).slice(0,e).map(i=>`- ${i.text} (${Ub(i.type)})`).join(`
`)}`}async function Hb(n,e,t=!1){return!n||n.trim().length===0?"":t&&e?await $u(n,e):le(n)}function Gh(n){return le(n)}var gl=class{llmService;settings;cache;loadCacheData;saveCacheData;constructor(e,t,r,s){this.llmService=e,this.settings=t,this.cache=new fl(24*60*60*1e3,t.variantCacheMaxSize||0),this.loadCacheData=r,this.saveCacheData=s,t.variantCachePersist&&r&&this.loadCache().catch(i=>{m.warn("Failed to load variant cache:",i)})}async loadCache(){if(this.loadCacheData)try{let e=await this.loadCacheData();e&&typeof e=="object"&&this.cache.loadFromData(e)}catch(e){m.warn("Failed to load variant cache:",e)}}async saveCache(){if(!(!this.settings.variantCachePersist||!this.saveCacheData))try{let e=this.cache.toData();await this.saveCacheData(e)}catch(e){m.warn("Failed to save variant cache:",e)}}getCacheStatistics(){return this.cache.getStatistics()}clearCache(){this.cache.clear(),this.saveCache().catch(e=>{m.warn("Failed to save cache after clear:",e)})}async generateVariants(e,t){let r=t||await Hb(e,this.llmService,this.settings.useLLMForNameExtraction||!1);if(!r||r.trim().length===0)return[];let s=this.cache.get(r);if(s)return s;if(this.llmService.isAvailable())try{let o=await this.generateVariantsWithLLM(r);if(o.length>0){let l=this.calculateAverageQuality(o);return this.cache.set(r,o,l),this.settings.variantCachePersist&&this.saveCache().catch(c=>m.warn("Cache save failed:",c)),o}}catch(o){m.warn("LLM variant generation failed, using fallback:",o)}let i=this.generateFallbackVariants(r),a=this.calculateAverageQuality(i,!1);return this.cache.set(r,i,a),this.settings.variantCachePersist&&this.saveCache().catch(o=>m.warn("Cache save failed:",o)),i}isAvailable(){return!0}async generateVariantsWithLLM(e){let t=this.constructPrompt(e);if(this.llmService.complete&&typeof this.llmService.complete=="function")try{let r=await this.llmService.complete(t,{temperature:.8,n_predict:512,stop:["}"]}),s=this.parseVariantResponse(r);if(s.length>0)return s}catch(r){m.warn("LLM completion failed, using fallback:",r)}return[]}parseVariantResponse(e){try{let t=z(e,!1),r=JSON.parse(t);return!r.variants||!Array.isArray(r.variants)?[]:r.variants.filter(s=>typeof s=="object"&&s!==null&&"text"in s&&"type"in s).map(s=>({text:String(s.text||"").trim(),type:this.validateVariantType(String(s.type||"")),quality:this.calculateVariantQuality(String(s.text||"").trim(),this.validateVariantType(String(s.type||"")))})).slice(0,this.settings.maxVariants||10)}catch(t){return m.warn("Failed to parse variant response:",e,t),[]}}validateVariantType(e){return["synonym","short","domain-hack","phonetic","portmanteau","made-up"].includes(e)?e:"made-up"}constructPrompt(e){return`Generate creative, brandable name variants for: "${e}"

CRITICAL REQUIREMENTS:
- Extract the CORE CONCEPT, not just use the literal text
- Focus on what makes the idea unique and memorable
- Generate names that could actually be used as product/brand names
- Prioritize creativity and memorability over literal translation

Generate 8-12 high-quality, brandable name variants. Each variant must be:
- Memorable and easy to pronounce (test: can you say it out loud naturally?)
- Distinct and creative (avoid generic words like "AI", "App", "Tool")
- Brandable (could you see this as a real product name?)
- 2-15 characters for most variants (domain hacks can be slightly longer if clever)

Variant types (use diverse mix):
1. synonym - Words capturing the idea's essence (e.g., "puzzle game" \u2192 "Riddle", "Enigma")
2. short - Concise, punchy names 3-8 chars (e.g., "notification" \u2192 "Ping", "Buzz")
3. domain-hack - TLD completes word naturally, MUST be short and clever (e.g., "find.it", "read.ly", NOT "longphrase.io")
4. phonetic - Similar sound, different spelling (e.g., "notify" \u2192 "Notifai")
5. portmanteau - Blend two relevant words (e.g., "net" + "flicks" \u2192 "Netflix")
6. made-up - Invented but pronounceable words (e.g., "Zapier", "Slack", "Figma")

STRICT RULES:
- NEVER create unpronounceable acronyms (e.g., "AGPFOIM" is BAD)
- If using acronyms, they must be 6 chars or fewer AND pronounceable (e.g., "ACME", "NASA")
- Domain hacks: Must be SHORT (under 12 chars total) and clever, not just appending .io to long phrases
- Avoid overly generic terms (e.g., "AI", "App", "Tool" alone are too generic)
- Short names: Must be meaningful words or pronounceable invented words, not random letters
- Extract the essence: For "AI puzzle with monkeys like Where's Waldo" \u2192 focus on "puzzle", "find", "monkey", "hidden", not the full description

Examples:

Input: "notification app"
Output: {
  "variants": [
    {"text": "Alert", "type": "synonym"},
    {"text": "Ping", "type": "short"},
    {"text": "Buzz", "type": "short"},
    {"text": "notif.io", "type": "domain-hack"},
    {"text": "Notifai", "type": "phonetic"},
    {"text": "Alertify", "type": "made-up"},
    {"text": "Signal", "type": "synonym"},
    {"text": "Chime", "type": "short"}
  ]
}

Input: "AI generated puzzle full of interlinked monkeys that look similar, sort of a where's waldo of monkeys"
Output: {
  "variants": [
    {"text": "MonkeyFind", "type": "portmanteau"},
    {"text": "PrimateSeek", "type": "portmanteau"},
    {"text": "FindMonkey", "type": "portmanteau"},
    {"text": "WaldoMonkey", "type": "portmanteau"},
    {"text": "SpotTheApe", "type": "portmanteau"},
    {"text": "MonkeyHunt", "type": "portmanteau"},
    {"text": "PrimatePuzzle", "type": "portmanteau"},
    {"text": "ApeSpot", "type": "short"},
    {"text": "MonkeySee", "type": "portmanteau"},
    {"text": "find.ape", "type": "domain-hack"},
    {"text": "Spotly", "type": "made-up"},
    {"text": "Primate", "type": "synonym"}
  ]
}

Input: "meditation tracker"
Output: {
  "variants": [
    {"text": "Mindful", "type": "synonym"},
    {"text": "Zen", "type": "short"},
    {"text": "Breathe", "type": "synonym"},
    {"text": "Mindspace", "type": "portmanteau"},
    {"text": "Breathly", "type": "made-up"},
    {"text": "Calmly", "type": "made-up"},
    {"text": "Zenly", "type": "made-up"}
  ]
}

Input: "task manager"
Output: {
  "variants": [
    {"text": "Organize", "type": "synonym"},
    {"text": "Tasker", "type": "short"},
    {"text": "Doable", "type": "made-up"},
    {"text": "get.done", "type": "domain-hack"},
    {"text": "Taskly", "type": "phonetic"},
    {"text": "Tackle", "type": "synonym"},
    {"text": "Action", "type": "synonym"}
  ]
}

Input: "${e}"
Output: {`}formatVariantsForMarkdown(e){return qh(e,this.settings.maxVariants||10)}calculateVariantQuality(e,t){let r=.5;return e.length>=3&&e.length<=15?r+=.2:e.length>15&&e.length<=25?r+=.1:(e.length<3||e.length>30)&&(r-=.2),r+={synonym:.15,portmanteau:.15,phonetic:.1,short:.05,"domain-hack":.05,"made-up":0}[t]||0,/^[a-z]+$/i.test(e)&&(r+=.1),e.split(/\s+/).length<=2&&(r+=.05),Math.max(0,Math.min(1,r))}calculateAverageQuality(e,t=!0){if(e.length===0)return 0;let r=e.map(i=>i.quality!==void 0?i.quality:this.calculateVariantQuality(i.text,i.type)),s=r.reduce((i,a)=>i+a,0)/r.length;return t?Math.min(1,s+.1):s}generateFallbackVariants(e){let t=[],r=e.split(/\s+/).filter(l=>l.length>0&&l.length<=15),s=e.replace(/\s+/g,"").toLowerCase(),i=r.filter(l=>{let c=l.toLowerCase();return!["the","a","an","of","for","with","that","this","is","are","was","were"].includes(c)}),a=i.length>0?i:r;if(a.length>0){let l=a[0];if(l.length>=3&&l.length<=12){let c=l.charAt(0).toUpperCase()+l.slice(1).toLowerCase();t.push({text:c,type:"short"})}}if(s.length>0&&s.length<=12&&(t.push({text:`${s}.io`,type:"domain-hack"}),s.length<=10&&t.push({text:`${s}.app`,type:"domain-hack"})),a.length>=2){let l=a[0].toLowerCase(),c=a[1].toLowerCase();if(l.length<=8&&c.length<=8){let d=l+c,u=l.substring(0,Math.min(4,l.length))+c;if(d.length<=12){let h=d.charAt(0).toUpperCase()+d.slice(1);t.push({text:h,type:"portmanteau"})}if(u.length<=12&&u!==d){let h=u.charAt(0).toUpperCase()+u.slice(1);t.push({text:h,type:"portmanteau"})}}}if(a.length>=2&&a.length<=4){let l=a.map(c=>c[0]?.toUpperCase()||"").join("");l.length>=2&&l.length<=4&&t.push({text:l,type:"short"})}return t.map(l=>({...l,quality:this.calculateVariantQuality(l.text,l.type)})).slice(0,this.settings.maxVariants||8)}};var jb={saas:"project",tool:"project",ux:"project",game:"game-mechanic",mechanic:"game-mechanic",story:"narrative-seed",ip:"narrative-seed",hardware:"hardware-concept",brand:"hardware-concept",personal:"generic-idea","":"generic-idea"},qb={id:"project",name:"Project Scaffold",categories:["saas","tool","ux"],sections:[{title:"Overview",content:`## Overview

**Name**: {{ideaName}}

{{ideaText}}

**Category**: {{category}}

**Created**: {{created}}`},{title:"Core Features",content:`## Core Features

- [ ] Feature 1
- [ ] Feature 2
- [ ] Feature 3`,questions:["What are the core features of this project?","What problems does it solve?","Who is the target audience?"]},{title:"Technical Considerations",content:`## Technical Considerations

- Technology stack
- Architecture decisions
- Scalability requirements`,questions:["What technologies are needed?","What are the technical challenges?","What infrastructure is required?"]},{title:"Next Steps",content:`## Next Steps

- [ ] Research existing solutions
- [ ] Validate market need
- [ ] Create prototype
- [ ] Gather feedback`}]},Gb={id:"game-mechanic",name:"Game Mechanic Scaffold",categories:["game","mechanic"],sections:[{title:"Overview",content:`## Overview

**Name**: {{ideaName}}

{{ideaText}}

**Category**: {{category}}

**Created**: {{created}}`},{title:"Mechanic Description",content:`## Mechanic Description

Describe how the mechanic works:

- Core gameplay loop
- Player interactions
- Progression systems`,questions:["How does this mechanic work?","What makes it engaging?","How does it fit into the larger game?"]},{title:"Implementation Considerations",content:`## Implementation Considerations

- Technical requirements
- Balance and tuning
- Player feedback systems`,questions:["What technical challenges exist?","How will this be balanced?","What metrics will measure success?"]},{title:"Next Steps",content:`## Next Steps

- [ ] Create prototype
- [ ] Playtest mechanic
- [ ] Iterate based on feedback
- [ ] Document design decisions`}]},zb={id:"narrative-seed",name:"Narrative Seed Scaffold",categories:["story","ip"],sections:[{title:"Overview",content:`## Overview

**Name**: {{ideaName}}

{{ideaText}}

**Category**: {{category}}

**Created**: {{created}}`},{title:"Core Concept",content:`## Core Concept

- Main premise
- Key themes
- Unique elements`,questions:["What is the central premise?","What themes does this explore?","What makes this story unique?"]},{title:"Characters and World",content:`## Characters and World

- Main characters
- Setting details
- World-building elements`,questions:["Who are the main characters?","Where does this take place?","What are the key world-building elements?"]},{title:"Development",content:`## Development

- Plot structure
- Key scenes
- Resolution`,questions:["What is the story structure?","What are the key turning points?","How does it resolve?"]}]},Vb={id:"hardware-concept",name:"Hardware Concept Scaffold",categories:["hardware","brand"],sections:[{title:"Overview",content:`## Overview

**Name**: {{ideaName}}

{{ideaText}}

**Category**: {{category}}

**Created**: {{created}}`},{title:"Product Description",content:`## Product Description

- Physical specifications
- Key features
- Design considerations`,questions:["What does this product do?","What are the key features?","What is the target market?"]},{title:"Technical Requirements",content:`## Technical Requirements

- Components needed
- Manufacturing considerations
- Technical challenges`,questions:["What components are required?","What are the manufacturing challenges?","What technical expertise is needed?"]},{title:"Next Steps",content:`## Next Steps

- [ ] Create detailed specifications
- [ ] Research manufacturing options
- [ ] Build prototype
- [ ] Test and iterate`}]},zh={id:"generic-idea",name:"Idea Scaffold",categories:["personal",""],sections:[{title:"Overview",content:`## Overview

**Name**: {{ideaName}}

{{ideaText}}

**Category**: {{category}}

**Created**: {{created}}`},{title:"Key Points",content:`## Key Points

- Main concept
- Important details
- Related ideas`,questions:["What is the core idea?","What are the key elements?","What should be explored further?"]},{title:"Next Steps",content:`## Next Steps

- [ ] Research
- [ ] Develop further
- [ ] Take action`}]},yl=[qb,Gb,zb,Vb,zh];function Vh(n){let e=jb[n]||"generic-idea";return yl.find(t=>t.id===e)||zh}var Cu=require("obsidian");var Rn=".ideatr/templates",bl=class{vault;app;customTemplates=[];allTemplates=[];constructor(e,t){this.vault=e,this.allTemplates=[...yl],e&&this.loadCustomTemplates().catch(r=>{m.warn("Failed to load custom templates:",r)})}async loadCustomTemplates(){if(this.vault)try{if(!this.vault.getAbstractFileByPath(Rn)){this.updateAllTemplates();return}let t=this.vault.getFiles().filter(s=>s.path.startsWith(Rn+"/")&&s.extension==="json"),r=[];for(let s of t)try{let i=await this.vault.read(s),a=JSON.parse(i);this.validateTemplate(a)?r.push(a):m.warn(`Invalid template structure in ${s.path}`)}catch(i){m.warn(`Failed to load template from ${s.path}:`,i)}this.customTemplates=r,this.updateAllTemplates()}catch(e){m.warn("Failed to load custom templates:",e),this.updateAllTemplates()}}updateAllTemplates(){let e=new Map;for(let t of yl)e.set(t.id,t);for(let t of this.customTemplates)e.set(t.id,t);this.allTemplates=Array.from(e.values())}validateTemplate(e){if(!e||typeof e!="object")return!1;let t=e;return typeof t.id=="string"&&typeof t.name=="string"&&Array.isArray(t.categories)&&Array.isArray(t.sections)&&t.sections.every(r=>{if(!r||typeof r!="object")return!1;let s=r;return typeof s.title=="string"&&typeof s.content=="string"})}async saveCustomTemplate(e){if(!this.vault)throw new Error("Vault not available for saving templates");this.vault.getAbstractFileByPath(Rn)||await this.vault.createFolder(Rn);let r=`${e.id}.json`,s=`${Rn}/${r}`,i=JSON.stringify(e,null,2),a=this.vault.getAbstractFileByPath(s);a&&a instanceof Cu.TFile?await this.vault.modify(a,i):await this.vault.create(s,i),await this.loadCustomTemplates()}async deleteCustomTemplate(e){if(!this.vault)throw new Error("Vault not available for deleting templates");let t=`${Rn}/${e}.json`,r=this.vault.getAbstractFileByPath(t);r&&r instanceof Cu.TFile&&(this.app?await this.app.fileManager.trashFile(r):this.vault&&await this.vault.delete(r),await this.loadCustomTemplates())}getAvailableTemplates(){return this.allTemplates}isAvailable(){return!0}generateScaffold(e,t,r){let s=r||Gh(e),i=this.selectTemplate(t),a={ideaName:s,ideaText:e||"",category:t||"uncategorized",created:new Date().toISOString().split("T")[0],tags:""};return i.sections.map(l=>{let c=this.substituteVariables(l.content,a);if(l.questions&&l.questions.length>0){let d=l.questions.map(u=>`- ${u}`).join(`
`);c+=`

### Questions to Consider

${d}`}return c}).join(`

`)}selectTemplate(e){let t=Vh(e).id;return this.allTemplates.find(r=>r.id===t)||this.allTemplates.find(r=>r.id==="generic-idea")||this.allTemplates[0]}substituteVariables(e,t){let r=e;for(let[s,i]of Object.entries(t)){let a=new RegExp(`\\{\\{${s}\\}\\}`,"g");r=r.replace(a,i||"")}return r}};var ot=class{parseFrontmatter(e){let t=/^---\n([\s\S]*?)\n---/,r=e.match(t);if(!r||!r[1])return null;let s=r[1],i={},a=s.split(`
`),o=null,l=null,c=null,d=0,u="";for(let x of a){let g=x.trim();if(g.startsWith("type:"))o=g.substring(5).trim();else if(g.startsWith("status:"))l=g.substring(7).trim();else if(g.startsWith("created:"))c=g.substring(8).trim();else if(g.startsWith("id:")){let E=g.substring(3).trim(),R=parseInt(E,10);isNaN(R)||(d=R)}else g.startsWith("category:")&&(u=g.substring(9).trim())}if(!o||!l||!c)return null;i.type=o,i.status=l,i.created=c,i.id=d,i.category=u,i.tags=this.parseArrayField(s,"tags"),i.related=this.parseNumberArrayField(s,"related"),i.domains=this.parseArrayField(s,"domains"),i["existence-check"]=this.parseArrayField(s,"existence-check");let h=s.match(/^elevated:\s*(.+)$/m),p=s.match(/^projectPath:\s*(.+)$/m),f=s.match(/^codename:\s*(.+)$/m);h&&(i.elevated=h[1].trim()),p&&(i.projectPath=p[1].trim()),f&&(i.codename=f[1].trim());let y=s.match(/^dismissed:\s*(.+)$/m),S=s.match(/^actedUpon:\s*(.+)$/m);return y&&(i.dismissed=y[1].trim().toLowerCase()==="true"),S&&(i.actedUpon=S[1].trim().toLowerCase()==="true"),this.validateFrontmatter(i)?i:null}parseArrayField(e,t){let r=new RegExp(`^${t}:\\s*(.+)$`,"m"),s=e.match(r);if(!s)return[];let i=s[1].trim();if(i==="[]")return[];let a=i.match(/^\[(.+)\]$/);return a?a[1].split(",").map(l=>l.trim()).filter(l=>l.length>0):[]}parseNumberArrayField(e,t){let r=new RegExp(`^${t}:\\s*(.+)$`,"m"),s=e.match(r);if(!s)return[];let i=s[1].trim();if(i==="[]")return[];let a=i.match(/^\[(.+)\]$/);return a?a[1].split(",").map(l=>{let c=l.trim().replace(/^["']|["']$/g,""),d=parseInt(c,10);return isNaN(d)?0:d}).filter(l=>l!==0):[]}parseIdeaFile(e,t){let r=this.parseFrontmatter(t);return r?{frontmatter:r,body:this.extractBody(t),filename:e.name}:{frontmatter:{type:"idea",status:"captured",created:new Date().toISOString().split("T")[0],id:0,category:"",tags:[],related:[],domains:[],"existence-check":[]},body:this.extractBody(t),filename:e.name}}parse(e){let t=this.parseFrontmatter(e),r=this.extractBody(e);return t?{frontmatter:t,body:r}:{frontmatter:{type:"idea",status:"captured",created:new Date().toISOString().split("T")[0],id:0,category:"",tags:[],related:[],domains:[],"existence-check":[]},body:r}}build(e,t){return`${Pn(e)}

${t}`}extractBody(e){let t=/^---\n[\s\S]*?\n---(\n\n?|\n?)/;return e.replace(t,"").trim()}validateFrontmatter(e){if(!e.type||e.type!=="idea")return!1;let t=["captured","elevated","archived","validated","promoted"];if(!e.status||!t.includes(e.status)||!e.created||typeof e.created!="string"||!/^\d{4}-\d{2}-\d{2}$/.test(e.created)||((e.id===void 0||typeof e.id!="number")&&(e.id=0),e.category!==void 0&&typeof e.category!="string"))return!1;let s=["tags","related","domains","existence-check"];for(let i of s)if(e[i]!==void 0&&!Array.isArray(e[i]))return!1;return!0}};var Wh=require("obsidian");var wl=class{constructor(e,t){this.vault=e;this.parser=t||new ot}cache=new Map;watchers=new Set;parser;MAX_CACHE_SIZE=1e4;async getAllIdeas(){let t=this.vault.getMarkdownFiles().filter(s=>s.path.startsWith("Ideas/")),r=[];for(let s of t)try{let i=await this.vault.read(s),a=this.parser.parseIdeaFile(s,i);if(r.push(a),this.cache.set(s.path,a),this.cache.size>this.MAX_CACHE_SIZE){let o=this.cache.keys().next().value;o&&this.cache.delete(o)}}catch{let a=new Be(`Failed to read idea file: ${s.path}`,"FILE_READ_ERROR");m.warn(a.message,a)}return r}async getIdeasByFilter(e){let r=this.cache.size>0?Array.from(this.cache.values()):await this.getAllIdeas();if(e.categories&&e.categories.length>0&&(r=r.filter(s=>e.categories.includes(s.frontmatter.category))),e.tags&&e.tags.length>0&&(r=r.filter(s=>e.tags.some(i=>s.frontmatter.tags.includes(i)))),e.status&&(r=r.filter(s=>s.frontmatter.status===e.status)),e.uncategorized&&(r=r.filter(s=>s.frontmatter.category==="")),e.searchText){let s=e.searchText.toLowerCase();r=r.filter(i=>{let a=i.filename.toLowerCase(),o=i.body.toLowerCase(),l=i.frontmatter.tags.join(" ").toLowerCase();return a.includes(s)||o.includes(s)||l.includes(s)})}return e.dateRange&&(r=r.filter(s=>{let i=new Date(s.frontmatter.created);return i>=e.dateRange.start&&i<=e.dateRange.end})),r}async getIdeaByPath(e){if(!e.startsWith("Ideas/"))return null;let t=this.vault.getAbstractFileByPath(e),r=t instanceof Wh.TFile?t:null;if(!r)return null;try{let s=await this.vault.read(r),i=this.parser.parseIdeaFile(r,s);if(this.cache.set(e,i),this.cache.size>this.MAX_CACHE_SIZE){let a=this.cache.keys().next().value;a&&this.cache.delete(a)}return i}catch(s){return m.warn(`Failed to read idea file: ${e}`,s),null}}watchIdeas(e){let t=async o=>{if(o.path.startsWith("Ideas/")){try{let c=await this.vault.read(o),d=this.parser.parseIdeaFile(o,c);this.cache.set(o.path,d)}catch{this.cache.delete(o.path)}let l=Array.from(this.cache.values());e(l)}},r=o=>{if(o.path.startsWith("Ideas/")){this.cache.delete(o.path);let l=Array.from(this.cache.values());e(l)}},s=this.vault.on("modify",t),i=this.vault.on("create",t),a=this.vault.on("delete",r);return this.watchers.add(s),this.watchers.add(i),this.watchers.add(a),()=>{s(),i(),a(),this.watchers.delete(s),this.watchers.delete(i),this.watchers.delete(a)}}async refresh(){this.cache.clear(),await this.getAllIdeas()}};var _n=class{isAvailable(){return!0}generateEmbedding(e){let t=this.tokenize(e),r=this.calculateWordFrequencies(t),s=[],i=Array.from(new Set(t));for(let a=0;a<50;a++){let o=0;for(let l of i){let c=this.simpleHash(l+a);o+=c%100/100*r[l]}s.push(o/i.length)}return s}generateEmbeddings(e){return e.map(t=>this.generateEmbedding(t))}calculateSimilarityMatrix(e){let t=[];for(let r=0;r<e.length;r++){let s=[],i=this.getIdeaText(e[r]);for(let a=0;a<e.length;a++)if(r===a)s.push(1);else{let o=this.getIdeaText(e[a]),l=this.calculateSimilarity(i,o);s.push(l)}t.push(s)}return t}calculateSimilarity(e,t){let r=new Set(this.tokenize(e.toLowerCase())),s=new Set(this.tokenize(t.toLowerCase()));if(r.size===0&&s.size===0)return 1;if(r.size===0||s.size===0)return 0;let i=new Set([...r].filter(o=>s.has(o))),a=new Set([...r,...s]);return i.size/a.size}tokenize(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(t=>t.length>0)}calculateWordFrequencies(e){let t={};for(let r of e)t[r]=(t[r]||0)+1;return t}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);t=(t<<5)-t+s,t=t&t}return Math.abs(t)}getIdeaText(e){let t=[];return e.frontmatter.category&&t.push(e.frontmatter.category),t.push(...e.frontmatter.tags),t.push(e.body),t.join(" ")}};var vl=class{constructor(e,t=.3){this.embeddingService=e;this.similarityThreshold=t}async clusterIdeas(e,t){if(e.length===0)return[];if(e.length===1)return[{id:"cluster-0",ideas:[e[0]],label:"Single Idea"}];let r;if(t)r=this.calculateSimilarityMatrixFromEmbeddings(t);else if(this.embeddingService instanceof _n)r=this.embeddingService.calculateSimilarityMatrix(e);else{let i=e.map(o=>this.getIdeaText(o)),a=this.embeddingService.generateEmbeddings(i);r=this.calculateSimilarityMatrixFromEmbeddings(a)}return this.hierarchicalClustering(e,r)}calculateSimilarity(e,t){if(e.length!==t.length)return 0;let r=0,s=0,i=0;for(let l=0;l<e.length;l++)r+=e[l]*t[l],s+=e[l]*e[l],i+=t[l]*t[l];let a=Math.sqrt(s)*Math.sqrt(i);return a===0?0:(r/a+1)/2}calculateSimilarityMatrixFromEmbeddings(e){let t=[];for(let r=0;r<e.length;r++){let s=[];for(let i=0;i<e.length;i++)if(r===i)s.push(1);else{let a=this.calculateSimilarity(e[r],e[i]);s.push(a)}t.push(s)}return t}hierarchicalClustering(e,t){let r=e.map((s,i)=>({id:`cluster-${i}`,ideas:[s],label:this.generateClusterLabel([s])}));for(;r.length>1;){let s=-1,i=-1,a=-1;for(let l=0;l<r.length;l++)for(let c=l+1;c<r.length;c++){let d=this.calculateClusterSimilarity(r[l],r[c],t,e);d>s&&(s=d,i=l,a=c)}if(s<this.similarityThreshold)break;let o={id:`cluster-${r.length}`,ideas:[...r[i].ideas,...r[a].ideas],label:this.generateClusterLabel([...r[i].ideas,...r[a].ideas])};r=r.filter((l,c)=>c!==i&&c!==a),r.push(o)}return r.map((s,i)=>({...s,id:`cluster-${i}`}))}calculateClusterSimilarity(e,t,r,s){let i=e.ideas.map(c=>s.findIndex(d=>d.filename===c.filename)),a=t.ideas.map(c=>s.findIndex(d=>d.filename===c.filename)),o=0,l=0;for(let c of i)for(let d of a)c>=0&&d>=0&&c<r.length&&d<r[c].length&&(o+=r[c][d],l++);return l>0?o/l:0}generateClusterLabel(e){if(e.length===0)return"Empty Cluster";if(e.length===1)return e[0].frontmatter.category||"Uncategorized";let t=e.map(i=>i.frontmatter.category).filter(i=>i);if(t.length===0)return"Mixed Ideas";let r={};for(let i of t)r[i]=(r[i]||0)+1;let s=Object.entries(r).sort((i,a)=>a[1]-i[1])[0];return s?`${s[0]} (${e.length})`:"Mixed Ideas"}getIdeaText(e){let t=[];return e.frontmatter.category&&t.push(e.frontmatter.category),t.push(...e.frontmatter.tags),t.push(e.body),t.join(" ")}};var xl=class{layoutGraph(e,t,r){if(e.length===0)return{nodes:[],edges:[],width:t,height:r};let s=[],i=[],a=t/2,o=r/2,l=Math.min(t,r)*.3,c=0;for(let d of e){let u=2*Math.PI*e.indexOf(d)/e.length,h=a+l*Math.cos(u),p=o+l*Math.sin(u),f=Math.ceil(Math.sqrt(d.ideas.length)),y=50;d.ideas.forEach((S,x)=>{let g=Math.floor(x/f),R=(x%f-f/2)*y,M=(g-f/2)*y;s.push({id:`node-${c++}`,idea:S,x:h+R,y:p+M,clusterId:d.id})})}for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++)if(s[d].clusterId===s[u].clusterId){let h=this.calculateNodeSimilarity(s[d].idea,s[u].idea);h>.1&&i.push({from:s[d].id,to:s[u].id,weight:h})}return{nodes:s,edges:i,width:t,height:r}}updateLayout(e,t){if(!t.length||!e.nodes.length)return e;let r=new Map;for(let d of e.nodes)r.set(d.idea.filename,d);let s=[...e.nodes],i=[...e.edges],a=e.nodes.reduce((d,u)=>d+u.x,0)/e.nodes.length,o=e.nodes.reduce((d,u)=>d+u.y,0)/e.nodes.length,l=e.nodes[0]?.clusterId??"cluster-0",c=0;for(let d of t){let u=r.get(d.filename);if(u){u.idea=d;continue}let h=30+c*20,p=c%2===0?1:-1,f={id:`node-${s.length+c}`,idea:d,x:Math.min(Math.max(a+p*h,0),e.width),y:Math.min(Math.max(o+p*h,0),e.height),clusterId:l};s.push(f);for(let y of e.nodes){if(y.clusterId!==f.clusterId)continue;let S=this.calculateNodeSimilarity(y.idea,d);S>.1&&i.push({from:y.id,to:f.id,weight:S})}c++}return{...e,nodes:s,edges:i}}calculateNodeSimilarity(e,t){let r=0;e.frontmatter.category===t.frontmatter.category&&e.frontmatter.category&&(r+=.3);let s=new Set(e.frontmatter.tags),i=new Set(t.frontmatter.tags),a=new Set([...s].filter(h=>i.has(h))),o=new Set([...s,...i]);o.size>0&&(r+=.2*(a.size/o.size));let l=new Set(this.tokenize(e.body)),c=new Set(this.tokenize(t.body)),d=new Set([...l].filter(h=>c.has(h))),u=new Set([...l,...c]);return u.size>0&&(r+=.5*(d.size/u.size)),Math.min(r,1)}tokenize(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(t=>t.length>2)}};var Pu=require("obsidian");var Sl=class{constructor(e,t,r){this.ideaRepository=e;this.settings=t;this.vault=r}async identifyOldIdeas(e){let t=e||this.settings.resurfacingThresholdDays||7,r=await this.ideaRepository.getAllIdeas(),s=new Date,i=new Date(s.getTime()-t*24*60*60*1e3),a=[];for(let o of r){let l=new Date(o.frontmatter.created);if(isNaN(l.getTime())){let c=new Be(`Failed to parse date for idea ${o.filename}`,"DATE_PARSE_ERROR");m.warn(c.message,c);continue}l<i&&(await this.isDismissedOrActedUpon(`Ideas/${o.filename}`)||a.push(o))}return a}async generateDigest(e){let t=e||await this.identifyOldIdeas();t.sort((s,i)=>{let a=new Date(s.frontmatter.created).getTime(),o=new Date(i.frontmatter.created).getTime();return a-o});let r=this.generateDigestMarkdown(t);return{id:`digest-${Date.now()}`,generatedAt:new Date,ideas:t,summary:r}}async markAsDismissed(e){if(!this.vault){m.warn("Vault not available, cannot mark as dismissed");return}let t=this.vault.getAbstractFileByPath(e),r=t instanceof Pu.TFile?t:null;if(!r){m.warn(`File not found: ${e}`);return}await new Xr(this.vault).updateIdeaFrontmatter(r,{dismissed:!0,dismissedAt:new Date().toISOString().split("T")[0]})}async markAsActedUpon(e){if(!this.vault){m.warn("Vault not available, cannot mark as acted upon");return}let t=this.vault.getAbstractFileByPath(e),r=t instanceof Pu.TFile?t:null;if(!r){m.warn(`File not found: ${e}`);return}await new Xr(this.vault).updateIdeaFrontmatter(r,{actedUpon:!0,actedUponAt:new Date().toISOString().split("T")[0]})}async isDismissedOrActedUpon(e){let t=await this.ideaRepository.getIdeaByPath(e);if(!t)return!1;let r=t.frontmatter;return!!(r.dismissed||r.actedUpon)}generateDigestMarkdown(e){if(e.length===0)return`# Weekly Idea Digest

No old ideas found.`;let t=["# Weekly Idea Digest","",`Generated on: ${new Date().toLocaleDateString()}`,"","## Old Ideas Needing Attention",""];for(let i of e){let a=this.calculateAge(i.frontmatter.created),o=i.body.substring(0,200),l=i.body.length>200;t.push(`### ${i.filename.replace(".md","")}`),t.push(""),t.push(`**Category**: ${i.frontmatter.category||"Uncategorized"}`),t.push(`**Created**: ${i.frontmatter.created}`),t.push(`**Age**: ${a} days`),i.frontmatter.tags.length>0&&t.push(`**Tags**: ${i.frontmatter.tags.join(", ")}`),t.push(""),t.push(o+(l?"...":"")),t.push(""),t.push(`[Open Idea](Ideas/${i.filename})`),t.push(""),t.push("---"),t.push("")}t.push("## Summary"),t.push(""),t.push(`- **Total Ideas**: ${e.length}`);let r={};for(let i of e){let a=i.frontmatter.category||"Uncategorized";r[a]=(r[a]||0)+1}let s=Object.entries(r).map(([i,a])=>`${i}: ${a}`).join(", ");return t.push(`- **By Category**: ${s}`),t.push(""),t.join(`
`)}calculateAge(e){try{let t=new Date(e),s=Math.abs(new Date().getTime()-t.getTime());return Math.ceil(s/(1e3*60*60*24))}catch{return 0}}};var Ru=require("obsidian");var Al=class{vault;app;frontmatterParser;settings;constructor(e,t,r,s){this.vault=e,this.app=s,this.frontmatterParser=t,this.settings=r}getProjectsDirectory(){return this.settings.elevationProjectsDirectory||"Projects"}getDefaultFolders(){return(this.settings.elevationDefaultFolders||"docs,notes,assets").split(",").map(t=>t.trim()).filter(t=>t.length>0)}canElevate(e){return!(!e.frontmatter||!e.frontmatter.type||!e.frontmatter.status||e.frontmatter.status==="elevated"||e.frontmatter.type!=="idea")}generateProjectName(e){let t=le(e.body);if(!t||t.trim().length===0){let r=e.filename.replace(/\.md$/,""),s=r.match(/^\d{4}-\d{2}-\d{2}\s+(.+)$/);s?t=s[1]:t=r}return this.sanitizeProjectName(t)}sanitizeProjectName(e){let t=e.toLowerCase();return t=t.replace(/[^a-z0-9-]/g,"-"),t=t.replace(/-+/g,"-"),t=t.replace(/^-+|-+$/g,""),t.length>50&&(t=t.substring(0,50),t=t.replace(/-+$/,"")),t.length<1&&(t="project"),t}isProjectNameAvailable(e){let t=`${this.getProjectsDirectory()}/${e}`;return this.vault.getAbstractFileByPath(t)===null}async elevateIdea(e,t){if(!this.canElevate(e))return{success:!1,error:"Idea cannot be elevated. It may already be elevated or have invalid frontmatter."};let r=`Ideas/${e.filename}`,s=this.vault.getAbstractFileByPath(r),i=s instanceof Ru.TFile?s:null;if(!i)return{success:!1,error:`Idea file not found: ${r}`};let a=t||this.generateProjectName(e),o=await this.resolveProjectNameCollision(a),l=`${this.getProjectsDirectory()}/${o}`,c=[],d=[];try{let u=await this.vault.read(i);await this.ensureProjectsDirectory(),await this.createProjectStructure(l,c);let h=this.prepareElevatedContent(u,l);await this.vault.create(`${l}/README.md`,h),c.push(`${l}/README.md`);try{await this.handleDevraIntegration(l,e),c.push(`${l}/.devra.json`)}catch(p){d.push("Failed to create project metadata file (non-fatal)"),m.warn("Project metadata integration failed:",p)}try{this.app?await this.app.fileManager.trashFile(i):await this.vault.delete(i)}catch(p){d.push("Failed to delete original idea file (project created successfully)"),m.warn("Failed to delete original file:",p)}return{success:!0,projectPath:l,warnings:d.length>0?d:void 0}}catch(u){return await this.rollback(c),{success:!1,error:u instanceof Error?u.message:"Unknown error during elevation"}}}async resolveProjectNameCollision(e){let t=e,r=2;for(;!this.isProjectNameAvailable(t);)t=`${e}-${r}`,r++;return t}async ensureProjectsDirectory(){let e=this.getProjectsDirectory();this.vault.getAbstractFileByPath(e)||await this.vault.createFolder(e)}async createProjectStructure(e,t){let r=this.getDefaultFolders();await this.vault.createFolder(e),t.push(e);for(let s of r){let i=`${e}/${s}`;await this.vault.createFolder(i),t.push(i)}}prepareElevatedContent(e,t){let r=this.frontmatterParser.parseFrontmatter(e);if(!r)throw new Error("Failed to parse frontmatter from original file");let s=e.match(/^---\n[\s\S]*?\n---(\n\n?|\n?)([\s\S]*)$/),i=s?s[2].trim():"",a={...r,status:"elevated",elevated:new Date().toISOString().split("T")[0],projectPath:t};return`${Pn(a)}

${i}`}async handleDevraIntegration(e,t){if(!this.settings.elevationCreateDevraMetadata)return;let r={name:this.generateProjectName(t),type:"project",source:"ideatr",elevated:new Date().toISOString().split("T")[0],ideaPath:t.filename,ideaCategory:t.frontmatter.category||"",ideaTags:t.frontmatter.tags||[],devraReady:!1,devraProjectPath:null},s=`${e}/.devra.json`;await this.vault.adapter.write(s,JSON.stringify(r,null,2))}async rollback(e){for(let t of[...e].reverse())try{let r=this.vault.getAbstractFileByPath(t);r&&(r instanceof Ru.TFile?this.app?await this.app.fileManager.trashFile(r):await this.vault.delete(r):await this.vault.adapter.rmdir(t,!0))}catch(r){m.warn(`Failed to rollback ${t}:`,r)}}};var El=class{vault;embeddingService;llmService;MIN_SIMILARITY=.3;MAX_SIMILARITY=.5;constructor(e,t,r){this.vault=e,this.embeddingService=t,this.llmService=r}async findTenuousLinks(e,t,r,s){let a=this.vault.getMarkdownFiles().filter(c=>c.path.startsWith("Ideas/")&&!c.path.startsWith("Ideas/Archived/")),o=[];for(let c of a)if(!s.includes(c.path))try{let d=await this.vault.cachedRead(c),u=d.match(/^---\n[\s\S]*?\n---\n\n?([\s\S]*)$/),h=u?u[1].trim():d.trim();if(h.length===0)continue;let p=this.calculateSimilarity(e,h);if(p>=this.MIN_SIMILARITY&&p<=this.MAX_SIMILARITY){let f=d.match(/^---\n([\s\S]*?)\n---/);if(f){let S=f[1].match(/^category:\s*(.+)$/m);if((S?S[1].trim():"")===t)continue;o.push({file:c,similarity:p,content:h})}}}catch(d){m.warn(`Failed to process ${c.path} for tenuous links:`,d)}let l=[];for(let c of o.slice(0,10))try{let d=await this.analyzeConnection(e,t,r,c.content,c.similarity);d.relevance>.5&&l.push({idea:{path:c.file.path,title:c.file.basename,similarity:c.similarity},similarity:c.similarity,explanation:d.explanation,synergy:d.synergy,relevance:d.relevance})}catch(d){m.warn(`Failed to analyze connection with ${c.file.path}:`,d)}return l.sort((c,d)=>d.relevance-c.relevance),l}calculateSimilarity(e,t){let r=this.embeddingService.generateEmbedding(e),s=this.embeddingService.generateEmbedding(t);return this.cosineSimilarity(r,s)}cosineSimilarity(e,t){if(e.length!==t.length)return 0;let r=0,s=0,i=0;for(let o=0;o<e.length;o++)r+=e[o]*t[o],s+=e[o]*e[o],i+=t[o]*t[o];let a=Math.sqrt(s)*Math.sqrt(i);return a===0?0:r/a}async analyzeConnection(e,t,r,s,i){let a=`Analyze the connection between these two ideas, focusing on unexpected or creative connections.

Original Idea:
${e}
Category: ${t}
Tags: ${r.join(", ")}

Related Idea:
${s}
Similarity: ${i.toFixed(2)}

CRITICAL REQUIREMENTS:
- Look beyond surface-level similarities to find deeper, more interesting connections
- Focus on unexpected or creative connections that might not be immediately obvious
- Consider how these ideas could enhance or transform each other
- Think about novel applications or combinations

Analyze and identify:

1. Unexpected Connection
   - What is the non-obvious link between these ideas?
   - What hidden relationships exist beyond the similarity score?
   - How do they relate in ways that might not be immediately apparent?
   - What shared principles, approaches, or underlying concepts connect them?

2. Combination Potential
   - How could these ideas be meaningfully combined?
   - What would a merged or hybrid version look like?
   - How could elements from one idea enhance the other?
   - What complementary strengths do they have?

3. New Possibilities
   - What novel applications emerge from this connection?
   - What new ideas or directions does this relationship suggest?
   - How could combining these ideas solve problems neither could solve alone?
   - What unique value would a combination create?

Output format (JSON only, no markdown, no code blocks):
{
  "explanation": "Clear explanation of the unexpected connection between these ideas...",
  "synergy": "Specific description of how these ideas could be combined and what the result would be...",
  "relevance": 0.0-1.0
}

Response:`;if(!this.llmService.complete)return{explanation:`Similarity: ${i.toFixed(2)}`,relevance:i};try{let o=await this.llmService.complete(a,{temperature:.7,n_predict:500}),l=z(o,!1),c=JSON.parse(l);return{explanation:c.explanation||"",synergy:c.synergy,relevance:c.relevance||.5}}catch(o){m.warn("Failed to parse LLM analysis:",o)}return{explanation:`Similarity: ${i.toFixed(2)}`,relevance:i}}};var Il=class{vault;frontmatterParser;ideaRepository;constructor(e,t){this.vault=e,this.frontmatterParser=new ot,this.ideaRepository=t}async exportIdeas(e){let r=this.vault.getMarkdownFiles().filter(o=>o.path.startsWith("Ideas/")&&!o.path.startsWith("Ideas/Archived/")),s=[],i=new H(this.ideaRepository);for(let o of r)try{let l=await this.vault.read(o),c=this.frontmatterParser.parse(l),d=o.basename.replace(/^\d{4}-\d{2}-\d{2}-/,"").replace(/-/g," "),u=Array.isArray(c.frontmatter.related)?c.frontmatter.related.filter(p=>typeof p=="number"&&p!==0):[],h=await i.idsToPaths(u);s.push({...c.frontmatter,related:h,title:d,body:c.body,filename:o.name,path:o.path})}catch(l){m.warn(`Failed to export ${o.path}:`,l)}let a={version:"1.0",exportedAt:new Date().toISOString(),totalIdeas:s.length,ideas:s};switch(e){case"json":return this.exportJSON(a);case"csv":return this.exportCSV(a);case"markdown":return this.exportMarkdown(a);default:throw new Error(`Unsupported export format: ${e}`)}}exportJSON(e){return JSON.stringify(e,null,2)}exportCSV(e){let t=[];t.push("title,created,category,tags,status,body,related,domains,existence-check");for(let r of e.ideas){let s=[this.escapeCSV(r.title),r.created,r.category||"",r.tags.join(";"),r.status,this.escapeCSV(r.body.replace(/\n/g," ")),r.related.join(";"),r.domains.join(";"),r["existence-check"].join(";")];t.push(s.join(","))}return t.join(`
`)}exportMarkdown(e){let t=[];t.push("# Ideas Export"),t.push(`Exported: ${e.exportedAt}`),t.push(`Total Ideas: ${e.totalIdeas}`),t.push("");for(let r of e.ideas)t.push(`## ${r.title}`),t.push(`- Created: ${r.created}`),t.push(`- Category: ${r.category||"none"}`),t.push(`- Status: ${r.status}`),t.push(`- Tags: ${r.tags.join(", ")||"none"}`),t.push(""),t.push(r.body),t.push(""),t.push("---"),t.push("");return t.join(`
`)}escapeCSV(e){return e.includes(",")||e.includes('"')||e.includes(`
`)?`"${e.replace(/"/g,'""')}"`:e}};var Cl=class{vault;frontmatterParser;ideaRepository;constructor(e,t){this.vault=e,this.frontmatterParser=new ot,this.ideaRepository=t}async importIdeas(e,t){let r={total:0,imported:0,failed:0,errors:[]},s=[];try{switch(t){case"json":s=this.parseJSON(e);break;case"csv":s=this.parseCSV(e);break;case"markdown":s=this.parseMarkdown(e);break;default:throw new Error(`Unsupported import format: ${t}`)}}catch(i){return r.errors.push({item:"parse",error:i instanceof Error?i.message:"Unknown error"}),r}r.total=s.length;for(let i of s)try{await this.importIdea(i),r.imported++}catch(a){r.failed++,r.errors.push({item:i.title||"unknown",error:a instanceof Error?a.message:"Unknown error"})}return r}async importIdea(e){let t=ol({text:e.body,timestamp:e.created?new Date(e.created):new Date}),r=[];if(e.related&&Array.isArray(e.related)){let d=e.related[0];if(e.related.length>0&&typeof d=="string"){let u=new H(this.ideaRepository),h=e.related.filter(p=>typeof p=="string");r=await u.pathsToIds(h)}else e.related.length>0&&typeof d=="number"&&(r=e.related.filter(u=>typeof u=="number"&&u!==0))}let s={...t,...e,type:"idea",status:e.status||"captured",created:e.created||new Date().toISOString().split("T")[0],id:typeof e.id=="number"?e.id:0,category:e.category||"",tags:e.tags||[],related:r,domains:e.domains||[],"existence-check":e["existence-check"]||[]},i=e.created?new Date(e.created):new Date,a=Cn(e.title||e.body,i),l=`${this.frontmatterParser.build(s,e.body)}

${e.body}`,c=`Ideas/${a}`;await this.vault.create(c,l)}parseJSON(e){let t=JSON.parse(e);if(t.ideas&&Array.isArray(t.ideas))return t.ideas;throw new Error("Invalid JSON format: missing ideas array")}parseCSV(e){let t=e.split(`
`);if(t.length<2)throw new Error("Invalid CSV: no data rows");t[0].split(",");let r=[];for(let s=1;s<t.length;s++){let i=this.parseCSVLine(t[s]),a={title:i[0]||"Untitled",created:i[1]||new Date().toISOString().split("T")[0],category:i[2]||"",tags:i[3]?i[3].split(";").filter(o=>o):[],status:i[4]||"captured",body:i[5]||"",related:i[6]?i[6].split(";").filter(o=>o):[],domains:i[7]?i[7].split(";").filter(o=>o):[],"existence-check":i[8]?i[8].split(";").filter(o=>o):[]};r.push(a)}return r}parseCSVLine(e){let t=[],r="",s=!1;for(let i=0;i<e.length;i++){let a=e[i];a==='"'?s&&e[i+1]==='"'?(r+='"',i++):s=!s:a===","&&!s?(t.push(r),r=""):r+=a}return t.push(r),t}parseMarkdown(e){let t=[],r=e.split(/^## /m);for(let s=1;s<r.length;s++){let a=r[s].split(`
`),o=a[0].trim(),l={},c=0;for(let u=1;u<a.length;u++){let h=a[u];if(h.match(/^- /)){let p=h.match(/^- (\w+): (.+)$/);p&&(l[p[1].toLowerCase()]=p[2])}else if(h.trim()===""){c=u+1;break}}let d=a.slice(c).join(`
`).trim();t.push({title:o,body:d,created:l.created||new Date().toISOString().split("T")[0],category:l.category||"",status:l.status||"captured",tags:l.tags?l.tags.split(",").map(u=>u.trim()):[]})}return t}};var Tn=class{provider;constructor(e){this.provider=e}async classify(e){return await this.provider.classify(e)}isAvailable(){return this.provider.isAvailable()}ensureReady(){return this.provider.isAvailable()?Promise.resolve(!0):Promise.resolve(!1)}async complete(e,t){if(this.provider.complete&&typeof this.provider.complete=="function")return await this.provider.complete(e,t);throw new Error("Provider does not support generic completions. Use local LLM or a provider with complete() method.")}getProvider(){return this.provider}};var Kb={enabled:!0,maxEntries:50,retentionDays:7},Pl=class{logs=[];settings;constructor(e){this.settings={...Kb,...e}}logError(e,t,r,s){if(!this.settings.enabled)return;let i=e instanceof Error?e.message:e,a=e instanceof Error?e.stack:void 0,o={timestamp:new Date,error:i,stack:a,context:t,userAction:r,metadata:s};this.logs.push(o),this.logs.length>this.settings.maxEntries&&(this.logs=this.logs.slice(-this.settings.maxEntries)),this.cleanOldEntries()}getRecentLogs(e){let t=new Date;t.setDate(t.getDate()-this.settings.retentionDays);let r=this.logs.filter(s=>s.timestamp>=t);return e?r.slice(-e):r}getAllLogs(){return[...this.logs]}clearLogs(){this.logs=[]}sanitizeLogs(e){let t=e.map(r=>{let s=this.sanitizeString(r.error),i=r.stack?this.sanitizeString(r.stack):void 0,a=r.metadata?this.sanitizeMetadata(r.metadata):void 0;return{...r,error:s,stack:i,metadata:a}});return JSON.stringify(t,null,2)}formatLogsForIssue(e){return e.length===0?"No error logs available.":`## Error Logs

${e.map(r=>{let s=this.sanitizeString(r.error),i=r.stack?this.sanitizeString(r.stack):void 0,a=`**${r.timestamp.toISOString()}**`;if(r.context&&(a+=` - Context: ${this.sanitizeString(r.context)}`),r.userAction&&(a+=` - Action: ${this.sanitizeString(r.userAction)}`),a+=`
\`\`\`
${s}
\`\`\``,i){let l=i.split(`
`).slice(-20).join(`
`);a+=`

Stack trace (last 20 lines):
\`\`\`
${l}
\`\`\``}return a}).join(`

---

`)}`}sanitizeString(e){return e=e.replace(/\/Users\/[^\/]+/g,"[USER_HOME]"),e=e.replace(/\/home\/[^\/]+/g,"[USER_HOME]"),e=e.replace(/C:\\Users\\[^\\]+/gi,"[USER_HOME]"),e=e.replace(/[A-Z]:\\[^:]+/g,"[DRIVE_PATH]"),e=e.replace(/sk-[a-zA-Z0-9]{20,}/g,"[API_KEY_REDACTED]"),e=e.replace(/[a-zA-Z0-9]{32,}/g,t=>t.length>40?"[API_KEY_REDACTED]":t),e=e.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,"[EMAIL_REDACTED]"),e=e.replace(/\.obsidian[^"'\s]*/g,"[OBSIDIAN_CONFIG]"),e=e.replace(/[^"'\s]*\/plugins\/[^"'\s]*/g,"[PLUGIN_PATH]"),e=e.replace(/Ideas\/[^"'\s]*/g,"[IDEA_FILE]"),e=e.replace(/Projects\/[^"'\s]*/g,"[PROJECT_FILE]"),e}sanitizeMetadata(e){let t={};for(let[r,s]of Object.entries(e))typeof s=="string"?t[r]=this.sanitizeString(s):typeof s=="object"&&s!==null?t[r]=this.sanitizeMetadata(s):t[r]=s;return t}cleanOldEntries(){let e=new Date;e.setDate(e.getDate()-this.settings.retentionDays),this.logs=this.logs.filter(t=>t.timestamp>=e)}updateSettings(e){this.settings={...this.settings,...e},this.cleanOldEntries()}getSettings(){return{...this.settings}}};var Rl=class{vault;settings;ARCHIVE_DIR="Ideas/Archived/";constructor(e,t){this.vault=e,this.settings=t}async moveToArchive(e){if(!this.settings.moveArchivedToFolder||(await this.ensureDirectoryExists(this.ARCHIVE_DIR),e.path.startsWith(this.ARCHIVE_DIR)))return;let t=`${this.ARCHIVE_DIR}${e.name}`;if(this.vault.getAbstractFileByPath(t)){let s=Date.now(),i=e.basename,a=e.extension,o=`${i}-${s}.${a}`;await this.vault.rename(e,`${this.ARCHIVE_DIR}${o}`)}else await this.vault.rename(e,t)}async moveFromArchive(e){if(!e.path.startsWith(this.ARCHIVE_DIR))return;let t=`Ideas/${e.name}`;if(this.vault.getAbstractFileByPath(t)){let s=Date.now(),i=e.basename,a=e.extension,o=`${i}-${s}.${a}`;await this.vault.rename(e,`Ideas/${o}`)}else await this.vault.rename(e,t)}async ensureDirectoryExists(e){this.vault.getAbstractFileByPath(e)||await this.vault.createFolder(e)}};var _l=class{constructor(e,t,r,s,i,a,o,l,c,d,u,h,p,f,y,S,x,g,E,R,M,B,O,U){this.app=e;this.plugin=t;this.settings=r;this.fileManager=s;this.classificationService=i;this.duplicateDetector=a;this.domainService=o;this.webSearchService=l;this.nameVariantService=c;this.scaffoldService=d;this.frontmatterParser=u;this.ideaRepository=h;this.embeddingService=p;this.clusteringService=f;this.graphLayoutService=y;this.resurfacingService=S;this.projectElevationService=x;this.tenuousLinkService=g;this.exportService=E;this.importService=R;this.searchService=M;this.llmService=B;this.errorLogService=O;this.fileOrganizer=U}};var Tl=class{constructor(e,t,r,s,i,a,o,l,c,d,u,h,p,f,y,S,x,g,E,R,M,B,O,U){this.app=e;this.plugin=t;this.settings=r;this.fileManager=s;this.classificationService=i;this.duplicateDetector=a;this.domainService=o;this.webSearchService=l;this.nameVariantService=c;this.scaffoldService=d;this.frontmatterParser=u;this.ideaRepository=h;this.embeddingService=p;this.clusteringService=f;this.graphLayoutService=y;this.resurfacingService=S;this.projectElevationService=x;this.tenuousLinkService=g;this.exportService=E;this.importService=R;this.searchService=M;this.llmService=B;this.errorLogService=O;this.fileOrganizer=U;this.commandContext=new _l(e,t,r,s,i,a,o,l,c,d,u,h,p,f,y,S,x,g,E,R,M,B,O,U)}commandContext};var Ml=class{vault;ideaRepository;fileManager;isProcessing=!1;idleTimeoutId;constructor(e,t,r){this.vault=e,this.ideaRepository=t,this.fileManager=r}async assignMissingIds(){if(this.isProcessing)return m.debug("ID assignment already in progress, skipping"),{assigned:0,errors:0};this.isProcessing=!0;let e=0,t=0;try{let r=await this.ideaRepository.getAllIdeas(),s=r.map(a=>a.frontmatter.id).filter(a=>a!==0&&a!==void 0),i=r.filter(a=>!a.frontmatter.id||a.frontmatter.id===0);m.debug(`Found ${i.length} ideas needing IDs`);for(let a of i)try{let o=this.vault.getAbstractFileByPath(`Ideas/${a.filename}`);if(!o){m.warn(`File not found for idea: ${a.filename}`),t++;continue}let l=il(s);s.push(l),await this.fileManager.updateIdeaFrontmatter(o,{id:l}),e++,m.debug(`Assigned ID ${l} to idea: ${a.filename}`)}catch(o){m.warn(`Failed to assign ID to idea ${a.filename}:`,o),t++}e>0&&m.info(`Auto-assigned ${e} idea IDs`)}catch(r){m.error("Error during ID assignment:",r),t++}finally{this.isProcessing=!1}return{assigned:e,errors:t}}scheduleIdleAssignment(e=2e3){this.idleTimeoutId&&clearTimeout(this.idleTimeoutId),typeof requestIdleCallback<"u"?requestIdleCallback(()=>{this.assignMissingIds().catch(t=>{m.warn("Idle ID assignment failed:",t)})},{timeout:e}):this.idleTimeoutId=window.setTimeout(()=>{this.assignMissingIds().catch(t=>{m.warn("Idle ID assignment failed:",t)})},e)}cancelScheduledAssignment(){this.idleTimeoutId&&(clearTimeout(this.idleTimeoutId),this.idleTimeoutId=void 0)}};var kl=class{vault;ideaRepository;fileManager;constructor(e,t,r){this.vault=e,this.ideaRepository=t,this.fileManager=r}async migrateRelatedToIds(){let e=0,t=0,r=0;try{let s=await this.ideaRepository.getAllIdeas(),i=new Map;for(let a of s){let o=`Ideas/${a.filename}`;a.frontmatter.id&&a.frontmatter.id!==0&&i.set(o,a.frontmatter.id)}m.debug(`Created path-to-ID map with ${i.size} entries`);for(let a of s)try{let o=a.frontmatter.related||[];if(!o.some(u=>typeof u=="string"||u===0||typeof u=="number"&&!i.has(`Ideas/${u}`)&&!s.find(h=>h.frontmatter.id===u))){r++;continue}let c=[];for(let u of o)if(typeof u=="string"){let h=i.get(u);h?c.push(h):m.warn(`Could not find ID for path: ${u}`)}else typeof u=="number"&&u!==0&&(s.some(p=>p.frontmatter.id===u)?c.push(u):m.warn(`Invalid ID found: ${u}`));let d=Array.from(new Set(c));if(d.length!==o.length||!d.every((u,h)=>o[h]===u)){let u=this.vault.getAbstractFileByPath(`Ideas/${a.filename}`);u?(await this.fileManager.updateIdeaFrontmatter(u,{related:d}),e++,m.debug(`Migrated related for idea: ${a.filename}`)):(m.warn(`File not found for idea: ${a.filename}`),t++)}else r++}catch(o){m.warn(`Failed to migrate related for idea ${a.filename}:`,o),t++}e>0&&m.info(`Migrated ${e} ideas' related fields from paths to IDs`)}catch(s){m.error("Error during related migration:",s),t++}return{migrated:e,errors:t,skipped:r}}};var Fl=class{static async initialize(e,t,r){let{fileManager:s,fileOrganizer:i,errorLogService:a}=this.initializeCoreServices(e,r),{localLLMService:o,llmService:l}=await this.initializeLLMServices(e,t,r),{searchService:c,classificationService:d,duplicateDetector:u}=this.initializeSearchServices(e,l),{domainService:h,webSearchService:p}=this.initializeValidationServices(r),{nameVariantService:f,scaffoldService:y}=this.initializeTransformationServices(e,t,r,l),{frontmatterParser:S,ideaRepository:x,embeddingService:g,clusteringService:E,graphLayoutService:R,resurfacingService:M,projectElevationService:B}=this.initializeManagementServices(e,r),{tenuousLinkService:O,exportService:U,importService:q}=this.initializeAnalysisServices(e,l,g,x),$=new Tl(e,t,r,s,d,u,h,p,f,y,S,x,g,E,R,M,B,O,U,q,c,l,a,i),G=new Ml(e.vault,x,s),ca=new kl(e.vault,x,s);return G.scheduleIdleAssignment(3e3),setTimeout(async()=>{try{await ca.migrateRelatedToIds()}catch(On){m.warn("Related migration failed:",On)}},5e3),{context:$,localLLMService:o}}static initializeCoreServices(e,t){let r=new Xr(e.vault),s=new Rl(e.vault,t),i=new Pl({enabled:t.errorLoggingEnabled,maxEntries:t.errorLogMaxEntries,retentionDays:t.errorLogRetentionDays});return{fileManager:r,fileOrganizer:s,errorLogService:i}}static initializeSearchServices(e,t){let r=new cl(e.vault),s=new dl(t,r),i=new ul(r);return{searchService:r,classificationService:s,duplicateDetector:i}}static initializeValidationServices(e){let t=new ml(e.prospectrUrl,e.domainCheckTimeout),r=new pl(t),s=new hl(e);return{domainService:r,webSearchService:s}}static initializeTransformationServices(e,t,r,s){let i=new gl(s,r,async()=>(await t.loadData())?.variantCache||{},async o=>{let l=await t.loadData();await t.saveData({...l,variantCache:o})}),a=new bl(e.vault,e);return{nameVariantService:i,scaffoldService:a}}static initializeManagementServices(e,t){let r=new ot,s=new wl(e.vault,r),i=new _n,a=new vl(i,t.clusteringSimilarityThreshold||.3),o=new xl,l=new Sl(s,t,e.vault),c=new Al(e.vault,r,t,e);return{frontmatterParser:r,ideaRepository:s,embeddingService:i,clusteringService:a,graphLayoutService:o,resurfacingService:l,projectElevationService:c}}static initializeAnalysisServices(e,t,r,s){let i=new El(e.vault,r,t),a=new Il(e.vault,s),o=new Cl(e.vault,s);return{tenuousLinkService:i,exportService:a,importService:o}}static async initializeLLMServices(e,t,r){let s=e.vault.adapter.basePath||e.vault.configDir,i=Zr(e.vault.configDir)?e.vault.configDir:ee(s,e.vault.configDir),a=Yr(ee(i,"plugins",t.manifest.id));m.debug("Plugin directory:",a);let o=Fe.getInstance(r,a),l=null;if(r.cloudProvider!=="none"&&r.cloudProvider!=="custom"&&r.cloudProvider!=="custom-model"){let d=r.cloudApiKeys&&r.cloudProvider in r.cloudApiKeys?(r.cloudApiKeys[r.cloudProvider]||"").trim():"";if(d.length>0)try{let u=It.createProvider(r.cloudProvider,d,{openRouterModel:r.openRouterModel,customEndpointUrl:r.customEndpointUrl});l=new Tn(u),m.info("Cloud AI provider initialized:",u.name)}catch(u){m.warn("Failed to initialize cloud provider:",u),new Ll.Notice("Failed to initialize cloud AI provider. Using local AI only.")}}else if(r.cloudProvider==="custom-model"){if(r.customModelProvider&&r.customModel){let d=r.cloudApiKeys&&r.customModelProvider in r.cloudApiKeys?(r.cloudApiKeys[r.customModelProvider]||"").trim():"";if(d.length>0)try{let u=It.createProvider("custom-model",d,{customModelProvider:r.customModelProvider,customModel:r.customModel});l=new Tn(u),m.info("Custom model provider initialized:",u.name,r.customModel)}catch(u){m.warn("Failed to initialize custom model provider:",u),new Ll.Notice("Failed to initialize custom model provider. Using local AI only.")}}}else if(r.cloudProvider==="custom"&&r.customEndpointUrl&&r.customEndpointUrl.trim().length>0)try{let d=It.createProvider("custom","",{customEndpointUrl:r.customEndpointUrl});l=new Tn(d),m.info("Cloud AI provider initialized:",d.name)}catch(d){m.warn("Failed to initialize custom endpoint:",d),new Ll.Notice("Failed to initialize custom endpoint. Using local AI only.")}let c=new ts(o,l,r.preferCloud);return r.preloadOnStartup&&c.isAvailable()&&c.ensureReady?.().then(d=>{d||m.debug("LLM not ready for preload (paths not configured or model not downloaded)")}).catch(d=>{m.warn("Failed to preload LLM on startup:",d)}),{localLLMService:o,llmService:c}}};var Mc=require("obsidian");var Ol=require("obsidian");var Dl=class extends Error{userMessage;constructor(e,t){super(e),this.name="UserFacingError",this.userMessage=t}};var V=class{constructor(e){this.context=e}handleError(e,t,r){if(m.error(`Failed to ${t||"execute command"}:`,e),this.context.errorLogService){let s=e instanceof Error?e:new Error(String(e));this.context.errorLogService.logError(s,t,r)}if(e instanceof Dl)new Ol.Notice(e.userMessage);else{let s=t?`Failed to ${t}. Please try again or check console for details.`:"Failed to execute command. Please try again or check console for details.";new Ol.Notice(s)}}showNotice(e){new Ol.Notice(e)}debug(e,...t){m.debug(e,...t)}info(e,...t){m.info(e,...t)}warn(e,...t){m.warn(e,...t)}};var Nl=class extends V{constructor(e){super(e)}async execute(){try{new rs(this.context.app,this.context.fileManager,this.context.classificationService,this.context.duplicateDetector,this.context.settings,this.context.domainService,this.context.webSearchService,this.context.nameVariantService,this.context.llmService).open()}catch(e){this.handleError(e,"open capture modal","capture-idea")}}};var $l=require("obsidian");var Mn=require("obsidian");var N=class extends V{constructor(e){super(e)}async execute(){try{let e=this.getActiveIdeaFile();if(!e)return;let{frontmatter:t,body:r,content:s}=await this.readIdeaContent(e),i=r.trim();if(!i||i.length===0){new Mn.Notice("No idea text found in file.");return}await this.executeWithFile(e,{frontmatter:t,body:r,content:s,ideaText:i})}catch(e){this.handleError(e,this.getCommandName())}}getActiveIdeaFile(){let e=this.context.app.workspace.getActiveFile();return e?(e.path.startsWith("Ideas/")||new Mn.Notice("This command works best with idea files in the Ideas/ directory."),e):(this.debug("No active file found"),new Mn.Notice("No active note. Please open an idea file."),null)}async readIdeaContent(e){let t=await this.context.app.vault.read(e),r=this.context.frontmatterParser.parse(t);return{frontmatter:r.frontmatter,body:r.body,content:t}}async updateIdeaFrontmatter(e,t){let r=await this.context.app.vault.read(e),s=this.context.frontmatterParser.parse(r),i={...s.frontmatter,...t},a=this.context.frontmatterParser.build(i,s.body);await this.context.app.vault.modify(e,a)}checkServiceAvailability(e,t){return e.isAvailable()?!0:(new Mn.Notice(`${t} is not configured. Please set it up in settings.`),!1)}checkLLMAvailability(){return this.context.llmService.isAvailable()?!0:(this.debug("LLM service not available"),new Mn.Notice("AI service is not configured. Please set up AI in settings."),!1)}};var Bl=class extends N{constructor(e){super(e)}getCommandName(){return"search existence"}async executeWithFile(e,t){if(!this.checkServiceAvailability(this.context.webSearchService,"Web search"))return;let r=t.frontmatter.category||"";new $l.Notice("Searching for similar ideas...");let s=await this.context.webSearchService.search(t.ideaText,r);if(s.length===0){new $l.Notice("No similar ideas found.");return}let i=s.map(a=>`${a.title}: ${a.snippet} (${a.url})`);await this.updateIdeaFrontmatter(e,{"existence-check":i}),new $l.Notice(`Search complete: Found ${s.length} similar idea${s.length>1?"s":""}`)}};var Hl=require("obsidian");var Kh=require("obsidian"),Ul=class extends Kh.Modal{duplicates;onLink;selected=new Set;constructor(e,t,r){super(e),this.duplicates=t,this.onLink=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Duplicate ideas found"}),e.createEl("p",{text:`Found ${this.duplicates.length} potential duplicate${this.duplicates.length>1?"s":""}. Select which ones to link in frontmatter:`}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-duplicate-list");this.duplicates.forEach(o=>{let l=r.createDiv("ideatr-duplicate-item"),c=l.createEl("input",{type:"checkbox",attr:{checked:"true"}});this.selected.add(o.path),c.addEventListener("change",u=>{u.target.checked?this.selected.add(o.path):this.selected.delete(o.path)});let d=l.createDiv("ideatr-duplicate-label");d.createEl("strong",{text:o.title}),d.createEl("div",{text:o.path,cls:"ideatr-duplicate-path"}),o.similarity!==void 0&&d.createEl("div",{text:`Similarity: ${(o.similarity*100).toFixed(0)}%`,cls:"ideatr-duplicate-similarity"})});let s=e.createDiv("ideatr-modal-buttons");s.createEl("button",{text:"Link selected",cls:"mod-cta"}).addEventListener("click",()=>{let o=this.duplicates.filter(l=>this.selected.has(l.path));this.onLink&&this.onLink(o),this.close()}),s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var jl=class extends N{idConverter;constructor(e){super(e),this.idConverter=new H(e.ideaRepository)}getCommandName(){return"check duplicates"}async executeWithFile(e,t){new Hl.Notice("Checking for duplicates...");let r=await this.context.duplicateDetector.checkDuplicate(t.ideaText);if(!r.isDuplicate||r.duplicates.length===0){new Hl.Notice("No duplicates found.");return}new Ul(this.context.app,r.duplicates,async s=>{let i=s.map(o=>o.path),a=await this.idConverter.pathsToIds(i);await this.updateIdeaFrontmatter(e,{related:a}),new Hl.Notice(`Linked ${s.length} duplicate${s.length>1?"s":""} in frontmatter.`)}).open()}};var Gl=require("obsidian");var Jh=require("obsidian"),ql=class extends Jh.Modal{relatedNotes;existingRelated;onSelect;selected=new Set;constructor(e,t,r,s){super(e),this.relatedNotes=t,this.existingRelated=r,this.onSelect=s}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Related notes"}),e.createEl("p",{text:`Found ${this.relatedNotes.length} related note${this.relatedNotes.length>1?"s":""}. Select which ones to link in frontmatter:`}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-related-list");this.relatedNotes.forEach(o=>{let l=r.createDiv("ideatr-related-item"),c=l.createEl("input",{type:"checkbox",attr:{checked:this.existingRelated.includes(o.path)?"true":null}});this.existingRelated.includes(o.path)&&this.selected.add(o.path),c.addEventListener("change",u=>{u.target.checked?this.selected.add(o.path):this.selected.delete(o.path)});let d=l.createDiv("ideatr-related-label");d.createEl("strong",{text:o.title}),d.createEl("div",{text:o.path,cls:"ideatr-related-path"}),o.similarity!==void 0&&d.createEl("div",{text:`Similarity: ${(o.similarity*100).toFixed(0)}%`,cls:"ideatr-related-similarity"}),this.existingRelated.includes(o.path)&&d.createEl("div",{text:"(Already linked)",cls:"ideatr-related-existing"})});let s=e.createDiv("ideatr-modal-buttons");s.createEl("button",{text:"Link selected",cls:"mod-cta"}).addEventListener("click",()=>{let o=this.relatedNotes.filter(l=>this.selected.has(l.path));this.onSelect&&this.onSelect(o),this.close()}),s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var zl=class extends N{idConverter;constructor(e){super(e),this.idConverter=new H(e.ideaRepository)}getCommandName(){return"find related notes"}async executeWithFile(e,t){new Gl.Notice("Finding related notes...");let r=await this.context.searchService.findRelatedNotes(t.ideaText,10);if(r.length===0){new Gl.Notice("No related notes found.");return}let s=Array.isArray(t.frontmatter.related)?t.frontmatter.related.filter(a=>typeof a=="number"&&a!==0):[],i=await this.idConverter.idsToPaths(s);new ql(this.context.app,r,i,async a=>{let o=a.map(c=>c.path),l=await this.idConverter.pathsToIds(o);await this.updateIdeaFrontmatter(e,{related:l}),new Gl.Notice(`Linked ${a.length} related note${a.length>1?"s":""} in frontmatter.`)}).open()}};var Vl=require("obsidian");var Wl=class extends N{constructor(e){super(e)}getCommandName(){return"run validations"}async executeWithFile(e,t){new Vl.Notice("Running all validations...");let r=await Promise.allSettled([this.context.domainService.checkDomains(t.ideaText).catch(c=>(console.error("Domain check failed:",c),[])),this.context.webSearchService.isAvailable()?this.context.webSearchService.search(t.ideaText,t.frontmatter.category).catch(c=>(console.error("Web search failed:",c),[])):Promise.resolve([]),this.context.duplicateDetector.checkDuplicate(t.ideaText).catch(c=>(console.error("Duplicate check failed:",c),{isDuplicate:!1,duplicates:[],threshold:.75}))]),s=r[0].status==="fulfilled"?r[0].value:[],i=r[1].status==="fulfilled"?r[1].value:[],a=r[2].status==="fulfilled"?r[2].value:{isDuplicate:!1,duplicates:[],threshold:.75},o={};if(s.length>0){let c=s.map(d=>d.available?`${d.domain}: available`:`${d.domain}: unavailable${d.error?` (${d.error})`:""}`);o.domains=c}if(i.length>0){let c=i.map(d=>`${d.title}: ${d.snippet} (${d.url})`);o["existence-check"]=c}a.isDuplicate&&a.duplicates.length>0&&new Vl.Notice(`Found ${a.duplicates.length} potential duplicate${a.duplicates.length>1?"s":""}. Use "check-duplicates" command to review.`),Object.keys(o).length>0&&await this.updateIdeaFrontmatter(e,o);let l=[`Domains: ${s.length} checked`,`Search: ${i.length} found`,`Duplicates: ${a.isDuplicate?a.duplicates.length+" found":"none"}`].join(", ");new Vl.Notice(`Validation complete: ${l}`)}};var Kl=require("obsidian");var Jl=class extends N{constructor(e){super(e)}getCommandName(){return"generate name variants"}async executeWithFile(e,t){new Kl.Notice("Generating name variants...");let r=await this.context.nameVariantService.generateVariants(t.ideaText);if(r.length===0){new Kl.Notice("No name variants could be generated.");return}let s=this.context.nameVariantService.formatVariantsForMarkdown(r);await this.context.fileManager.appendToFileBody(e,"Name Variants",s),new Kl.Notice("Name variants generated and added to note.")}};var Xl=require("obsidian");var Ql=class extends N{constructor(e){super(e)}getCommandName(){return"generate scaffold"}async executeWithFile(e,t){let r="",s=t.content.match(/^---\n([\s\S]*?)\n---/);if(s){let o=s[1].match(/^category:\s*(.+)$/m);o&&(r=o[1].trim())}new Xl.Notice("Generating scaffold...");let i=this.context.scaffoldService.generateScaffold(t.ideaText,r);(this.context.settings.scaffoldDefaultAction||"append")==="append"?(await this.context.fileManager.appendToFileBody(e,"Scaffold",i),new Xl.Notice("Scaffold generated and added to note.")):(await this.context.fileManager.appendToFileBody(e,"Scaffold",i),new Xl.Notice("Scaffold generated and added to note."))}};var kn=require("obsidian");var Xh=require("obsidian"),Yl=class extends Xh.Modal{mutations;onSelect;selected=new Set;constructor(e,t,r){super(e),this.mutations=t,this.onSelect=r,t.forEach((s,i)=>this.selected.add(i))}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Idea mutations"}),e.createEl("p",{text:`Generated ${this.mutations.length} mutation${this.mutations.length>1?"s":""}. Select which ones to save:`}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-mutation-list");this.mutations.forEach((l,c)=>{let d=r.createDiv("ideatr-mutation-item");d.createEl("input",{type:"checkbox",attr:{checked:"true"}}).addEventListener("change",p=>{p.target.checked?this.selected.add(c):this.selected.delete(c)});let h=d.createDiv("ideatr-mutation-label");if(h.createEl("strong",{text:l.title}),h.createEl("div",{text:l.description,cls:"ideatr-mutation-description"}),l.differences.length>0){let p=h.createEl("ul",{cls:"ideatr-mutation-differences"});l.differences.forEach(f=>{p.createEl("li",{text:f})})}});let s=e.createDiv("ideatr-modal-buttons");s.createEl("button",{text:"Save as New Ideas",cls:"mod-cta"}).addEventListener("click",()=>{let l=this.mutations.filter((c,d)=>this.selected.has(d));this.onSelect&&this.onSelect(l,"save"),this.close()}),s.createEl("button",{text:"Append to Current Note"}).addEventListener("click",()=>{let l=this.mutations.filter((c,d)=>this.selected.has(d));this.onSelect&&this.onSelect(l,"append"),this.close()}),s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var Zl=class extends N{idConverter;constructor(e){super(e),this.idConverter=new H(e.ideaRepository)}getCommandName(){return"generate mutations"}async executeWithFile(e,t){if(!this.checkLLMAvailability())return;if(new kn.Notice("Generating mutations..."),!this.context.llmService.generateMutations){new kn.Notice("Mutation generation is not supported by the current AI provider.");return}let r;try{r=await this.context.llmService.generateMutations(t.ideaText,{category:t.frontmatter.category,tags:Array.isArray(t.frontmatter.tags)?t.frontmatter.tags:void 0,count:8})}catch(s){let{MutationErrorModal:i}=await Promise.resolve().then(()=>(Yh(),Qh)),a=s instanceof Error?s.message:"Unknown error occurred",o=s,l=o.responseLength??(a.includes("empty response")?0:void 0),c=o.responsePreview;new i(this.context.app,{message:a,responseLength:l,responsePreview:c?.substring(0,500),canRetry:!0},async()=>{await this.execute()}).open();return}if(r.length===0){new kn.Notice("No mutations could be generated.");return}new Yl(this.context.app,r,async(s,i)=>{if(i==="save"){let a=await this.idConverter.pathsToIds([e.path]);for(let o of s){let l=`---
type: idea
status: captured
created: ${new Date().toISOString().split("T")[0]}
id: 0
category: ${t.frontmatter.category||""}
tags: ${JSON.stringify(t.frontmatter.tags||[])}
related: ${JSON.stringify(a)}
domains: []
existence-check: []
---

# ${o.title}

${o.description}

## Key Differences
${o.differences.map(d=>`- ${d}`).join(`
`)}
`,c=`Ideas/${Cn(o.title,new Date)}`;await this.context.app.vault.create(c,l)}new kn.Notice(`Created ${s.length} new idea${s.length>1?"s":""} from mutations.`)}else{let a=s.map(o=>`## ${o.title}

${o.description}

**Key Differences:**
${o.differences.map(l=>`- ${l}`).join(`
`)}`).join(`

---

`);await this.context.fileManager.appendToFileBody(e,"Mutations",a),new kn.Notice(`Added ${s.length} mutation${s.length>1?"s":""} to note.`)}}).open()}};var sa=require("obsidian");var Zh=require("obsidian"),ec=class extends Zh.Modal{expansion;onAction;constructor(e,t,r){super(e),this.expansion=t,this.onAction=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Expanded idea preview"}),e.createEl("p",{text:"Review the expanded idea content below. Choose to append or replace the current content:"}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-expansion-preview");r.style.maxHeight="400px",r.style.overflowY="auto",r.style.padding="10px",r.style.border="1px solid var(--background-modifier-border)",r.style.borderRadius="4px";let s=r.createDiv("ideatr-expansion-content");s.textContent=this.expansion.expandedText,s.style.whiteSpace="pre-wrap";let i=e.createDiv("ideatr-modal-buttons");i.createEl("button",{text:"Append to Note",cls:"mod-cta"}).addEventListener("click",()=>{this.onAction&&this.onAction("append"),this.close()}),i.createEl("button",{text:"Replace content"}).addEventListener("click",()=>{this.onAction&&this.onAction("replace"),this.close()}),i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var tc=class extends N{constructor(e){super(e)}getCommandName(){return"expand idea"}async executeWithFile(e,t){if(!this.checkLLMAvailability())return;if(new sa.Notice("Expanding idea..."),!this.context.llmService.expandIdea){this.debug("LLM service does not support expandIdea"),new sa.Notice("Idea expansion is not supported by the current AI provider.");return}let r=await this.context.llmService.expandIdea(t.ideaText,{category:t.frontmatter.category,tags:Array.isArray(t.frontmatter.tags)?t.frontmatter.tags:void 0,detailLevel:"detailed"});new ec(this.context.app,r,async s=>{if(s==="append")await this.context.fileManager.appendToFileBody(e,"Expanded Idea",r.expandedText),new sa.Notice("Expanded content added to note.");else if(s==="replace"){let i=this.context.frontmatterParser.parse(t.content),a=this.context.frontmatterParser.build(i.frontmatter,r.expandedText);await this.context.app.vault.modify(e,a),new sa.Notice("Idea content replaced with expanded version.")}}).open()}};var na=require("obsidian");var ef=require("obsidian"),rc=class extends ef.Modal{originalText;reorganization;onAction;constructor(e,t,r,s){super(e),this.originalText=t,this.reorganization=r,this.onAction=s}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Reorganized idea preview"}),e.createEl("p",{text:"Review the reorganized idea below. A backup file has been created. Choose to accept or reject the changes:"}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-reorganization-changes");this.reorganization.changes.sectionsAdded.length>0&&r.createEl("div",{text:`Sections added: ${this.reorganization.changes.sectionsAdded.join(", ")}`,cls:"ideatr-change-added"}),this.reorganization.changes.sectionsRemoved.length>0&&r.createEl("div",{text:`Sections removed: ${this.reorganization.changes.sectionsRemoved.join(", ")}`,cls:"ideatr-change-removed"}),this.reorganization.changes.sectionsReorganized.length>0&&r.createEl("div",{text:`Sections reorganized: ${this.reorganization.changes.sectionsReorganized.join(", ")}`,cls:"ideatr-change-reorganized"});let s=e.createDiv("ideatr-reorganization-tabs"),i=s.createEl("button",{text:"Before",cls:"ideatr-tab-button"}),a=s.createEl("button",{text:"After",cls:"ideatr-tab-button mod-cta"}),o=e.createDiv("ideatr-reorganization-preview");o.style.maxHeight="400px",o.style.overflowY="auto",o.style.padding="10px",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px",o.style.marginTop="10px";let l="after",c=()=>{o.empty();let p=l==="before"?this.originalText:this.reorganization.reorganizedText,f=o.createDiv("ideatr-reorganization-content");f.textContent=p,f.style.whiteSpace="pre-wrap",i.classList.toggle("mod-cta",l==="before"),a.classList.toggle("mod-cta",l==="after")};i.addEventListener("click",()=>{l="before",c()}),a.addEventListener("click",()=>{l="after",c()}),c();let d=e.createDiv("ideatr-modal-buttons");d.createEl("button",{text:"Accept changes",cls:"mod-cta"}).addEventListener("click",()=>{this.onAction&&this.onAction("accept"),this.close()}),d.createEl("button",{text:"Reject"}).addEventListener("click",()=>{this.onAction&&this.onAction("reject"),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var sc=class extends N{constructor(e){super(e)}getCommandName(){return"reorganize idea"}async executeWithFile(e,t){if(!this.checkLLMAvailability())return;if(new na.Notice("Reorganizing idea..."),!this.context.llmService.reorganizeIdea){new na.Notice("Idea reorganization is not supported by the current AI provider.");return}let r=e.path.replace(/\.md$/,".backup.md");try{await this.context.app.vault.create(r,t.content)}catch(i){m.warn("Failed to create backup file:",i)}let s=await this.context.llmService.reorganizeIdea(t.ideaText,{category:t.frontmatter.category,tags:Array.isArray(t.frontmatter.tags)?t.frontmatter.tags:void 0});new rc(this.context.app,t.ideaText,s,async i=>{if(i==="accept"){let a=this.context.frontmatterParser.parse(t.content),o=this.context.frontmatterParser.build(a.frontmatter,s.reorganizedText);await this.context.app.vault.modify(e,o),new na.Notice("Idea reorganized successfully.")}else i==="reject"&&new na.Notice("Reorganization cancelled.")}).open()}};var Ln=require("obsidian");var nc=class{llmService;constructor(e){this.llmService=e}async analyzeIntent(e,t,r){let s=this.buildIntentAnalysisPrompt(e,t,r);try{if(!this.llmService.complete)throw new Error("LLM service does not support completion");let i=await this.llmService.complete(s,{temperature:.3,n_predict:1e3,stop:["}"]});return this.parseIntentResponse(i)}catch(i){return m.warn("Intent analysis failed:",i),{intent:"custom",operations:[{type:"transform",target:"body",action:e}],description:`Apply transformation: ${e}`,requiresBodyModification:!0}}}async executeTransformation(e,t,r,s,i,a){let o=this.buildExecutionPrompt(e,t,r,s,a);try{if(!this.llmService.complete)throw new Error("LLM service does not support completion");let l=await this.llmService.complete(o,{temperature:.7,n_predict:4e3,stop:["}"]});return this.parseExecutionResponse(l)}catch(l){throw m.error("Transformation execution failed:",l),new Error(`Failed to execute transformation: ${l instanceof Error?l.message:String(l)}`)}}buildIntentAnalysisPrompt(e,t,r){let s=JSON.stringify(r,null,2),i=t.substring(0,2e3);return`Analyze this user request and determine what transformation to perform on an idea note.

User Request: "${e}"

Current Note Content (preview):
${i}

Frontmatter:
${s}

Available Operations:
- organize: Sort, group, or structure content (e.g., "sort alphabetically", "group by category")
- expand: Add content, examples, or variations (e.g., "add 3 alternatives", "include examples")
- transform: Rename, reformat, or restructure (e.g., "rename to X", "make it shorter", "convert to list")
- analyze: Extract insights or identify issues (e.g., "find problems", "list assumptions")
- restructure: Move, split, or combine sections (e.g., "move section X to top", "split into 3 parts")

Determine:
1. Primary intent (one of the operations above)
2. Specific action to take
3. What parts of the note to modify
4. Expected outcome

Respond in JSON format (no markdown, no code blocks, just JSON):
{
  "intent": "organize|expand|transform|analyze|restructure|custom",
  "action": "specific action description",
  "target": "what to modify (e.g., 'list in body', 'frontmatter fields', 'section X')",
  "expectedOutcome": "what the result should look like",
  "requiresFileRename": false,
  "requiresFrontmatterUpdate": false,
  "requiresBodyModification": true,
  "description": "human-readable description of what will happen"
}

Response: {`}buildExecutionPrompt(e,t,r,s,i){let a=JSON.stringify(s,null,2),o=i?`
Current Filename: ${i}`:"",l=this.getIntentInstructions(t.intent),c=t.operations[0],d=c?.action||t.description,u=c?.target||"body",h=t.description;return`Transform this idea note according to the user's request.

User Request: "${e}"

Transformation Plan:
- Intent: ${t.intent}
- Action: ${d}
- Target: ${u}
- Expected Outcome: ${h}

Current Note Content:
${r}${o}

Frontmatter:
${a}

Instructions:
${l}

Critical Rules:
1. Preserve ALL important information unless explicitly asked to remove it
2. Maintain valid YAML frontmatter structure
3. Preserve markdown formatting
4. Keep the original intent and meaning of the content
5. Only make changes that align with the user's request

Generate the transformed content. If no changes are needed to a section, return it as-is.

Output format (JSON only, no markdown, no code blocks):
{
  "newFilename": "new-filename.md" (if rename needed, else null),
  "frontmatter": { ... updated frontmatter as JSON object ... },
  "body": "transformed body content as string",
  "summary": "brief description of changes made"
}

Response: {`}getIntentInstructions(e){let t={organize:`- Organize content logically (sort, group, structure)
- Maintain all original content
- Use clear headings and structure
- Preserve relationships between items`,expand:`- Add new content that enhances the idea
- Maintain consistency with existing content
- Add content in appropriate locations
- Use markdown formatting for new content`,transform:`- Transform content format or structure
- Preserve meaning while changing presentation
- Update references if renaming
- Maintain valid markdown`,analyze:`- Extract insights from the content
- Identify patterns, problems, or assumptions
- Add analysis as a new section or append to existing
- Use clear headings for analysis results`,restructure:`- Reorganize sections or content
- Maintain all information
- Update section order logically
- Preserve content within sections`,custom:`- Follow the user's specific request
- Make reasonable interpretations
- Preserve important information
- Apply changes as requested`};return t[e]||t.custom}parseIntentResponse(e){try{let t=z(e,!0),r=JSON.parse(t),s=this.validateIntent(r.intent||"custom");return{intent:s,operations:[{type:r.action||"transform",target:r.target||"body",action:r.action||"custom transformation",parameters:{}}],description:r.description||`Apply ${s} transformation`,requiresFileRename:r.requiresFileRename===!0,requiresFrontmatterUpdate:r.requiresFrontmatterUpdate===!0,requiresBodyModification:r.requiresBodyModification!==!1}}catch(t){return m.warn("Failed to parse intent response:",t),{intent:"custom",operations:[{type:"transform",target:"body",action:"custom transformation"}],description:"Apply custom transformation",requiresBodyModification:!0}}}parseExecutionResponse(e){try{let t=z(e,!0),r=JSON.parse(t);return{newFilename:r.newFilename||null,frontmatter:r.frontmatter||void 0,body:r.body||void 0,summary:r.summary||"Transformation applied"}}catch(t){m.warn("Failed to parse execution response:",t);let r=e.match(/"body"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);if(r)return{body:r[1].replace(/\\n/g,`
`).replace(/\\"/g,'"'),summary:"Transformation applied (partial parsing)"};throw new Error("Failed to parse transformation result")}}validateIntent(e){return["organize","expand","transform","analyze","restructure","custom"].includes(e)?e:"custom"}isAvailable(){return this.llmService.isAvailable()}};var ia=require("obsidian"),ic=class extends ia.Modal{inputEl;statusEl;previewContainer;buttonContainer;service;noteContent;frontmatter;body;currentFilename;transformationResult;transformationPlan;onAccept;isProcessing=!1;constructor(e,t,r,s,i,a,o){super(e),this.service=t,this.noteContent=r,this.frontmatter=s,this.body=i,this.currentFilename=a,this.onAccept=o}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ideatr-guided-ideation-modal"),e.createEl("h2",{text:"Ideatr: Transform"}),e.createEl("p",{text:'Describe the transformation you want to apply to this idea. Examples: "Organize this list alphabetically", "Add three alternatives", "Rename to Project Goodspring"'}).addClass("ideatr-modal-description"),this.inputEl=e.createEl("textarea",{attr:{placeholder:"Enter your transformation request...",rows:"4"}}),this.inputEl.addClass("ideatr-input"),this.inputEl.style.width="100%",this.inputEl.style.marginBottom="10px",this.statusEl=e.createDiv("ideatr-status"),this.statusEl.style.display="none",this.previewContainer=e.createDiv("ideatr-preview-container"),this.previewContainer.style.display="none",this.previewContainer.style.maxHeight="400px",this.previewContainer.style.overflowY="auto",this.previewContainer.style.padding="10px",this.previewContainer.style.border="1px solid var(--background-modifier-border)",this.previewContainer.style.borderRadius="4px",this.previewContainer.style.marginTop="10px",this.previewContainer.style.marginBottom="10px",this.buttonContainer=e.createDiv("ideatr-modal-buttons"),this.buttonContainer.style.marginTop="10px",this.buttonContainer.createEl("button",{text:"Transform",cls:"mod-cta"}).addEventListener("click",()=>this.handleTransform()),this.buttonContainer.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.inputEl.addEventListener("keydown",i=>{(i.metaKey||i.ctrlKey)&&i.key==="Enter"&&(i.preventDefault(),this.isProcessing||this.handleTransform())}),this.inputEl.focus()}async handleTransform(){let e=this.inputEl.value.trim();if(!e){new ia.Notice("Please enter a transformation request.");return}if(!this.isProcessing){this.isProcessing=!0,this.showStatus("Analyzing intent...");try{let t=await this.service.analyzeIntent(e,this.noteContent,this.frontmatter);this.transformationPlan=t,this.showStatus("Generating transformation...");let r=await this.service.executeTransformation(e,t,this.noteContent,this.frontmatter,this.body,this.currentFilename);this.transformationResult=r,this.showPreview(r,t),this.showAcceptButton()}catch(t){this.showError(t instanceof Error?t.message:"Failed to transform idea."),console.error("Transformation failed:",t)}finally{this.isProcessing=!1}}}showStatus(e){this.statusEl.empty(),this.statusEl.style.display="block",this.statusEl.createEl("p",{text:e}),this.previewContainer.style.display="none",this.hideAcceptButton()}showError(e){this.statusEl.empty(),this.statusEl.style.display="block",this.statusEl.addClass("ideatr-error"),this.statusEl.createEl("p",{text:e}),this.previewContainer.style.display="none",this.hideAcceptButton()}showPreview(e,t){this.statusEl.style.display="none",this.previewContainer.empty(),this.previewContainer.style.display="block";let r=this.previewContainer.createDiv("ideatr-plan-description");if(r.createEl("strong",{text:"Transformation: "}),r.createEl("span",{text:t.description}),e.summary){let s=this.previewContainer.createDiv("ideatr-summary");s.createEl("strong",{text:"Summary: "}),s.createEl("span",{text:e.summary})}if(e.newFilename&&e.newFilename!==this.currentFilename){let s=this.previewContainer.createDiv("ideatr-filename-change");s.createEl("strong",{text:"Filename: "}),s.createEl("span",{text:`${this.currentFilename} \u2192 ${e.newFilename}`})}if(e.body){let s=this.previewContainer.createEl("strong",{text:"Body preview:"});s.style.display="block",s.style.marginTop="10px",s.style.marginBottom="5px";let i=this.previewContainer.createDiv("ideatr-body-preview");i.style.whiteSpace="pre-wrap",i.style.fontFamily="var(--font-monospace)",i.style.fontSize="0.9em",i.style.padding="10px",i.style.backgroundColor="var(--background-secondary)",i.style.borderRadius="4px",i.textContent=e.body.substring(0,2e3),e.body.length>2e3&&(i.textContent+=`

... (content truncated for preview)`)}if(e.frontmatter){let s=this.previewContainer.createEl("strong",{text:"Frontmatter changes:"});s.style.display="block",s.style.marginTop="10px",s.style.marginBottom="5px";let i=this.previewContainer.createDiv("ideatr-frontmatter-preview");i.style.whiteSpace="pre-wrap",i.style.fontFamily="var(--font-monospace)",i.style.fontSize="0.9em",i.style.padding="10px",i.style.backgroundColor="var(--background-secondary)",i.style.borderRadius="4px",i.textContent=JSON.stringify(e.frontmatter,null,2)}}showAcceptButton(){let e=this.buttonContainer.querySelector(".ideatr-accept-button");e&&e.remove();let t=this.buttonContainer.createEl("button",{text:"Accept changes",cls:"mod-cta ideatr-accept-button"});t.style.marginLeft="10px",t.addEventListener("click",async()=>{if(this.transformationResult&&this.transformationPlan&&this.onAccept)try{await this.onAccept(this.transformationResult,this.transformationPlan),this.close()}catch(r){new ia.Notice(`Failed to apply changes: ${r instanceof Error?r.message:String(r)}`),console.error("Failed to apply transformation:",r)}})}hideAcceptButton(){let e=this.buttonContainer.querySelector(".ideatr-accept-button");e&&e.remove()}onClose(){let{contentEl:e}=this;e.empty()}};var ac=class extends N{service;constructor(e){super(e),this.service=new nc(e.llmService)}getCommandName(){return"Transform"}async executeWithFile(e,t){this.checkLLMAvailability()&&new ic(this.context.app,this.service,t.content,t.frontmatter,t.body,e.basename,async(r,s)=>{await this.applyTransformation(e,r,s,t)}).open()}async applyTransformation(e,t,r,s){try{let i=e.path.replace(/\.md$/,".backup.md");try{await this.context.app.vault.create(i,s.content)}catch(o){m.warn("Failed to create backup file:",o)}let a=e;if(t.newFilename){let o=t.newFilename.split("/").pop()||t.newFilename;if(o.replace(/\.md$/,"")!==e.basename){o.endsWith(".md")||(o=`${o}.md`);let c=e.path.replace(e.name,o);try{await this.context.app.vault.rename(e,c);let d=this.context.app.vault.getAbstractFileByPath(c),u=d instanceof Ln.TFile?d:null;if(u&&(a=u),!a)throw new Error("File rename succeeded but could not find renamed file");new Ln.Notice(`File renamed to ${o}`)}catch(d){m.error("Failed to rename file:",d),new Ln.Notice("Failed to rename file. Other changes will still be applied.")}}}t.frontmatter&&r.requiresFrontmatterUpdate&&await this.context.fileManager.updateIdeaFrontmatter(a,t.frontmatter),t.body&&r.requiresBodyModification&&await this.updateFileBody(a,t.body),new Ln.Notice("Transformation applied successfully!")}catch(i){throw m.error("Failed to apply transformation:",i),i}}async updateFileBody(e,t){await this.context.app.vault.process(e,r=>{let s=/^---\n([\s\S]*?)\n---(\n\n?|\n?)/,i=r.match(s);return i?i[0]+t:t})}};var rf=require("obsidian");var tf=require("obsidian"),oc=class extends tf.Modal{currentStatus;onSelect;selectedStatus=null;constructor(e,t,r){super(e),this.currentStatus=t,this.onSelect=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Change idea status"}),e.createEl("p",{text:`Current status: ${this.currentStatus}. Select a new status:`}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-status-list");[{value:"captured",label:"Captured",description:"Newly captured idea"},{value:"validated",label:"Validated",description:"Idea has been validated"},{value:"promoted",label:"Promoted",description:"Idea has been promoted"},{value:"archived",label:"Archived",description:"Archived idea"}].forEach(l=>{let c=r.createDiv("ideatr-status-item"),d=c.createEl("input",{type:"radio",attr:{name:"status",value:l.value,checked:this.currentStatus===l.value?"true":null}});this.currentStatus===l.value&&(this.selectedStatus=l.value),d.addEventListener("change",h=>{h.target.checked&&(this.selectedStatus=l.value)});let u=c.createDiv("ideatr-status-label");u.createEl("strong",{text:l.label}),u.createEl("div",{text:l.description,cls:"ideatr-status-description"})});let i=e.createDiv("ideatr-modal-buttons");i.createEl("button",{text:"Apply",cls:"mod-cta"}).addEventListener("click",()=>{this.selectedStatus&&this.onSelect&&this.onSelect(this.selectedStatus),this.close()}),i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var lc=class extends N{constructor(e){super(e)}getCommandName(){return"change status"}async executeWithFile(e,t){let r=t.frontmatter.status||"captured";new oc(this.context.app,r,async s=>{await this.updateIdeaFrontmatter(e,{status:s});let a=t.frontmatter.status==="archived",o=s==="archived";o?await this.context.fileOrganizer.moveToArchive(e):a&&!o&&await this.context.fileOrganizer.moveFromArchive(e),new rf.Notice(`Status changed to ${s}`)}).open()}};var Tu=require("obsidian");var aa=class extends N{constructor(t,r){super(t);this.isArchive=r}getCommandName(){return this.isArchive?"archive idea":"unarchive idea"}async executeWithFile(t,r){if(this.isArchive)await this.updateIdeaFrontmatter(t,{status:"archived"}),await this.context.fileOrganizer.moveToArchive(t),new Tu.Notice("Idea archived successfully.");else{let s=r.frontmatter.status==="archived"?"captured":r.frontmatter.status||"captured";await this.updateIdeaFrontmatter(t,{status:s}),await this.context.fileOrganizer.moveFromArchive(t),new Tu.Notice("Idea unarchived successfully.")}}};var oa=require("obsidian");var cc=class extends N{constructor(e){super(e)}getCommandName(){return"generate codename"}async executeWithFile(e,t){if(!this.context.llmService?.isAvailable()||!this.context.llmService.complete){new oa.Notice("LLM service is not available. Cannot generate codename.");return}let r=le(t.body),s=r?`${r}

${t.body}`:t.body;new oa.Notice("Generating codename...");let i=await this.generateCodename(s);if(!i){new oa.Notice("Failed to generate codename. Please try again.");return}await this.updateIdeaFrontmatter(e,{codename:i.trim()});let o=`${Eu(i.trim())}.md`;if(e.name!==o){let d=e.path.substring(0,e.path.lastIndexOf("/")+1)+o;await this.context.app.vault.rename(e,d)}new oa.Notice(`Codename "${i}" generated successfully.`)}async generateCodename(e){if(!this.context.llmService?.complete)return null;let t=`Generate a memorable, brandable codename for this idea.

Idea: "${e.substring(0,500)}"

CRITICAL REQUIREMENTS:
- Extract the CORE CONCEPT, not just use the literal text
- Focus on what makes the idea unique or memorable
- Create a codename that could work as a project/product name
- Prioritize memorability and pronounceability over literal accuracy

Requirements:
- 1-3 words maximum (prefer 1-2 words)
- Easy to remember and pronounce (test: can you say it naturally?)
- Captures the idea's essence in a creative way
- Professional but distinctive
- Suitable for filenames (alphanumeric, hyphens, spaces only)
- 2-20 characters total (shorter is usually better)
- IMPORTANT: Avoid unpronounceable acronyms longer than 6 characters. If using acronyms, they must be pronounceable (e.g., "ACME" is fine, "AGPFOIM" is not)

Codename strategies:
- Portmanteau: Blend key words (e.g., "net" + "flicks" \u2192 "Netflix")
- Compound: Combine two relevant words (e.g., "VolumeBand", "SoundSense")
- Single word: Use a powerful, relevant word (e.g., "Zen", "Ping", "Alert")
- Short acronym: Only if pronounceable and 6 chars or fewer (e.g., "NASA", "ACME")

Examples:
- "bracelet that measures room volume" \u2192 "VolumeBand", "SoundSense", "EchoBand"
- "AI writing assistant" \u2192 "WriteBot", "TextCraft", "WordSmith"
- "social network for developers" \u2192 "DevNet", "CodeConnect", "DevHub"
- "AI generated puzzle full of interlinked monkeys that look similar, sort of a where's waldo of monkeys" \u2192 "MonkeyFind", "PrimateSeek", "ApeSpot", "FindMonkey"
- "task manager for remote teams" \u2192 "TaskFlow", "TeamSync", "RemoteTask"

Return ONLY the codename. No quotes, no explanation, no prefixes like "Codename:" or "Name:". Just the name itself:`;try{let s=(await this.context.llmService.complete(t,{temperature:.8,n_predict:50,stop:[`
`,".","!","?",'"',"'"]})).trim();return s=s.replace(/^["']|["']$/g,""),s=s.substring(0,30).trim(),s=s.replace(/[^a-zA-Z0-9\s-]/g,""),s.length<2?null:s}catch(r){throw console.error("Codename generation failed:",r),r}}};var dc=class extends V{constructor(e){super(e)}async execute(){try{await this.context.app.workspace.getLeaf(!1).setViewState({type:"ideatr-dashboard",active:!0})}catch(e){this.handleError(e,"open dashboard")}}};var uc=class extends V{constructor(e){super(e)}async execute(){try{await this.context.app.workspace.getLeaf(!1).setViewState({type:"ideatr-graph",active:!0})}catch(e){this.handleError(e,"open graph view")}}};Au();var pc=class extends V{constructor(e){super(e)}async execute(){try{await new ea(this.context.app).openIndex()}catch(e){this.handleError(e,"open tutorials","Opening tutorials")}}};var Mu=require("obsidian");var mc=class extends N{constructor(e){super(e)}getCommandName(){return"classify note"}async executeWithFile(e,t){if(!this.checkServiceAvailability(this.context.classificationService,"AI classification"))return;new Mu.Notice("Classifying idea...");let r=await this.context.classificationService.classifyIdea(t.ideaText),s=this.context.frontmatterParser.parse(t.content);if(s.frontmatter.category=r.category,s.frontmatter.tags=r.tags,r.related.length>0){let o=await new H(this.context.ideaRepository).pathsToIds(r.related);s.frontmatter.related=o}let i=this.context.frontmatterParser.build(s.frontmatter,s.body);await this.context.app.vault.modify(e,i),new Mu.Notice("Classification complete!")}};var ku=require("obsidian");var hc=class extends N{constructor(e){super(e)}getCommandName(){return"refresh idea"}async executeWithFile(e,t){new ku.Notice("Refreshing idea...");let r={};if(this.context.classificationService.isAvailable())try{let s=await this.context.classificationService.classifyIdea(t.ideaText);r.category=s.category,r.tags=s.tags}catch(s){m.warn("Failed to re-classify:",s)}try{let s=await this.context.searchService.findRelatedNotes(t.ideaText,5),i=new H(this.context.ideaRepository),a=s.map(o=>o.path);r.related=await i.pathsToIds(a)}catch(s){m.warn("Failed to refresh related notes:",s)}if(this.context.settings.enableNameVariants&&this.context.nameVariantService.isAvailable())try{let s=await this.context.nameVariantService.generateVariants(t.ideaText);if(s.length>0){let i=this.context.nameVariantService.formatVariantsForMarkdown(s);await this.context.fileManager.appendToFileBody(e,"Name Variants",i)}}catch(s){m.warn("Failed to regenerate name variants:",s)}Object.keys(r).length>0&&await this.updateIdeaFrontmatter(e,r),new ku.Notice("Idea refreshed successfully.")}};var Lu=require("obsidian");var fc=class extends V{constructor(e){super(e)}async execute(){try{let e="json";new Lu.Notice("Exporting ideas...");let t=await this.context.exportService.exportIdeas(e),s=`Ideatr-Export-${new Date().toISOString().replace(/[:.]/g,"-")}.${e==="json"?"json":e==="csv"?"csv":"md"}`,i=`Ideas/${s}`;await this.context.app.vault.create(i,t),new Lu.Notice(`Exported ${s} successfully.`)}catch(e){this.handleError(e,"export ideas")}}};var Fn=require("obsidian");var sf=require("obsidian"),gc=class extends sf.SuggestModal{onSelect;allowedExtensions;constructor(e,t=["json","csv","md"],r){super(e),this.onSelect=r,this.allowedExtensions=t,this.setPlaceholder("Type to search for import files...")}getSuggestions(e){let r=this.app.vault.getFiles().filter(i=>{let a=i.extension.toLowerCase();return this.allowedExtensions.includes(a)});if(!e)return r.slice(0,50);let s=e.toLowerCase();return r.filter(i=>i.name.toLowerCase().includes(s)||i.path.toLowerCase().includes(s)).slice(0,50)}renderSuggestion(e,t){if(t.createEl("div",{text:e.name,attr:{style:"font-weight: bold;"}}),t.createEl("div",{text:e.path,attr:{style:"font-size: 12px; color: var(--text-muted); margin-top: 2px;"}}),e.stat&&e.stat.size){let r=(e.stat.size/1024).toFixed(1);t.createEl("div",{text:`${r} KB`,attr:{style:"font-size: 11px; color: var(--text-faint); margin-top: 2px;"}})}}onChooseSuggestion(e,t){this.onSelect(e)}};var nf=require("obsidian"),sr=class extends nf.Modal{onCancel;cancelled=!1;progressContainer;statusContainer;errorContainer;cancelButton=null;title;constructor(e,t,r){super(e),this.onCancel=r,this.title=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:this.title}),this.progressContainer=e.createDiv("ideatr-progress-container");let t=this.progressContainer.createDiv("ideatr-progress-bar");t.style.width="100%",t.style.height="20px",t.style.backgroundColor="var(--background-modifier-border)",t.style.borderRadius="4px",t.style.overflow="hidden";let r=t.createDiv("ideatr-progress-fill");r.style.width="0%",r.style.height="100%",r.style.backgroundColor="var(--interactive-accent)",r.style.transition="width 0.3s ease",t.fill=r,this.statusContainer=e.createDiv("ideatr-progress-status"),this.statusContainer.style.marginTop="10px",this.statusContainer.style.fontSize="14px",this.statusContainer.style.color="var(--text-muted)",this.errorContainer=e.createDiv("ideatr-progress-errors"),this.errorContainer.style.marginTop="10px",this.errorContainer.style.maxHeight="200px",this.errorContainer.style.overflowY="auto",this.errorContainer.style.display="none";let s=e.createDiv("ideatr-modal-buttons");s.style.marginTop="20px",this.cancelButton=s.createEl("button",{text:"Cancel",cls:"mod-cta"}),this.cancelButton.addEventListener("click",()=>{this.cancelled=!0,this.onCancel&&this.onCancel(),this.close()}),this.progressFill=r,this.progressBar=t}updateProgress(e){let t=this.progressFill;if(!t)return;let r=e.total>0?e.current/e.total*100:0;t.style.width=`${r}%`,this.statusContainer.empty(),e.currentItem&&this.statusContainer.createEl("div",{text:`Processing: ${e.currentItem}`,cls:"ideatr-progress-current-item"}),this.statusContainer.createEl("div",{text:`${e.current} / ${e.total} completed`,cls:"ideatr-progress-count"}),e.errors&&e.errors.length>0&&(this.errorContainer.style.display="block",this.errorContainer.empty(),this.errorContainer.createEl("strong",{text:"Errors:"}),e.errors.forEach(s=>{let i=this.errorContainer.createEl("div",{text:s,cls:"ideatr-progress-error"});i.style.color="var(--text-error)",i.style.marginTop="5px"})),e.status==="completed"?(this.statusContainer.createEl("div",{text:"\u2713 Completed",cls:"ideatr-progress-completed"}),this.cancelButton&&(this.cancelButton.textContent="Close")):e.status==="cancelled"&&this.statusContainer.createEl("div",{text:"\u2717 Cancelled",cls:"ideatr-progress-cancelled"})}isCancelled(){return this.cancelled}onClose(){let{contentEl:e}=this;e.empty(),this.cancelled=!1}};var yc=class extends V{constructor(e){super(e)}async execute(){try{if(!this.context.importService){new Fn.Notice("Import service is not available.");return}new gc(this.context.app,["json","csv","md"],async e=>{let t="json",r=e.extension?.toLowerCase()||"";if(r==="json")t="json";else if(r==="csv")t="csv";else if(r==="md"||r==="markdown")t="markdown";else{new Fn.Notice(`Unsupported file format: ${r}. Please use JSON, CSV, or Markdown files.`);return}try{let s=await this.context.app.vault.read(e),i=new sr(this.context.app,"Importing Ideas");i.open(),i.updateProgress({current:0,total:1,currentItem:`Parsing ${e.name}...`,status:"processing"});let a=await this.context.importService.importIdeas(s,t);i.updateProgress({current:a.total,total:a.total,status:(a.failed===0,"completed"),errors:a.errors.length>0?a.errors.map(o=>`${o.item}: ${o.error}`):void 0}),a.imported>0?new Fn.Notice(`Import complete: ${a.imported} imported, ${a.failed} failed${a.errors.length>0?". Check console for details.":"."}`):new Fn.Notice(`Import failed: ${a.failed} failed. Check console for details.`),setTimeout(()=>{i.close()},2e3)}catch(s){console.error("Failed to import ideas:",s),new Fn.Notice("Failed to import ideas. Please try again or check console for details.")}}).open()}catch(e){this.handleError(e,"show import file picker")}}};var Fu=require("obsidian");var bc=class extends V{constructor(e){super(e)}async execute(){try{new Fu.Notice("Generating digest...");let e=await this.context.resurfacingService.generateDigest(),t=e.summary,r=`Ideas/.ideatr-digest-${Date.now()}.md`;await this.context.app.vault.create(r,t),new Fu.Notice(`Digest generated: ${e.ideas.length} ideas`),this.context.app.vault.getAbstractFileByPath(r)&&await this.context.app.workspace.openLinkText(r,"",!1)}catch(e){this.handleError(e,"generate digest")}}};var Qr=require("obsidian");var wc=class extends V{constructor(e){super(e)}async execute(){try{let e=this.context.app.workspace.getActiveFile();if(!e){new Qr.Notice("No active note. Please open an idea file.");return}if(!e.path.startsWith("Ideas/")){new Qr.Notice("This command works with idea files in the Ideas/ directory.");return}let t=await this.context.app.vault.read(e),r=this.context.frontmatterParser.parseIdeaFile({path:e.path,name:e.name},t);if(!this.context.projectElevationService.canElevate(r)){new Qr.Notice("This idea cannot be elevated. It may already be elevated or have invalid frontmatter.");return}let s=this.context.projectElevationService.generateProjectName(r);if(!await Ce(this.context.app,`Elevate idea to project?

Project name: ${s}

The idea file will be moved to Projects/${s}/README.md
Original file will be deleted.`))return;new Qr.Notice("Elevating idea to project...");let a=await this.context.projectElevationService.elevateIdea(r);a.success?(new Qr.Notice(`Idea elevated to project: ${a.projectPath}`),await this.context.ideaRepository.refresh(),this.context.app.vault.getAbstractFileByPath(`${a.projectPath}/README.md`)&&await this.context.app.workspace.openLinkText(`${a.projectPath}/README.md`,"",!1)):(new Qr.Notice(`Failed to elevate idea: ${a.error||"Unknown error"}`),a.warnings&&a.warnings.length>0&&m.warn("Elevation warnings:",a.warnings))}catch(e){this.handleError(e,"elevate idea to project","elevate-idea")}}};var vc=require("obsidian");var xc=class extends V{constructor(e){super(e)}async execute(){try{let t=this.context.app.vault.getMarkdownFiles().filter(o=>o.path.startsWith("Ideas/")&&!o.path.startsWith("Ideas/Archived/"));if(t.length===0){new vc.Notice("No idea files found in Ideas/ directory.");return}if(!this.context.classificationService.isAvailable()){new vc.Notice("Classification service is not available. Please configure AI in settings.");return}let r=new sr(this.context.app,"Reclassifying Ideas");r.open();let s=0,i=0,a=[];for(let o=0;o<t.length&&!r.isCancelled();o++){let l=t[o];r.updateProgress({current:o+1,total:t.length,currentItem:l.name,status:"processing"});try{let c=await this.context.app.vault.read(l),d=this.context.frontmatterParser.parse(c),u=d.body.trim();if(u.length===0){a.push(`${l.name}: No content to classify`),i++;continue}let h=await this.context.classificationService.classifyIdea(u),f=await new H(this.context.ideaRepository).pathsToIds(h.related),y={...d.frontmatter,category:h.category,tags:h.tags,related:f},S=this.context.frontmatterParser.build(y,d.body);await this.context.app.vault.modify(l,S),s++}catch(c){let d=c instanceof Error?c.message:"Unknown error";a.push(`${l.name}: ${d}`),i++}}r.updateProgress({current:t.length,total:t.length,status:r.isCancelled()?"cancelled":"completed",errors:a.length>0?a:void 0}),r.isCancelled()||new vc.Notice(`Reclassification complete: ${s} updated, ${i} failed`)}catch(e){this.handleError(e,"reclassify all ideas")}}};var nr=require("obsidian");var af=require("obsidian"),Sc=class extends af.Modal{pairs;selected=new Set;onBulkAction;onLink;onArchive;onMerge;constructor(e,t,r){super(e),this.pairs=t,this.onBulkAction=r?.onBulkAction,this.onLink=r?.onLink,this.onArchive=r?.onArchive,this.onMerge=r?.onMerge}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Duplicate pairs found"}),e.createEl("p",{text:`Found ${this.pairs.length} duplicate pair${this.pairs.length>1?"s":""}. Select pairs and choose an action:`}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-duplicate-pairs-list");r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginBottom="20px",this.pairs.forEach((d,u)=>{let h=r.createDiv("ideatr-duplicate-pair-item");h.style.marginBottom="15px",h.style.padding="10px",h.style.border="1px solid var(--background-modifier-border)",h.style.borderRadius="4px";let p=h.createEl("input",{type:"checkbox",attr:{checked:"true"}});this.selected.add(u),p.style.marginRight="10px",p.style.marginBottom="10px",p.addEventListener("change",B=>{B.target.checked?this.selected.add(u):this.selected.delete(u)});let f=h.createDiv("ideatr-duplicate-pair-info"),y=f.createEl("div",{text:`Similarity: ${(d.similarity*100).toFixed(1)}%`,cls:"ideatr-duplicate-pair-similarity"});y.style.fontWeight="bold",y.style.marginBottom="8px",y.style.color="var(--text-accent)";let S=f.createDiv("ideatr-duplicate-pair-file");S.createEl("strong",{text:"File 1: "}),S.createEl("span",{text:d.file1.name}),S.style.marginBottom="4px";let x=f.createDiv("ideatr-duplicate-pair-file");x.createEl("strong",{text:"File 2: "}),x.createEl("span",{text:d.file2.name}),x.style.marginBottom="8px";let g=h.createDiv("ideatr-duplicate-pair-actions");g.style.marginTop="8px",g.style.display="flex",g.style.gap="8px",g.createEl("button",{text:"Link",attr:{style:"font-size: 11px; padding: 4px 8px;"}}).addEventListener("click",()=>{this.onLink&&this.onLink(d)}),g.createEl("button",{text:"Archive",attr:{style:"font-size: 11px; padding: 4px 8px;"}}).addEventListener("click",()=>{this.onArchive&&this.onArchive(d)}),g.createEl("button",{text:"Merge",attr:{style:"font-size: 11px; padding: 4px 8px;"}}).addEventListener("click",()=>{this.onMerge&&this.onMerge(d)})});let s=e.createDiv("ideatr-duplicate-bulk-actions");s.style.marginTop="20px",s.style.paddingTop="20px",s.style.borderTop="1px solid var(--background-modifier-border)",s.createEl("h3",{text:"Bulk actions",attr:{style:"margin-bottom: 10px;"}}),s.createEl("p",{text:`Apply action to ${this.selected.size} selected pair${this.selected.size>1?"s":""}:`,attr:{style:"font-size: 12px; color: var(--text-muted); margin-bottom: 10px;"}});let i=s.createDiv("ideatr-modal-buttons");i.style.display="flex",i.style.gap="10px",i.createEl("button",{text:"Link selected",cls:"mod-cta"}).addEventListener("click",()=>{let d=this.pairs.filter((u,h)=>this.selected.has(h));this.onBulkAction&&this.onBulkAction(d,"link")}),i.createEl("button",{text:"Archive selected"}).addEventListener("click",()=>{let d=this.pairs.filter((u,h)=>this.selected.has(h));this.onBulkAction&&this.onBulkAction(d,"archive")}),i.createEl("button",{text:"Merge selected"}).addEventListener("click",()=>{let d=this.pairs.filter((u,h)=>this.selected.has(h));this.onBulkAction&&this.onBulkAction(d,"merge")}),i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var Ac=class extends V{constructor(e){super(e)}async execute(){try{let t=this.context.app.vault.getMarkdownFiles().filter(i=>i.path.startsWith("Ideas/")&&!i.path.startsWith("Ideas/Archived/"));if(t.length<2){new nr.Notice("Need at least 2 idea files to find duplicates.");return}new nr.Notice("Scanning for duplicates... This may take a while.");let r=[];for(let i=0;i<t.length;i++)for(let a=i+1;a<t.length;a++){let o=t[i],l=t[a];try{let c=await this.context.app.vault.read(o),d=await this.context.app.vault.read(l),u=this.context.frontmatterParser.parse(c),h=this.context.frontmatterParser.parse(d),p=u.body,f=h.body,y=this.context.searchService.calculateSimilarity(p,f);y>.75&&r.push({file1:o,file2:l,similarity:y})}catch(c){m.warn(`Failed to compare ${o.name} and ${l.name}:`,c)}}if(r.length===0){new nr.Notice("No duplicates found.");return}let s=new Sc(this.context.app,r,{onBulkAction:async(i,a)=>{for(let o of i)try{a==="link"?await this.linkDuplicatePair(o):a==="archive"?await this.archiveDuplicatePair(o):a==="merge"&&await this.mergeDuplicatePair(o)}catch(l){console.error(`Failed to ${a} pair:`,l)}new nr.Notice(`Applied ${a} to ${i.length} pair${i.length>1?"s":""}.`),s.close()},onLink:async i=>{await this.linkDuplicatePair(i),new nr.Notice("Duplicates linked in frontmatter.")},onArchive:async i=>{await this.archiveDuplicatePair(i),new nr.Notice("Duplicate archived.")},onMerge:async i=>{await this.mergeDuplicatePair(i),new nr.Notice("Duplicates merged.")}});s.open()}catch(e){this.handleError(e,"find all duplicates")}}async linkDuplicatePair(e){let t=await this.context.app.vault.read(e.file1),r=await this.context.app.vault.read(e.file2),s=this.context.frontmatterParser.parse(t),i=this.context.frontmatterParser.parse(r),a=new H(this.context.ideaRepository),o=Array.isArray(s.frontmatter.related)?[...s.frontmatter.related].filter(y=>typeof y=="number"&&y!==0):[],l=Array.isArray(i.frontmatter.related)?[...i.frontmatter.related].filter(y=>typeof y=="number"&&y!==0):[],c=await a.pathsToIds([e.file2.path]),d=await a.pathsToIds([e.file1.path]);c.length>0&&!o.includes(c[0])&&o.push(c[0]),d.length>0&&!l.includes(d[0])&&l.push(d[0]);let u={...s.frontmatter,related:o},h={...i.frontmatter,related:l},p=this.context.frontmatterParser.build(u,s.body),f=this.context.frontmatterParser.build(h,i.body);await this.context.app.vault.modify(e.file1,p),await this.context.app.vault.modify(e.file2,f)}async archiveDuplicatePair(e){await this.context.fileOrganizer.moveToArchive(e.file2);let t=await this.context.app.vault.read(e.file2),r=this.context.frontmatterParser.parse(t),s={...r.frontmatter,status:"archived"},i=this.context.frontmatterParser.build(s,r.body);await this.context.app.vault.modify(e.file2,i)}async mergeDuplicatePair(e){let t=await this.context.app.vault.read(e.file1),r=await this.context.app.vault.read(e.file2),s=this.context.frontmatterParser.parse(t),i=this.context.frontmatterParser.parse(r),a=`${s.body}

---

Merged from: ${e.file2.name}

${i.body}`,o=[...Array.isArray(s.frontmatter.tags)?s.frontmatter.tags:[],...Array.isArray(i.frontmatter.tags)?i.frontmatter.tags:[]],l=Array.from(new Set(o)),c=new H(this.context.ideaRepository),d=Array.isArray(s.frontmatter.related)?[...s.frontmatter.related].filter(x=>typeof x=="number"&&x!==0):[],u=Array.isArray(i.frontmatter.related)?[...i.frontmatter.related].filter(x=>typeof x=="number"&&x!==0):[],h=await c.pathsToIds([e.file2.path]),p=[...d,...u,...h],f=Array.from(new Set(p)),y={...s.frontmatter,tags:l,related:f},S=this.context.frontmatterParser.build(y,a);await this.context.app.vault.modify(e.file1,S),await this.context.app.fileManager.trashFile(e.file2)}};var Du=require("obsidian");var Ec=class extends V{constructor(e){super(e)}async execute(){try{let t=this.context.app.vault.getMarkdownFiles().filter(o=>o.path.startsWith("Ideas/")&&!o.path.startsWith("Ideas/Archived/"));if(t.length===0){new Du.Notice("No idea files found in Ideas/ directory.");return}let r=new sr(this.context.app,"Refreshing Related Notes");r.open();let s=0,i=0,a=[];for(let o=0;o<t.length&&!r.isCancelled();o++){let l=t[o];r.updateProgress({current:o+1,total:t.length,currentItem:l.name,status:"processing"});try{let c=await this.context.app.vault.read(l),d=this.context.frontmatterParser.parse(c),u=d.body.trim();if(u.length===0){a.push(`${l.name}: No content to search`),i++;continue}let h=await this.context.searchService.findRelatedNotes(u,5),p=new H(this.context.ideaRepository),f=h.map(g=>g.path),y=await p.pathsToIds(f),S={...d.frontmatter,related:y},x=this.context.frontmatterParser.build(S,d.body);await this.context.app.vault.modify(l,x),s++}catch(c){let d=c instanceof Error?c.message:"Unknown error";a.push(`${l.name}: ${d}`),i++}}r.updateProgress({current:t.length,total:t.length,status:r.isCancelled()?"cancelled":"completed",errors:a.length>0?a:void 0}),r.isCancelled()||new Du.Notice(`Refresh complete: ${s} updated, ${i} failed`)}catch(e){this.handleError(e,"refresh all related notes")}}};var Dn=require("obsidian");var of=require("obsidian"),Ic=class extends of.Modal{links;onLink;onCloseCallback;constructor(e,t,r,s){super(e),this.links=t,this.onLink=r,this.onCloseCallback=s}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Tenuous links"}),e.createEl("p",{text:`Found ${this.links.length} unexpected connection${this.links.length>1?"s":""}. These are ideas with lower similarity but interesting potential connections:`}).addClass("ideatr-modal-description");let r=e.createDiv("ideatr-tenuous-links-list");this.links.forEach(i=>{let a=r.createDiv("ideatr-tenuous-link-item");a.style.marginBottom="20px",a.style.padding="10px",a.style.border="1px solid var(--background-modifier-border)",a.style.borderRadius="4px",a.createEl("strong",{text:i.idea.title}),a.createEl("div",{text:`Similarity: ${(i.similarity*100).toFixed(1)}% | Relevance: ${(i.relevance*100).toFixed(1)}%`,cls:"ideatr-tenuous-link-meta",attr:{style:"font-size: 12px; color: var(--text-muted); margin-top: 5px;"}}),a.createEl("div",{text:i.explanation,cls:"ideatr-tenuous-link-explanation",attr:{style:"margin-top: 10px; font-style: italic;"}}),i.synergy&&a.createEl("div",{text:`\u{1F4A1} Synergy: ${i.synergy}`,cls:"ideatr-tenuous-link-synergy",attr:{style:"margin-top: 10px; color: var(--text-accent);"}});let o=a.createDiv("ideatr-modal-buttons");o.style.marginTop="10px",o.createEl("button",{text:"Link ideas",cls:"mod-cta"}).addEventListener("click",()=>{this.onLink&&this.onLink(i,"link")}),o.createEl("button",{text:"Create combined idea"}).addEventListener("click",()=>{this.onLink&&this.onLink(i,"combine")})}),e.createDiv("ideatr-modal-buttons").createEl("button",{text:"Close"}).addEventListener("click",()=>{this.onCloseCallback&&this.onCloseCallback(),this.close()})}onClose(){let{contentEl:e}=this;e.empty(),this.onCloseCallback&&this.onCloseCallback()}};var Cc=class extends N{idConverter;constructor(e){super(e),this.idConverter=new H(e.ideaRepository)}getCommandName(){return"find tenuous links"}async executeWithFile(e,t){if(!this.context.tenuousLinkService){new Dn.Notice("Tenuous link service is not available.");return}new Dn.Notice("Finding tenuous links... This may take a moment.");let r=Array.isArray(t.frontmatter.related)?t.frontmatter.related.filter(a=>typeof a=="number"&&a!==0):[],s=await this.idConverter.idsToPaths(r),i=await this.context.tenuousLinkService.findTenuousLinks(t.ideaText,t.frontmatter.category||"",Array.isArray(t.frontmatter.tags)?t.frontmatter.tags:[],s);if(i.length===0){new Dn.Notice("No tenuous links found.");return}new Ic(this.context.app,i,async(a,o)=>{if(o==="link"){let l=Array.isArray(t.frontmatter.related)?t.frontmatter.related.filter(d=>typeof d=="number"&&d!==0):[],c=await this.idConverter.pathsToIds([a.idea.path]);c.length>0&&!l.includes(c[0])&&(await this.updateIdeaFrontmatter(e,{related:[...l,c[0]]}),new Dn.Notice(`Linked to ${a.idea.title}`))}else if(o==="combine"){let l=await this.idConverter.pathsToIds([e.path]),c=await this.idConverter.pathsToIds([a.idea.path]),d=[...l,...c].filter(p=>p!==0),u=`---
type: idea
status: captured
created: ${new Date().toISOString().split("T")[0]}
id: 0
category: ${t.frontmatter.category||""}
tags: ${JSON.stringify([...Array.isArray(t.frontmatter.tags)?t.frontmatter.tags:[],"combined"])}
related: ${JSON.stringify(d)}
domains: []
existence-check: []
---

# Combined Idea

## Original Idea
${t.ideaText}

## Linked Idea
${a.explanation}

## Synergy
${a.synergy||"Potential combination of these ideas"}
`,h=`Ideas/${new Date().toISOString().split("T")[0]}-combined-idea.md`;await this.context.app.vault.create(h,u),new Dn.Notice("Created combined idea.")}}).open()}};var la=require("obsidian");var lf=require("obsidian"),Pc=class extends lf.Modal{cluster;onOpenIdea;constructor(e,t,r){super(e),this.cluster=t,this.onOpenIdea=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Cluster analysis"});let t=e.createDiv("ideatr-cluster-header");if(t.createEl("h3",{text:this.cluster.label||"Unnamed Cluster",attr:{style:"margin-bottom: 10px;"}}),t.createEl("p",{text:`${this.cluster.ideas.length} idea${this.cluster.ideas.length>1?"s":""} in this cluster`,attr:{style:"color: var(--text-muted); margin-bottom: 20px;"}}),this.cluster.statistics){let o=e.createDiv("ideatr-cluster-stats");o.style.marginBottom="20px",o.style.padding="10px",o.style.backgroundColor="var(--background-secondary)",o.style.borderRadius="4px",o.createEl("h4",{text:"Statistics",attr:{style:"margin-bottom: 10px;"}});let l=o.createEl("ul",{attr:{style:"margin: 0; padding-left: 20px;"}});if(this.cluster.statistics.averageAge!==void 0&&l.createEl("li",{text:`Average age: ${Math.round(this.cluster.statistics.averageAge)} days`}),this.cluster.statistics.statusDistribution){let c=Object.entries(this.cluster.statistics.statusDistribution).map(([d,u])=>`${d}: ${u}`).join(", ");l.createEl("li",{text:`Status distribution: ${c}`})}}if(this.cluster.commonTags&&this.cluster.commonTags.length>0){let o=e.createDiv("ideatr-cluster-tags");o.style.marginBottom="20px",o.createEl("h4",{text:"Common tags",attr:{style:"margin-bottom: 10px;"}});let l=o.createDiv("ideatr-cluster-tags-list");l.style.display="flex",l.style.flexWrap="wrap",l.style.gap="5px",this.cluster.commonTags.forEach(c=>{l.createEl("span",{text:c,attr:{style:"background: var(--background-modifier-border); padding: 2px 8px; border-radius: 12px; font-size: 12px;"}})})}if(this.cluster.commonThemes&&this.cluster.commonThemes.length>0){let o=e.createDiv("ideatr-cluster-themes");o.style.marginBottom="20px",o.createEl("h4",{text:"Common themes",attr:{style:"margin-bottom: 10px;"}});let l=o.createEl("ul",{attr:{style:"margin: 0; padding-left: 20px;"}});this.cluster.commonThemes.forEach(c=>{l.createEl("li",{text:c})})}let r=e.createDiv("ideatr-cluster-members");r.style.marginBottom="20px",r.createEl("h4",{text:"Cluster members",attr:{style:"margin-bottom: 10px;"}});let s=r.createDiv("ideatr-cluster-members-list");if(s.style.maxHeight="300px",s.style.overflowY="auto",s.style.border="1px solid var(--background-modifier-border)",s.style.borderRadius="4px",s.style.padding="10px",this.cluster.ideas.forEach(o=>{let l=s.createDiv("ideatr-cluster-member-item");l.style.marginBottom="8px",l.style.padding="8px",l.style.cursor="pointer",l.style.borderRadius="4px",l.style.transition="background-color 0.2s",l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--background-modifier-hover)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="transparent"}),l.addEventListener("click",()=>{this.onOpenIdea&&this.onOpenIdea(`Ideas/${o.filename}`)}),l.createEl("strong",{text:o.filename}),o.frontmatter?.category&&l.createEl("div",{text:`Category: ${o.frontmatter.category}`,attr:{style:"font-size: 12px; color: var(--text-muted); margin-top: 4px;"}})}),this.cluster.relatedClusters&&this.cluster.relatedClusters.length>0){let o=e.createDiv("ideatr-cluster-related");o.style.marginBottom="20px",o.createEl("h4",{text:"Related clusters",attr:{style:"margin-bottom: 10px;"}});let l=o.createEl("ul",{attr:{style:"margin: 0; padding-left: 20px;"}});this.cluster.relatedClusters.forEach(c=>{let d=l.createEl("li",{attr:{style:"margin-bottom: 8px;"}});d.createEl("strong",{text:`${c.label} (similarity: ${(c.similarity*100).toFixed(1)}%)`}),c.explanation&&d.createEl("div",{text:c.explanation,attr:{style:"font-size: 12px; color: var(--text-muted); margin-top: 4px; font-style: italic;"}})})}let i=e.createDiv("ideatr-modal-buttons");i.style.marginTop="20px",i.createEl("button",{text:"Close",cls:"mod-cta"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var Rc=class extends N{constructor(e){super(e)}getCommandName(){return"analyze idea cluster"}async executeWithFile(e,t){if(!this.context.clusteringService){new la.Notice("Clustering service is not available.");return}new la.Notice("Analyzing cluster...");let s=this.context.app.vault.getMarkdownFiles().filter(g=>g.path.startsWith("Ideas/")&&!g.path.startsWith("Ideas/Archived/"));if(s.length===0){new la.Notice("No idea files found.");return}let i=[];for(let g of s)try{let E=await this.context.app.vault.read(g),R=this.context.frontmatterParser.parseIdeaFile({path:g.path,name:g.name},E);i.push(R)}catch(E){m.warn(`Failed to parse ${g.path}:`,E)}let a=await this.context.clusteringService.clusterIdeas(i),o=a.find(g=>g.ideas.some(E=>E.filename===e.name||`Ideas/${E.filename}`===e.path));if(!o){new la.Notice("Could not find cluster for this idea.");return}let l=new Map;o.ideas.forEach(g=>{(g.frontmatter?.tags||[]).forEach(R=>{l.set(R,(l.get(R)||0)+1)})});let c=Array.from(l.entries()).filter(([g,E])=>E>=2).sort((g,E)=>E[1]-g[1]).map(([g])=>g).slice(0,10),d=o.ideas.map(g=>{let E=g.frontmatter?.created?new Date(g.frontmatter.created).getTime():Date.now();return Math.floor((Date.now()-E)/(1e3*60*60*24))}),u=d.reduce((g,E)=>g+E,0)/d.length,h={};o.ideas.forEach(g=>{let E=g.frontmatter?.status||"unknown";h[E]=(h[E]||0)+1});let p=await Promise.all(a.filter(g=>g!==o).map(async g=>{let E=0,R=0;for(let B of o.ideas)for(let O of g.ideas){let U=B.body||B.filename||"",q=O.body||O.filename||"";if(U&&q){let $=this.context.searchService.calculateSimilarity(U,q);E+=$,R++}}let M=R>0?E/R:0;return{label:g.label,similarity:M,cluster:g}})),f=p.filter(g=>g.similarity>.3).sort((g,E)=>E.similarity-g.similarity).slice(0,5).map(g=>({label:g.label,similarity:g.similarity})),y=[],S=new Map;if(this.context.llmService.isAvailable()&&this.context.llmService.complete)try{let g=o.ideas.map(M=>({title:M.filename.replace(".md",""),text:M.body||"",category:M.frontmatter?.category||"",tags:M.frontmatter?.tags||[]})),E=lr.clusterAnalysis({clusterIdeas:g}),R=await this.context.llmService.complete(E,{temperature:.7,n_predict:500,grammar:or.clusterAnalysis});try{let M=z(R,!1);y=JSON.parse(M).commonThemes||[]}catch(M){m.warn("Failed to parse cluster analysis JSON:",M)}for(let M of f.slice(0,3)){let B=p.find(O=>O.label===M.label)?.cluster;if(B){let O=B.ideas.map($=>({title:$.filename.replace(".md",""),text:$.body||"",category:$.frontmatter?.category||"",tags:$.frontmatter?.tags||[]})),U=lr.clusterAnalysis({clusterIdeas:g,otherClusterIdeas:O,similarity:M.similarity}),q=await this.context.llmService.complete(U,{temperature:.7,n_predict:300,grammar:or.clusterAnalysis});try{let $=z(q,!1),G=JSON.parse($);M.label&&S.set(M.label,G.relationshipToOtherCluster||"")}catch($){m.warn("Failed to parse relationship analysis JSON:",$)}}}}catch(g){m.warn("Failed to analyze cluster with LLM:",g)}let x={label:o.label||"Unnamed Cluster",ideas:o.ideas,commonTags:c,commonThemes:y.length>0?y:void 0,statistics:{totalIdeas:o.ideas.length,averageAge:u,statusDistribution:h},relatedClusters:f.map(g=>({label:g.label||"Unnamed Cluster",similarity:g.similarity,explanation:S.get(g.label||"")})).filter(g=>g.label!=="Unnamed Cluster"||g.similarity>0)};new Pc(this.context.app,x,async g=>{this.context.app.vault.getAbstractFileByPath(g||"")&&await this.context.app.workspace.openLinkText(g||"","",!0)}).open()}};var cf=require("obsidian");var _c=class extends cf.Modal{stats;idConverter;constructor(e,t,r){super(e),this.stats=t,r&&(this.idConverter=new H(r))}async onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Idea statistics"});let t=e.createDiv("ideatr-stats-grid");t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",t.style.gap="15px",t.style.marginBottom="20px",this.createStatCard(t,"Age",`${this.stats.age} day${this.stats.age!==1?"s":""}`),this.createStatCard(t,"Status",this.stats.status||"unknown"),this.createStatCard(t,"Category",this.stats.category||"none"),this.createStatCard(t,"Related Notes",this.stats.relatedCount.toString()),this.createStatCard(t,"Tags",this.stats.tagsCount.toString()),this.createStatCard(t,"Domains",this.stats.domainsCount.toString());let r=e.createDiv("ideatr-stats-dates");r.style.marginBottom="20px",r.style.padding="10px",r.style.backgroundColor="var(--background-secondary)",r.style.borderRadius="4px",r.createEl("h4",{text:"Dates",attr:{style:"margin-bottom: 10px;"}});let s=r.createEl("ul",{attr:{style:"margin: 0; padding-left: 20px;"}});if(s.createEl("li",{text:`Created: ${this.stats.created.toLocaleDateString()}`}),s.createEl("li",{text:`Last modified: ${this.stats.lastModified.toLocaleDateString()}`}),this.stats.frontmatter){let o=e.createDiv("ideatr-stats-additional");if(o.style.marginBottom="20px",this.stats.frontmatter.tags&&this.stats.frontmatter.tags.length>0){let l=o.createDiv("ideatr-stats-tags");l.style.marginBottom="10px",l.createEl("h4",{text:"Tags",attr:{style:"margin-bottom: 10px;"}});let c=l.createDiv("ideatr-stats-tags-list");c.style.display="flex",c.style.flexWrap="wrap",c.style.gap="5px",this.stats.frontmatter.tags.forEach(d=>{c.createEl("span",{text:d,attr:{style:"background: var(--background-modifier-border); padding: 2px 8px; border-radius: 12px; font-size: 12px;"}})})}if(this.stats.frontmatter.related&&this.stats.frontmatter.related.length>0){let l=o.createDiv("ideatr-stats-related");l.style.marginBottom="10px",l.createEl("h4",{text:"Related notes",attr:{style:"margin-bottom: 10px;"}});let c=l.createEl("ul",{attr:{style:"margin: 0; padding-left: 20px; max-height: 150px; overflow-y: auto;"}}),d=this.stats.frontmatter.related,u=d.filter(h=>typeof h=="number"&&h!==0);if(u.length>0&&this.idConverter)try{let h=await this.idConverter.idsToTitles(u);u.forEach(p=>{c.createEl("li",{attr:{style:"font-size: 12px; cursor: help;"}}).createEl("span",{text:p.toString(),attr:{style:"text-decoration: underline; text-decoration-style: dotted;",title:h.get(p)||`ID: ${p}`}})})}catch{u.forEach(h=>{c.createEl("li",{text:h.toString(),attr:{style:"font-size: 12px;"}})})}else d.forEach(h=>{let p=typeof h=="number"?h.toString():h;c.createEl("li",{text:p,attr:{style:"font-size: 12px;"}})})}}let i=e.createDiv("ideatr-modal-buttons");i.style.marginTop="20px",i.createEl("button",{text:"Close",cls:"mod-cta"}).addEventListener("click",()=>{this.close()})}createStatCard(e,t,r){let s=e.createDiv("ideatr-stat-card");return s.style.padding="10px",s.style.backgroundColor="var(--background-secondary)",s.style.borderRadius="4px",s.style.border="1px solid var(--background-modifier-border)",s.createEl("div",{text:t,attr:{style:"font-size: 12px; color: var(--text-muted); margin-bottom: 5px;"}}),s.createEl("div",{text:r,attr:{style:"font-size: 16px; font-weight: bold;"}}),s}onClose(){let{contentEl:e}=this;e.empty()}};var Tc=class extends N{constructor(e){super(e)}getCommandName(){return"show idea stats"}async executeWithFile(e,t){let r=t.frontmatter.created?new Date(t.frontmatter.created):new Date(e.stat.mtime),s=Math.floor((Date.now()-r.getTime())/(1e3*60*60*24)),i=Array.isArray(t.frontmatter.related)?t.frontmatter.related.length:0,a=Array.isArray(t.frontmatter.tags)?t.frontmatter.tags.length:0,o=Array.isArray(t.frontmatter.domains)?t.frontmatter.domains.length:0,l=new Date(e.stat.mtime),c={age:s,status:t.frontmatter.status||"unknown",category:t.frontmatter.category||"none",relatedCount:i,tagsCount:a,domainsCount:o,lastModified:l,created:r,frontmatter:t.frontmatter};new _c(this.context.app,c,this.context.ideaRepository).open()}};var kc=class n{static createCommandCallback(e,t){let r=async()=>{m.info(`Callback invoked for: ${e}`),m.debug("Callback stack trace:",new Error().stack);try{m.debug(`About to call operation for: ${e}`),await n.safeExecute(e,t),m.debug(`Operation completed for: ${e}`)}catch(s){console.error(`[Ideatr] Callback error for ${e}:`,s),m.error(`Callback error for ${e}:`,s)}};return typeof r!="function"&&(console.error(`[Ideatr] ERROR: Callback for ${e} is not a function! Type: ${typeof r}`),m.error(`Callback for ${e} is not a function! Type: ${typeof r}`)),r}static async safeExecute(e,t){m.info(`Starting command: ${e}`);let r=null;try{r=new Mc.Notice(`\u23F3 Processing ${e}...`,0),m.debug(`Created loading notice for: ${e}`);try{let s=r.noticeEl;if(s){let i=s.createSpan({cls:"ideatr-loading-spinner"});i.textContent="\u23F3",i.addClass("ideatr-loading-spinner")}}catch(s){m.debug("Could not add spinner to notice (non-critical):",s)}}catch(s){console.error(`[Ideatr] Failed to create loading notice for ${e}:`,s),m.error(`Failed to create loading notice for ${e}:`,s)}try{m.debug(`Executing operation for: ${e}`),await t(),m.info(`Finished command: ${e}`),r&&r.hide(),new Mc.Notice(`\u2713 ${e} completed`,2e3)}catch(s){console.error(`[Ideatr] Command '${e}' failed:`,s),m.error(`Command '${e}' failed:`,s),r&&r.hide()}}static registerAll(e,t){m.debug("Registering commands...");let r=n.createCommandCallback("Capture Idea",()=>new Nl(t).execute());e.addCommand({id:"capture-idea",name:"Capture Idea",callback:r}),m.debug("Registered: Capture Idea"),e.addCommand({id:"search-existence",name:"Search Existence",callback:n.createCommandCallback("Search Existence",()=>new Bl(t).execute())}),e.addCommand({id:"check-duplicates",name:"Check Duplicates",callback:n.createCommandCallback("Check Duplicates",()=>new jl(t).execute())}),e.addCommand({id:"find-related-notes",name:"Find Related Notes",callback:n.createCommandCallback("Find Related Notes",()=>new zl(t).execute())}),e.addCommand({id:"quick-validate",name:"Quick Validate",callback:n.createCommandCallback("Quick Validate",()=>new Wl(t).execute())});let s=n.createCommandCallback("Generate Name Variants",()=>new Jl(t).execute());m.debug("Created nameVariantCallback, type:",typeof s),e.addCommand({id:"generate-name-variants",name:"Generate Name Variants",callback:s}),m.debug("Registered: Generate Name Variants"),e.addCommand({id:"generate-scaffold",name:"Generate Scaffold",callback:n.createCommandCallback("Generate Scaffold",()=>new Ql(t).execute())}),e.addCommand({id:"generate-mutations",name:"Generate Mutations",callback:n.createCommandCallback("Generate Mutations",()=>new Zl(t).execute())});let i=n.createCommandCallback("Expand Idea",()=>new tc(t).execute());if(m.debug("Created expandCallback, type:",typeof i,"is function:",typeof i=="function"),e.addCommand({id:"expand-idea",name:"Expand Idea",callback:i}),m.debug("Registered: Expand Idea, callback stored:",typeof i),e.addCommand({id:"reorganize-idea",name:"Reorganize Idea",callback:n.createCommandCallback("Reorganize Idea",()=>new sc(t).execute())}),e.addCommand({id:"guided-ideation",name:"Transform",callback:n.createCommandCallback("Transform",()=>new ac(t).execute())}),e.addCommand({id:"change-status",name:"Change Status",callback:n.createCommandCallback("Change Status",()=>new lc(t).execute())}),e.addCommand({id:"archive-idea",name:"Archive Idea",callback:n.createCommandCallback("Archive Idea",()=>new aa(t,!0).execute())}),e.addCommand({id:"unarchive-idea",name:"Unarchive Idea",callback:n.createCommandCallback("Unarchive Idea",()=>new aa(t,!1).execute())}),e.addCommand({id:"add-codename",name:"Generate Codename",callback:n.createCommandCallback("Generate Codename",()=>new cc(t).execute())}),e.addCommand({id:"open-dashboard",name:"Open Dashboard",callback:n.createCommandCallback("Open Dashboard",()=>new dc(t).execute())}),e.addCommand({id:"open-graph",name:"Open Graph View",callback:n.createCommandCallback("Open Graph View",()=>new uc(t).execute())}),e.addCommand({id:"open-tutorials",name:"Open Tutorials",callback:n.createCommandCallback("Open Tutorials",()=>new pc(t).execute())}),e.addCommand({id:"classify-current-note",name:"Classify Current Note",callback:n.createCommandCallback("Classify Current Note",()=>new mc(t).execute())}),e.addCommand({id:"refresh-idea",name:"Refresh Idea",callback:n.createCommandCallback("Refresh Idea",()=>new hc(t).execute())}),e.addCommand({id:"export-ideas",name:"Export Ideas",callback:n.createCommandCallback("Export Ideas",()=>new fc(t).execute())}),e.addCommand({id:"import-ideas",name:"Import Ideas",callback:n.createCommandCallback("Import Ideas",()=>new yc(t).execute())}),e.addCommand({id:"generate-digest",name:"Generate Weekly Digest",callback:n.createCommandCallback("Generate Weekly Digest",()=>new bc(t).execute())}),e.addCommand({id:"elevate-to-project",name:"Elevate to Project",callback:n.createCommandCallback("Elevate to Project",()=>new wc(t).execute())}),e.addCommand({id:"reclassify-all-ideas",name:"Reclassify All Ideas",callback:n.createCommandCallback("Reclassify All Ideas",()=>new xc(t).execute())}),e.addCommand({id:"find-all-duplicates",name:"Find All Duplicates",callback:n.createCommandCallback("Find All Duplicates",()=>new Ac(t).execute())}),e.addCommand({id:"refresh-all-related-notes",name:"Refresh All Related Notes",callback:n.createCommandCallback("Refresh All Related Notes",()=>new Ec(t).execute())}),e.addCommand({id:"find-tenuous-links",name:"Find Tenuous Links",callback:n.createCommandCallback("Find Tenuous Links",()=>new Cc(t).execute())}),e.addCommand({id:"analyze-idea-cluster",name:"Analyze Idea Cluster",callback:n.createCommandCallback("Analyze Idea Cluster",()=>new Rc(t).execute())}),e.addCommand({id:"show-idea-stats",name:"Show Idea Statistics",callback:n.createCommandCallback("Show Idea Statistics",()=>new Tc(t).execute())}),m.isDebugEnabled()){let a=n.createCommandCallback("Ideatr Debug (Registry)",async()=>{m.debug("[Ideatr DEBUG REGISTRY] Command operation executed!"),m.info("DEBUG REGISTRY: Command executed successfully"),new Mc.Notice("Ideatr Debug (Registry) command executed - check console")});m.debug("Debug registry callback type:",typeof a),e.addCommand({id:"debug-registry",name:"Debug (Registry)",callback:a}),m.debug("Registered debug command via CommandRegistry")}}};var Lc=class{snapshots=[];maxSnapshots=100;monitoringInterval=null;startMonitoring(e=3e4){if(this.monitoringInterval){m.warn("Memory monitoring already started");return}m.debug("Starting memory monitoring"),this.takeSnapshot(),this.monitoringInterval=setInterval(()=>{this.takeSnapshot(),this.checkForLeaks()},e)}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null,m.debug("Stopped memory monitoring"))}takeSnapshot(){let e=process.memoryUsage(),t={timestamp:Date.now(),heapUsedMB:e.heapUsed/1024/1024,heapTotalMB:e.heapTotal/1024/1024,externalMB:e.external/1024/1024,arrayBuffersMB:e.arrayBuffers/1024/1024};return this.snapshots.push(t),this.snapshots.length>this.maxSnapshots&&this.snapshots.shift(),t}checkForLeaks(){if(this.snapshots.length<10)return;let e=this.snapshots.slice(-10),t=e[0],r=e[e.length-1],s=r.heapUsedMB-t.heapUsedMB,i=(r.timestamp-t.timestamp)/1e3/60,a=s/i;a>1&&m.warn("Potential memory leak detected:",{heapGrowthMB:s.toFixed(2),timeElapsedMinutes:i.toFixed(2),growthRateMBPerMinute:a.toFixed(2)})}getReport(){if(this.snapshots.length===0)return"No memory snapshots available";let e=this.snapshots[this.snapshots.length-1],t=this.snapshots[0],r=e.heapUsedMB-t.heapUsedMB;return`Memory Report:
  Current Heap: ${e.heapUsedMB.toFixed(2)} MB
  Total Heap: ${e.heapTotalMB.toFixed(2)} MB
  External: ${e.externalMB.toFixed(2)} MB
  Growth since monitoring started: ${r.toFixed(2)} MB
  Snapshots collected: ${this.snapshots.length}`}getCurrentUsage(){return this.snapshots.length===0?null:this.snapshots[this.snapshots.length-1]}clearSnapshots(){this.snapshots=[]}isMonitoring(){return this.monitoringInterval!==null}};var df="iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAHhlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAABgAAAAAQAAAGAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAABigAwAEAAAAAQAAABgAAAAAPuetXQAAAAlwSFlzAAAOxAAADsQBlSsOGwAABDNJREFUSA2lVN9rHFUU/ubeuXdm9kc2v1pJGmkloLEUH1QKkipGQVHqi/rSp7740Aeh4pNQCksV/AcqgiISbZWiPkTUJiC2WKHGGoi1IWkam7T53U12d3Y3uzM7s/d6Rgism01S8b7MvXfO+b5zvnPuAe5zXb24fOCPXwqPaK1j9+nyj5mxm/EH6YmEs9F5uq1LnIjv4ZKbWNBQU5YlJtxifuTo8Z5LO2Hw7X6m02l2fOD8UZVLDlazidfbH9SWjBmmoVg7lPlwzZdH3Ezl2D7xQnb01rlr2+Fsm8HwudUT2fnYh76r4RerOHiEQ0gOTUhBtQbP09DKwJ2pVTCBdxfl8pl0eiBsJGKNF9FZ6zSrVtgxaZrgdoj4XgOxVgYR17CSGnbMgGMbkFIj3iYwM5k7vXg5ONQMy2x2efP6W/sDL3yC2T6kApwYg5UADFPDIFGrAmDgyGQKuDL8F5TvwGkV/YQ13ojXNIPl2eB5S8Tj0laItQC1oIYrX3oYHwmxMKHgbxCBXcPvl++AhRyphESqRbyoib+RYEsGkdHwebzCuYYgGbjQuDmlUMwwlLIaKzM1mEIh1aWgqgba2+IwTUFyscNjY0sdQPdaPckWgunpQkfoV/stGSCRZFhbCFDKkN6kOyN5WORBlS6vmeju2YvCukdhGwirwQPXhzK99PdfBFskmhstV4r3SgsqCOGVfSxMUcQWwKmgpqNgUqF5jArDa1SFBFr3SSiusF4ozo7dyMzURx/tt2gWXX7+/uRrlbz1dTFbhmAOTEaFoOi5pcGkQe1JBAHDRjGPGxO3EfqUFq++MfjbS59E/vVrSwbRz553LgxJx//eCCVy2XWImEcZAMJikMIgzRnshMLS8gqMqqQ79atV2/NZPfDmvinBgJEOex+TbyujnC1lQ9zLrFK/k0SSmjMCdzj8MI9y3kc8birL4emPxp4MNkHrv00JIoOnX+2d1sw7SRUN795ykXfXIIQPi9oz0Rpi+XYWqWQLYjH27dlLz43Ug9bvm9Zg04Amp3Hy2Z8mgsB6VIuAoi5TBhz7H0oBpUgaG6HyXz514fGLmz6N320ziAyj9gug5pkhKXKGcpFadt3H2lIZrZ1J2C2ikkhZE42g9ecdCQhf11j4Y8hKNCo0Eo5AW4sNTkPOdGgeteKHrtzBxXrAxv2Wh9ZoUOn95jt3Vb136JkB6f45idm5efiej3zuADzkhr746uNao0/9eVeCvOt6brlQnpodl5niCrLeIo3rKjIFo1athcv1YM32O0tEHgYsThMJwpS0Z1ChIt00NkplOnN6fjuvXQkssArnjAkpqE0FGIveAoe0JN3qHbswot6VoFRKrVm28+nc3F24bgG27SBJ/U/Igzz0ft45/m1mUTOnw0/1v8kZTuWyLk+2JM9eG716ppnd/7rr6+vr6O7u7vwvIH8DwCqf0vItrMwAAAAASUVORK5CYII=",uf="iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAHhlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAABgAAAAAQAAAGAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAABigAwAEAAAAAQAAABgAAAAAPuetXQAAAAlwSFlzAAAOxAAADsQBlSsOGwAABDZJREFUSA2tVV1oHFUU/u7cO3dmdme2u8nmv5SmiD5EKoEgVlpiCfokkfpQ7KsoaH2sT6LpVkEffKt/KFp8EIQ2iFKFKmnaUqnakpoYSA02Jm2TbP72L7ubzM7f9U4wEJJNNoIzD/fOme+e75zvnnsusKtHkIvZT/ddKZx/SAhh7GrJvyBSC3z2r1RsNjbWl2TJl5qCNq5AeQBCxhhjY5ncyk8n2/uu7eRjW4KUSCk0fbc3y5bOLPPswceCJ1EvmgEq4FMHPnMxv5hxB4ZvnhroHfpgOxK23Y/2Be2VGVP5SPc4XDuGBG+ERqQ6PuB4FJ4doD4aVx9tf/js4ZEnmruzDaePHk15m/0pmw3h95WnBLNJ8YQqODQvigbahLjSgAhiMEkcUSUGg0TXCOMsjqH5kTf6st8crOaragbmt5f32W65k7sGAiJgUBNREgMjHAoomCQWNEC+WMKl8UE4agUGjzwuCW5vJqmawT1/rEeVIerChEUScAIH/aXPcNnpxx3/FsqkAFXoGJz8GT53YFoGEmbimRTEFn9bMghBK8F7varQoMMCJQzjlUHkxSKKXhZT/p9QZSZJtMFlFdTH6sBUJqUzjjw9dyOZasbCxiy2MJ5YHqpzSPkQ9wxYNI5MsICsWICmGNCpIeWKSqlUFJUM2hvb0KK3ooEn4auV5Hdz5/ZvdB7OtxCM2N/bi6X8olMBik4Z496wdMigKgxcRq7JVye6XKhAjbpoYS0IbIHSkjOTLmenNhNUPQfvj731Qo6kv16w5yFiRTDTkxurrhGEGw0hpJABChkXo6PTqJAKzCBx8vrxoU82E2zJIAS8fv7tfinRD2F1LC2uQnctmYG6VpacaGsS6cLCzIMCXL0CTtWbzR0HvtjsPPyuSkBSxOuMHjkFl+ZyTgHp6RXEZP1zhcsNVmGwCCo5BXkvj0hUDwxLO32h44Kza4IQ+NyB4+N70X6GKUz8vXgfhbQAc+UOBPK4+Q2YzMzASkQQ5ZGLV3v++LGa89C2pUw3Ap/3X/z4WnHgVcbZI6P3J1C+U5atSMX+xr0Qpo96Xg9SoZ+DQGxct3FeVaJ1QFdXl1tx/LucSWkoRdEvyZJdQtpOI6knQ9nsuGqOruOrjTsShAsSouFGUCbQZHuI6ByWqSOgLqIwkVDqLnV30ulqjtdtdH2y3di951jGvU1f7ml8luJ3C6XrBJVfOfSJJuSuinf7jn01vN3a0L7jHoSApdm51bI8cRPDM3w5bcOeDuA6Anms+K7tzoaYnZ6aEhFdo7KBEqbKZMPLRnjySvBRXilB9o+aAdYEaFBWqaIoXFOhqrJdU9mwBQXXuDTTqp1gY0Y1MyiV9izpunFuavIeCvkCdM1AzIqFJ/TLKPN2vI9DopoRrEfTdejwa6qCN3O5vGJZ1oe3fvvlnfV//9vY0dFR19ramvwvDv8BxwGDgevhw4MAAAAASUVORK5CYII=",pf="iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAHhlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAABgAAAAAQAAAGAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAABigAwAEAAAAAQAAABgAAAAAPuetXQAAAAlwSFlzAAAOxAAADsQBlSsOGwAABBBJREFUSA2VVVtonEUU/mbmv+19001MabpIpIqiEYrVFjEQib4Wn/qiPuiDoeAFS9GXSoXqg8+VUpRSX0SsDxEkiBWRUoxaqJDGapJaa7pJzOa21/z733bG87emTeKf7HqWYWcO3/m+OWfOzA+0ZYrZfxzJ24U3e5RSvK2Qf0GsFXjh+4FkzKy9pWd2v9Y0coASfwLBuOByvLJsj3bv/+LH7Ti2FFAKrDbef1DzVo7rsr43SB8ASEBwDo0HYMxGbaXmzY9PHn3ghd9ObiWypUB56o2hJK6cDpwqvIYD0fkswC3ioQpJB6pZBmc+grIDmch/kHkofYyxd4PNQtpmR7geGFAaky8/DyHgKxPMStPud1J5AEY/xciHJi1rcMlX//2Ht6cvzp+j0F8280UKDH/25W5eqe71JO2YEEzrAhMdd2KZtMnZhFPxsTT2LWK8gaRmPhElENkRrDH2TCIukorvADe66UwV/OunEMwNQ1bGoAIbknWgPnWZyF0kEnFY8Vj/nR2sm0RkoDhXRw4qFqPdd95qu1w8D+UViXgRsv4rZWMA1n3QNapPljCaoJMx+gtXz+3IP3xoZR1/eGIbrTw9kuGo7/dVBky/B2qViJ0ZIqW6h0OjsjFBWc3B2tkDkckD8Rwsk+VF+cIjG9lutcRGl1P+3POr1TkVxNB0XMjSJUIRIR04BCUs9NuDKQijChXfBc8XWF7xZuzitYmNbGFTRFhx9NXnLKM67NaL0OQ8EdVIhMg5kZNY2ElMcNhVHcXJBcK4aASpVx57ferjzXT/KVEIeGf85Ijr6iNms0SdoqB4JxHqNAywUITmSmRR/9tGXHi0Nn9WZuqTzeThOlLgoyHmB6mnjjq2Voa9BHuR7o9JIhoJhMOIw6snwNwarGRSWdmu9/cNXfbbFgiBux59acI3Hzyh0YE6xQLqpQRdrSQkz9Du74W3tIhkOkbz1Ne9hy6NRJGHvog2vQv173/xlJw5f1izrD3V2VnMT9ChKoF0d4CUFkBL5SAD8zRjTN6N2jiLLNEapLf3aSeAmhBWgh45Bi2oQPcWwVYL0NM5BHrKMTPZK2v4qP9tBcIAj3ddbDQUNY+BmKEjETco7QaUloAUuW+ys2IminjNt22JQtDx7/Z9ZfgLJwYHB42JyasoTN+A6znI9+ZQXuXDZ8982lwji/pvKVAqV5x6xV2NjxWMhQUXN2eb8DwJR7ObsunPRZGu97UsUZy+MEIwGBqn6yVpNKm3JezVOj1B9Ai1sJYC0mINzhm34hZMywSnL5rQNeiGLrbvwdvKLQX8SmXZMq0zN67/hdJyiR41C+lkGroQZ00EF1okQBm3aY8fePIwlelYaaUs0tn0hz+Njr7XZmj7sL6+vo6eHrpd/8P+AaolgMPx0J5bAAAAAElFTkSuQmCC",mf="iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAHhlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAABgAAAAAQAAAGAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAABigAwAEAAAAAQAAABgAAAAAPuetXQAAAAlwSFlzAAAOxAAADsQBlSsOGwAABCpJREFUSA2tVVtoHFUY/s7cd7LXxIQ0iQk0MYEsBSstJeqLGlGKAV+LBN/0wRuiIuiDC14QhYJQEATBiqAYvNWE2lCxXmirJfQhSrw0Kblt0nbNbDK7c9mZneM/kdJ1d+JGcOAw55z5zvf93/+fcwbY5VM4+kq3M/nJ3mXOY7tcsg1jzcD5sTFdM1aeYAcOPusPDukQpRVa85ssS3ObRmm675nnv/43DnGnjzyXEx7vax9TreJxzbbHq8NZPUinZJGhTfYrQ4pp3uFcvXLkPiZsfLC0cmEnHmmnD4Wk+ogeU98OWnRYQQB0doLHdPjk2XcEuJUK9Na03HPbvmOz9492FXzxpbtyOb+eT6if2B5zLsLcPBKoKtyWOIQ9XWDtHWDxOLUEEDaaRywGlkjg6tmzL9iTH++L4op0kD892c3s8q0VIuCcA4k0hEQSkAguCuDlMsADmGUL86dOQXEcBJJ6kAQu1otECii/X7pbU5RkWaMIKVpe3ELw5usQenrAbhkC6+2DT26Wvv8BStVHPJWEB3Y7kb9TL9C4izhnhaOvfapWrAetZAaCrIB9/hn48iIYOWACZVVREOztxx9mGYFt0VCG73pzRTmx//DJk26tSEMNjDNnUnCsEU+n3Le1QVxZBsuvQNDJDRUcScq/pkJcX0PHnk6ovT2QCCfJ0mArKv215GG/QcCdmvLMza28S5F7tgP+4/ntiMOoQUXfbmFtyE28XILY2QUXDEXLXSxVzCv1Ao0pIsTF5548rAh8yikUkFlfR9rcAqc0QCEBWQanNIWRXSPiX1bXAEqT7fOHH5qbf79eoMFBCPjijbemA0GelE0T67SJnJvawcgRYtrfW5OcVDOtWKUaqK4LUZbPl/T0h/Xk4ThSIMeYHxve/7Tr84JvFLHkB+AddA5oV4UiLBHHhhpDhZzF4nqgpxK5R2dmvF0LhMCB8fFLnig8JXieZywuIq/pcFMp+OkMvJ5eFNbySJGQ2BL/cvSbn6ajyMO5yBrUgNnp4YFZ1qJlnUwGtmHQCgGZ/gHolglV0+Ax9sChj05M1az5RzfyoNUgeIWxhZiuZ0VGsfxpgFerqFAN2gb7w2LbIpNma/AN3cga1KL8ZPI72/UgiTJaqNBpItcsK0wNpHTrVwuGvVqLr+83c4CJ7KEpby3/6ui99yi/zv6MpfkFuK6Dm02GUsk/8d7ERLWetHbcVGDDKLqbtmvNXF5S1ssOlv0qvCpHdatcpSdfSxbVb5oi2vki/WSYIooQ6AYFCYDqYJVMyNsXUxTtjbmmDgRBshgRKZoCma4Lga5riUt0c6giF4NmuzD6oN3QB+X5WkFVY+9eXlhEkQ6dpmpI0E+GXB2Ha31bi43qN43g+qIDI3c+porsRWPDEFtSiWMXzp17+fq3/+09ks22dnd3t/0Xwr8AlfeB0c709XMAAAAASUVORK5CYII=";var Fc=class extends Ae.Plugin{settings;localLLMService;modelManager;pluginContext;statusBarItem;statusUpdateInterval;memoryMonitor;unhandledRejectionHandler;uncaughtExceptionHandler;exitHandler;sigintHandler;sigtermHandler;get nameVariantService(){return this.pluginContext.nameVariantService}get errorLogService(){return this.pluginContext.errorLogService}async onload(){await this.loadSettings(),this.unhandledRejectionHandler=(r,s)=>{console.error("Ideatr: Unhandled Rejection at:",s,"reason:",r),m.error("Unhandled Rejection:",r)},process.on("unhandledRejection",this.unhandledRejectionHandler),this.uncaughtExceptionHandler=r=>{console.error("Ideatr: Uncaught Exception:",r),m.error("Uncaught Exception:",r)},process.on("uncaughtException",this.uncaughtExceptionHandler),this.exitHandler=()=>{m.debug("Process exit handler triggered - cleaning up llama-server"),Fe.destroyInstance()},this.sigintHandler=()=>{m.debug("SIGINT received - cleaning up and exiting"),Fe.destroyInstance(),process.exit(0)},this.sigtermHandler=()=>{m.debug("SIGTERM received - cleaning up and exiting"),Fe.destroyInstance(),process.exit(0)},process.on("exit",this.exitHandler),process.on("SIGINT",this.sigintHandler),process.on("SIGTERM",this.sigtermHandler),await m.initialize(this.app,this.settings.debugMode),this.modelManager=new be,lp(this.settings)&&setTimeout(()=>{new ss(this.app,this.modelManager,this.settings,async()=>{await this.saveSettings()}).open()},100);let{context:e,localLLMService:t}=await Fl.initialize(this.app,this,this.settings);this.pluginContext=e,this.localLLMService=t,this.addStatusBarIndicator(),await this.ensureTutorialsAvailable(),this.registerView("ideatr-dashboard",r=>new va(r,this.pluginContext.ideaRepository,this.pluginContext.clusteringService,this.pluginContext.resurfacingService,this.pluginContext.projectElevationService,this.settings.dashboardItemsPerPage,this.settings.dashboardPersistFilters)),this.registerView("ideatr-graph",r=>new xa(r,this.pluginContext.clusteringService,this.pluginContext.graphLayoutService,this.pluginContext.ideaRepository,this.pluginContext.projectElevationService)),this.addSettingTab(new nl(this.app,this)),m.debug("Starting command registration...");try{if(!this.pluginContext)throw new Error("PluginContext is not initialized");if(!this.pluginContext.commandContext)throw new Error("CommandContext is not initialized");if(kc.registerAll(this,this.pluginContext.commandContext),m.isDebugEnabled()){let r=async()=>{m.debug("[Ideatr DEBUG MAIN] Command callback invoked!"),m.debug("[Ideatr DEBUG MAIN] Stack trace:",new Error().stack),m.info("DEBUG MAIN: Command executed successfully"),new Ae.Notice("Ideatr Debug (Main) command executed - check console")};m.debug("Debug main callback type:",typeof r),this.addCommand({id:"debug-main",name:"Debug (Main)",callback:r}),m.debug("Registered debug command directly in main.ts")}(0,Ae.addIcon)(Un,Hn(`data:image/png;base64,${df}`)),(0,Ae.addIcon)(jc,Hn(`data:image/png;base64,${uf}`)),(0,Ae.addIcon)(qc,Hn(`data:image/png;base64,${pf}`)),(0,Ae.addIcon)(Gc,Hn(`data:image/png;base64,${mf}`)),this.addRibbonIcon(Un,"Capture Idea",()=>{this.openCaptureModal()}),this.addCommand({id:"force-kill-server",name:"Force Kill AI Server",callback:()=>{this.localLLMService&&(this.localLLMService.stopServer(),new Ae.Notice("AI Server stopped (Force Kill)"))}}),this.addCommand({id:"show-memory-report",name:"Show Memory Report",callback:()=>{if(this.memoryMonitor){let r=this.memoryMonitor.getReport();m.debug("Memory Report:",r);let s=this.memoryMonitor.getCurrentUsage();s?new Ae.Notice(`Heap: ${s.heapUsedMB.toFixed(0)}MB | Ext: ${s.externalMB.toFixed(0)}MB`):new Ae.Notice("Memory report logged to console")}else new Ae.Notice("Memory monitoring is not enabled (requires Debug Mode)")}}),m.info("All commands registered successfully")}catch(r){console.error("[Ideatr] Error registering commands:",r),console.error("[Ideatr] Error details:",r instanceof Error?r.stack:r),new Ae.Notice("Failed to register Ideatr commands. Check console for details.")}this.settings.debugMode&&(this.memoryMonitor=new Lc,this.memoryMonitor.startMonitoring(6e4),m.debug("Memory monitoring started"))}openCaptureModal(){new rs(this.app,this.pluginContext.fileManager,this.pluginContext.classificationService,this.pluginContext.duplicateDetector,this.settings,this.pluginContext.domainService,this.pluginContext.webSearchService,this.pluginContext.nameVariantService,this.pluginContext.llmService,this.pluginContext.ideaRepository).open()}async ensureLLMReady(){this.pluginContext.llmService?.ensureReady&&await this.pluginContext.llmService.ensureReady()}onunload(){m.debug("Unloading Ideatr plugin"),this.unhandledRejectionHandler&&(process.removeListener("unhandledRejection",this.unhandledRejectionHandler),this.unhandledRejectionHandler=void 0),this.uncaughtExceptionHandler&&(process.removeListener("uncaughtException",this.uncaughtExceptionHandler),this.uncaughtExceptionHandler=void 0),this.exitHandler&&(process.removeListener("exit",this.exitHandler),this.exitHandler=void 0),this.sigintHandler&&(process.removeListener("SIGINT",this.sigintHandler),this.sigintHandler=void 0),this.sigtermHandler&&(process.removeListener("SIGTERM",this.sigtermHandler),this.sigtermHandler=void 0),this.statusUpdateInterval&&(clearInterval(this.statusUpdateInterval),this.statusUpdateInterval=void 0),this.memoryMonitor&&(m.debug("Memory report before unload:"),m.debug(this.memoryMonitor.getReport()),this.memoryMonitor.stopMonitoring(),this.memoryMonitor=void 0),this.pluginContext?.llmService&&this.pluginContext.llmService.cleanup?.(),Fe.destroyInstance(),m.debug("Ideatr plugin unloaded successfully")}async loadSettings(){let e=await this.loadData();if(this.settings=Object.assign({},Bh,e),e&&"cloudApiKey"in e&&e.cloudApiKey&&(!this.settings.cloudApiKeys||Object.values(this.settings.cloudApiKeys).every(t=>!t))){let t=e.cloudApiKey,r=e.cloudProvider||"none";t&&r!=="none"&&r!=="custom"&&(this.settings.cloudApiKeys||(this.settings.cloudApiKeys={anthropic:"",openai:"",gemini:"",groq:"",openrouter:""}),(r==="anthropic"||r==="openai"||r==="gemini"||r==="groq"||r==="openrouter")&&(this.settings.cloudApiKeys[r]=t),await this.saveSettings())}this.settings.cloudApiKeys||(this.settings.cloudApiKeys={anthropic:"",openai:"",gemini:"",groq:"",openrouter:""})}async saveSettings(){await this.saveData(this.settings),this.localLLMService&&this.localLLMService.updateSettings(this.settings)}addStatusBarIndicator(){this.statusBarItem=this.addStatusBarItem(),this.updateStatusBarIndicator(),this.statusUpdateInterval=window.setInterval(()=>{this.updateStatusBarIndicator()},5e3)}updateStatusBarIndicator(){if(!this.statusBarItem)return;this.statusBarItem.empty();let e=ba(this.pluginContext.llmService,this.settings,this.app);this.statusBarItem.appendChild(e)}async ensureTutorialsAvailable(){try{let e=this.app.vault.adapter.basePath||this.app.vault.configDir,t=Zr(this.app.vault.configDir)?this.app.vault.configDir:ee(e,this.app.vault.configDir),r=Yr(ee(t,"plugins",this.manifest.id)),s=new In(this.app,r);s.tutorialsExistInVault()||(await s.bundledTutorialsAvailable()?(m.info("Tutorials not found in vault, copying from plugin directory..."),await s.resetTutorials()):m.warn("Tutorial files not found in plugin directory. They may need to be manually restored."))}catch(e){m.warn("Error ensuring tutorials are available:",e)}}};
/*! Bundled license information:

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
*/
